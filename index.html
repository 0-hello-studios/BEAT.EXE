<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>STUDIO.EXE</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700;800&family=Syne:wght@400;700;800&display=swap');
:root{--bg:#08080b;--surface:#111115;--s2:#18181e;--s3:#1f1f27;--border:#303040;--bl:#40405a;--text:#c8c8d0;--dim:#4a4a58;--accent:#e8364f;--ag:rgba(232,54,79,.25);--a2:#22d3ee;--a2g:rgba(34,211,238,.25);--green:#10b981;--purple:#a855f7;--orange:#f59e0b;--kick:#e8364f;--snare:#f59e0b;--hihat:#22d3ee;--clap:#a855f7;--tom:#f97316;--perc:#06b6d4;--bass:#10b981;--synth:#ec4899;--ch1:#e8364f;--ch2:#22d3ee;--ch3:#a855f7;--ch4:#10b981}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'JetBrains Mono',monospace;height:100vh;overflow:hidden;user-select:none;-webkit-user-select:none;-webkit-touch-callout:none;display:flex;flex-direction:column}
.workspace{flex:1;position:relative;overflow:auto;background:var(--bg)}
.ws-inner{position:relative;min-width:3000px;min-height:2000px;background-image:radial-gradient(circle,rgba(255,255,255,.1) 1px,transparent 1px);background-size:24px 24px}
.topbar{display:flex;flex-direction:column;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--surface);z-index:100}
.tb-row1{display:flex;align-items:center;height:36px;gap:3px;padding:0 6px;overflow:hidden}
.tb-row1::-webkit-scrollbar{display:none}
.tb-row2{display:flex;align-items:center;height:28px;gap:3px;padding:0 6px;border-top:1px solid var(--border);overflow:hidden}
.tb-row2::-webkit-scrollbar{display:none}
.topbar h1{font-family:'Syne',sans-serif;font-weight:800;font-size:15px;color:#fff;letter-spacing:-.5px;flex-shrink:1;min-width:0;white-space:nowrap}
.topbar h1 span{color:var(--accent)}
.sep{width:1px;height:16px;background:var(--border);margin:0 1px;flex-shrink:1;min-width:0}
.abtn{background:var(--s2);border:1px solid var(--border);color:var(--dim);font-family:inherit;font-size:7px;font-weight:700;padding:2px 4px;border-radius:3px;cursor:pointer;transition:all .15s;letter-spacing:.3px;display:flex;align-items:center;gap:2px;-webkit-touch-callout:none;touch-action:manipulation;white-space:nowrap;overflow:hidden;min-width:0;flex-shrink:1}
.abtn:hover{border-color:var(--dim);color:var(--text)}
.abtn .dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.xbtn{background:var(--s2);border:1px solid var(--green);color:var(--green);font-family:inherit;font-size:7px;font-weight:700;padding:2px 4px;border-radius:3px;cursor:pointer;transition:all .15s;white-space:nowrap;overflow:hidden;min-width:0;flex-shrink:1}
.xbtn:hover{background:var(--green);color:#fff}
.spacer{flex:1}
.ch-tabs{display:flex;gap:2px;flex-shrink:1;min-width:0}
.chtab{background:var(--s2);border:1px solid var(--border);color:var(--dim);font-family:inherit;font-size:7px;font-weight:700;padding:2px 5px;border-radius:3px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:2px;white-space:nowrap;flex-shrink:1;min-width:0}
.chtab .cdot{width:5px;height:5px;border-radius:50%}
.chtab.active{color:#fff;background:var(--s3);border-color:var(--bl)}
.win{position:absolute;background:var(--surface);border:1px solid var(--border);border-radius:6px;display:flex;flex-direction:column;box-shadow:0 4px 20px rgba(0,0,0,.5);min-width:200px;min-height:80px;z-index:10}
.win.focused{z-index:50;border-color:var(--bl);box-shadow:0 8px 36px rgba(0,0,0,.7)}
.win.hidden{display:none}
.wh{display:flex;align-items:center;padding:0 8px;height:26px;gap:5px;cursor:move;flex-shrink:0;border-bottom:1px solid var(--border);background:var(--s2);border-radius:6px 6px 0 0}
.wc{width:3px;height:12px;border-radius:2px;flex-shrink:0}
.wt{font-family:'Syne',sans-serif;font-weight:800;font-size:10px;color:#fff;letter-spacing:-.3px}.wt span{opacity:.5}
.wtag{font-size:6px;color:var(--dim);letter-spacing:1px;text-transform:uppercase}
.wsel{background:var(--s3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:7px;padding:1px 2px;border-radius:2px;outline:none;cursor:pointer}
.wctrls{margin-left:auto;display:flex;gap:2px}
.wb{background:none;border:1px solid var(--border);color:var(--dim);font-size:7px;font-weight:700;width:16px;height:14px;border-radius:2px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s;padding:0}
.wb:hover{border-color:var(--dim);color:var(--text)}
.wb.close:hover{border-color:#ef4444;color:#ef4444}
.wb.kb{font-size:9px;width:20px}
.wb.kb.active{border-color:var(--accent);color:var(--accent);background:rgba(232,54,79,.1)}
.wbadge{position:absolute;top:-1px;right:28px;font-size:5px;font-weight:700;padding:1px 4px;border-radius:0 0 3px 3px;color:#fff;letter-spacing:.5px}
.wbody{flex:1;overflow:auto;padding:6px 8px}
.win.collapsed .wbody{display:none}
.win.collapsed{min-height:auto!important;height:auto!important}
.win.collapsed .wh{border-radius:6px;border-bottom:none}
.wresize{position:absolute;bottom:0;right:0;width:12px;height:12px;cursor:nwse-resize}
.wresize::after{content:'';position:absolute;bottom:3px;right:3px;width:5px;height:5px;border-right:2px solid var(--bl);border-bottom:2px solid var(--bl)}
.bg{display:flex;flex-direction:column;gap:1px}
.br{display:flex;align-items:center;gap:1px;height:24px}
.bl{width:130px;min-width:130px;display:flex;align-items:center;gap:2px;padding-right:2px;flex-shrink:0}
.bn{font-size:6px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;width:28px;text-align:right}
.bm,.bs_btn{width:11px;height:11px;border-radius:2px;border:1px solid var(--border);background:var(--s2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:5px;color:var(--dim);transition:all .1s;flex-shrink:0}
.bm.muted{background:#ef4444;border-color:#ef4444;color:#fff}
.bs_btn.soloed{background:#f59e0b;border-color:#f59e0b;color:#fff}
.bv{-webkit-appearance:none;width:22px;height:2px;background:var(--border);border-radius:1px;outline:none;flex-shrink:0}
.dk{-webkit-appearance:none;appearance:none;width:20px;height:2px;border-radius:1px;outline:none;cursor:pointer;flex-shrink:0;margin:0;padding:0}
.dk::-webkit-slider-thumb{-webkit-appearance:none;width:4px;height:8px;border-radius:1px;background:var(--dim);cursor:pointer}
.dk::-moz-range-thumb{width:4px;height:8px;border-radius:1px;background:var(--dim);cursor:pointer;border:none}
input[type="range"][style*="appearance"]::-webkit-slider-thumb{-webkit-appearance:none;width:8px;height:8px;border-radius:50%;background:var(--dim);cursor:pointer;border:1px solid var(--s2)}
input[type="range"][style*="appearance"]::-moz-range-thumb{width:8px;height:8px;border-radius:50%;background:var(--dim);cursor:pointer;border:1px solid var(--s2);padding:0}
.bv::-webkit-slider-thumb{-webkit-appearance:none;width:5px;height:5px;border-radius:50%;background:var(--dim);cursor:pointer}
.bsel{background:var(--s2);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:6px;padding:1px 2px;border-radius:2px;outline:none;width:46px;flex-shrink:0;cursor:pointer}
.bsteps{display:flex;gap:1px;flex:1;min-width:0}
.bstep{flex:1 1 0;height:24px;background:var(--s2);border:1px solid var(--border);border-radius:2px;cursor:pointer;transition:background .05s;-webkit-touch-callout:none;touch-action:manipulation}
.bstep:hover{background:var(--s3)}
.bstep.on{opacity:.85}.bstep.on:hover{opacity:1}
.bstep.current{box-shadow:inset 0 -2px 0 var(--accent)}
.bstep.bm4{border-top:2px solid var(--bl)}
.bnums{display:flex;gap:1px;height:10px;padding-left:130px}
.bnum{flex:1 1 0;text-align:center;font-size:5px;color:var(--dim)}
.bnum.bb{color:var(--text);font-weight:700}
.bcfg{display:flex;gap:3px;align-items:center;padding:0 0 4px;flex-wrap:wrap}
.stog{display:flex;border:1px solid var(--border);border-radius:3px;overflow:hidden}
.stog button{background:var(--s2);border:none;color:var(--dim);font-family:inherit;font-size:6px;font-weight:700;padding:2px 6px;cursor:pointer;transition:all .15s}
.stog button.active{background:var(--accent);color:#fff}
.stog button+button{border-left:1px solid var(--border)}
.pbtn{background:var(--s2);border:1px solid var(--border);color:var(--dim);font-family:inherit;font-size:6px;font-weight:500;padding:2px 6px;border-radius:3px;cursor:pointer;transition:all .15s}
.pbtn:hover{border-color:var(--accent);color:var(--text)}
.st{display:flex;gap:6px;flex-wrap:wrap}
.ss{background:var(--s2);border:1px solid var(--border);border-radius:4px;padding:5px 7px;display:flex;flex-direction:column;gap:3px;min-width:90px;flex:1}
.sst{font-size:6px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--a2)}
.skr{display:flex;gap:5px;flex-wrap:wrap}
.sk{display:flex;flex-direction:column;align-items:center;gap:1px}
.sk label{font-size:5px;color:var(--dim);letter-spacing:.5px;text-transform:uppercase}
.sk input[type="range"]{-webkit-appearance:none;width:36px;height:2px;background:var(--border);border-radius:2px;outline:none}
.sk input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:7px;height:7px;border-radius:50%;background:var(--a2);cursor:pointer}
.sk .kv{font-size:5px;color:var(--a2);font-weight:700}
.sws{display:flex;gap:2px}
.swb{background:var(--s3);border:1px solid var(--border);color:var(--dim);font-family:inherit;font-size:6px;font-weight:700;padding:2px 5px;border-radius:2px;cursor:pointer;transition:all .12s}
.swb.active{background:var(--a2);border-color:var(--a2);color:#fff}
.skb{display:flex;position:relative;height:60px;margin-top:4px;border-radius:3px;overflow:hidden;border:1px solid var(--border)}
.swk{flex:1;background:#e8e8ec;border-right:1px solid #c0c0c8;cursor:pointer;transition:background .06s;position:relative;z-index:1;border-radius:0 0 2px 2px}
.swk:last-child{border-right:none}.swk:hover{background:#d0d0d8}.swk.active{background:var(--a2)}
.swk .kl{position:absolute;bottom:2px;left:50%;transform:translateX(-50%);font-size:5px;color:#888;font-weight:700}
.sbk{position:absolute;top:0;width:7%;height:55%;background:#1a1a22;border:1px solid #000;border-top:none;z-index:2;cursor:pointer;transition:background .06s;border-radius:0 0 2px 2px}
.sbk:hover{background:#333}.sbk.active{background:var(--a2)}
.fxg{display:grid;grid-template-columns:repeat(3,1fr);gap:4px}
.fxu{background:var(--s2);border:1px solid var(--border);border-radius:4px;padding:6px 8px;display:flex;flex-direction:column;gap:4px;overflow:hidden;transition:border-color .15s}
.fxu.active{border-color:var(--purple)}
.fxh{display:flex;align-items:center;justify-content:space-between;gap:4px;min-height:14px}
.fxn{font-size:6px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--dim);white-space:nowrap}
.fxu.active .fxn{color:var(--purple)}
.fxsw{width:22px;height:11px;background:var(--border);border-radius:6px;position:relative;cursor:pointer;transition:background .2s;border:none;flex-shrink:0}
.fxsw::after{content:'';position:absolute;top:2px;left:2px;width:7px;height:7px;border-radius:50%;background:var(--dim);transition:all .2s}
.fxsw.on{background:var(--purple)}.fxsw.on::after{left:13px;background:#fff}
.fxks{display:flex;gap:6px;align-items:flex-end}
.fxk{display:flex;flex-direction:column;align-items:center;gap:1px;flex:1;min-width:0}
.fxk label{font-size:5px;color:var(--dim);letter-spacing:.5px;text-transform:uppercase;white-space:nowrap}
.fxk input[type="range"]{-webkit-appearance:none;width:100%;height:2px;background:var(--border);border-radius:2px;outline:none}
.fxk input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:8px;height:8px;border-radius:50%;background:var(--dim);cursor:pointer}
.fxu.active .fxk input[type="range"]::-webkit-slider-thumb{background:var(--purple)}

/* === MIDI === */
.midi-ports{display:flex;gap:3px;flex-wrap:wrap;margin-bottom:4px}
.midi-port{background:var(--s2);border:1px solid var(--border);border-radius:3px;padding:4px 6px;font-size:6px;cursor:pointer;transition:all .12s;display:flex;align-items:center;gap:3px}
.midi-port:hover{border-color:#10b981}
.midi-port.connected{border-color:#10b981;background:rgba(16,185,129,.1)}
.midi-port .mp-dot{width:5px;height:5px;border-radius:50%;background:var(--dim)}
.midi-port.connected .mp-dot{background:#10b981;box-shadow:0 0 4px #10b98180}
.midi-act{display:flex;gap:8px;margin-top:4px}
.midi-note-disp{background:var(--s2);border:1px solid var(--border);border-radius:4px;padding:6px;min-height:40px;font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:800;color:#10b981;text-align:center;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:2px;transition:all .1s}
.midi-note-disp .midi-vel{font-size:7px;color:var(--dim);font-weight:600}
.midi-log{background:var(--s2);border:1px solid var(--border);border-radius:3px;padding:4px;max-height:60px;overflow-y:auto;font-size:5px;color:var(--dim);line-height:1.5}

/* === ARRANGE === */
.arr-timeline{position:relative;background:color-mix(in srgb, var(--bg) 85%, var(--surface));border:1px solid var(--border);border-radius:5px;overflow:auto;cursor:default;flex:1;min-height:0}
.arr-inner{position:relative;min-height:100%}
.arr-ruler{height:24px;background:var(--surface);border-bottom:1px solid color-mix(in srgb, var(--ac, #14b8a6) 15%, transparent);position:sticky;top:0;z-index:5;cursor:pointer}
.arr-ruler-mark{font-size:7px;color:var(--dim);position:absolute;top:4px;letter-spacing:.3px;font-weight:600}
.arr-ruler-mark.bar{color:color-mix(in srgb, var(--ac, #14b8a6) 70%, var(--text));font-weight:800;font-size:8px}
.arr-ruler-line{position:absolute;top:16px;bottom:0;width:1px;pointer-events:none;z-index:1}
.arr-track{border-bottom:1px solid var(--border);position:relative;display:flex;transition:background .15s}
.arr-track:hover{background:color-mix(in srgb, var(--text) 3%, transparent)}
.arr-track-hd{width:140px;min-width:140px;background:var(--surface);border-right:1px solid var(--border);display:flex;align-items:center;gap:3px;padding:4px 5px;position:sticky;left:0;z-index:4;cursor:default;backdrop-filter:blur(4px);flex-wrap:wrap}
.arr-track-nm{font-size:8px;font-weight:700;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
.arr-track-del{font-size:8px;color:var(--dim);cursor:pointer;opacity:0;transition:opacity .15s;padding:0 2px}
.arr-track:hover .arr-track-del{opacity:1}
.arr-track-del:hover{color:#ef4444}
.arr-track-body{position:relative;flex:1;min-width:0}
.arr-clip{position:absolute;top:3px;height:calc(100% - 6px);border-radius:4px;cursor:grab;display:flex;align-items:center;overflow:hidden;border:1px solid transparent;transition:border-color .1s,box-shadow .15s,opacity .1s}
.arr-clip.dragging{z-index:20;opacity:.85;box-shadow:0 4px 16px color-mix(in srgb, var(--bg) 60%, transparent);pointer-events:none}
.arr-clip:hover{border-color:color-mix(in srgb, var(--text) 25%, transparent);box-shadow:0 2px 12px color-mix(in srgb, var(--bg) 60%, transparent)}
.arr-clip:active{cursor:grabbing;opacity:.85}
.arr-clip.selected{border-color:var(--ac, #14b8a6);box-shadow:0 0 12px color-mix(in srgb, var(--ac, #14b8a6) 30%, transparent)}
.arr-clip canvas{width:100%;height:100%;pointer-events:none;opacity:.8}
.arr-clip-label{position:absolute;top:2px;left:6px;font-size:7px;font-weight:700;color:var(--text);text-shadow:0 1px 3px color-mix(in srgb, var(--bg) 50%, transparent);pointer-events:none;white-space:nowrap}
.arr-clip-dur{position:absolute;bottom:2px;right:6px;font-size:6px;color:var(--dim);pointer-events:none}
.arr-clip-handle{position:absolute;top:0;width:8px;height:100%;cursor:ew-resize;z-index:2;opacity:0;transition:opacity .15s}
.arr-clip:hover .arr-clip-handle{opacity:1}
.arr-clip-handle::after{content:'';position:absolute;top:50%;transform:translateY(-50%);width:3px;height:18px;border-radius:2px;background:color-mix(in srgb, var(--text) 50%, transparent)}
.arr-clip-handle.left{left:0}.arr-clip-handle.left::after{left:2px}
.arr-clip-handle.right{right:0}.arr-clip-handle.right::after{right:2px}
.arr-playhead{position:absolute;top:0;bottom:0;width:12px;margin-left:-5px;background:transparent;z-index:8;cursor:col-resize;left:100px;pointer-events:auto}
.arr-playhead .arr-ph-line{position:absolute;top:0;left:5px;width:2px;height:100%;background:var(--ac, #14b8a6);box-shadow:0 0 8px color-mix(in srgb, var(--ac, #14b8a6) 50%, transparent)}
.arr-playhead .arr-ph-head{position:absolute;top:0;left:-1px;width:0;height:0;border-left:7px solid transparent;border-right:7px solid transparent;border-top:9px solid var(--ac, #14b8a6);filter:drop-shadow(0 0 3px color-mix(in srgb, var(--ac, #14b8a6) 60%, transparent))}
.arr-playhead .arr-ph-glow{position:absolute;top:0;bottom:0;left:3px;width:6px;background:linear-gradient(90deg,rgba(20,184,166,.12),transparent);pointer-events:none}
.arr-playhead:hover .arr-ph-line{width:3px;left:4px;box-shadow:0 0 12px rgba(20,184,166,.7)}
.arr-playhead:hover .arr-ph-head{border-top-color:var(--ac-bright, #5eead4)}
.arr-playhead.dragging .arr-ph-line{background:var(--ac-bright, #5eead4);width:3px;left:4px}
.arr-ctrl{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-bottom:6px;padding:4px 0}
.arr-transport{display:flex;gap:2px;align-items:center;background:var(--s2);border:1px solid var(--border);border-radius:5px;padding:3px 4px}
.arr-tbtn{background:none;border:none;color:var(--dim);font-family:inherit;font-size:11px;font-weight:700;width:28px;height:24px;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s;padding:0}
.arr-tbtn:hover{background:var(--border);color:var(--text)}
.arr-tbtn.play{color:var(--ac, #14b8a6)}.arr-tbtn.play:hover{background:color-mix(in srgb, var(--ac, #14b8a6) 10%, transparent)}
.arr-tbtn.play.active{color:#fff;background:var(--ac, #14b8a6)}
.arr-tbtn.pause{color:#f59e0b}.arr-tbtn.pause:hover{background:rgba(245,158,11,.1)}
.arr-tbtn.stop:hover{color:var(--text);background:var(--border)}
.arr-time{font-size:10px;font-weight:700;color:var(--ac, #14b8a6);min-width:68px;text-align:center;font-variant-numeric:tabular-nums;letter-spacing:-.3px;padding:0 6px;background:var(--s3);border:1px solid var(--border);border-radius:4px;height:24px;display:flex;align-items:center;justify-content:center}
.arr-sep{width:1px;height:18px;background:var(--border);margin:0 2px;flex-shrink:0}
.arr-zoom{display:flex;align-items:center;gap:3px}
.arr-zoom span{font-size:6px;color:var(--dim);font-weight:700}
.arr-param{display:flex;align-items:center;gap:3px;background:var(--s2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;height:24px}
.arr-param label{font-size:6px;color:var(--dim);font-weight:700;letter-spacing:.4px}
.arr-param input,.arr-param select{background:var(--s3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:8px;font-weight:700;padding:2px 4px;border-radius:3px;outline:none}
.arr-empty{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;pointer-events:none;z-index:3}
.arr-empty-icon{font-size:28px;opacity:.15}
.arr-empty-text{font-size:9px;color:var(--dim);font-weight:600;letter-spacing:.5px}
.arr-empty-sub{font-size:7px;color:var(--dim);font-weight:500}
.arr-fx-row{display:flex;gap:3px;margin-top:6px;flex-wrap:wrap;align-items:center;padding:4px 0}
.arr-fxbtn{background:var(--s2);border:1px solid var(--border);color:var(--dim);font-family:inherit;font-size:7px;font-weight:600;padding:4px 10px;border-radius:4px;cursor:pointer;transition:all .12s;letter-spacing:.2px}
.arr-fxbtn:hover{border-color:color-mix(in srgb, var(--ac, #14b8a6) 40%, transparent);color:var(--ac, #14b8a6);background:color-mix(in srgb, var(--ac, #14b8a6) 5%, transparent)}
.arr-fxbtn.danger{border-color:rgba(239,68,68,.15);color:rgba(239,68,68,.5)}
.arr-fxbtn.danger:hover{border-color:rgba(239,68,68,.5);color:#ef4444;background:rgba(239,68,68,.05)}
/* Toolstrip */
.arr-tools{display:flex;gap:2px;flex-wrap:wrap;align-items:stretch;padding:5px 0;border-top:1px solid var(--border)}
.arr-tool-grp{display:flex;flex-direction:column;gap:3px;background:var(--s2);border:1px solid var(--border);border-radius:5px;padding:5px 8px;min-width:0}
.arr-tool-grp-label{font-size:5px;font-weight:800;color:var(--dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:1px}
.arr-tool-row{display:flex;gap:4px;align-items:center}
.arr-tool-row label{font-size:6px;color:var(--dim);font-weight:600;min-width:28px}
.arr-tool-row input[type="range"]{-webkit-appearance:none;appearance:none;width:70px;height:4px;background:var(--s3);border-radius:2px;outline:none;cursor:pointer}
.arr-tool-row input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:10px;height:10px;border-radius:50%;background:var(--ac, #14b8a6);cursor:pointer;border:2px solid var(--s2)}
.arr-tool-row input[type="range"]::-moz-range-thumb{width:10px;height:10px;border-radius:50%;background:var(--ac, #14b8a6);cursor:pointer;border:2px solid var(--s2)}
.arr-tool-val{font-size:7px;font-weight:700;color:var(--ac, #14b8a6);min-width:24px;text-align:right;font-variant-numeric:tabular-nums}
.arr-tool-btn{background:var(--s3);border:1px solid var(--border);color:var(--dim);font-family:inherit;font-size:7px;font-weight:700;padding:4px 8px;border-radius:3px;cursor:pointer;transition:all .1s;white-space:nowrap}
.arr-tool-btn:hover{border-color:color-mix(in srgb, var(--ac, #14b8a6) 40%, transparent);color:var(--ac, #14b8a6);background:color-mix(in srgb, var(--ac, #14b8a6) 6%, transparent)}
.arr-tool-btn.active{border-color:var(--ac, #14b8a6);color:var(--ac, #14b8a6);background:color-mix(in srgb, var(--ac, #14b8a6) 10%, transparent)}
/* Track routing */
.arr-track-vol{-webkit-appearance:none;appearance:none;width:36px;height:3px;background:var(--s3);border-radius:2px;outline:none;cursor:pointer}
.arr-track-vol::-webkit-slider-thumb{-webkit-appearance:none;width:8px;height:8px;border-radius:50%;background:var(--text);cursor:pointer}
/* === PIANO === */
.piano-kb{display:flex;position:relative;height:90px;border:1px solid var(--border);border-radius:3px;overflow-x:auto;overflow-y:hidden;min-width:0}
.pk-w{min-width:22px;flex:1;background:#e8e8ec;border-right:1px solid #c0c0c8;cursor:pointer;transition:background .05s;position:relative;z-index:1;-webkit-touch-callout:none;-webkit-user-select:none;touch-action:manipulation}
.pk-w:last-child{border-right:none}.pk-w:hover{background:#d0d0d8}.pk-w.active{background:#f472b6}
.pk-w .pkl{position:absolute;bottom:2px;left:50%;transform:translateX(-50%);font-size:5px;color:#999;font-weight:700}
.pk-b{position:absolute;top:0;width:14px;height:55%;background:#1a1a22;border:1px solid #000;border-top:none;z-index:2;cursor:pointer;border-radius:0 0 2px 2px;-webkit-touch-callout:none;-webkit-user-select:none;touch-action:manipulation}
.pk-b:hover{background:#333}.pk-b.active{background:#f472b6}
.piano-ctrl{display:flex;gap:6px;align-items:center;margin-bottom:4px;flex-wrap:wrap}
.piano-ctrl .sst{color:#f472b6}
/* === NOTE / PIANO ROLL === */
.nr-wrap{position:relative;overflow:auto;border:1px solid var(--border);border-radius:3px;background:var(--s2)}
.nr-grid{display:grid;gap:0}
.nr-label{font-size:5px;color:var(--dim);padding:0 3px;display:flex;align-items:center;border-right:1px solid var(--border);background:var(--s2);position:sticky;left:0;z-index:2;min-width:28px}
.nr-cell{height:14px;border:1px solid rgba(255,255,255,.03);cursor:pointer;transition:background .05s}
.nr-cell:hover{background:rgba(255,255,255,.06)}
.nr-cell.on{border-radius:1px}
.nr-cell.current{box-shadow:inset 0 0 0 1px rgba(232,54,79,.4)}
.nr-cell.bar{border-left:1px solid rgba(255,255,255,.08)}
/* === BASS === */
.bass-ctrl{display:flex;gap:6px;flex-wrap:wrap}
.bass-sec{background:var(--s2);border:1px solid var(--border);border-radius:4px;padding:5px 7px;flex:1;min-width:90px}
.bass-sec .sst{color:#818cf8}
/* === SAMPLE === */
.smp-drop{border:2px dashed var(--border);border-radius:4px;padding:12px;text-align:center;font-size:7px;color:var(--dim);cursor:pointer;transition:border-color .2s;min-height:40px;display:flex;align-items:center;justify-content:center}
.smp-drop:hover,.smp-drop.over{border-color:var(--a2);color:var(--text)}
.smp-slots{display:flex;gap:3px;flex-wrap:wrap;margin-top:6px}
.smp-slot{background:var(--s2);border:1px solid var(--border);border-radius:3px;padding:4px 6px;font-size:6px;cursor:pointer;transition:all .12s;display:flex;align-items:center;gap:3px;min-width:60px}
.smp-slot:hover{border-color:var(--a2)}.smp-slot.playing{border-color:var(--accent);background:rgba(232,54,79,.1)}
.smp-slot .smp-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text)}
.smp-slot .smp-x{color:var(--dim);font-weight:700;cursor:pointer}.smp-slot .smp-x:hover{color:#ef4444}
/* === TAPE === */
.tape-viz{height:80px;background:#0a0e14;border:1px solid var(--border);border-radius:4px;position:relative;overflow:hidden}
.tape-viz canvas{width:100%;height:100%}
.tape-reels{display:flex;justify-content:space-between;align-items:center;padding:4px 12px;pointer-events:none;position:absolute;top:0;left:0;right:0;bottom:0}
.tape-reel{width:28px;height:28px;border-radius:50%;border:2px solid rgba(251,146,60,.3);display:flex;align-items:center;justify-content:center;position:relative}
.tape-reel-inner{width:10px;height:10px;border-radius:50%;border:1.5px solid rgba(251,146,60,.2)}
.tape-reel.spin{animation:reelSpin 1s linear infinite}
@keyframes reelSpin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
.tape-label{position:absolute;bottom:3px;left:50%;transform:translateX(-50%);font-size:5px;color:rgba(251,146,60,.4);font-weight:700;letter-spacing:1px;white-space:nowrap}
.tape-transport{display:flex;gap:4px;margin-top:4px;align-items:center}
.tape-btn{background:rgba(251,146,60,.06);border:1.5px solid rgba(251,146,60,.2);color:rgba(251,146,60,.6);font-family:inherit;font-size:7px;font-weight:800;padding:5px 10px;border-radius:4px;cursor:pointer;transition:all .15s;letter-spacing:.5px}
.tape-btn:hover{border-color:#fb923c;color:#fb923c;background:rgba(251,146,60,.12)}
.tape-btn.rec{border-color:rgba(239,68,68,.4);color:rgba(239,68,68,.7)}.tape-btn.rec:hover{background:rgba(239,68,68,.15);color:#ef4444;border-color:#ef4444}
.tape-btn.rec.active{background:#ef4444;color:#fff;border-color:#ef4444;animation:pulse .8s infinite}
.tape-btn.active{background:rgba(251,146,60,.2);color:#fb923c;border-color:#fb923c}
.tape-info{font-size:5px;color:rgba(251,146,60,.4);font-weight:700;display:flex;gap:8px;margin-top:3px;letter-spacing:.5px}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
.mxchs{display:flex;gap:5px}
.mxch{background:var(--s2);border:1px solid var(--border);border-radius:4px;padding:6px;min-width:140px;flex:1;display:flex;flex-direction:column;gap:4px}
.mxhd{display:flex;align-items:center;gap:4px}
.mxdot{width:7px;height:7px;border-radius:50%}
.mxnm{font-size:7px;font-weight:700;color:#fff}
.mxtr{display:flex;gap:2px}
.mxb{background:var(--s3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:10px;width:22px;height:20px;border-radius:3px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.mxb:hover{border-color:var(--accent)}
.mxb.playing{background:var(--accent);border-color:var(--accent);color:#fff}
.mxr{display:flex;align-items:center;gap:3px}
.mxr label{font-size:5px;color:var(--dim);letter-spacing:.8px;text-transform:uppercase;width:20px}
.mxr input[type="range"]{-webkit-appearance:none;flex:1;height:2px;background:var(--border);border-radius:2px;outline:none}
.mxr input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:7px;height:7px;border-radius:50%;cursor:pointer}
.mxv{font-size:6px;font-weight:700;min-width:16px;text-align:right}
.mxms{display:flex;gap:2px;margin-top:2px}
.mxmb{background:var(--s3);border:1px solid var(--border);color:var(--dim);font-family:inherit;font-size:6px;font-weight:700;padding:2px 5px;border-radius:2px;cursor:pointer;transition:all .12s}
.mxmb.muted{background:#ef4444;border-color:#ef4444;color:#fff}
.mxmb.soloed{background:#f59e0b;border-color:#f59e0b;color:#fff}
.vizr{display:flex;gap:4px;margin-top:4px}
.vizb{flex:1;min-width:70px;background:var(--s2);border:1px solid var(--border);border-radius:3px;height:44px;position:relative;overflow:hidden}
.vizb canvas{width:100%;height:100%}
.vizl{position:absolute;top:2px;left:4px;font-size:5px;color:var(--dim);letter-spacing:1px;text-transform:uppercase;pointer-events:none}
.bl{width:210px;min-width:210px;display:flex;align-items:center;gap:2px;padding-right:2px}
.bn{font-size:5px;font-weight:700;letter-spacing:.5px;width:28px;min-width:28px}
.bs_btn{font-family:inherit;font-size:5px;font-weight:700;color:var(--dim);background:var(--s3);border:1px solid var(--border);border-radius:2px;width:12px;height:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .1s}
.bs_btn.soloed{background:#f59e0b!important;color:#000!important;border-color:#f59e0b!important}
.bsel{background:var(--s3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:5px;padding:0 1px;border-radius:2px;width:38px;outline:none}
::-webkit-scrollbar{width:5px;height:7px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--bl);border-radius:3px}::-webkit-scrollbar-corner{background:var(--bg)}
/* iOS long-press prevention */
button,select,input,.key,.bkey,.pk-w,.pk-b,.swk,.sbk,.bstep,.wh,.wresize,.nr-cell{-webkit-touch-callout:none;-webkit-user-select:none;touch-action:manipulation}
/* Mobile */
@media(max-width:768px){
  .tb-row1{height:30px;gap:3px}
  .tb-row2{height:24px;gap:4px}
  .topbar{padding:0 4px}
  .abtn{font-size:5px;padding:2px 4px}
  .abtn .dot{width:4px;height:4px}
  .xbtn{font-size:5px;padding:2px 4px}
  .chtab{font-size:5px;padding:2px 5px}
  .chtab .cdot{width:4px;height:4px}
  .topbar h1{font-size:11px}
  .sep{margin:0;height:14px}
  .ws-inner{min-width:1500px;min-height:1200px}
  .win{min-width:160px}
  .wh{height:30px;padding:0 6px}
  .wt{font-size:9px}
  .swk,.pk-w{min-width:28px!important}
  .bstep{min-width:20px!important;min-height:20px!important}
  .bl{width:160px;min-width:160px}
  input[type="range"]{height:20px}
  .wresize{width:16px;height:16px}
  .fxg{grid-template-columns:repeat(2,1fr)}
  .sk input[type="range"],.fxk input[type="range"]{height:20px}
  .nr-cell{height:20px!important}
  .piano-kb,.skb{height:70px}
}
@media(max-width:480px){
  .topbar h1{font-size:10px}
  .abtn,.xbtn,.chtab{font-size:5px;padding:2px 3px}
  .win{min-width:140px}
  .swk,.pk-w{min-width:24px!important}
  .bl{width:120px;min-width:120px}
  .fxg{grid-template-columns:1fr}
  .piano-kb,.skb{height:60px}
}

/* ‚ïê‚ïê‚ïê TABLET / TOUCH (iPad) ‚ïê‚ïê‚ïê */
@media(pointer:coarse){
  /* Toolbar ‚Äî bigger touch targets */
  .tb-row1{height:42px;gap:4px;padding:0 6px;-webkit-overflow-scrolling:touch;overflow-x:auto;overflow-y:hidden}
  .tb-row2{height:36px;gap:4px;padding:0 6px;-webkit-overflow-scrolling:touch;overflow-x:auto;overflow-y:hidden}
  .abtn{font-size:8px;padding:5px 10px;min-height:32px;border-radius:4px;flex-shrink:0}
  .abtn .dot{width:6px;height:6px}
  .xbtn{font-size:8px;padding:5px 10px;min-height:32px;border-radius:4px;flex-shrink:0}
  .chtab{font-size:8px;padding:5px 8px;min-height:32px;flex-shrink:0}
  .chtab .cdot{width:6px;height:6px}
  .ch-tabs{gap:3px;flex-shrink:0}
  .topbar h1{font-size:13px;flex-shrink:0}
  .sep{height:20px;margin:0 3px}

  /* Windows ‚Äî larger headers, drag areas, close buttons */
  .win{border-radius:10px;max-width:calc(100vw - 44px)}
  .wh{height:36px;padding:0 10px;gap:6px;border-radius:10px 10px 0 0}
  .wt{font-size:11px}
  .wb{width:26px;height:26px;border-radius:5px;font-size:11px}
  .wbody{padding:8px 10px;-webkit-overflow-scrolling:touch}
  .wresize{width:24px;height:24px}
  .wresize::after{width:10px;height:10px;bottom:4px;right:4px}

  /* Beat steps ‚Äî bigger for finger tapping */
  .bstep{min-width:22px!important;min-height:28px!important;border-radius:3px}
  .bl{width:140px;min-width:140px}
  .bl span{font-size:8px!important}
  .bl button{min-width:20px!important;min-height:22px!important}

  /* Piano keys ‚Äî taller and wider */
  .piano-kb,.skb{height:90px}
  .swk,.pk-w{min-width:32px!important}
  .pk-b{width:18px;height:58%}

  /* Form elements ‚Äî compact sliders, touch polyfill handles drag */
  input[type="range"]{touch-action:none}
  input[type="range"]::-webkit-slider-thumb{width:14px;height:14px;border-radius:50%;margin-top:-6px}
  select{font-size:10px!important;min-height:28px;padding:3px 6px!important;border-radius:4px}
  input[type="text"],input[type="number"],textarea{font-size:11px!important;min-height:28px;padding:3px 6px!important}
  input[type="color"]{width:32px;height:28px;border-radius:4px;padding:2px}

  /* Button/chip base */
  .pbtn{min-height:28px;padding:4px 10px;font-size:8px;border-radius:4px}
  button{-webkit-tap-highlight-color:transparent}

  /* FX grid ‚Äî 2 columns on touch */
  .fxg{gap:4px;grid-template-columns:repeat(2,1fr)!important}
  .fxk{padding:4px}
  .fxk label{font-size:6px!important}

  /* Knobs */
  .sk{padding:4px}
  .sk label{font-size:6px!important}

  /* Sequencer cells */
  .nr-cell{min-height:22px!important;min-width:22px!important}

  /* Theme grid ‚Äî bigger theme buttons */
  #themeGrid{grid-template-columns:repeat(3,1fr)!important;gap:4px!important}
  #themeGrid button{height:36px!important;border-radius:6px!important}
  #themeGrid button span{font-size:7px!important}

  /* Tracks / arranger */
  .arr-clip{min-height:48px}
  .arr-clip-handle{width:16px!important;opacity:1!important}
  .arr-clip-handle::after{width:5px;height:24px;border-radius:3px}
  .arr-clip-label{font-size:9px}
  .arr-tbtn{min-width:36px;min-height:36px;font-size:14px;border-radius:6px}
  .arr-ctrl{gap:6px;padding:6px 8px}
  .arr-track-hd{min-width:100px}

  /* Safe area */
  body{padding-bottom:env(safe-area-inset-bottom)}
  .topbar{padding-top:env(safe-area-inset-top)}

  /* Toast bigger */
  .toast{font-size:11px;padding:8px 16px;border-radius:6px}

  /* Mixer ‚Äî 2-column wrap */
  .mxchs{flex-wrap:wrap;gap:4px}
  .mxch{min-width:calc(50% - 4px);flex:1 1 calc(50% - 4px);padding:6px}
  .mxhd .mxnm{font-size:9px!important}
  .mxr{gap:4px}
  .mxr label{font-size:6px!important;width:24px}
  .mxv{font-size:8px!important;min-width:20px}
  .mxb{width:24px;height:24px;font-size:10px}
  .mxmb{min-width:24px;min-height:24px;font-size:9px}

  /* Workspace */
  .workspace{-webkit-overflow-scrolling:touch;overscroll-behavior:contain}

  /* Scrollbar thin on touch */
  .wbody::-webkit-scrollbar{width:3px}
}
</style>
<script src="https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js"></script>
</head>
<body>
<div class="topbar">
<div class="tb-row1">
<h1>STUDIO<span>.EXE</span></h1><div class="sep"></div>
<div class="ch-tabs" id="chTabs">
<button class="chtab active" data-ch="all">ALL</button>
<button class="chtab" data-ch="0"><span class="cdot" style="background:var(--ch1)"></span>CH1</button>
<button class="chtab" data-ch="1"><span class="cdot" style="background:var(--ch2)"></span>CH2</button>
<button class="chtab" data-ch="2"><span class="cdot" style="background:var(--ch3)"></span>CH3</button>
<button class="chtab" data-ch="3"><span class="cdot" style="background:var(--ch4)"></span>CH4</button>
</div><div class="sep"></div>
<button class="abtn" id="addBeat"><span class="dot" style="background:var(--accent)"></span>+BEAT</button>
<button class="abtn" id="addSynth"><span class="dot" style="background:var(--a2)"></span>+SYNTH</button>
<button class="abtn" id="addPiano"><span class="dot" style="background:#f472b6"></span>+PIANO</button>
<button class="abtn" id="addBass"><span class="dot" style="background:#818cf8"></span>+BASS</button>
<button class="abtn" id="addNote"><span class="dot" style="background:#fbbf24"></span>+NOTE</button>
<button class="abtn" id="addSample"><span class="dot" style="background:#34d399"></span>+SAMPLE</button>
<button class="abtn" id="addTape"><span class="dot" style="background:#fb923c"></span>+TAPE</button>
<button class="abtn" id="addDrum"><span class="dot" style="background:#f97316"></span>+DRUM</button>
<button class="abtn" id="addChord"><span class="dot" style="background:#14b8a6"></span>+CHORD</button>
<button class="abtn" id="addInst"><span class="dot" style="background:#d946ef"></span>+INST</button>
<button class="abtn" id="addEdit"><span class="dot" style="background:#06b6d4"></span>+EDIT</button>
<button class="abtn" id="addFx"><span class="dot" style="background:var(--purple)"></span>+FX</button>
<button class="abtn" id="addOsc"><span class="dot" style="background:#60a5fa"></span>+OSC</button>
<button class="abtn" id="addAuto"><span class="dot" style="background:#f59e0b"></span>+AUTO</button>
<button class="abtn" id="addSidechain"><span class="dot" style="background:#f43f5e"></span>+SIDE</button>
<button class="abtn" id="addMixer"><span class="dot" style="background:var(--green)"></span>+MIXER</button>
</div>
<div class="tb-row2">
<div id="recInd" style="display:none;align-items:center;gap:4px;font-size:7px;font-weight:700;color:#ef4444;letter-spacing:.5px"><span style="width:6px;height:6px;border-radius:50%;background:#ef4444;animation:pulse .8s infinite"></span>REC <span id="recTime" style="color:var(--dim)">0:00</span></div>
<button class="xbtn" id="recBtn" style="border-color:#ef4444;color:#ef4444">‚óè REC</button>
<button class="xbtn" id="dlBtn" style="display:none">‚Üì WAV</button>
<button class="abtn" id="addTracks"><span class="dot" style="background:#14b8a6"></span>+TRACKS</button>
<button class="abtn" id="addLearn" style="border-color:#14b8a640;color:#14b8a6"><span class="dot" style="background:#14b8a6"></span>LEARN</button>
<div class="spacer"></div>
<button class="abtn" id="addCollab"><span class="dot" style="background:#8b5cf6"></span>+COLLAB</button>
<button class="abtn" id="addMidi"><span class="dot" style="background:#10b981"></span>+MIDI</button>
<button class="abtn" id="addBank"><span class="dot" style="background:#60a5fa"></span>+FILES</button>
<button class="abtn" id="addSave"><span class="dot" style="background:#10b981"></span>+SAVE</button>
<button class="xbtn" id="helpBtn" style="border-color:var(--dim);color:var(--dim)">?</button>
<button class="xbtn" id="settingsBtn" style="border-color:var(--dim);color:var(--dim)">‚öô</button>
</div>
</div>
<div id="settingsPanel" style="display:none;position:fixed;top:36px;right:8px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0;z-index:99999;width:280px;max-height:calc(100vh - 50px);box-shadow:0 8px 30px rgba(0,0,0,.6);overflow:hidden;display:none;flex-direction:column">
<div style="padding:10px 12px 6px;border-bottom:1px solid var(--border);flex-shrink:0">
<div style="font-family:'Syne',sans-serif;font-size:10px;font-weight:800;color:var(--text);letter-spacing:1px;display:flex;align-items:center;justify-content:space-between">SETTINGS<span id="settingsClose" style="cursor:pointer;opacity:.4;font-size:14px;line-height:1">√ó</span></div>
</div>
<div style="overflow-y:auto;flex:1;padding:8px 12px 12px;min-height:0">
<div style="font-size:6px;color:var(--dim);letter-spacing:.5px;text-transform:uppercase;margin-bottom:4px;font-weight:700">Theme</div>
<div id="themeGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:3px;margin-bottom:10px"></div>
<div style="font-size:6px;color:var(--dim);letter-spacing:.5px;text-transform:uppercase;margin-bottom:4px;font-weight:700">Grid Dots</div>
<div id="dotGrid" style="display:flex;gap:4px;margin-bottom:10px"></div>
<div style="font-size:6px;color:var(--dim);letter-spacing:.5px;text-transform:uppercase;margin-bottom:4px;font-weight:700">Workspace Color</div>
<div style="display:flex;gap:4px;align-items:center;margin-bottom:10px">
<input type="color" id="wsBgColor" value="#0a0a0f" style="width:28px;height:20px;border:1px solid var(--border);border-radius:3px;background:var(--s2);cursor:pointer;padding:0">
<div id="wsBgPresets" style="display:grid;grid-template-columns:repeat(8,1fr);gap:3px;flex:1"></div>
</div>
<div style="font-size:6px;color:var(--dim);letter-spacing:.5px;text-transform:uppercase;margin-bottom:4px;font-weight:700">Accent Color</div>
<div id="accentGrid" style="display:grid;grid-template-columns:repeat(5,1fr);gap:4px;margin-bottom:10px"></div>
<div style="border-top:1px solid var(--border);padding-top:8px">
<button id="resetStudio" style="width:100%;padding:6px;background:#e8364f18;border:1px solid #e8364f40;border-radius:4px;color:#e8364f;font-family:inherit;font-size:7px;font-weight:800;letter-spacing:1px;cursor:pointer;transition:all .15s">‚ü≥ RESET STUDIO</button>
</div>
</div>
</div>
<div id="helpPanel" style="display:none;position:fixed;top:36px;right:8px;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:12px;z-index:99999;width:360px;max-height:80vh;overflow-y:auto;box-shadow:0 8px 30px rgba(0,0,0,.6)">
<div style="font-family:'Syne',sans-serif;font-size:10px;font-weight:800;color:var(--text);margin-bottom:10px;letter-spacing:1px;display:flex;align-items:center;justify-content:space-between">STUDIO.EXE GUIDE<span id="helpClose" style="cursor:pointer;opacity:.5;font-size:14px">√ó</span></div>
<div id="helpContent" style="font-size:7px;color:var(--dim);line-height:1.6;letter-spacing:.2px">
<div style="color:var(--text);font-weight:800;font-size:8px;margin-bottom:6px">Getting Started</div>
<p style="margin:0 0 8px">Click any <b style="color:var(--text)">+MODULE</b> button in the toolbar to add instruments, effects, and tools to your workspace. Drag windows by their title bars to arrange them. Each module routes audio through one of 4 channels.</p>
<div style="border-top:1px solid var(--border);margin:8px 0"></div>
<div style="color:#e8364f;font-weight:800;font-size:7px;margin-bottom:4px">BEAT.EXE ‚Äî Step Sequencer</div>
<p style="margin:0 0 8px">8-track grid sequencer. Click cells to toggle hits. Use the <b style="color:var(--text)">Steps</b> dropdown to set grid length (16/32). Genre presets auto-fill patterns. Per-track mute/solo controls on the left.</p>
<div style="color:#a855f7;font-weight:800;font-size:7px;margin-bottom:4px">SYNTH.EXE ‚Äî Synthesizer</div>
<p style="margin:0 0 8px">4-waveform oscillator with dual-osc detune. Play via the keyboard (click or press A-K keys after clicking ‚å®). Shape sound with ADSR envelope and lowpass filter knobs.</p>
<div style="color:#22d3ee;font-weight:800;font-size:7px;margin-bottom:4px">PIANO.EXE / BASS.EXE</div>
<p style="margin:0 0 8px">Similar to Synth but tuned for piano and bass ranges. Same keyboard controls and knob layout.</p>
<div style="color:#10b981;font-weight:800;font-size:7px;margin-bottom:4px">NOTE.EXE ‚Äî Piano Roll</div>
<p style="margin:0 0 8px">Click the grid to place notes. Each column is one step, rows are pitches. Choose between 10 synth presets or 21 sampled instruments via the üéª dropdown. Notes play back in sequence with the transport.</p>
<div style="color:#f97316;font-weight:800;font-size:7px;margin-bottom:4px">DRUM.EXE ‚Äî Drum Machine</div>
<p style="margin:0 0 8px">10-part drum grid (kick, snare, hats, etc). Click = normal hit, right-click cycles velocity (ghost/accent). 4 patterns (A/B/C/D) with chain mode. Euclid generator creates algorithmic rhythms. 12 genre presets.</p>
<div style="color:#fb923c;font-weight:800;font-size:7px;margin-bottom:4px">TAPE.EXE ‚Äî Looper</div>
<p style="margin:0 0 8px">Record from your microphone or drop an audio file onto the waveform. Play, loop, adjust speed. Spinning reels animate during playback.</p>
<div style="color:#818cf8;font-weight:800;font-size:7px;margin-bottom:4px">SAMPLE.EXE ‚Äî Sample Pads</div>
<p style="margin:0 0 8px">Drop audio files onto the 8 pads. Click pads to trigger one-shots. Use with the Edit module to process samples before loading.</p>
<div style="color:#d946ef;font-weight:800;font-size:7px;margin-bottom:4px">CHORD.EXE ‚Äî Chord Pads</div>
<p style="margin:0 0 8px">29 chord types across all 12 roots. Click pads to play chords. 22 genre progression presets auto-sequence chords. Waveform select and ADSR controls shape the chord sound.</p>
<div style="color:#d946ef;font-weight:800;font-size:7px;margin-bottom:4px">INST.EXE ‚Äî Instruments</div>
<p style="margin:0 0 8px">21 sampled instruments (strings, brass, woodwind, guitar, keys, vocal) via WebAudioFont. Play with the 2-octave keyboard. Optional layer adds a second instrument on top. Sustain pedal via spacebar.</p>
<div style="color:#60a5fa;font-weight:800;font-size:7px;margin-bottom:4px">OSC.EXE ‚Äî Oscilloscope</div>
<p style="margin:0 0 8px">Waveform scope with real-time frequency detection. Type any Hz and press Enter to hear it ‚Äî all keys play that exact frequency. Draw custom waveforms or blend harmonics. <b style="color:var(--text)">‚Üí SYNTH</b> sends settings to open Synth modules. Toggle FFT for spectrum view.</p>
<div style="color:#06b6d4;font-weight:800;font-size:7px;margin-bottom:4px">EDIT.EXE ‚Äî Audio Editor</div>
<p style="margin:0 0 8px">Drop audio to load. Drag the cyan handles to select a region. 3 tool panels: <b style="color:var(--text)">Edit</b> (trim, delete, reverse, silence, duplicate, fade), <b style="color:var(--text)">Gain/Pitch</b> (dB slider, normalize, pitch shift, octave), <b style="color:var(--text)">FX</b> (filter, distort, bitcrush, chorus, echo, reverb, compress, time stretch). 20-level undo. Export as WAV or send to Sampler.</p>
<div style="color:#f59e0b;font-weight:800;font-size:7px;margin-bottom:4px">FX.EXE ‚Äî Effects Chain</div>
<p style="margin:0 0 8px">19 effects that process an entire channel: reverb, delay, chorus, phaser, flanger, distortion, bitcrush, tremolo, ring mod, EQ, compressor, limiter, gate, pitch shift, and more. Toggle each on/off. Assign to any channel.</p>
<div style="color:#10b981;font-weight:800;font-size:7px;margin-bottom:4px">MIXER / SAVE</div>
<p style="margin:0 0 8px"><b style="color:var(--text)">Mixer</b> controls 4 channels with BPM, swing, play/stop. Channel sequencing modes: All, Chain, A/B, Custom patterns. <b style="color:var(--text)">Save</b> serializes your entire session to JSON ‚Äî download and reload later. <b style="color:var(--text)">‚Üì WAV</b> in the toolbar exports a real-time recording.</p>
<div style="border-top:1px solid var(--border);margin:8px 0"></div>
<div style="color:#10b981;font-weight:800;font-size:7px;margin-bottom:4px">MIDI.IN &mdash; MIDI Controller</div>
<p style="margin:0 0 4px"><span style="background:#f59e0b20;color:#f59e0b;font-weight:800;padding:1px 4px;border-radius:2px;font-size:6px">‚ö† BETA ‚Äî MIDI mapping is experimental and may not be fully stable</span></p>
<p style="margin:0 0 4px">Connect any USB MIDI controller. Notes auto-route to instruments on the same channel. Default: CC1 (mod wheel) ‚Üí filter, CC7 ‚Üí volume.</p>
<p style="margin:0 0 4px"><b style="color:var(--text)">CC Mapping:</b> Each module shows a mini visual replica of its controls. Tap any control to arm it (it pulses green), then move a knob/fader on your controller ‚Äî mapped instantly. Tap a mapped control to unmap it.</p>
<p style="margin:0 0 4px"><b style="color:var(--text)">Mappable controls per module:</b></p>
<div style="margin:0 0 4px;padding:4px 6px;background:var(--s2);border:1px solid var(--border);border-radius:3px;font-size:6px;line-height:1.6">
<b style="color:#e8364f">BEAT</b> ‚Äî Per-track: <span style="color:#f59e0b">Mute ‚ü°</span> <span style="color:#f59e0b">Solo ‚ü°</span> Volume ‚óã<br>
<b style="color:#22d3ee">SYNTH / PIANO / BASS / CHORD / OSC / INST</b> ‚Äî Detune ‚óã Octave ‚óã Attack ‚óã Decay ‚óã Sustain ‚óã Release ‚óã Filter Freq ‚óã Filter Res ‚óã Volume ‚óã<br>
<b style="color:#f97316">DRUM</b> ‚Äî Per-part: <span style="color:#f59e0b">Mute ‚ü°</span> <span style="color:#f59e0b">Solo ‚ü°</span> Volume ‚óã Pitch ‚óã Decay ‚óã &nbsp;|&nbsp; <span style="color:#a855f7">Pattern A/B/C/D ‚ñ∂</span><br>
<b style="color:#f59e0b">FX</b> ‚Äî <span style="color:#f59e0b">Toggle each effect on/off ‚ü°</span> (Reverb, Delay, Distort, Filter, Chorus, Phaser, Compress, Bitcrush, Vinyl, Wow/Flut, Lo-Fi, Saturate, Tremolo, Ring Mod, Flanger, Limiter, Gate, EQ, Pitch)<br>
<b style="color:#f43f5e">SIDECHAIN</b> ‚Äî Depth ‚óã Attack ‚óã Release ‚óã<br>
<b style="color:#10b981">CHANNEL</b> ‚Äî Volume ‚óã BPM ‚óã Swing ‚óã
</div>
<p style="margin:0 0 4px;font-size:6px;color:var(--dim)">‚óã = CC knob/fader (continuous) &nbsp; <span style="color:#f59e0b">‚ü° = Toggle</span> (CC &gt; 63 flips on/off) &nbsp; <span style="color:#a855f7">‚ñ∂ = Trigger</span> (CC &gt; 63 fires once)</p>
<p style="margin:0 0 8px"><b style="color:var(--text)">Presets:</b> Save/Load mapping presets as .json files, or Copy/Paste between sessions. Presets match by module type so they work across different projects.</p>
<div style="color:#14b8a6;font-weight:800;font-size:7px;margin-bottom:4px">TRACKS.EXE &mdash; Track Editor</div>
<p style="margin:0 0 8px">DAW-style freeform arrangement. Drop audio files to create tracks. Drag clips to reposition, resize with edge handles, right-click to delete. Built-in per-clip FX: reverse, fade, speed change, lo-fi, pitch shift. Snap to grid with the snap selector. Mute/solo individual tracks.</p>
<div style="color:#f59e0b;font-weight:800;font-size:7px;margin-bottom:4px">AUTO.EXE &mdash; Parameter Automation</div>
<p style="margin:0 0 8px">Draw automation curves for Volume, Filter, Pan, Pitch, Swing, and Send FX. Click &amp; drag on the canvas to draw values per step. Shape presets: flat, ramp up/down, sine LFO, random. Curves apply in real-time to the assigned channel.</p>
<div style="color:#f43f5e;font-weight:800;font-size:7px;margin-bottom:4px">SIDE.EXE &mdash; Sidechain Ducker</div>
<p style="margin:0 0 8px">Rhythmic volume ducking ‚Äî makes bass/synths pump in time with the beat. Set trigger pattern with the step grid (presets: 4/4, off-beat, pumping, fast, trap, half). Controls for depth, attack, and release shape the ducking curve. VU meter shows gain reduction.</p>
<div style="color:#8b5cf6;font-weight:800;font-size:7px;margin-bottom:4px">COLLAB.EXE &mdash; Module Sharing</div>
<p style="margin:0 0 8px">Export any module's settings as a JSON snippet ‚Äî copy and share with collaborators. Import snippets to recreate modules with full state including patterns, knob positions, effects, and even per-module themes.</p>
<div style="border-top:1px solid var(--border);margin:8px 0"></div>
<div style="color:var(--text);font-weight:800;font-size:7px;margin-bottom:4px">Tips</div>
<p style="margin:0 0 4px">‚Ä¢ <b style="color:var(--text)">‚å® button</b> on any keyboard module ‚Äî click to capture keyboard focus, then play with A-K keys</p>
<p style="margin:0 0 4px">‚Ä¢ <b style="color:var(--text)">Channel routing</b> ‚Äî use the CH dropdown on each module to route audio through different mixer channels</p>
<p style="margin:0 0 4px">‚Ä¢ <b style="color:var(--text)">Copy/Paste</b> ‚Äî ‚ßâ/‚äû buttons on modules share settings between sound sources</p>
<p style="margin:0 0 4px">‚Ä¢ <b style="color:var(--text)">‚öô Settings</b> ‚Äî themes, grid style, accent color, workspace background</p>
</div>
</div>
<div class="workspace" id="workspace"><div class="ws-inner" id="wsI"></div></div>
<script>
'use strict';
// === AUDIO ENGINE ===
let ctx=null,mGain=null,anW=null,anF=null;
// Track bus system ‚Äî 8 independent gain nodes ‚Üí master, bypasses 4 channel system
const ARR_BUSES=[];const ARR_BUS_COUNT=8;
const BUS_COLORS=['#e8364f','#22d3ee','#a855f7','#10b981','#f59e0b','#f97316','#ec4899','#818cf8'];
function ensureBuses(){if(!ctx||ARR_BUSES.length)return;
  for(let i=0;i<ARR_BUS_COUNT;i++){const g=ctx.createGain();g.gain.value=1;g.connect(mGain);ARR_BUSES.push(g)}}
const NCH=4;
const CHR=['#e8364f','#22d3ee','#a855f7','#10b981'];
const chs=Array.from({length:NCH},()=>({g:null,bpm:120,sw:0,vol:75,on:false,mut:false,solo:false,step:-1,nxt:0,tid:null,ts:0}));
// Channel sequencing: mode='all'|'chain'|'ab'|'custom', barsPerCh=number of bars per channel in chain mode
const seqState={mode:'all',barsPerCh:2,order:Array.from({length:NCH},(_,i)=>i),curIdx:0,barCount:0,stepInBar:0,active:Array.from({length:NCH},()=>true),customPattern:Array.from({length:NCH},(_,i)=>[i])};
const _seqUp=[];// callbacks when seq state changes
function initA(){if(ctx)return;ctx=new(window.AudioContext||window.webkitAudioContext)();mGain=ctx.createGain();mGain.gain.value=.8;anW=ctx.createAnalyser();anW.fftSize=2048;anF=ctx.createAnalyser();anF.fftSize=256;const cp=ctx.createDynamicsCompressor();cp.threshold.value=-18;cp.ratio.value=4;mGain.connect(anW);anW.connect(anF);anF.connect(cp);cp.connect(ctx.destination);chs.forEach(c=>{c.g=ctx.createGain();c.g.gain.value=c.vol/100;c.scDuck=ctx.createGain();c.scDuck.gain.value=1;c.g.connect(c.scDuck);c.scDuck.connect(mGain)});ensureBuses()}

// === SOUNDS ===
// === SOUND LIBRARY ‚Äî multi-layer synthesis ===
// Shared helpers
function _mkNz(c,dur,st){const ch=st?2:1,b=c.createBuffer(ch,Math.max(1,Math.round(c.sampleRate*dur)),c.sampleRate);
  for(let i=0;i<ch;i++){const a=b.getChannelData(i);for(let j=0;j<a.length;j++)a[j]=Math.random()*2-1}return b}
function _mkDrv(c,drive,inp,out){if(drive<.01){inp.connect(out);return}
  const ws=c.createWaveShaper(),k=2+drive*40;const cv=new Float32Array(512);
  for(let i=0;i<512;i++){const x=i*2/511-1;cv[i]=Math.tanh(k*x)}ws.curve=cv;ws.oversample='2x';inp.connect(ws);ws.connect(out)}

const SL={
kick:{
  // === 808 ===
  'Kick 808':(t,v,c,d)=>{
    // Pure 808: long sine sweep, heavy sub, no click
    const o=c.createOscillator(),g=c.createGain();o.type='sine';o.connect(g);g.connect(d);
    o.frequency.setValueAtTime(160,t);o.frequency.exponentialRampToValueAtTime(42,t+.07);o.frequency.exponentialRampToValueAtTime(20,t+.5);
    g.gain.setValueAtTime(v*1.2,t);g.gain.setValueAtTime(v*1.15,t+.01);g.gain.exponentialRampToValueAtTime(.001,t+.5);o.start(t);o.stop(t+.5);
    // Sub layer
    const s=c.createOscillator(),sg=c.createGain();s.type='sine';s.connect(sg);sg.connect(d);
    s.frequency.setValueAtTime(48,t);s.frequency.exponentialRampToValueAtTime(20,t+.55);
    sg.gain.setValueAtTime(v*.7,t);sg.gain.exponentialRampToValueAtTime(.001,t+.55);s.start(t);s.stop(t+.55)},
  // === Punchy ===
  'Kick Punchy':(t,v,c,d)=>{
    // Fast sweep, strong click, short tail ‚Äî for house/techno
    const o=c.createOscillator(),g=c.createGain();o.type='sine';o.connect(g);g.connect(d);
    o.frequency.setValueAtTime(320,t);o.frequency.exponentialRampToValueAtTime(55,t+.025);o.frequency.exponentialRampToValueAtTime(20,t+.2);
    g.gain.setValueAtTime(v*1.4,t);g.gain.exponentialRampToValueAtTime(.001,t+.22);o.start(t);o.stop(t+.22);
    // Click transient
    const cl=c.createOscillator(),clg=c.createGain();cl.type='square';cl.frequency.value=2800;cl.connect(clg);clg.connect(d);
    clg.gain.setValueAtTime(v*.25,t);clg.gain.exponentialRampToValueAtTime(.001,t+.005);cl.start(t);cl.stop(t+.008);
    // Noise click
    const nb=_mkNz(c,.006);const ns=c.createBufferSource();ns.buffer=nb;
    const nf=c.createBiquadFilter();nf.type='highpass';nf.frequency.value=4000;const ng=c.createGain();
    ns.connect(nf);nf.connect(ng);ng.connect(d);ng.gain.setValueAtTime(v*.15,t);ng.gain.exponentialRampToValueAtTime(.001,t+.005);ns.start(t);ns.stop(t+.008)},
  // === Deep ===
  'Kick Deep':(t,v,c,d)=>{
    // Very low, very long ‚Äî sub bass kick for dubstep/trap
    const o=c.createOscillator(),g=c.createGain();o.type='sine';o.connect(g);g.connect(d);
    o.frequency.setValueAtTime(90,t);o.frequency.exponentialRampToValueAtTime(32,t+.15);o.frequency.exponentialRampToValueAtTime(20,t+.7);
    g.gain.setValueAtTime(v*1.2,t);g.gain.exponentialRampToValueAtTime(.001,t+.7);o.start(t);o.stop(t+.7);
    const s=c.createOscillator(),sg=c.createGain();s.type='sine';s.connect(sg);sg.connect(d);
    s.frequency.setValueAtTime(38,t);s.frequency.exponentialRampToValueAtTime(20,t+.75);
    sg.gain.setValueAtTime(v*.8,t);sg.gain.exponentialRampToValueAtTime(.001,t+.75);s.start(t);s.stop(t+.75)},
  // === Tight ===
  'Kick Tight':(t,v,c,d)=>{
    // Short snappy kick ‚Äî for DnB, techno
    const o=c.createOscillator(),g=c.createGain();o.type='sine';o.connect(g);g.connect(d);
    o.frequency.setValueAtTime(280,t);o.frequency.exponentialRampToValueAtTime(65,t+.015);o.frequency.exponentialRampToValueAtTime(20,t+.1);
    g.gain.setValueAtTime(v*1.3,t);g.gain.exponentialRampToValueAtTime(.001,t+.12);o.start(t);o.stop(t+.12);
    const cl=c.createOscillator(),clg=c.createGain();cl.type='square';cl.frequency.value=3500;cl.connect(clg);clg.connect(d);
    clg.gain.setValueAtTime(v*.3,t);clg.gain.exponentialRampToValueAtTime(.001,t+.004);cl.start(t);cl.stop(t+.006)},
  // === Distorted ===
  'Kick Dist':(t,v,c,d)=>{
    // Saturated, aggressive ‚Äî phonk/industrial
    const o=c.createOscillator(),g=c.createGain();o.type='triangle';
    const ws=c.createWaveShaper();const k=25;const cv=new Float32Array(512);
    for(let i=0;i<512;i++){const x=i*2/511-1;cv[i]=Math.tanh(k*x)}ws.curve=cv;ws.oversample='2x';
    o.connect(g);g.connect(ws);ws.connect(d);
    o.frequency.setValueAtTime(180,t);o.frequency.exponentialRampToValueAtTime(38,t+.08);o.frequency.exponentialRampToValueAtTime(20,t+.4);
    g.gain.setValueAtTime(v*1.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.42);o.start(t);o.stop(t+.42)},
  // === Boom ===
  'Kick Boom':(t,v,c,d)=>{
    // Round boomy kick ‚Äî lo-fi, boom bap
    const o=c.createOscillator(),g=c.createGain();o.type='sine';o.connect(g);g.connect(d);
    o.frequency.setValueAtTime(140,t);o.frequency.exponentialRampToValueAtTime(48,t+.1);o.frequency.exponentialRampToValueAtTime(20,t+.35);
    g.gain.setValueAtTime(v*1.1,t);g.gain.setValueAtTime(v*1.05,t+.01);g.gain.exponentialRampToValueAtTime(.001,t+.38);o.start(t);o.stop(t+.38);
    const s=c.createOscillator(),sg=c.createGain();s.type='sine';s.connect(sg);sg.connect(d);
    s.frequency.setValueAtTime(55,t);s.frequency.exponentialRampToValueAtTime(20,t+.4);
    sg.gain.setValueAtTime(v*.55,t);sg.gain.exponentialRampToValueAtTime(.001,t+.42);s.start(t);s.stop(t+.42)}
},
snare:{
  // === Crack ===
  'Snare Crack':(t,v,c,d)=>{
    // Bright snappy ‚Äî general purpose
    const dur=.14;const nb=_mkNz(c,dur);const ns=c.createBufferSource();ns.buffer=nb;
    const nf=c.createBiquadFilter();nf.type='highpass';nf.frequency.value=1800;nf.Q.value=.8;
    const ng=c.createGain();ns.connect(nf);nf.connect(ng);ng.connect(d);
    ng.gain.setValueAtTime(v*.7,t);ng.gain.setValueAtTime(v*.5,t+.015);ng.gain.exponentialRampToValueAtTime(.001,t+dur);ns.start(t);ns.stop(t+dur+.01);
    // Tonal body
    const o=c.createOscillator(),g2=c.createGain();o.type='triangle';o.connect(g2);g2.connect(d);
    o.frequency.setValueAtTime(260,t);o.frequency.exponentialRampToValueAtTime(140,t+.03);
    g2.gain.setValueAtTime(v*.4,t);g2.gain.exponentialRampToValueAtTime(.001,t+.06);o.start(t);o.stop(t+.07);
    // Wire snap
    const w=c.createOscillator(),wg=c.createGain();w.type='square';w.frequency.value=5000;w.connect(wg);wg.connect(d);
    wg.gain.setValueAtTime(v*.08,t);wg.gain.exponentialRampToValueAtTime(.001,t+.004);w.start(t);w.stop(t+.006)},
  // === Tight ===
  'Snare Tight':(t,v,c,d)=>{
    // Short bright ‚Äî trap/drill
    const dur=.07;const nb=_mkNz(c,dur);const ns=c.createBufferSource();ns.buffer=nb;
    const nf=c.createBiquadFilter();nf.type='highpass';nf.frequency.value=2500;nf.Q.value=1;
    const ng=c.createGain();ns.connect(nf);nf.connect(ng);ng.connect(d);
    ng.gain.setValueAtTime(v*.8,t);ng.gain.exponentialRampToValueAtTime(.001,t+dur);ns.start(t);ns.stop(t+dur+.01)},
  // === Lo-Fi ===
  'Snare Lo-Fi':(t,v,c,d)=>{
    // Dark saturated ‚Äî lo-fi/boom bap
    const dur=.16;const nb=_mkNz(c,dur);const ns=c.createBufferSource();ns.buffer=nb;
    const nf=c.createBiquadFilter();nf.type='lowpass';nf.frequency.value=3200;nf.Q.value=.5;
    const ng=c.createGain();
    const ws=c.createWaveShaper();const k=15;const cv=new Float32Array(512);
    for(let i=0;i<512;i++){const x=i*2/511-1;cv[i]=Math.tanh(k*x)}ws.curve=cv;
    ns.connect(nf);nf.connect(ng);ng.connect(ws);ws.connect(d);
    ng.gain.setValueAtTime(v*.6,t);ng.gain.exponentialRampToValueAtTime(.001,t+dur);ns.start(t);ns.stop(t+dur+.01);
    // Fat tonal body
    const o=c.createOscillator(),g2=c.createGain();o.type='triangle';o.connect(g2);g2.connect(ws);
    o.frequency.setValueAtTime(220,t);o.frequency.exponentialRampToValueAtTime(120,t+.04);
    g2.gain.setValueAtTime(v*.35,t);g2.gain.exponentialRampToValueAtTime(.001,t+.08);o.start(t);o.stop(t+.09)},
  // === Rim ===
  'Snare Rim':(t,v,c,d)=>{
    // Cross-stick rim shot
    const o=c.createOscillator(),g=c.createGain();o.type='triangle';o.connect(g);g.connect(d);
    o.frequency.setValueAtTime(1400,t);o.frequency.exponentialRampToValueAtTime(500,t+.003);
    g.gain.setValueAtTime(v*.5,t);g.gain.exponentialRampToValueAtTime(.001,t+.04);o.start(t);o.stop(t+.05);
    // Shell body
    const o2=c.createOscillator(),g2=c.createGain();o2.type='sine';o2.frequency.value=280;o2.connect(g2);g2.connect(d);
    g2.gain.setValueAtTime(v*.15,t);g2.gain.exponentialRampToValueAtTime(.001,t+.05);o2.start(t);o2.stop(t+.06);
    // Noise transient
    const nb=_mkNz(c,.004);const ns=c.createBufferSource();ns.buffer=nb;
    const nf=c.createBiquadFilter();nf.type='highpass';nf.frequency.value=6000;const ng=c.createGain();
    ns.connect(nf);nf.connect(ng);ng.connect(d);ng.gain.setValueAtTime(v*.12,t);ng.gain.exponentialRampToValueAtTime(.001,t+.003);ns.start(t);ns.stop(t+.005)},
  // === Clap Snare ===
  'Snare Clap':(t,v,c,d)=>{
    // Layered clap + snare body
    for(let i=0;i<4;i++){const tt=t+i*.006;
      const nb=_mkNz(c,.02);const ns=c.createBufferSource();ns.buffer=nb;
      const nf=c.createBiquadFilter();nf.type='bandpass';nf.frequency.value=2200;nf.Q.value=1.5;
      const ng=c.createGain();ns.connect(nf);nf.connect(ng);ng.connect(d);
      ng.gain.setValueAtTime(v*.3*(1-i*.15),tt);ng.gain.exponentialRampToValueAtTime(.001,tt+.03);ns.start(tt);ns.stop(tt+.035)}
    // Tail
    const tb=_mkNz(c,.12);const ts=c.createBufferSource();ts.buffer=tb;
    const tf=c.createBiquadFilter();tf.type='bandpass';tf.frequency.value=1800;tf.Q.value=.8;
    const tg=c.createGain();ts.connect(tf);tf.connect(tg);tg.connect(d);
    tg.gain.setValueAtTime(v*.2,t+.024);tg.gain.exponentialRampToValueAtTime(.001,t+.14);ts.start(t+.024);ts.stop(t+.15)}
},
hihat:{
  // === Closed ===
  'HH Closed':(t,v,c,d)=>{
    const dur=.045;const nb=_mkNz(c,dur);const ns=c.createBufferSource();ns.buffer=nb;
    const nf=c.createBiquadFilter();nf.type='highpass';nf.frequency.value=7500;nf.Q.value=.8;
    const ng=c.createGain();ns.connect(nf);nf.connect(ng);ng.connect(d);
    ng.gain.setValueAtTime(v*.35,t);ng.gain.exponentialRampToValueAtTime(.001,t+dur);ns.start(t);ns.stop(t+dur+.01);
    // Metallic partials
    const freqs=[6047,8230];freqs.forEach((f,i)=>{
      const o=c.createOscillator(),og=c.createGain();o.type='square';o.frequency.value=f;o.connect(og);og.connect(d);
      og.gain.setValueAtTime(v*.025/(i+1),t);og.gain.exponentialRampToValueAtTime(.001,t+dur*.6);o.start(t);o.stop(t+dur)})},
  // === Open ===
  'HH Open':(t,v,c,d)=>{
    const dur=.22;const nb=_mkNz(c,dur);const ns=c.createBufferSource();ns.buffer=nb;
    const nf=c.createBiquadFilter();nf.type='highpass';nf.frequency.value=6000;nf.Q.value=.5;
    const ng=c.createGain();ns.connect(nf);nf.connect(ng);ng.connect(d);
    ng.gain.setValueAtTime(v*.3,t);ng.gain.setValueAtTime(v*.25,t+.01);ng.gain.exponentialRampToValueAtTime(.001,t+dur);ns.start(t);ns.stop(t+dur+.01);
    const freqs=[6047,6890,8230,10540];freqs.forEach((f,i)=>{
      const o=c.createOscillator(),og=c.createGain();o.type='square';o.frequency.value=f;o.connect(og);og.connect(d);
      og.gain.setValueAtTime(v*.02/(i+1),t);og.gain.exponentialRampToValueAtTime(.001,t+dur*.5);o.start(t);o.stop(t+dur)})},
  // === Crispy ===
  'HH Crispy':(t,v,c,d)=>{
    // Very bright, very short
    const dur=.025;const nb=_mkNz(c,dur);const ns=c.createBufferSource();ns.buffer=nb;
    const nf=c.createBiquadFilter();nf.type='highpass';nf.frequency.value=9500;nf.Q.value=1.2;
    const ng=c.createGain();ns.connect(nf);nf.connect(ng);ng.connect(d);
    ng.gain.setValueAtTime(v*.4,t);ng.gain.exponentialRampToValueAtTime(.001,t+dur);ns.start(t);ns.stop(t+dur+.01);
    const o=c.createOscillator(),og=c.createGain();o.type='square';o.frequency.value=10540;o.connect(og);og.connect(d);
    og.gain.setValueAtTime(v*.03,t);og.gain.exponentialRampToValueAtTime(.001,t+dur*.5);o.start(t);o.stop(t+dur)},
  // === Shaker ===
  'HH Shaker':(t,v,c,d)=>{
    // Egg shaker / tambourine feel
    const dur=.06;const nb=_mkNz(c,dur);const ns=c.createBufferSource();ns.buffer=nb;
    const nf=c.createBiquadFilter();nf.type='bandpass';nf.frequency.value=8000;nf.Q.value=2;
    const ng=c.createGain();ns.connect(nf);nf.connect(ng);ng.connect(d);
    ng.gain.setValueAtTime(v*.35,t);ng.gain.setValueAtTime(v*.25,t+.008);ng.gain.exponentialRampToValueAtTime(.001,t+dur);ns.start(t);ns.stop(t+dur+.01)}
},
clap:{
  // === Tight ===
  'Clap Tight':(t,v,c,d)=>{
    const layers=4,spread=.007;
    for(let i=0;i<layers;i++){const tt=t+i*spread;const dur=.025;
      const nb=_mkNz(c,dur);const ns=c.createBufferSource();ns.buffer=nb;
      const nf=c.createBiquadFilter();nf.type='bandpass';nf.frequency.value=2500;nf.Q.value=2;
      const ng=c.createGain();ns.connect(nf);nf.connect(ng);ng.connect(d);
      ng.gain.setValueAtTime(v*.3*(1-i*.12),tt);ng.gain.exponentialRampToValueAtTime(.001,tt+dur);ns.start(tt);ns.stop(tt+dur+.01)}
    // Tail
    const tb=_mkNz(c,.08);const ts=c.createBufferSource();ts.buffer=tb;
    const tf=c.createBiquadFilter();tf.type='bandpass';tf.frequency.value=2000;tf.Q.value=.8;
    const tg=c.createGain();ts.connect(tf);tf.connect(tg);tg.connect(d);
    tg.gain.setValueAtTime(v*.15,t+layers*spread);tg.gain.exponentialRampToValueAtTime(.001,t+.1);ts.start(t+layers*spread);ts.stop(t+.11)},
  // === Snap ===
  'Clap Snap':(t,v,c,d)=>{
    // Single sharp snap ‚Äî finger snap character
    const nb=_mkNz(c,.015);const ns=c.createBufferSource();ns.buffer=nb;
    const nf=c.createBiquadFilter();nf.type='bandpass';nf.frequency.value=4500;nf.Q.value=5;
    const ng=c.createGain();ns.connect(nf);nf.connect(ng);ng.connect(d);
    ng.gain.setValueAtTime(v*.65,t);ng.gain.exponentialRampToValueAtTime(.001,t+.03);ns.start(t);ns.stop(t+.04)},
  // === Big ===
  'Clap Big':(t,v,c,d)=>{
    // Loose wide clap ‚Äî lots of hands
    const layers=6,spread=.012;
    for(let i=0;i<layers;i++){const tt=t+i*spread;const dur=.03;
      const nb=_mkNz(c,dur);const ns=c.createBufferSource();ns.buffer=nb;
      const nf=c.createBiquadFilter();nf.type='bandpass';nf.frequency.value=1800+Math.random()*800;nf.Q.value=1;
      const ng=c.createGain();ns.connect(nf);nf.connect(ng);ng.connect(d);
      ng.gain.setValueAtTime(v*.2*(1-i*.1),tt);ng.gain.exponentialRampToValueAtTime(.001,tt+dur);ns.start(tt);ns.stop(tt+dur+.01)}
    const tb=_mkNz(c,.18);const ts=c.createBufferSource();ts.buffer=tb;
    const tf=c.createBiquadFilter();tf.type='bandpass';tf.frequency.value=1600;tf.Q.value=.5;
    const tg=c.createGain();ts.connect(tf);tf.connect(tg);tg.connect(d);
    tg.gain.setValueAtTime(v*.18,t+layers*spread);tg.gain.exponentialRampToValueAtTime(.001,t+.2);ts.start(t+layers*spread);ts.stop(t+.21)}
},
tom:{
  // === High ===
  'Tom High':(t,v,c,d)=>{
    const o=c.createOscillator(),g=c.createGain();o.type='sine';o.connect(g);g.connect(d);
    o.frequency.setValueAtTime(420,t);o.frequency.exponentialRampToValueAtTime(180,t+.04);o.frequency.exponentialRampToValueAtTime(150,t+.18);
    g.gain.setValueAtTime(v*.85,t);g.gain.exponentialRampToValueAtTime(.001,t+.2);o.start(t);o.stop(t+.21);
    // Stick attack
    const nb=_mkNz(c,.006);const ns=c.createBufferSource();ns.buffer=nb;
    const nf=c.createBiquadFilter();nf.type='bandpass';nf.frequency.value=3000;nf.Q.value=1;const ng=c.createGain();
    ns.connect(nf);nf.connect(ng);ng.connect(d);ng.gain.setValueAtTime(v*.15,t);ng.gain.exponentialRampToValueAtTime(.001,t+.005);ns.start(t);ns.stop(t+.008);
    // Shell resonance
    const o2=c.createOscillator(),g2=c.createGain();o2.type='sine';o2.frequency.value=284;o2.connect(g2);g2.connect(d);
    g2.gain.setValueAtTime(v*.08,t);g2.gain.exponentialRampToValueAtTime(.001,t+.1);o2.start(t);o2.stop(t+.11)},
  // === Mid ===
  'Tom Mid':(t,v,c,d)=>{
    const o=c.createOscillator(),g=c.createGain();o.type='sine';o.connect(g);g.connect(d);
    o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(120,t+.05);o.frequency.exponentialRampToValueAtTime(100,t+.25);
    g.gain.setValueAtTime(v*.85,t);g.gain.exponentialRampToValueAtTime(.001,t+.27);o.start(t);o.stop(t+.28);
    const nb=_mkNz(c,.008);const ns=c.createBufferSource();ns.buffer=nb;
    const nf=c.createBiquadFilter();nf.type='bandpass';nf.frequency.value=2500;nf.Q.value=1;const ng=c.createGain();
    ns.connect(nf);nf.connect(ng);ng.connect(d);ng.gain.setValueAtTime(v*.12,t);ng.gain.exponentialRampToValueAtTime(.001,t+.006);ns.start(t);ns.stop(t+.01)},
  // === Floor ===
  'Tom Floor':(t,v,c,d)=>{
    const o=c.createOscillator(),g=c.createGain();o.type='sine';o.connect(g);g.connect(d);
    o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(75,t+.07);o.frequency.exponentialRampToValueAtTime(60,t+.35);
    g.gain.setValueAtTime(v*.9,t);g.gain.exponentialRampToValueAtTime(.001,t+.38);o.start(t);o.stop(t+.4);
    const nb=_mkNz(c,.01);const ns=c.createBufferSource();ns.buffer=nb;
    const nf=c.createBiquadFilter();nf.type='bandpass';nf.frequency.value=2000;nf.Q.value=.8;const ng=c.createGain();
    ns.connect(nf);nf.connect(ng);ng.connect(d);ng.gain.setValueAtTime(v*.1,t);ng.gain.exponentialRampToValueAtTime(.001,t+.008);ns.start(t);ns.stop(t+.012);
    // Membrane resonance
    const o2=c.createOscillator(),g2=c.createGain();o2.type='sine';o2.frequency.value=95;o2.connect(g2);g2.connect(d);
    g2.gain.setValueAtTime(v*.12,t);g2.gain.exponentialRampToValueAtTime(.001,t+.2);o2.start(t);o2.stop(t+.21)}
},
perc:{
  // === Click (clave) ===
  'Perc Click':(t,v,c,d)=>{
    const o=c.createOscillator(),g=c.createGain();o.type='triangle';o.connect(g);g.connect(d);
    o.frequency.setValueAtTime(1200,t);o.frequency.exponentialRampToValueAtTime(600,t+.008);
    g.gain.setValueAtTime(v*.5,t);g.gain.exponentialRampToValueAtTime(.001,t+.05);o.start(t);o.stop(t+.06);
    // Second partial
    const o2=c.createOscillator(),g2=c.createGain();o2.type='sine';o2.frequency.value=890;o2.connect(g2);g2.connect(d);
    g2.gain.setValueAtTime(v*.12,t);g2.gain.exponentialRampToValueAtTime(.001,t+.03);o2.start(t);o2.stop(t+.04)},
  // === Rim ===
  'Perc Rim':(t,v,c,d)=>{
    const o=c.createOscillator(),g=c.createGain();o.type='square';o.connect(g);g.connect(d);
    o.frequency.setValueAtTime(1600,t);o.frequency.exponentialRampToValueAtTime(500,t+.003);
    g.gain.setValueAtTime(v*.45,t);g.gain.exponentialRampToValueAtTime(.001,t+.035);o.start(t);o.stop(t+.04);
    const nb=_mkNz(c,.003);const ns=c.createBufferSource();ns.buffer=nb;
    const nf=c.createBiquadFilter();nf.type='highpass';nf.frequency.value=6000;const ng=c.createGain();
    ns.connect(nf);nf.connect(ng);ng.connect(d);ng.gain.setValueAtTime(v*.1,t);ng.gain.exponentialRampToValueAtTime(.001,t+.003);ns.start(t);ns.stop(t+.005)},
  // === Cowbell ===
  'Perc Cowbell':(t,v,c,d)=>{
    // Two inharmonic square oscs = metallic cowbell
    const o=c.createOscillator(),o2=c.createOscillator(),g=c.createGain();
    const f=c.createBiquadFilter();f.type='bandpass';f.frequency.value=800;f.Q.value=3;
    o.connect(f);o2.connect(f);f.connect(g);g.connect(d);
    o.type='square';o2.type='square';o.frequency.value=587;o2.frequency.value=845;
    g.gain.setValueAtTime(v*.3,t);g.gain.exponentialRampToValueAtTime(.001,t+.1);
    o.start(t);o.stop(t+.11);o2.start(t);o2.stop(t+.11)},
  // === Conga ===
  'Perc Conga':(t,v,c,d)=>{
    const o=c.createOscillator(),g=c.createGain();o.type='sine';o.connect(g);g.connect(d);
    o.frequency.setValueAtTime(450,t);o.frequency.exponentialRampToValueAtTime(280,t+.02);
    g.gain.setValueAtTime(v*.6,t);g.gain.exponentialRampToValueAtTime(.001,t+.15);o.start(t);o.stop(t+.16);
    // Skin attack noise
    const nb=_mkNz(c,.006);const ns=c.createBufferSource();ns.buffer=nb;
    const nf=c.createBiquadFilter();nf.type='bandpass';nf.frequency.value=2000;nf.Q.value=1;const ng=c.createGain();
    ns.connect(nf);nf.connect(ng);ng.connect(d);ng.gain.setValueAtTime(v*.15,t);ng.gain.exponentialRampToValueAtTime(.001,t+.005);ns.start(t);ns.stop(t+.008)}
},
bass:{
  // === Sub ===
  'Bass Sub':(t,v,c,d)=>{
    const o=c.createOscillator(),g=c.createGain();o.type='sine';o.connect(g);g.connect(d);
    o.frequency.setValueAtTime(55,t);g.gain.setValueAtTime(v*.8,t);g.gain.setValueAtTime(v*.75,t+.01);
    g.gain.exponentialRampToValueAtTime(.001,t+.28);o.start(t);o.stop(t+.28)},
  // === Saw ===
  'Bass Saw':(t,v,c,d)=>{
    const o=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();o.type='sawtooth';
    o.connect(f);f.connect(g);g.connect(d);f.type='lowpass';f.Q.value=2;
    f.frequency.setValueAtTime(1200,t);f.frequency.exponentialRampToValueAtTime(180,t+.08);
    o.frequency.setValueAtTime(55,t);g.gain.setValueAtTime(v*.65,t);g.gain.exponentialRampToValueAtTime(.001,t+.22);o.start(t);o.stop(t+.22)},
  // === Square ===
  'Bass Square':(t,v,c,d)=>{
    const o=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();o.type='square';
    o.connect(f);f.connect(g);g.connect(d);f.type='lowpass';f.Q.value=1.5;
    f.frequency.setValueAtTime(800,t);f.frequency.exponentialRampToValueAtTime(150,t+.06);
    o.frequency.setValueAtTime(55,t);g.gain.setValueAtTime(v*.45,t);g.gain.exponentialRampToValueAtTime(.001,t+.2);o.start(t);o.stop(t+.2)},
  // === Pluck ===
  'Bass Pluck':(t,v,c,d)=>{
    const o=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();o.type='sawtooth';
    o.connect(f);f.connect(g);g.connect(d);f.type='lowpass';f.Q.value=4;
    f.frequency.setValueAtTime(3000,t);f.frequency.exponentialRampToValueAtTime(100,t+.03);
    o.frequency.setValueAtTime(82,t);g.gain.setValueAtTime(v*.6,t);g.gain.exponentialRampToValueAtTime(.001,t+.1);o.start(t);o.stop(t+.1)},
  // === 808 ===
  'Bass 808':(t,v,c,d)=>{
    // Long 808 bass slide
    const o=c.createOscillator(),g=c.createGain();o.type='sine';o.connect(g);g.connect(d);
    o.frequency.setValueAtTime(80,t);o.frequency.exponentialRampToValueAtTime(45,t+.05);
    g.gain.setValueAtTime(v*.85,t);g.gain.setValueAtTime(v*.8,t+.01);g.gain.exponentialRampToValueAtTime(.001,t+.5);o.start(t);o.stop(t+.5);
    // Harmonic layer
    const o2=c.createOscillator(),g2=c.createGain(),f2=c.createBiquadFilter();o2.type='triangle';
    o2.connect(f2);f2.connect(g2);g2.connect(d);f2.type='lowpass';f2.frequency.value=200;
    o2.frequency.setValueAtTime(80,t);o2.frequency.exponentialRampToValueAtTime(45,t+.05);
    g2.gain.setValueAtTime(v*.25,t);g2.gain.exponentialRampToValueAtTime(.001,t+.35);o2.start(t);o2.stop(t+.35)},
  // === Dist ===
  'Bass Dist':(t,v,c,d)=>{
    const o=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();o.type='sawtooth';
    const ws=c.createWaveShaper();const k=18;const cv=new Float32Array(512);
    for(let i=0;i<512;i++){const x=i*2/511-1;cv[i]=Math.tanh(k*x)}ws.curve=cv;ws.oversample='2x';
    o.connect(f);f.connect(g);g.connect(ws);ws.connect(d);f.type='lowpass';f.Q.value=3;
    f.frequency.setValueAtTime(1500,t);f.frequency.exponentialRampToValueAtTime(200,t+.06);
    o.frequency.setValueAtTime(55,t);g.gain.setValueAtTime(v*.5,t);g.gain.exponentialRampToValueAtTime(.001,t+.25);o.start(t);o.stop(t+.25)}
},
synth:{
  // === Stab ===
  'Synth Stab':(t,v,c,d)=>{
    const o=c.createOscillator(),o2=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();
    o.connect(f);o2.connect(f);f.connect(g);g.connect(d);o.type='square';o2.type='sawtooth';
    f.type='lowpass';f.Q.value=2;f.frequency.setValueAtTime(2500,t);f.frequency.exponentialRampToValueAtTime(250,t+.12);
    o.frequency.setValueAtTime(220,t);o2.frequency.setValueAtTime(221.5,t);
    g.gain.setValueAtTime(v*.25,t);g.gain.exponentialRampToValueAtTime(.001,t+.2);o.start(t);o.stop(t+.2);o2.start(t);o2.stop(t+.2)},
  // === Pluck ===
  'Synth Pluck':(t,v,c,d)=>{
    const o=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();o.type='sawtooth';
    o.connect(f);f.connect(g);g.connect(d);f.type='lowpass';f.Q.value=5;
    f.frequency.setValueAtTime(5000,t);f.frequency.exponentialRampToValueAtTime(200,t+.04);
    o.frequency.setValueAtTime(330,t);g.gain.setValueAtTime(v*.3,t);g.gain.exponentialRampToValueAtTime(.001,t+.12);o.start(t);o.stop(t+.12)},
  // === Chord ===
  'Synth Chord':(t,v,c,d)=>{
    [220,277.2,329.6].forEach(fr=>{
      const o=c.createOscillator(),o2=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();
      o.connect(f);o2.connect(f);f.connect(g);g.connect(d);
      o.type='sawtooth';o2.type='sawtooth';o2.detune.value=8;
      f.type='lowpass';f.Q.value=1;f.frequency.setValueAtTime(1800,t);f.frequency.exponentialRampToValueAtTime(400,t+.15);
      o.frequency.setValueAtTime(fr,t);o2.frequency.setValueAtTime(fr,t);
      g.gain.setValueAtTime(v*.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.35);
      o.start(t);o.stop(t+.35);o2.start(t);o2.stop(t+.35)})},
  // === Zap ===
  'Synth Zap':(t,v,c,d)=>{
    const o=c.createOscillator(),g=c.createGain();o.type='sawtooth';o.connect(g);g.connect(d);
    o.frequency.setValueAtTime(1600,t);o.frequency.exponentialRampToValueAtTime(80,t+.06);
    g.gain.setValueAtTime(v*.35,t);g.gain.exponentialRampToValueAtTime(.001,t+.08);o.start(t);o.stop(t+.08)},
  // === Pad ===
  'Synth Pad':(t,v,c,d)=>{
    [220,330,440].forEach(fr=>{
      const o=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();
      o.connect(f);f.connect(g);g.connect(d);o.type='sine';
      f.type='lowpass';f.frequency.setValueAtTime(800,t);f.frequency.linearRampToValueAtTime(1200,t+.2);f.frequency.linearRampToValueAtTime(600,t+.6);
      o.frequency.setValueAtTime(fr,t);
      g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(v*.08,t+.1);
      g.gain.linearRampToValueAtTime(v*.06,t+.3);g.gain.exponentialRampToValueAtTime(.001,t+.6);
      o.start(t);o.stop(t+.6)})},
  // === Keys ===
  'Synth Keys':(t,v,c,d)=>{
    const o=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();
    o.connect(f);f.connect(g);g.connect(d);o.type='triangle';
    f.type='lowpass';f.Q.value=1;f.frequency.setValueAtTime(3000,t);f.frequency.exponentialRampToValueAtTime(500,t+.1);
    o.frequency.setValueAtTime(440,t);
    g.gain.setValueAtTime(v*.3,t);g.gain.exponentialRampToValueAtTime(v*.15,t+.05);
    g.gain.exponentialRampToValueAtTime(.001,t+.25);o.start(t);o.stop(t+.25)}
}
};

// === WINDOW MANAGER ===
let mods=[],mid=0,topZ=10,aTab='all',_dr=null,_rs=null,_kb=null;
const _modsByChannel=Array.from({length:NCH},()=>[]);function _rebuildModIndex(){_modsByChannel.forEach(a=>a.length=0);mods.forEach(m=>{if(m.ci>=0&&m.ci<NCH)_modsByChannel[m.ci].push(m)})}
const ws=document.getElementById('workspace'),wsI=document.getElementById('wsI');
document.addEventListener('mousemove',e=>{
  if(_dr){const d=_dr;const wr=ws.getBoundingClientRect();const mx=e.clientX-wr.left+ws.scrollLeft,my=e.clientY-wr.top+ws.scrollTop;d.w.style.left=Math.max(0,mx-d.ox)+'px';d.w.style.top=Math.max(0,my-d.oy)+'px'}
  if(_rs){const r=_rs;r.w.style.width=Math.max(200,r.sw+(e.clientX-r.sx))+'px';r.w.style.height=Math.max(80,r.sh+(e.clientY-r.sy))+'px'}
});
document.addEventListener('mouseup',()=>{_dr=null;_rs=null});
// Touch equivalents for window drag/resize
document.addEventListener('touchmove',e=>{
  if(_dr||_rs){e.preventDefault();const t=e.touches[0];
    if(_dr){const d=_dr;const wr=ws.getBoundingClientRect();const mx=t.clientX-wr.left+ws.scrollLeft,my=t.clientY-wr.top+ws.scrollTop;d.w.style.left=Math.max(0,mx-d.ox)+'px';d.w.style.top=Math.max(0,my-d.oy)+'px'}
    if(_rs){const r=_rs;r.w.style.width=Math.max(200,r.sw+(t.clientX-r.sx))+'px';r.w.style.height=Math.max(80,r.sh+(t.clientY-r.sy))+'px'}}
},{passive:false});
document.addEventListener('touchend',()=>{if(_dr||_rs)unlockWsScroll();_dr=null;_rs=null});
function setKb(id){_kb=_kb===id?null:id;document.querySelectorAll('.wb.kb').forEach(b=>b.classList.toggle('active',+b.dataset.mid===_kb))}
function mkW(title,tag,col,x,y,w,h,ci){
  // center on current viewport
  const ws=document.getElementById('workspace');
  const vx=ws.scrollLeft+ws.clientWidth/2-w/2;
  const vy=ws.scrollTop+ws.clientHeight/2-h/2;
  // slight random offset so stacked windows don't perfectly overlap
  const ox=(Math.random()-.5)*40, oy=(Math.random()-.5)*30;
  const fx=Math.max(0,Math.round(vx+ox)), fy=Math.max(0,Math.round(vy+oy));
  const el=document.createElement('div');el.className='win focused';el.style.cssText=`left:${fx}px;top:${fy}px;width:${w}px;height:${h}px;z-index:${++topZ}`;
  const hd=document.createElement('div');hd.className='wh';
  const sel=document.createElement('select');sel.className='wsel';
  for(let i=0;i<NCH;i++){const o=document.createElement('option');o.value=i;o.textContent='CH'+(i+1);if(i===ci)o.selected=true;sel.appendChild(o)}
  hd.innerHTML=`<div class="wc" style="background:${col}"></div><span class="wt">${title}</span><span class="wtag">${tag}</span>`;
  hd.appendChild(sel);
  const ct=document.createElement('div');ct.className='wctrls';ct.innerHTML=`<button class="wb min" title="Collapse">‚Äî</button><button class="wb close" title="Remove">‚úï</button>`;
  hd.appendChild(ct);
  const bdg=document.createElement('div');bdg.className='wbadge';bdg.style.background=CHR[ci];bdg.textContent='CH'+(ci+1);
  const bd=document.createElement('div');bd.className='wbody';
  const rsz=document.createElement('div');rsz.className='wresize';
  el.append(bdg,hd,bd,rsz);
  el.addEventListener('mousedown',()=>{document.querySelectorAll('.win').forEach(w=>w.classList.remove('focused'));el.classList.add('focused');el.style.zIndex=++topZ});
  hd.addEventListener('mousedown',e=>{if(e.target.closest('.wb')||e.target.closest('.wsel'))return;e.preventDefault();el.classList.add('focused');el.style.zIndex=++topZ;
    const wr=ws.getBoundingClientRect();
    const elX=el.offsetLeft, elY=el.offsetTop;
    const mouseWsX=e.clientX-wr.left+ws.scrollLeft, mouseWsY=e.clientY-wr.top+ws.scrollTop;
    _dr={w:el,ox:mouseWsX-elX,oy:mouseWsY-elY}});
  hd.addEventListener('touchstart',e=>{if(e.target.closest('.wb')||e.target.closest('.wsel'))return;e.preventDefault();
    el.classList.add('focused');el.style.zIndex=++topZ;lockWsScroll();
    const t=e.touches[0];const wr=ws.getBoundingClientRect();
    const mouseWsX=t.clientX-wr.left+ws.scrollLeft,mouseWsY=t.clientY-wr.top+ws.scrollTop;
    _dr={w:el,ox:mouseWsX-el.offsetLeft,oy:mouseWsY-el.offsetTop}},{passive:false});
  rsz.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();_rs={w:el,sx:e.clientX,sy:e.clientY,sw:el.offsetWidth,sh:el.offsetHeight}});
  rsz.addEventListener('touchstart',e=>{e.preventDefault();e.stopPropagation();lockWsScroll();const t=e.touches[0];
    _rs={w:el,sx:t.clientX,sy:t.clientY,sw:el.offsetWidth,sh:el.offsetHeight}},{passive:false});
  ct.querySelector('.min').addEventListener('click',()=>el.classList.toggle('collapsed'));
  // üé® per-module theme button
  const paintBtn=document.createElement('button');paintBtn.className='wb';paintBtn.title='Module theme';paintBtn.textContent='üé®';paintBtn.style.fontSize='9px';
  ct.insertBefore(paintBtn,ct.querySelector('.min'));
  paintBtn.addEventListener('click',e=>{e.stopPropagation();showModTheme(el,paintBtn)});
  return{el,bd,sel,bdg,ct};
}
// per-module theme picker
function showModTheme(winEl,anchor){
  let pop=document.getElementById('modThemePop');
  if(pop){if(pop._target===winEl){pop.remove();return}pop.remove()}
  pop=document.createElement('div');pop.id='modThemePop';pop._target=winEl;
  const _isTchPop='ontouchstart'in window||navigator.maxTouchPoints>0;
  const popW=_isTchPop?300:240;
  const r=anchor.getBoundingClientRect();
  pop.style.cssText=`position:fixed;top:${r.bottom+4}px;left:${Math.min(r.left,window.innerWidth-popW-10)}px;background:var(--surface);border:1px solid var(--border);border-radius:${_isTchPop?10:6}px;padding:${_isTchPop?10:6}px;z-index:999999;width:${popW}px;max-height:${_isTchPop?440:340}px;display:flex;flex-direction:column;gap:${_isTchPop?6:4}px;box-shadow:0 8px 24px rgba(0,0,0,.5)`;
  const hdr=document.createElement('div');hdr.style.cssText='display:flex;justify-content:space-between;align-items:center';
  const lbl=document.createElement('span');lbl.style.cssText='font-size:6px;font-weight:800;color:var(--dim);letter-spacing:.5px';lbl.textContent='MODULE THEME';
  const resetBtn=document.createElement('button');resetBtn.style.cssText='background:none;border:1px solid var(--border);color:var(--dim);font-family:inherit;font-size:5px;font-weight:700;padding:1px 5px;border-radius:2px;cursor:pointer';
  resetBtn.textContent='‚Ü© DEFAULT';
  resetBtn.addEventListener('click',()=>{
    ['--bg','--surface','--s2','--s3','--border','--text','--dim'].forEach(k=>winEl.style.removeProperty(k));
    winEl.removeAttribute('data-mod-theme');pop.remove()});
  hdr.append(lbl,resetBtn);pop.appendChild(hdr);
  // === SOLID BRIGHT COLORS ===
  const SOLIDS=[
    {name:'RED',bg:'#dc2626',surface:'#ef4444',s2:'#f87171',s3:'#fca5a5',border:'#b91c1c',text:'#fff',dim:'#fecaca'},
    {name:'ORANGE',bg:'#ea580c',surface:'#f97316',s2:'#fb923c',s3:'#fdba74',border:'#c2410c',text:'#fff',dim:'#fed7aa'},
    {name:'AMBER',bg:'#d97706',surface:'#f59e0b',s2:'#fbbf24',s3:'#fcd34d',border:'#b45309',text:'#fff',dim:'#fde68a'},
    {name:'YELLOW',bg:'#ca8a04',surface:'#eab308',s2:'#facc15',s3:'#fde047',border:'#a16207',text:'#422006',dim:'#713f12'},
    {name:'LIME',bg:'#65a30d',surface:'#84cc16',s2:'#a3e635',s3:'#bef264',border:'#4d7c0f',text:'#fff',dim:'#ecfccb'},
    {name:'GREEN',bg:'#16a34a',surface:'#22c55e',s2:'#4ade80',s3:'#86efac',border:'#15803d',text:'#fff',dim:'#dcfce7'},
    {name:'EMERALD',bg:'#059669',surface:'#10b981',s2:'#34d399',s3:'#6ee7b7',border:'#047857',text:'#fff',dim:'#d1fae5'},
    {name:'TEAL',bg:'#0d9488',surface:'#14b8a6',s2:'#2dd4bf',s3:'#5eead4',border:'#0f766e',text:'#fff',dim:'#ccfbf1'},
    {name:'CYAN',bg:'#0891b2',surface:'#06b6d4',s2:'#22d3ee',s3:'#67e8f9',border:'#0e7490',text:'#fff',dim:'#cffafe'},
    {name:'SKY',bg:'#0284c7',surface:'#0ea5e9',s2:'#38bdf8',s3:'#7dd3fc',border:'#0369a1',text:'#fff',dim:'#e0f2fe'},
    {name:'BLUE',bg:'#2563eb',surface:'#3b82f6',s2:'#60a5fa',s3:'#93c5fd',border:'#1d4ed8',text:'#fff',dim:'#dbeafe'},
    {name:'INDIGO',bg:'#4f46e5',surface:'#6366f1',s2:'#818cf8',s3:'#a5b4fc',border:'#4338ca',text:'#fff',dim:'#e0e7ff'},
    {name:'VIOLET',bg:'#7c3aed',surface:'#8b5cf6',s2:'#a78bfa',s3:'#c4b5fd',border:'#6d28d9',text:'#fff',dim:'#ede9fe'},
    {name:'PURPLE',bg:'#9333ea',surface:'#a855f7',s2:'#c084fc',s3:'#d8b4fe',border:'#7e22ce',text:'#fff',dim:'#f3e8ff'},
    {name:'FUCHSIA',bg:'#c026d3',surface:'#d946ef',s2:'#e879f9',s3:'#f0abfc',border:'#a21caf',text:'#fff',dim:'#fae8ff'},
    {name:'PINK',bg:'#db2777',surface:'#ec4899',s2:'#f472b6',s3:'#f9a8d4',border:'#be185d',text:'#fff',dim:'#fce7f3'},
    {name:'ROSE',bg:'#e11d48',surface:'#f43f5e',s2:'#fb7185',s3:'#fda4af',border:'#be123c',text:'#fff',dim:'#ffe4e6'},
    {name:'SLATE',bg:'#475569',surface:'#64748b',s2:'#94a3b8',s3:'#cbd5e1',border:'#334155',text:'#fff',dim:'#e2e8f0'},
    {name:'ZINC',bg:'#52525b',surface:'#71717a',s2:'#a1a1aa',s3:'#d4d4d8',border:'#3f3f46',text:'#fff',dim:'#e4e4e7'},
    {name:'STONE',bg:'#57534e',surface:'#78716c',s2:'#a8a29e',s3:'#d6d3d1',border:'#44403c',text:'#fff',dim:'#e7e5e4'},
    {name:'CHARCOAL',bg:'#1c1917',surface:'#292524',s2:'#44403c',s3:'#57534e',border:'#78716c',text:'#fafaf9',dim:'#a8a29e'},
    {name:'MIDNIGHT',bg:'#0f172a',surface:'#1e293b',s2:'#334155',s3:'#475569',border:'#64748b',text:'#f1f5f9',dim:'#94a3b8'},
    {name:'SNOW',bg:'#f8fafc',surface:'#ffffff',s2:'#f1f5f9',s3:'#e2e8f0',border:'#cbd5e1',text:'#0f172a',dim:'#64748b'},
    {name:'CREAM',bg:'#fefce8',surface:'#fefdf0',s2:'#fef9c3',s3:'#fef08a',border:'#eab308',text:'#422006',dim:'#a16207'},
  ];
  const sLbl=document.createElement('div');sLbl.style.cssText='font-size:5px;font-weight:800;color:var(--dim);letter-spacing:.4px;opacity:.6';sLbl.textContent='SOLID';
  pop.appendChild(sLbl);
  const _isTch='ontouchstart'in window||navigator.maxTouchPoints>0;
  const sGrid=document.createElement('div');sGrid.style.cssText='display:grid;grid-template-columns:repeat('+(_isTch?6:8)+',1fr);gap:'+(_isTch?'3':'2')+'px;margin-bottom:2px';
  function applyThemeToWin(t,btn,allBtns){
    winEl.style.setProperty('--bg',t.bg);winEl.style.setProperty('--surface',t.surface);
    winEl.style.setProperty('--s2',t.s2);winEl.style.setProperty('--s3',t.s3);
    winEl.style.setProperty('--border',t.border);winEl.style.setProperty('--text',t.text);
    winEl.style.setProperty('--dim',t.dim);
    winEl.setAttribute('data-mod-theme',t.name);
    pop.querySelectorAll('.mt-btn').forEach(x=>{x.style.borderWidth='1px';x.style.borderColor=x.dataset.bc||'transparent'});
    btn.style.borderColor='#fff';btn.style.borderWidth='2px';
  }
  SOLIDS.forEach(t=>{
    const b=document.createElement('button');b.className='mt-btn';b.dataset.bc=t.border;
    b.style.cssText=`height:${_isTch?28:18}px;border-radius:${_isTch?4:3}px;border:1px solid ${t.border};cursor:pointer;background:${t.surface};transition:all .1s;position:relative;-webkit-tap-highlight-color:transparent`;
    b.title=t.name;
    if(winEl.getAttribute('data-mod-theme')===t.name){b.style.borderColor='#fff';b.style.borderWidth='2px'}
    const applyFn=()=>applyThemeToWin(t,b);
    b.addEventListener('click',applyFn);
    if(_isTch)b.addEventListener('touchend',e=>{e.preventDefault();applyFn()},{passive:false});
    sGrid.appendChild(b)});
  pop.appendChild(sGrid);
  // === STUDIO THEMES ===
  const tLbl=document.createElement('div');tLbl.style.cssText='font-size:5px;font-weight:800;color:var(--dim);letter-spacing:.4px;opacity:.6';tLbl.textContent='THEMES';
  pop.appendChild(tLbl);
  const grid=document.createElement('div');grid.style.cssText='display:grid;grid-template-columns:repeat('+(_isTch?4:5)+',1fr);gap:'+(_isTch?'3':'2')+'px;overflow-y:auto;flex:1;min-height:0;-webkit-overflow-scrolling:touch';
  if(typeof THEMES!=='undefined')THEMES.forEach(t=>{
    const b=document.createElement('button');b.className='mt-btn';b.dataset.bc=t.border;
    b.style.cssText=`height:${_isTch?28:20}px;border-radius:${_isTch?4:3}px;border:1px solid ${t.border};cursor:pointer;background:linear-gradient(135deg,${t.bg},${t.surface});position:relative;transition:all .1s;overflow:hidden;-webkit-tap-highlight-color:transparent`;
    const nm=document.createElement('span');nm.style.cssText='font-size:'+(_isTch?'6':'4')+'px;color:'+t.text+';font-weight:700;letter-spacing:.3px;position:absolute;bottom:1px;left:2px;right:2px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis';nm.textContent=t.name;
    b.appendChild(nm);
    if(winEl.getAttribute('data-mod-theme')===t.name){b.style.borderColor='#fff';b.style.borderWidth='2px'}
    const applyFn=()=>applyThemeToWin(t,b);
    b.addEventListener('click',applyFn);
    if(_isTch)b.addEventListener('touchend',e=>{e.preventDefault();applyFn()},{passive:false});
    grid.appendChild(b)});
  pop.appendChild(grid);
  document.body.appendChild(pop);
  const closePop=e=>{if(!pop.contains(e.target)&&e.target!==anchor){pop.remove();document.removeEventListener('pointerdown',closePop);document.removeEventListener('touchstart',closePop)}};
  setTimeout(()=>{document.addEventListener('pointerdown',closePop);document.addEventListener('touchstart',closePop,{passive:true})},100);
}

// === TAB FILTER ===
document.getElementById('chTabs').addEventListener('click',e=>{const t=e.target.closest('.chtab');if(!t)return;aTab=t.dataset.ch;document.querySelectorAll('.chtab').forEach(x=>x.classList.toggle('active',x.dataset.ch===aTab));filt()});
function filt(){_rebuildModIndex();mods.forEach(m=>{if(m.ci<0)m.el.classList.remove('hidden');else m.el.classList.toggle('hidden',aTab!=='all'&&String(m.ci)!==aTab)})}

// === CLIPBOARD SYSTEM ===
let _clip=null;
const _clipUp=[];
const CLIP_KEYS=['wv','oct','vol','a','d','s','r','ff','fr','det'];
function clipCopy(mod){
  const d={type:mod.type,from:mod.id};
  CLIP_KEYS.forEach(k=>{if(mod[k]!==undefined)d[k]=mod[k]});
  if(mod.type==='chord'&&mod.slots)d.slots=mod.slots.map(s=>({root:s.root,type:s.type}));
  if(mod.type==='chord')d.stepsPerChord=mod.stepsPerChord;
  if(mod.type==='note'&&mod.grid){d.cells=[];mod.grid.forEach((row,ri)=>row.forEach((v,ci)=>{if(v)d.cells.push([ri,ci])}))}
  if(mod.type==='note')d.inst=mod.inst;if(mod.type==='note')d.ts=mod.ts;
  if(mod.type==='drum'&&mod.getPats)d.pats=mod.getPats().map(p=>({steps:p.steps,grid:p.grid.map(r=>[...r])}));
  if(mod.type==='drum'&&mod.parts)d.parts=mod.parts.map(p=>({name:p.name,snd:p.snd,v:p.v}));
  if(mod.type==='beat'&&mod.ch)d.ch=mod.ch.map(c=>({t:c.t,s:c.s,steps:[...c.steps],v:c.v}));
  if(mod.type==='bass')d.mode=mod.mode;
  if(mod.type==='inst'){['iIdx','i2Idx','chord','bend','rvbMix','dlMix','dlTime','detune'].forEach(k=>{if(mod[k]!==undefined)d[k]=mod[k]})}
  if(mod.type==='piano')d.sus=mod.sus;
  _clip=d;_clipUp.forEach(fn=>fn());
  const badge=mod.el.querySelector('.wbadge');
  if(badge){const old=badge.textContent;badge.textContent='COPIED';badge.style.background='#14b8a6';
    setTimeout(()=>{badge.textContent=old;badge.style.background=CHR[mod.ci>=0?mod.ci:0]},800)}
}
function clipPaste(mod){
  if(!_clip)return;
  CLIP_KEYS.forEach(k=>{if(_clip[k]!==undefined&&mod[k]!==undefined)mod[k]=_clip[k]});
  if(mod.type==='chord'&&_clip.slots){mod.slots=_clip.slots.map(s=>({root:s.root,type:s.type}));if(_clip.stepsPerChord)mod.stepsPerChord=_clip.stepsPerChord}
  if(mod.type==='note'&&_clip.cells&&mod.grid){
    mod.grid.forEach(r=>r.fill(false));
    _clip.cells.forEach(([r,c])=>{if(mod.grid[r]&&c<mod.grid[r].length)mod.grid[r][c]=true});
    if(mod.buildNR)mod.buildNR()}
  if(mod.type==='note'&&_clip.inst){mod.inst=_clip.inst;
    // Update instrument buttons
    mod.el.querySelectorAll('.sws .swb').forEach(b=>{const bn=b.textContent.toLowerCase();
      b.classList.toggle('active',bn===mod.inst);b.style.background=bn===mod.inst?'':''})}
  if(mod.type==='note'&&_clip.ts&&_clip.ts!==mod.ts){mod.ts=_clip.ts;if(mod.buildNR)mod.buildNR()}
  if(mod.type==='drum'&&_clip.pats&&mod.setPats){mod.setPats(_clip.pats);if(mod.buildGrid)mod.buildGrid()}
  if(mod.type==='drum'&&_clip.parts&&mod.parts){_clip.parts.forEach((p,i)=>{if(mod.parts[i]){if(p.snd)mod.parts[i].snd=p.snd;if(p.v)mod.parts[i].v=p.v}})}
  if(mod.type==='beat'&&_clip.ch&&mod.ch){_clip.ch.forEach((c,i)=>{if(mod.ch[i]){mod.ch[i].v=c.v;c.steps.forEach((s,si)=>{mod.ch[i].steps[si]=s})}})}
  if(mod.type==='bass'&&_clip.mode)mod.mode=_clip.mode;
  if(mod.type==='inst'){['iIdx','i2Idx','chord','bend','rvbMix','dlMix','dlTime','detune'].forEach(k=>{if(_clip[k]!==undefined)mod[k]=_clip[k]})}
  if(mod.type==='piano'&&_clip.sus!==undefined)mod.sus=_clip.sus;
  // Refresh sliders
  mod.el.querySelectorAll('.sk').forEach(sl=>{const lb=sl.querySelector('label');const inp=sl.querySelector('input');const vd=sl.querySelector('.kv');
    if(!lb||!inp)return;const n=lb.textContent.toLowerCase();
    const map={oct:mod.oct,vol:(mod.vol||0)*100,det:mod.det||mod.detune||0,a:(mod.a||0)*100,d:(mod.d||0)*100,s:(mod.s||0)*100,r:(mod.r||0)*100,freq:mod.ff,res:mod.fr};
    Object.entries(map).forEach(([k,v])=>{if(n.startsWith(k)&&v!==undefined){inp.value=v;if(vd)vd.textContent=Math.round(v)}})});
  // Refresh waveform buttons
  if(mod.wv){mod.el.querySelectorAll('.swb').forEach(b=>{const bw=b.textContent.toLowerCase();
    b.classList.toggle('active',(bw==='saw'&&mod.wv==='sawtooth')||(bw==='squ'&&mod.wv==='square')||(bw==='tri'&&mod.wv==='triangle')||(bw==='sin'&&mod.wv==='sine'))})}
  if(mod.type==='chord'&&mod.renSlots)mod.renSlots();
  if(mod.type==='beat'){const wbd=mod.el.querySelector('.wbody');if(wbd)buildBG(mod,wbd)}
  const badge=mod.el.querySelector('.wbadge');
  if(badge){const old=badge.textContent;badge.textContent='PASTED';badge.style.background='#14b8a6';
    setTimeout(()=>{badge.textContent=old;badge.style.background=CHR[mod.ci>=0?mod.ci:0]},800)}
}
function addClipBtns(ct,mod){
  const cpb=document.createElement('button');cpb.className='wb';cpb.title='Copy';cpb.textContent='‚ßâ';cpb.style.fontSize='9px';
  cpb.addEventListener('click',()=>clipCopy(mod));
  const psb=document.createElement('button');psb.className='wb';psb.title='Paste';psb.textContent='‚äû';psb.style.fontSize='9px';
  psb.addEventListener('click',()=>clipPaste(mod));
  const upPaste=()=>{psb.style.opacity=_clip?'1':'.3';psb.style.pointerEvents=_clip?'auto':'none';
    psb.title=_clip?'Paste from '+_clip.type:'Nothing copied'};
  upPaste();_clipUp.push(upPaste);
  mod._clipClean=()=>{const i=_clipUp.indexOf(upPaste);if(i>=0)_clipUp.splice(i,1)};
  ct.querySelector('.min').before(cpb);ct.querySelector('.min').before(psb);
}

// === PER-CHANNEL TRANSPORT ===
function chMax(ci){let m=16;mods.forEach(x=>{if(x.ci===ci&&x.ts>m)m=x.ts});return m}
function seqIsActive(ci){
  if(seqState.mode==='all')return true;
  if(seqState.mode==='chain')return seqState.order[seqState.curIdx%seqState.order.length]===ci;
  if(seqState.mode==='ab'){
    // A/B mode: alternates between two groups
    const grpA=seqState.order.filter((_,i)=>i%2===0);
    const grpB=seqState.order.filter((_,i)=>i%2===1);
    const grp=seqState.curIdx%2===0?grpA:grpB;
    return grp.includes(ci);
  }
  if(seqState.mode==='custom'){
    const step=seqState.customPattern[seqState.curIdx%seqState.customPattern.length];
    return step&&step.includes(ci);
  }
  return true;
}
function seqAdvanceBar(){
  if(seqState.mode==='all')return;
  seqState.barCount++;
  if(seqState.barCount>=seqState.barsPerCh){
    seqState.barCount=0;
    seqState.curIdx++;
    // Apply gain changes based on active channels
    applySeqGains();
    _seqUp.forEach(fn=>fn());
  }
}
function applySeqGains(){
  if(seqState.mode==='all'){chs.forEach((c,i)=>{if(c.g)c.g.gain.value=c.mut?0:c.vol/100});applyChGains();return}
  const anySolo=chs.some(c=>c.solo);
  chs.forEach((c,i)=>{
    if(!c.g)return;
    const active=seqIsActive(i);
    if(anySolo)c.g.gain.value=(c.solo&&!c.mut&&active)?c.vol/100:0;
    else c.g.gain.value=(active&&!c.mut)?c.vol/100:0;
  });
}
function chSched(ci){
  const ch=chs[ci];if(!ch.on)return;
  const bpm=ch.bpm,sw=ch.sw/100,sd=(60/bpm)/4;
  const ms=chMax(ci);
  while(ch.nxt<ctx.currentTime+.1){
    const s=(ch.step+1)%ms;ch.step=s;
    let t=ch.nxt;if(s%2===1)t+=sd*sw*.5;
    // Track bars for sequencing (a bar = ms steps)
    seqState.stepInBar++;
    if(seqState.stepInBar>=ms){seqState.stepInBar=0;if(ci===0||!chs[0].on)seqAdvanceBar()}
    const _cm=_modsByChannel[ci];if(_cm)_cm.forEach(m=>{if(m.onStep)m.onStep(s,t)});
    ch.nxt+=sd;
  }
  if(ch.on)ch.tid=setTimeout(()=>chSched(ci),25);
}
function startCh(ci){initA();if(ctx.state==='suspended')ctx.resume();const ch=chs[ci];if(ch.on)return;ch.on=true;ch.step=-1;ch.nxt=ctx.currentTime;ch.ts=ctx.currentTime;
  mods.forEach(m=>{if(m.ci===ci&&m.initFx)m.initFx()});
  chSched(ci);applySeqGains();updMx()}
function stopCh(ci){const ch=chs[ci];ch.on=false;ch.step=-1;clearTimeout(ch.tid);mods.forEach(m=>{if(m.ci===ci&&m.clr)m.clr()});updMx()}
function togCh(ci){chs[ci].on?stopCh(ci):startCh(ci)}
function playAll(){seqState.curIdx=0;seqState.barCount=0;seqState.stepInBar=0;for(let i=0;i<NCH;i++)startCh(i);applySeqGains()}
function stopAll(){for(let i=0;i<NCH;i++)stopCh(i);seqState.curIdx=0;seqState.barCount=0;seqState.stepInBar=0;_seqUp.forEach(fn=>fn())}

// === GLOBAL INSTRUMENT DATA (shared by INST + NOTE modules) ===
const _waf=typeof WebAudioFontPlayer!=='undefined'?new WebAudioFontPlayer():null;
const _INSTS=[
  {name:'Violin',cat:'Strings',col:'#d946ef',oct:5,file:'0400_JCLive_sf2_file',vn:'_tone_0400_JCLive_sf2_file'},
  {name:'Viola',cat:'Strings',col:'#c084fc',oct:4,file:'0410_JCLive_sf2_file',vn:'_tone_0410_JCLive_sf2_file'},
  {name:'Cello',cat:'Strings',col:'#a855f7',oct:3,file:'0420_JCLive_sf2_file',vn:'_tone_0420_JCLive_sf2_file'},
  {name:'Contrabass',cat:'Strings',col:'#7c3aed',oct:2,file:'0430_JCLive_sf2_file',vn:'_tone_0430_JCLive_sf2_file'},
  {name:'Trumpet',cat:'Brass',col:'#f59e0b',oct:5,file:'0560_JCLive_sf2_file',vn:'_tone_0560_JCLive_sf2_file'},
  {name:'Trombone',cat:'Brass',col:'#eab308',oct:3,file:'0570_JCLive_sf2_file',vn:'_tone_0570_JCLive_sf2_file'},
  {name:'Tuba',cat:'Brass',col:'#78716c',oct:2,file:'0580_JCLive_sf2_file',vn:'_tone_0580_JCLive_sf2_file'},
  {name:'Fr Horn',cat:'Brass',col:'#b45309',oct:4,file:'0600_JCLive_sf2_file',vn:'_tone_0600_JCLive_sf2_file'},
  {name:'Flute',cat:'Woodwind',col:'#06b6d4',oct:6,file:'0730_JCLive_sf2_file',vn:'_tone_0730_JCLive_sf2_file'},
  {name:'Clarinet',cat:'Woodwind',col:'#475569',oct:4,file:'0710_JCLive_sf2_file',vn:'_tone_0710_JCLive_sf2_file'},
  {name:'Oboe',cat:'Woodwind',col:'#7c3aed',oct:5,file:'0680_JCLive_sf2_file',vn:'_tone_0680_JCLive_sf2_file'},
  {name:'Sax',cat:'Woodwind',col:'#d97706',oct:4,file:'0650_JCLive_sf2_file',vn:'_tone_0650_JCLive_sf2_file'},
  {name:'Guitar',cat:'Guitar/Keys',col:'#92400e',oct:4,file:'0240_JCLive_sf2_file',vn:'_tone_0240_JCLive_sf2_file'},
  {name:'Bass Gtr',cat:'Guitar/Keys',col:'#451a03',oct:3,file:'0330_JCLive_sf2_file',vn:'_tone_0330_JCLive_sf2_file'},
  {name:'Harmonica',cat:'Woodwind',col:'#dc2626',oct:5,file:'0220_JCLive_sf2_file',vn:'_tone_0220_JCLive_sf2_file'},
  {name:'Strings',cat:'Strings',col:'#e879f9',oct:4,file:'0480_JCLive_sf2_file',vn:'_tone_0480_JCLive_sf2_file'},
  {name:'Choir',cat:'Vocal',col:'#fb7185',oct:4,file:'0520_JCLive_sf2_file',vn:'_tone_0520_JCLive_sf2_file'},
  {name:'Organ',cat:'Guitar/Keys',col:'#818cf8',oct:4,file:'0190_JCLive_sf2_file',vn:'_tone_0190_JCLive_sf2_file'},
  {name:'Harp',cat:'Strings',col:'#fbbf24',oct:5,file:'0460_JCLive_sf2_file',vn:'_tone_0460_JCLive_sf2_file'},
  {name:'Pizzicato',cat:'Strings',col:'#f472b6',oct:4,file:'0450_JCLive_sf2_file',vn:'_tone_0450_JCLive_sf2_file'},
  {name:'Timpani',cat:'Strings',col:'#a3a3a3',oct:3,file:'0470_JCLive_sf2_file',vn:'_tone_0470_JCLive_sf2_file'},
];
const _wafLoaded={};
function _wafLoad(idx,cb){
  const ins=_INSTS[idx];if(!ins)return;
  if(_wafLoaded[ins.vn]){if(cb)cb(_wafLoaded[ins.vn]);return}
  const url='https://surikov.github.io/webaudiofontdata/sound/'+ins.file+'.js';
  const s=document.createElement('script');s.src=url;
  s.onload=()=>{initA();const preset=window[ins.vn];
    if(preset&&_waf){_waf.adjustPreset(ctx,preset);_wafLoaded[ins.vn]=preset}
    if(cb)cb(preset)};
  s.onerror=()=>{if(cb)cb(null)};
  document.head.appendChild(s);
}

// === BEAT MODULE ===
const BC=[{n:'Kick',t:'kick',s:'Kick 808',c:'var(--kick)',v:.9},{n:'Snare',t:'snare',s:'Snare Crack',c:'var(--snare)',v:.8},{n:'HiHat',t:'hihat',s:'HH Closed',c:'var(--hihat)',v:.7},{n:'Clap',t:'clap',s:'Clap Tight',c:'var(--clap)',v:.75},{n:'Tom',t:'tom',s:'Tom Mid',c:'var(--tom)',v:.7},{n:'Perc',t:'perc',s:'Perc Click',c:'var(--perc)',v:.6},{n:'Bass',t:'bass',s:'Bass Saw',c:'var(--bass)',v:.8},{n:'Synth',t:'synth',s:'Synth Stab',c:'var(--synth)',v:.5}];
const BX={kick:{s:'Kick Punchy',v:.85},snare:{s:'Snare Tight',v:.75},hihat:{s:'HH Open',v:.6},clap:{s:'Clap Snap',v:.7},tom:{s:'Tom Floor',v:.65},perc:{s:'Perc Rim',v:.55},bass:{s:'Bass Sub',v:.7},synth:{s:'Synth Chord',v:.45}};

function addBeat(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('BEAT<span>.EXE</span>','Seq','var(--accent)',20+(mods.length%4)*30,20+(mods.length%4)*20,840,320,ci);
  el.id='m'+id;
  const m={id,type:'beat',el,ci,ts:16,cm:8,se:[],ds:null,ch:[]};
  BC.forEach(b=>m.ch.push({...b,mut:false,solo:false,steps:new Array(32).fill(false)}));
  m.aud=(i)=>{const a=m.ch.some(c=>c.solo);return a?m.ch[i].solo&&!m.ch[i].mut:!m.ch[i].mut};
  m.snd=(c)=>SL[c.t][c.s];
  m.dst=()=>chs[m.ci].g||mGain;
  m.onStep=(s,t)=>{const d=m.dst();m.ch.forEach((c,i)=>{if(c.steps[s]&&m.aud(i))m.snd(c)(t,c.v,ctx,d)});m.se.forEach(r=>r.forEach((e,si)=>e.classList.toggle('current',si===s)))};
  m.clr=()=>m.se.forEach(r=>r.forEach(e=>e.classList.remove('current')));
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});
  // kb
  const kb=document.createElement('button');kb.className='wb kb';kb.title='Q-I';kb.textContent='‚å®';kb.dataset.mid=id;
  kb.addEventListener('click',e=>{e.stopPropagation();setKb(id)});ct.prepend(kb);
  const BK='qwertyui';
  m._kd=e=>{if(e.repeat||_kb!==id)return;const ki=BK.indexOf(e.key.toLowerCase());if(ki>=0&&ki<m.ch.length){initA();const c=m.ch[ki];if(m.aud(ki))m.snd(c)(ctx.currentTime,c.v,ctx,m.dst())}};
  window.addEventListener('keydown',m._kd);
  m.destroy=()=>{window.removeEventListener('keydown',m._kd);if(_kb===id)_kb=null};
  // config
  const cfg=document.createElement('div');cfg.className='bcfg';
  const st=document.createElement('div');st.className='stog';
  [16,32].forEach(n=>{const b=document.createElement('button');b.textContent=n;b.className=n===16?'active':'';b.addEventListener('click',()=>{if(n===m.ts)return;m.ts=n;st.querySelectorAll('button').forEach(x=>x.classList.toggle('active',+x.textContent===n));buildBG(m,bd)});st.appendChild(b)});
  const cst=document.createElement('div');cst.className='stog';
  [8,16].forEach(n=>{const b=document.createElement('button');b.textContent=n+'CH';b.className=n===8?'active':'';b.addEventListener('click',()=>{if(n===m.cm)return;cst.querySelectorAll('button').forEach(x=>x.classList.toggle('active',x.textContent===n+'CH'));rebCh(m,n,bd)});cst.appendChild(b)});
  cfg.append(st,cst);
  // === ADVANCED PRESET SYSTEM (32 genres, 8CH + 16CH) ===
  const PR={
    hiphop:{bpm:90,snd:{0:'Kick 808',1:'Snare Crack',2:'HH Closed',3:'Clap Tight',4:'Tom Mid',5:'Perc Click',6:'Bass Saw',7:'Synth Stab'},s:[[1,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0]],s16:[[1,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick 808',1:'Kick Boom',2:'Snare Crack',3:'Snare Rim',4:'HH Closed',5:'HH Open',6:'Clap Tight',7:'Clap Snap',8:'Tom Mid',9:'Tom High',10:'Perc Click',11:'Perc Conga',12:'Bass Saw',13:'Bass 808',14:'Synth Stab',15:'Synth Chord'}},
    boombap:{bpm:88,snd:{0:'Kick Boom',1:'Snare Lo-Fi',2:'HH Open',3:'Clap Snap',4:'Tom Floor',5:'Perc Rim',6:'Bass Sub',7:'Synth Keys'},s:[[1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Boom',1:'Kick 808',2:'Snare Lo-Fi',3:'Snare Rim',4:'HH Open',5:'HH Closed',6:'Clap Snap',7:'Clap Tight',8:'Tom Floor',9:'Tom Mid',10:'Perc Rim',11:'Perc Conga',12:'Bass Sub',13:'Bass Pluck',14:'Synth Keys',15:'Synth Pad'}},
    trap:{bpm:140,snd:{0:'Kick 808',1:'Snare Tight',2:'HH Crispy',3:'Clap Tight',4:'Tom High',5:'Perc Rim',6:'Bass 808',7:'Synth Pluck'},s:[[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,1,0,1,1,0,1,1,1,1,0,1,1,0,1,1],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0]],s16:[[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,0,1,1,0,1,1,1,1,0,1,1,0,1,1],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0]],snd16:{0:'Kick 808',1:'Kick Deep',2:'Snare Tight',3:'Snare Clap',4:'HH Crispy',5:'HH Closed',6:'Clap Tight',7:'Clap Snap',8:'Tom High',9:'Tom Mid',10:'Perc Rim',11:'Perc Click',12:'Bass 808',13:'Bass Sub',14:'Synth Zap',15:'Synth Stab'}},
    phonk:{bpm:130,snd:{0:'Kick Dist',1:'Snare Lo-Fi',2:'HH Crispy',3:'Clap Big',4:'Tom Floor',5:'Perc Cowbell',6:'Bass 808',7:'Synth Stab'},s:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0]],s16:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0],[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0]],snd16:{0:'Kick Dist',1:'Kick 808',2:'Snare Lo-Fi',3:'Snare Clap',4:'HH Crispy',5:'HH Closed',6:'Clap Big',7:'Clap Snap',8:'Tom Floor',9:'Tom Mid',10:'Perc Cowbell',11:'Perc Click',12:'Bass 808',13:'Bass Dist',14:'Synth Stab',15:'Synth Zap'}},
    drill:{bpm:145,snd:{0:'Kick Punchy',1:'Snare Tight',2:'HH Closed',3:'Clap Tight',4:'Tom High',5:'Perc Rim',6:'Bass 808',7:'Synth Pluck'},s:[[1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0]],snd16:{0:'Kick Punchy',1:'Kick Tight',2:'Snare Tight',3:'Snare Rim',4:'HH Closed',5:'HH Crispy',6:'Clap Tight',7:'Clap Snap',8:'Tom High',9:'Tom Mid',10:'Perc Rim',11:'Perc Click',12:'Bass 808',13:'Bass Pluck',14:'Synth Pluck',15:'Synth Zap'}},
    memphis:{bpm:138,snd:{0:'Kick Boom',1:'Snare Lo-Fi',2:'HH Open',3:'Clap Big',4:'Tom Mid',5:'Perc Cowbell',6:'Bass 808',7:'Synth Keys'},s:[[1,0,0,0,0,0,1,0,1,0,0,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,1,0,1,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,0,0,0,1,0,1,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,1,0,1,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0]],snd16:{0:'Kick Boom',1:'Kick Dist',2:'Snare Lo-Fi',3:'Snare Clap',4:'HH Open',5:'HH Crispy',6:'Clap Big',7:'Clap Snap',8:'Tom Mid',9:'Tom Floor',10:'Perc Cowbell',11:'Perc Click',12:'Bass 808',13:'Bass Sub',14:'Synth Keys',15:'Synth Stab'}},
    cloud:{bpm:68,snd:{0:'Kick Deep',1:'Snare Lo-Fi',2:'HH Shaker',3:'Clap Snap',4:'Tom Mid',5:'Perc Click',6:'Bass Sub',7:'Synth Pad'},s:[[1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0],[0,0,1,0,0,0,1,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0],[1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,1,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Deep',1:'Kick 808',2:'Snare Lo-Fi',3:'Snare Rim',4:'HH Shaker',5:'HH Closed',6:'Clap Snap',7:'Clap Tight',8:'Tom Mid',9:'Tom High',10:'Perc Click',11:'Perc Conga',12:'Bass Sub',13:'Bass 808',14:'Synth Pad',15:'Synth Keys'}},
    house:{bpm:124,snd:{0:'Kick Punchy',1:'Snare Clap',2:'HH Open',3:'Clap Tight',4:'Tom High',5:'Perc Rim',6:'Bass Saw',7:'Synth Chord'},s:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0],[1,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0]],s16:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[1,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Punchy',1:'Kick Tight',2:'Snare Clap',3:'Snare Rim',4:'HH Open',5:'HH Closed',6:'Clap Tight',7:'Clap Snap',8:'Tom High',9:'Tom Mid',10:'Perc Rim',11:'Perc Cowbell',12:'Bass Saw',13:'Bass Pluck',14:'Synth Chord',15:'Synth Stab'}},
    deephouse:{bpm:122,snd:{0:'Kick Deep',1:'Snare Rim',2:'HH Shaker',3:'Clap Snap',4:'Tom Floor',5:'Perc Conga',6:'Bass Sub',7:'Synth Pad'},s:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0]],snd16:{0:'Kick Deep',1:'Kick Punchy',2:'Snare Rim',3:'Snare Clap',4:'HH Shaker',5:'HH Open',6:'Clap Snap',7:'Clap Tight',8:'Tom Floor',9:'Tom Mid',10:'Perc Conga',11:'Perc Rim',12:'Bass Sub',13:'Bass Pluck',14:'Synth Pad',15:'Synth Chord'}},
    techno:{bpm:132,snd:{0:'Kick Tight',1:'Snare Rim',2:'HH Closed',3:'Clap Big',4:'Tom High',5:'Perc Click',6:'Bass Square',7:'Synth Zap'},s:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0]],s16:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0],[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Tight',1:'Kick Punchy',2:'Snare Rim',3:'Snare Clap',4:'HH Closed',5:'HH Open',6:'Clap Big',7:'Clap Snap',8:'Tom High',9:'Tom Floor',10:'Perc Click',11:'Perc Cowbell',12:'Bass Saw',13:'Bass Square',14:'Synth Zap',15:'Synth Pluck'}},
    hardtechno:{bpm:148,snd:{0:'Kick Dist',1:'Snare Tight',2:'HH Crispy',3:'Clap Big',4:'Tom Floor',5:'Perc Cowbell',6:'Bass Dist',7:'Synth Zap'},s:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0]],s16:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0],[0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1]],snd16:{0:'Kick Dist',1:'Kick Tight',2:'Snare Tight',3:'Snare Crack',4:'HH Crispy',5:'HH Closed',6:'Clap Big',7:'Clap Snap',8:'Tom Floor',9:'Tom High',10:'Perc Cowbell',11:'Perc Rim',12:'Bass Dist',13:'Bass Saw',14:'Synth Zap',15:'Synth Stab'}},
    trance:{bpm:138,snd:{0:'Kick Punchy',1:'Snare Crack',2:'HH Open',3:'Clap Tight',4:'Tom Mid',5:'Perc Click',6:'Bass Saw',7:'Synth Pad'},s:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Punchy',1:'Kick Tight',2:'Snare Crack',3:'Snare Clap',4:'HH Open',5:'HH Closed',6:'Clap Tight',7:'Clap Big',8:'Tom Mid',9:'Tom High',10:'Perc Click',11:'Perc Rim',12:'Bass Saw',13:'Bass Pluck',14:'Synth Pad',15:'Synth Chord'}},
    minimal:{bpm:126,snd:{0:'Kick Tight',1:'Snare Rim',2:'HH Closed',3:'Clap Snap',4:'Tom Mid',5:'Perc Click',6:'Bass Pluck',7:'Synth Pluck'},s:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0],[0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Tight',1:'Kick Punchy',2:'Snare Rim',3:'Snare Crack',4:'HH Closed',5:'HH Crispy',6:'Clap Snap',7:'Clap Tight',8:'Tom Mid',9:'Tom High',10:'Perc Click',11:'Perc Rim',12:'Bass Pluck',13:'Bass Sub',14:'Synth Pluck',15:'Synth Keys'}},
    electro:{bpm:128,snd:{0:'Kick Punchy',1:'Snare Crack',2:'HH Crispy',3:'Clap Big',4:'Tom High',5:'Perc Cowbell',6:'Bass Square',7:'Synth Stab'},s:[[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0]],s16:[[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Punchy',1:'Kick Tight',2:'Snare Crack',3:'Snare Tight',4:'HH Crispy',5:'HH Open',6:'Clap Big',7:'Clap Snap',8:'Tom High',9:'Tom Floor',10:'Perc Cowbell',11:'Perc Click',12:'Bass Square',13:'Bass Saw',14:'Synth Stab',15:'Synth Zap'}},
    dnb:{bpm:174,snd:{0:'Kick Tight',1:'Snare Crack',2:'HH Closed',3:'Clap Snap',4:'Tom High',5:'Perc Rim',6:'Bass Square',7:'Synth Pluck'},s:[[1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0]],s16:[[1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1]],snd16:{0:'Kick Tight',1:'Kick Punchy',2:'Snare Crack',3:'Snare Rim',4:'HH Closed',5:'HH Open',6:'Clap Snap',7:'Clap Tight',8:'Tom High',9:'Tom Mid',10:'Perc Rim',11:'Perc Click',12:'Bass Saw',13:'Bass Pluck',14:'Synth Stab',15:'Synth Zap'}},
    jungle:{bpm:165,snd:{0:'Kick Boom',1:'Snare Crack',2:'HH Open',3:'Clap Tight',4:'Tom Mid',5:'Perc Rim',6:'Bass Sub',7:'Synth Chord'},s:[[1,0,0,0,0,1,0,0,0,0,1,0,0,1,0,0],[0,0,0,0,1,0,0,1,0,0,0,0,0,0,1,0],[1,1,0,1,0,1,1,0,1,1,0,1,0,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,0,0,1,0,0,0,0,1,0,0,1,0,0],[0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0],[0,0,0,0,1,0,0,1,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,0,1,0,1,1,0,1,1,0,1,0,1,1,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0]],snd16:{0:'Kick Boom',1:'Kick Tight',2:'Snare Crack',3:'Snare Rim',4:'HH Open',5:'HH Closed',6:'Clap Tight',7:'Clap Snap',8:'Tom Mid',9:'Tom Floor',10:'Perc Rim',11:'Perc Click',12:'Bass Sub',13:'Bass Pluck',14:'Synth Chord',15:'Synth Zap'}},
    dubstep:{bpm:140,snd:{0:'Kick Deep',1:'Snare Crack',2:'HH Closed',3:'Clap Big',4:'Tom Floor',5:'Perc Rim',6:'Bass Dist',7:'Synth Zap'},s:[[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0]],s16:[[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Deep',1:'Kick Dist',2:'Snare Crack',3:'Snare Clap',4:'HH Closed',5:'HH Open',6:'Clap Big',7:'Clap Snap',8:'Tom Floor',9:'Tom Mid',10:'Perc Rim',11:'Perc Cowbell',12:'Bass Dist',13:'Bass 808',14:'Synth Zap',15:'Synth Stab'}},
    garage:{bpm:132,snd:{0:'Kick Punchy',1:'Snare Clap',2:'HH Shaker',3:'Clap Tight',4:'Tom High',5:'Perc Click',6:'Bass Pluck',7:'Synth Pluck'},s:[[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0]],s16:[[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Punchy',1:'Kick Tight',2:'Snare Clap',3:'Snare Rim',4:'HH Shaker',5:'HH Open',6:'Clap Tight',7:'Clap Snap',8:'Tom High',9:'Tom Mid',10:'Perc Click',11:'Perc Rim',12:'Bass Pluck',13:'Bass Saw',14:'Synth Chord',15:'Synth Stab'}},
    reggaeton:{bpm:95,snd:{0:'Kick Punchy',1:'Snare Rim',2:'HH Closed',3:'Clap Tight',4:'Tom Mid',5:'Perc Conga',6:'Bass 808',7:'Synth Stab'},s:[[1,0,0,1,0,0,0,1,1,0,0,1,0,0,0,1],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,1,0,0,0,1,1,0,0,1,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Punchy',1:'Kick Boom',2:'Snare Rim',3:'Snare Clap',4:'HH Closed',5:'HH Shaker',6:'Clap Tight',7:'Clap Snap',8:'Tom Mid',9:'Tom High',10:'Perc Conga',11:'Perc Click',12:'Bass 808',13:'Bass Sub',14:'Synth Stab',15:'Synth Keys'}},
    afrobeats:{bpm:108,snd:{0:'Kick Boom',1:'Snare Rim',2:'HH Shaker',3:'Clap Snap',4:'Tom Mid',5:'Perc Conga',6:'Bass Pluck',7:'Synth Keys'},s:[[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[1,0,1,0,0,1,1,0,1,0,1,0,0,1,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1]],s16:[[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],[1,0,1,0,0,1,1,0,1,0,1,0,0,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Boom',1:'Kick 808',2:'Snare Rim',3:'Snare Clap',4:'HH Shaker',5:'HH Closed',6:'Clap Snap',7:'Clap Tight',8:'Tom Mid',9:'Tom High',10:'Perc Conga',11:'Perc Click',12:'Bass Pluck',13:'Bass Sub',14:'Synth Keys',15:'Synth Pad'}},
    dancehall:{bpm:100,snd:{0:'Kick Boom',1:'Snare Clap',2:'HH Open',3:'Clap Tight',4:'Tom High',5:'Perc Conga',6:'Bass 808',7:'Synth Chord'},s:[[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Boom',1:'Kick Punchy',2:'Snare Clap',3:'Snare Rim',4:'HH Open',5:'HH Closed',6:'Clap Tight',7:'Clap Snap',8:'Tom High',9:'Tom Mid',10:'Perc Conga',11:'Perc Cowbell',12:'Bass 808',13:'Bass Sub',14:'Synth Chord',15:'Synth Keys'}},
    samba:{bpm:105,snd:{0:'Kick Boom',1:'Snare Rim',2:'HH Shaker',3:'Clap Snap',4:'Tom High',5:'Perc Conga',6:'Bass Sub',7:'Synth Keys'},s:[[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0],[0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0],[0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Boom',1:'Kick Punchy',2:'Snare Rim',3:'Snare Crack',4:'HH Shaker',5:'HH Crispy',6:'Clap Snap',7:'Clap Tight',8:'Tom High',9:'Tom Mid',10:'Perc Conga',11:'Perc Click',12:'Bass Sub',13:'Bass Pluck',14:'Synth Keys',15:'Synth Pad'}},
    reggae:{bpm:76,snd:{0:'Kick Deep',1:'Snare Rim',2:'HH Shaker',3:'Clap Snap',4:'Tom Floor',5:'Perc Rim',6:'Bass Sub',7:'Synth Chord'},s:[[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0]],s16:[[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Deep',1:'Kick Boom',2:'Snare Rim',3:'Snare Lo-Fi',4:'HH Shaker',5:'HH Closed',6:'Clap Snap',7:'Clap Tight',8:'Tom Floor',9:'Tom Mid',10:'Perc Rim',11:'Perc Conga',12:'Bass Sub',13:'Bass 808',14:'Synth Chord',15:'Synth Keys'}},
    cumbia:{bpm:95,snd:{0:'Kick Boom',1:'Snare Crack',2:'HH Shaker',3:'Clap Snap',4:'Tom High',5:'Perc Conga',6:'Bass Pluck',7:'Synth Keys'},s:[[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0],[0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Boom',1:'Kick Punchy',2:'Snare Crack',3:'Snare Rim',4:'HH Shaker',5:'HH Closed',6:'Clap Snap',7:'Clap Tight',8:'Tom High',9:'Tom Mid',10:'Perc Conga',11:'Perc Cowbell',12:'Bass Pluck',13:'Bass Sub',14:'Synth Keys',15:'Synth Chord'}},
    amapiano:{bpm:115,snd:{0:'Kick Deep',1:'Snare Rim',2:'HH Shaker',3:'Clap Snap',4:'Tom Floor',5:'Perc Conga',6:'Bass 808',7:'Synth Keys'},s:[[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0]],s16:[[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Deep',1:'Kick Boom',2:'Snare Rim',3:'Snare Lo-Fi',4:'HH Shaker',5:'HH Closed',6:'Clap Snap',7:'Clap Tight',8:'Tom Floor',9:'Tom Mid',10:'Perc Conga',11:'Perc Click',12:'Bass 808',13:'Bass Sub',14:'Synth Keys',15:'Synth Pad'}},
    lofi:{bpm:78,snd:{0:'Kick Boom',1:'Snare Lo-Fi',2:'HH Shaker',3:'Clap Snap',4:'Tom Mid',5:'Perc Click',6:'Bass Sub',7:'Synth Pad'},s:[[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,0,0,0,1,0,0,0,1,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,1,0,0,0,1,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Boom',1:'Kick 808',2:'Snare Lo-Fi',3:'Snare Rim',4:'HH Shaker',5:'HH Closed',6:'Clap Snap',7:'Clap Tight',8:'Tom Mid',9:'Tom High',10:'Perc Click',11:'Perc Conga',12:'Bass Sub',13:'Bass Pluck',14:'Synth Pad',15:'Synth Keys'}},
    chillhop:{bpm:85,snd:{0:'Kick 808',1:'Snare Lo-Fi',2:'HH Closed',3:'Clap Snap',4:'Tom Mid',5:'Perc Rim',6:'Bass Pluck',7:'Synth Keys'},s:[[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0],[0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick 808',1:'Kick Boom',2:'Snare Lo-Fi',3:'Snare Rim',4:'HH Closed',5:'HH Shaker',6:'Clap Snap',7:'Clap Tight',8:'Tom Mid',9:'Tom High',10:'Perc Rim',11:'Perc Conga',12:'Bass Pluck',13:'Bass Sub',14:'Synth Keys',15:'Synth Pad'}},
    rnb:{bpm:72,snd:{0:'Kick 808',1:'Snare Lo-Fi',2:'HH Closed',3:'Clap Snap',4:'Tom Floor',5:'Perc Click',6:'Bass Sub',7:'Synth Pad'},s:[[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick 808',1:'Kick Deep',2:'Snare Lo-Fi',3:'Snare Rim',4:'HH Closed',5:'HH Shaker',6:'Clap Snap',7:'Clap Tight',8:'Tom Floor',9:'Tom Mid',10:'Perc Click',11:'Perc Conga',12:'Bass Sub',13:'Bass 808',14:'Synth Pad',15:'Synth Keys'}},
    pop:{bpm:115,snd:{0:'Kick Punchy',1:'Snare Crack',2:'HH Open',3:'Clap Tight',4:'Tom High',5:'Perc Click',6:'Bass Pluck',7:'Synth Chord'},s:[[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0]],s16:[[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Punchy',1:'Kick 808',2:'Snare Crack',3:'Snare Clap',4:'HH Open',5:'HH Closed',6:'Clap Tight',7:'Clap Snap',8:'Tom High',9:'Tom Mid',10:'Perc Click',11:'Perc Cowbell',12:'Bass Pluck',13:'Bass Saw',14:'Synth Chord',15:'Synth Stab'}},
    synthwave:{bpm:118,snd:{0:'Kick Punchy',1:'Snare Clap',2:'HH Open',3:'Clap Big',4:'Tom Mid',5:'Perc Cowbell',6:'Bass Square',7:'Synth Pad'},s:[[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Punchy',1:'Kick Tight',2:'Snare Clap',3:'Snare Crack',4:'HH Open',5:'HH Closed',6:'Clap Big',7:'Clap Snap',8:'Tom Mid',9:'Tom High',10:'Perc Cowbell',11:'Perc Click',12:'Bass Saw',13:'Bass Square',14:'Synth Pad',15:'Synth Chord'}},
    disco:{bpm:120,snd:{0:'Kick Punchy',1:'Snare Crack',2:'HH Open',3:'Clap Tight',4:'Tom High',5:'Perc Cowbell',6:'Bass Pluck',7:'Synth Chord'},s:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,1,0,1,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0],[1,0,0,0,0,0,1,0,1,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Punchy',1:'Kick Tight',2:'Snare Crack',3:'Snare Clap',4:'HH Open',5:'HH Closed',6:'Clap Tight',7:'Clap Snap',8:'Tom High',9:'Tom Mid',10:'Perc Cowbell',11:'Perc Click',12:'Bass Pluck',13:'Bass Saw',14:'Synth Chord',15:'Synth Keys'}},
    funk:{bpm:108,snd:{0:'Kick Punchy',1:'Snare Crack',2:'HH Open',3:'Clap Snap',4:'Tom Floor',5:'Perc Cowbell',6:'Bass Pluck',7:'Synth Keys'},s:[[1,0,0,0,0,0,1,0,0,0,1,0,0,1,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,0,0,0,1,0,0,0,1,0,0,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,1],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Punchy',1:'Kick Boom',2:'Snare Crack',3:'Snare Rim',4:'HH Open',5:'HH Closed',6:'Clap Snap',7:'Clap Tight',8:'Tom Floor',9:'Tom Mid',10:'Perc Cowbell',11:'Perc Conga',12:'Bass Pluck',13:'Bass Saw',14:'Synth Keys',15:'Synth Stab'}},
    jersey:{bpm:140,snd:{0:'Kick Tight',1:'Snare Tight',2:'HH Crispy',3:'Clap Snap',4:'Tom High',5:'Perc Click',6:'Bass Square',7:'Synth Pluck'},s:[[1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0]],s16:[[1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Tight',1:'Kick Punchy',2:'Snare Tight',3:'Snare Rim',4:'HH Crispy',5:'HH Closed',6:'Clap Snap',7:'Clap Tight',8:'Tom High',9:'Tom Mid',10:'Perc Click',11:'Perc Rim',12:'Bass Square',13:'Bass Pluck',14:'Synth Pluck',15:'Synth Zap'}},
    footwork:{bpm:160,snd:{0:'Kick Tight',1:'Snare Tight',2:'HH Crispy',3:'Clap Big',4:'Tom High',5:'Perc Click',6:'Bass Sub',7:'Synth Zap'},s:[[1,0,1,0,0,0,1,0,1,0,0,0,1,0,1,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[1,1,0,1,0,1,1,0,1,1,0,1,0,1,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,1,0,0,0,1,0,1,0,0,0,1,0,1,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,0,1,0,1,1,0,1,1,0,1,0,1,1,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1]],snd16:{0:'Kick Tight',1:'Kick Punchy',2:'Snare Tight',3:'Snare Crack',4:'HH Crispy',5:'HH Closed',6:'Clap Big',7:'Clap Tight',8:'Tom High',9:'Tom Mid',10:'Perc Click',11:'Perc Rim',12:'Bass Sub',13:'Bass Pluck',14:'Synth Zap',15:'Synth Stab'}},
    industrial:{bpm:130,snd:{0:'Kick Dist',1:'Snare Crack',2:'HH Crispy',3:'Clap Big',4:'Tom Floor',5:'Perc Cowbell',6:'Bass Dist',7:'Synth Zap'},s:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0]],s16:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0],[0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1]],snd16:{0:'Kick Dist',1:'Kick Tight',2:'Snare Crack',3:'Snare Tight',4:'HH Crispy',5:'HH Closed',6:'Clap Big',7:'Clap Snap',8:'Tom Floor',9:'Tom Mid',10:'Perc Cowbell',11:'Perc Rim',12:'Bass Dist',13:'Bass Saw',14:'Synth Zap',15:'Synth Stab'}},
    hardstyle:{bpm:150,snd:{0:'Kick Dist',1:'Snare Crack',2:'HH Closed',3:'Clap Big',4:'Tom Floor',5:'Perc Cowbell',6:'Bass Dist',7:'Synth Stab'},s:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Dist',1:'Kick Tight',2:'Snare Crack',3:'Snare Tight',4:'HH Closed',5:'HH Open',6:'Clap Big',7:'Clap Snap',8:'Tom Floor',9:'Tom Mid',10:'Perc Cowbell',11:'Perc Rim',12:'Bass Dist',13:'Bass Saw',14:'Synth Stab',15:'Synth Zap'}},
    jazz:{bpm:120,snd:{0:'Kick Boom',1:'Snare Rim',2:'HH Closed',3:'Clap Snap',4:'Tom High',5:'Perc Click',6:'Bass Pluck',7:'Synth Keys'},s:[[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Boom',1:'Kick Deep',2:'Snare Rim',3:'Snare Lo-Fi',4:'HH Closed',5:'HH Open',6:'Clap Snap',7:'Clap Tight',8:'Tom High',9:'Tom Mid',10:'Perc Click',11:'Perc Conga',12:'Bass Pluck',13:'Bass Sub',14:'Synth Keys',15:'Synth Pad'}},
    bossa:{bpm:75,snd:{0:'Kick Deep',1:'Snare Rim',2:'HH Shaker',3:'Clap Snap',4:'Tom High',5:'Perc Conga',6:'Bass Sub',7:'Synth Pad'},s:[[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,1,0,0,0,0,0,1,0,0,0,1,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],s16:[[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,1,0,0,0,0,0,1,0,0,0,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],snd16:{0:'Kick Deep',1:'Kick Boom',2:'Snare Rim',3:'Snare Lo-Fi',4:'HH Shaker',5:'HH Closed',6:'Clap Snap',7:'Clap Tight',8:'Tom High',9:'Tom Mid',10:'Perc Conga',11:'Perc Click',12:'Bass Sub',13:'Bass Pluck',14:'Synth Pad',15:'Synth Keys'}}
  };
  // Tile preset across grid, apply sounds
  function applyBeatPreset(key){const p=PR[key];if(!p)return;chs[m.ci].bpm=p.bpm;updMx();
    const is16=m.cm===16;const pat=is16&&p.s16?p.s16:p.s;const sndMap=is16&&p.snd16?p.snd16:p.snd;
    m.ch.forEach((c,i)=>{c.steps.fill(false);
      if(sndMap&&sndMap[i]!==undefined){const sn=sndMap[i];if(SL[c.t]&&SL[c.t][sn])c.s=sn}
      if(pat[i]){const src=pat[i];for(let tile=0;tile<Math.ceil(m.ts/src.length);tile++){
        for(let s=0;s<src.length;s++){const pos=tile*src.length+s;if(pos<m.ts)c.steps[pos]=!!src[s]}}}});buildBG(m,bd)}
  const preSel=document.createElement('select');
  preSel.style.cssText='background:var(--s3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:7px;font-weight:700;padding:2px 4px;border-radius:2px;cursor:pointer;outline:none';
  const defOpt=document.createElement('option');defOpt.value='';defOpt.textContent='PRESET';defOpt.disabled=true;defOpt.selected=true;preSel.appendChild(defOpt);
  const _prCats={'‚îÄ‚îÄ Hip-Hop ‚îÄ‚îÄ':0,hiphop:'Hip-Hop',boombap:'Boom Bap',trap:'Trap',phonk:'Phonk',drill:'Drill',memphis:'Memphis',cloud:'Cloud Rap','‚îÄ‚îÄ Electronic ‚îÄ‚îÄ':0,house:'House',deephouse:'Deep House',techno:'Techno',hardtechno:'Hard Techno',trance:'Trance',minimal:'Minimal',electro:'Electro','‚îÄ‚îÄ Bass ‚îÄ‚îÄ':0,dnb:'DnB',jungle:'Jungle',dubstep:'Dubstep',garage:'UK Garage','‚îÄ‚îÄ World ‚îÄ‚îÄ':0,reggaeton:'Reggaeton',afrobeats:'Afrobeats',dancehall:'Dancehall',samba:'Samba',reggae:'Reggae',cumbia:'Cumbia',amapiano:'Amapiano','‚îÄ‚îÄ Chill ‚îÄ‚îÄ':0,lofi:'Lo-Fi',chillhop:'Chill Hop',rnb:'R&B','‚îÄ‚îÄ Pop / Retro ‚îÄ‚îÄ':0,pop:'Pop',synthwave:'Synthwave',disco:'Disco',funk:'Funk','‚îÄ‚îÄ Club ‚îÄ‚îÄ':0,jersey:'Jersey Club',footwork:'Footwork','‚îÄ‚îÄ Aggressive ‚îÄ‚îÄ':0,industrial:'Industrial',hardstyle:'Hardstyle','‚îÄ‚îÄ Jazz ‚îÄ‚îÄ':0,jazz:'Jazz',bossa:'Bossa Nova'};
  Object.entries(_prCats).forEach(([k,v])=>{if(v===0){const g=document.createElement('optgroup');g.label=k;preSel.appendChild(g)}else{const o=document.createElement('option');o.value=k;o.textContent=v;const last=preSel.querySelector('optgroup:last-of-type');if(last)last.appendChild(o);else preSel.appendChild(o)}});
  preSel.addEventListener('change',()=>{applyBeatPreset(preSel.value);preSel.selectedIndex=0});
  cfg.appendChild(preSel);
  const clrBtnB=document.createElement('button');clrBtnB.className='pbtn';clrBtnB.textContent='CLR';
  clrBtnB.addEventListener('click',()=>{m.ch.forEach(c=>c.steps.fill(false));buildBG(m,bd)});
  cfg.appendChild(clrBtnB);
  bd.appendChild(cfg);buildBG(m,bd);
  addClipBtns(ct,m);ct.querySelector('.close').addEventListener('click',()=>{if(m._clipClean)m._clipClean();rmMod(id)});
  wsI.appendChild(el);mods.push(m);filt();
}
function buildBG(m,bd){
  let w=bd.querySelector('.bgw');if(w)w.remove();w=document.createElement('div');w.className='bgw';
  const nm=document.createElement('div');nm.className='bnums';
  for(let s=0;s<m.ts;s++){const n=document.createElement('div');n.className='bnum'+(s%4===0?' bb':'');n.textContent=s+1;nm.appendChild(n)}
  w.appendChild(nm);const g=document.createElement('div');g.className='bg';m.se=[];
  m.ch.forEach((ch,ci)=>{
    const r=document.createElement('div');r.className='br';
    const lb=document.createElement('div');lb.className='bl';
    const nn=document.createElement('span');nn.className='bn';nn.style.color=ch.c;nn.textContent=ch.n;
    const mt=document.createElement('div');mt.className='bm'+(ch.mut?' muted':'');mt.textContent='M';mt.addEventListener('click',()=>{ch.mut=!ch.mut;mt.classList.toggle('muted')});
    const sl=document.createElement('div');sl.className='bs_btn'+(ch.solo?' soloed':'');sl.textContent='S';sl.addEventListener('click',()=>{ch.solo=!ch.solo;sl.classList.toggle('soloed')});
    const vl=document.createElement('input');vl.type='range';vl.className='bv';vl.min=0;vl.max=100;vl.value=ch.v*100;vl.addEventListener('input',()=>{ch.v=vl.value/100});
    const se=document.createElement('select');se.className='bsel';Object.keys(SL[ch.t]).forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;if(ch.s===s)o.selected=true;se.appendChild(o)});se.addEventListener('change',()=>{ch.s=se.value});
    lb.append(nn,mt,sl,vl,se);r.appendChild(lb);
    const sc=document.createElement('div');sc.className='bsteps';const sr=[];
    for(let s=0;s<m.ts;s++){const st=document.createElement('div');st.className='bstep'+(s%4===0?' bm4':'');
      if(ch.steps[s]){st.classList.add('on');st.style.background=ch.c;st.style.borderColor=ch.c}
      st.addEventListener('mousedown',e=>{e.preventDefault();ch.steps[s]=!ch.steps[s];st.classList.toggle('on');
        if(ch.steps[s]){st.style.background=ch.c;st.style.borderColor=ch.c}else{st.style.background='';st.style.borderColor=''}
        if(ch.steps[s]&&m.aud(ci)){initA();m.snd(ch)(ctx.currentTime,ch.v,ctx,m.dst())}
        m.ds={v:ch.steps[s],ci,c:ch.c}});
      st.addEventListener('touchstart',e=>{e.preventDefault();ch.steps[s]=!ch.steps[s];st.classList.toggle('on');
        if(ch.steps[s]){st.style.background=ch.c;st.style.borderColor=ch.c}else{st.style.background='';st.style.borderColor=''}
        if(ch.steps[s]&&m.aud(ci)){initA();m.snd(ch)(ctx.currentTime,ch.v,ctx,m.dst())}
        m.ds={v:ch.steps[s],ci,c:ch.c}},{passive:false});
      st.addEventListener('mouseenter',()=>{if(m.ds&&m.ds.ci===ci){ch.steps[s]=m.ds.v;st.classList.toggle('on',ch.steps[s]);if(ch.steps[s]){st.style.background=m.ds.c;st.style.borderColor=m.ds.c}else{st.style.background='';st.style.borderColor=''}}});
      sc.appendChild(st);sr.push(st)}
    r.appendChild(sc);m.se.push(sr);g.appendChild(r)});
  w.appendChild(g);bd.appendChild(w);window.addEventListener('mouseup',()=>{m.ds=null});window.addEventListener('touchend',()=>{m.ds=null});
}
function rebCh(m,mode,bd){m.cm=mode;const sv=m.ch.map(c=>({t:c.t,s:c.s,steps:[...c.steps],v:c.v,mut:c.mut,solo:c.solo}));m.ch.length=0;
  BC.forEach((b,i)=>{const s=sv[i];m.ch.push({...b,mut:s?s.mut:false,solo:s?s.solo:false,s:s?s.s:b.s,v:s?s.v:b.v,steps:s?s.steps:new Array(32).fill(false)});
    if(mode===16){const ex=BX[b.t];const si=sv[i+8];m.ch.push({n:b.n+'2',t:b.t,c:b.c,s:si?si.s:ex.s,v:si?si.v:ex.v,mut:si?si.mut:false,solo:si?si.solo:false,steps:si?si.steps:new Array(32).fill(false)})}
  });buildBG(m,bd)}

// === SYNTH MODULE ===
function addSynth(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('SYNTH<span>.EXE</span>','Synth','var(--a2)',880+(mods.length%4)*30,20+(mods.length%4)*20,500,280,ci);
  el.id='m'+id;
  const m={id,type:'synth',el,ci,ts:0,wv:'sawtooth',det:5,a:.01,d:.2,s:.5,r:.3,ff:4000,fr:1,vol:.6,oct:4,an:{},
    nn:['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'],km:{a:0,w:1,s:2,e:3,d:4,f:5,t:6,g:7,y:8,h:9,u:10,j:11,k:12}};
  m.dst=()=>chs[m.ci].g||mGain;
  m.nf=(n,o)=>440*Math.pow(2,(n-9)/12+(o-4));
  m.play=(note,vel=.8)=>{if(!ctx)return;const freq=m._oscFreq||m.nf(note,m.oct),t=ctx.currentTime,dest=m.dst();
    const o1=ctx.createOscillator(),o2=ctx.createOscillator(),g=ctx.createGain(),f=ctx.createBiquadFilter();
    o1.type=m.wv;o1.frequency.value=freq;o2.type=m.wv;o2.frequency.value=freq;o2.detune.value=m.det;
    f.type='lowpass';f.frequency.value=m.ff;f.Q.value=m.fr;o1.connect(f);o2.connect(f);f.connect(g);g.connect(dest);
    g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(m.vol*vel,t+m.a);g.gain.linearRampToValueAtTime(m.vol*vel*m.s,t+m.a+m.d);
    o1.start(t);o2.start(t);m.an[note]={o1,o2,g,f}};
  m.stop=(note)=>{const n=m.an[note];if(!n)return;const t=ctx.currentTime;n.g.gain.cancelScheduledValues(t);n.g.gain.setValueAtTime(n.g.gain.value,t);n.g.gain.linearRampToValueAtTime(0,t+m.r);n.o1.stop(t+m.r+.05);n.o2.stop(t+m.r+.05);delete m.an[note]};
  m.onStep=()=>{};m.clr=()=>{};
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});
  const top=document.createElement('div');top.className='st';
  const osc=document.createElement('div');osc.className='ss';osc.innerHTML='<div class="sst">OSC</div>';
  const wr=document.createElement('div');wr.className='sws';
  ['sine','triangle','sawtooth','square'].forEach(w=>{const b=document.createElement('button');b.className='swb'+(m.wv===w?' active':'');b.textContent=w==='sawtooth'?'SAW':w.slice(0,3).toUpperCase();b.addEventListener('click',()=>{m.wv=w;wr.querySelectorAll('.swb').forEach(x=>x.classList.remove('active'));b.classList.add('active')});wr.appendChild(b)});
  osc.appendChild(wr);const kr=document.createElement('div');kr.className='skr';
  kr.append(mkK('Det',0,50,m.det,v=>{m.det=v}),mkK('Oct',2,6,m.oct,v=>{m.oct=Math.round(v)},1));
  osc.appendChild(kr);top.appendChild(osc);
  const env=document.createElement('div');env.className='ss';env.innerHTML='<div class="sst">ENV</div>';
  const er=document.createElement('div');er.className='skr';
  er.append(mkK('A',0,100,m.a*100,v=>{m.a=v/100}),mkK('D',0,100,m.d*100,v=>{m.d=v/100}),mkK('S',0,100,m.s*100,v=>{m.s=v/100}),mkK('R',0,100,m.r*100,v=>{m.r=v/100}));
  env.appendChild(er);top.appendChild(env);
  const fl=document.createElement('div');fl.className='ss';fl.innerHTML='<div class="sst">FLT</div>';
  const flr=document.createElement('div');flr.className='skr';
  flr.append(mkK('Freq',50,18000,m.ff,v=>{m.ff=v}),mkK('Res',0,20,m.fr,v=>{m.fr=v}),mkK('Vol',0,100,m.vol*100,v=>{m.vol=v/100}));
  fl.appendChild(flr);top.appendChild(fl);bd.appendChild(top);
  const keybd=document.createElement('div');keybd.className='skb';
  const whites=[0,2,4,5,7,9,11,12],bp={1:1,3:2,6:4,8:5,10:6};
  whites.forEach(note=>{const k=document.createElement('div');k.className='swk';k.dataset.note=note;const l=document.createElement('span');l.className='kl';l.textContent=m.nn[note%12];k.appendChild(l);
    k.addEventListener('mousedown',e=>{e.preventDefault();initA();m.play(note);k.classList.add('active')});k.addEventListener('mouseup',()=>{m.stop(note);k.classList.remove('active')});k.addEventListener('mouseleave',()=>{m.stop(note);k.classList.remove('active')});keybd.appendChild(k)});
  Object.entries(bp).forEach(([note,pos])=>{const k=document.createElement('div');k.className='sbk';k.dataset.note=note;k.style.left=((pos-1)/whites.length*100+100/whites.length*0.6)+'%';
    k.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();initA();m.play(+note);k.classList.add('active')});k.addEventListener('mouseup',()=>{m.stop(+note);k.classList.remove('active')});k.addEventListener('mouseleave',()=>{m.stop(+note);k.classList.remove('active')});keybd.appendChild(k)});
  bd.appendChild(keybd);
  const kbb=document.createElement('button');kbb.className='wb kb';kbb.title='A-K';kbb.textContent='‚å®';kbb.dataset.mid=id;
  kbb.addEventListener('click',e=>{e.stopPropagation();setKb(id)});ct.prepend(kbb);
  const kd=e=>{if(e.repeat||_kb!==id)return;const n=m.km[e.key.toLowerCase()];if(n!==undefined){initA();m.play(n);const k=keybd.querySelector(`[data-note="${n}"]`);if(k)k.classList.add('active')}};
  const ku=e=>{if(_kb!==id)return;const n=m.km[e.key.toLowerCase()];if(n!==undefined){m.stop(n);const k=keybd.querySelector(`[data-note="${n}"]`);if(k)k.classList.remove('active')}};
  window.addEventListener('keydown',kd);window.addEventListener('keyup',ku);
  m.destroy=()=>{window.removeEventListener('keydown',kd);window.removeEventListener('keyup',ku);Object.keys(m.an).forEach(n=>m.stop(+n));if(_kb===id)_kb=null;if(m._clipClean)m._clipClean()};
  addClipBtns(ct,m);ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}
function mkK(l,mn,mx,v,fn,rnd){const w=document.createElement('div');w.className='sk';const lb=document.createElement('label');lb.textContent=l;const i=document.createElement('input');i.type='range';i.min=mn;i.max=mx;i.value=v;const vd=document.createElement('span');vd.className='kv';vd.textContent=rnd?Math.round(v):v;i.addEventListener('input',()=>{const x=+i.value;fn(x);vd.textContent=rnd?Math.round(x):x});w.append(lb,i,vd);return w}

// === FX MODULE ===
function addFx(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('FX<span>.EXE</span>','FX','var(--purple)',20+(mods.length%4)*30,360+(mods.length%4)*20,540,210,ci);
  el.id='m'+id;
  const st={reverb:{on:false,mix:.3,decay:.8},delay:{on:false,time:.25,fb:.35,mix:.25},dist:{on:false,amt:.4},filter:{on:false,freq:2000},chorus:{on:false,rate:.4,depth:.4},phaser:{on:false,rate:.5,depth:.6},comp:{on:false,thr:.5,rat:.6},crush:{on:false,bits:.5,mix:.4},vinyl:{on:false,crackle:.3,hiss:.2},wobble:{on:false,rate:.25,depth:.3},lofi:{on:false,cut:3000,noise:.15},sat:{on:false,drive:.5,mix:.7},
    trem:{on:false,rate:.4,depth:.6},ring:{on:false,freq:.3,mix:.5},flang:{on:false,rate:.3,depth:.5,fb:.4},limit:{on:false,thr:.7,rel:.3},gate:{on:false,thr:.3,att:.5},eq:{on:false,lo:50,mid:50,hi:50},pshift:{on:false,semi:.5,mix:.6}};
  const nd={};
  let _fxBusMode=false,_fxBusIdx=-1; // -1=channel mode, 0-7=bus mode
  let _fxConnectedNode=null; // track which node we actually wired into
  function _fxSourceGain(){
    if(_fxBusMode&&_fxBusIdx>=0){
      if(typeof ARR_BUSES!=='undefined'&&ARR_BUSES[_fxBusIdx])return ARR_BUSES[_fxBusIdx];
    }
    return chs[m.ci].g;
  }
  function initFx(){
    if(!ctx)initA();
    if(!ctx||nd.ok)return;const existFx=mods.find(x=>x.type==='fx'&&x.ci===m.ci&&x.id!==id&&x._fxActive&&!_fxBusMode);
    if(existFx&&!_fxBusMode){nd.ok=true;nd._noRoute=true;return}
    nd.ok=true;if(!_fxBusMode)m._fxActive=true;
    const _out=chs[m.ci].scDuck||mGain;
    const chG=_fxSourceGain();if(!chG)return;
    _fxConnectedNode=chG;

    // === STEP 1: Disconnect channel gain from everything FIRST ===
    try{chG.disconnect()}catch(e){}

    // === STEP 2: Build DRY INSERT CHAIN ===
    // chG ‚Üí dist ‚Üí flt ‚Üí loFlt ‚Üí cmp ‚Üí [post chain] ‚Üí mGain
    nd.dist=ctx.createWaveShaper();nd.dist.oversample='4x';
    // Linear passthrough curve (not null ‚Äî null can throw in some browsers)
    const linCurve=new Float32Array(2);linCurve[0]=-1;linCurve[1]=1;nd.dist.curve=linCurve;
    nd.flt=ctx.createBiquadFilter();nd.flt.type='lowpass';nd.flt.frequency.value=20000;nd.flt.Q.value=1;
    nd.loFlt=ctx.createBiquadFilter();nd.loFlt.type='lowpass';nd.loFlt.frequency.value=20000;nd.loFlt.Q.value=0;
    nd.cmp=ctx.createDynamicsCompressor();nd.cmp.threshold.value=0;nd.cmp.ratio.value=1;nd.cmp.knee.value=12;

    // Post-insert chain: fixed order so multiple can be active simultaneously
    // cmp ‚Üí wobDl ‚Üí tremG ‚Üí eqLo ‚Üí eqMid ‚Üí eqHi ‚Üí limiter ‚Üí mGain
    nd.wobDl=ctx.createDelay(.05);nd.wobDl.delayTime.value=.01;
    nd.wobLfo=ctx.createOscillator();nd.wobLfo.type='sine';nd.wobLfo.frequency.value=.5;
    nd.wobDepth=ctx.createGain();nd.wobDepth.gain.value=0;
    nd.wobLfo.connect(nd.wobDepth);nd.wobDepth.connect(nd.wobDl.delayTime);nd.wobLfo.start();

    nd.tremG=ctx.createGain();nd.tremG.gain.value=1;
    nd.tremLfo=ctx.createOscillator();nd.tremLfo.type='sine';nd.tremLfo.frequency.value=4;
    nd.tremDepth=ctx.createGain();nd.tremDepth.gain.value=0;
    nd.tremLfo.connect(nd.tremDepth);nd.tremDepth.connect(nd.tremG.gain);nd.tremLfo.start();

    nd.eqLo=ctx.createBiquadFilter();nd.eqLo.type='lowshelf';nd.eqLo.frequency.value=320;nd.eqLo.gain.value=0;
    nd.eqMid=ctx.createBiquadFilter();nd.eqMid.type='peaking';nd.eqMid.frequency.value=1000;nd.eqMid.Q.value=1;nd.eqMid.gain.value=0;
    nd.eqHi=ctx.createBiquadFilter();nd.eqHi.type='highshelf';nd.eqHi.frequency.value=3200;nd.eqHi.gain.value=0;

    nd.limiter=ctx.createDynamicsCompressor();nd.limiter.threshold.value=0;nd.limiter.ratio.value=1;
    nd.limiter.knee.value=0;nd.limiter.attack.value=.001;nd.limiter.release.value=.05;

    // Wire fixed post chain
    chG.connect(nd.dist);nd.dist.connect(nd.flt);nd.flt.connect(nd.loFlt);nd.loFlt.connect(nd.cmp);
    nd.cmp.connect(nd.wobDl);nd.wobDl.connect(nd.tremG);nd.tremG.connect(nd.eqLo);
    nd.eqLo.connect(nd.eqMid);nd.eqMid.connect(nd.eqHi);nd.eqHi.connect(nd.limiter);nd.limiter.connect(_out);

    // === STEP 3: Build SEND effects (all tap from chG, output to mGain) ===

    // Reverb: convolver with generated IR
    nd.rvC=ctx.createConvolver();nd.rvG=ctx.createGain();nd.rvG.gain.value=0;
    nd._rebuildIR=function(decayTime){
      const len=Math.max(.1,decayTime)*2;
      const rl=Math.round(ctx.sampleRate*len);
      const rb=ctx.createBuffer(2,rl,ctx.sampleRate);
      const decayExp=1+decayTime*4; // longer decay = slower falloff
      for(let ch=0;ch<2;ch++){const a=rb.getChannelData(ch);
        for(let i=0;i<rl;i++)a[i]=(Math.random()*2-1)*Math.pow(1-i/rl,decayExp)}
      nd.rvC.buffer=rb};
    nd._rebuildIR(st.reverb.decay);
    chG.connect(nd.rvC);nd.rvC.connect(nd.rvG);nd.rvG.connect(_out);

    // Delay: delay ‚Üí wet + feedback loop
    nd.dl=ctx.createDelay(2);nd.dl.delayTime.value=.25;
    nd.dlG=ctx.createGain();nd.dlG.gain.value=0;
    nd.dlFb=ctx.createGain();nd.dlFb.gain.value=0;
    chG.connect(nd.dl);nd.dl.connect(nd.dlG);nd.dlG.connect(_out);nd.dl.connect(nd.dlFb);nd.dlFb.connect(nd.dl);

    // Chorus: modulated delay
    nd.chDl=ctx.createDelay(.05);nd.chDl.delayTime.value=.015;
    nd.chLfo=ctx.createOscillator();nd.chLfo.type='sine';nd.chLfo.frequency.value=1;
    nd.chDepth=ctx.createGain();nd.chDepth.gain.value=0;
    nd.chLfo.connect(nd.chDepth);nd.chDepth.connect(nd.chDl.delayTime);nd.chLfo.start();
    nd.chG=ctx.createGain();nd.chG.gain.value=0;
    chG.connect(nd.chDl);nd.chDl.connect(nd.chG);nd.chG.connect(_out);

    // Phaser: 4-stage allpass
    nd.phLfo=ctx.createOscillator();nd.phLfo.type='sine';nd.phLfo.frequency.value=.5;
    nd.phAPs=[];nd.phLfoGs=[];
    for(let i=0;i<4;i++){
      const ap=ctx.createBiquadFilter();ap.type='allpass';ap.frequency.value=1000;ap.Q.value=.5;
      nd.phAPs.push(ap);
      const lg=ctx.createGain();lg.gain.value=0;
      nd.phLfo.connect(lg);lg.connect(ap.frequency);nd.phLfoGs.push(lg)}
    nd.phLfo.start();
    nd.phG=ctx.createGain();nd.phG.gain.value=0;
    chG.connect(nd.phAPs[0]);
    for(let i=0;i<3;i++)nd.phAPs[i].connect(nd.phAPs[i+1]);
    nd.phAPs[3].connect(nd.phG);nd.phG.connect(_out);

    // Bitcrush
    nd.crushIn=true;
    try{
      nd.crushNode=ctx.createScriptProcessor(2048,1,1);
      let phaseAcc=0;let lastSample=0;
      nd.crushNode.onaudioprocess=function(e){
        if(!st.crush.on)return;
        const inp=e.inputBuffer.getChannelData(0),out=e.outputBuffer.getChannelData(0);
        const bits=Math.max(1,Math.round(1+st.crush.bits*15));
        const step=Math.pow(.5,bits);
        const ratioReduce=Math.max(.05,1-st.crush.mix*.9);
        for(let i=0;i<inp.length;i++){
          phaseAcc+=ratioReduce;
          if(phaseAcc>=1){phaseAcc-=1;lastSample=step*Math.floor(inp[i]/step+.5)}
          out[i]=lastSample}};
      nd.crushWet=ctx.createGain();nd.crushWet.gain.value=0;
      chG.connect(nd.crushNode);nd.crushNode.connect(nd.crushWet);nd.crushWet.connect(_out);
    }catch(e){nd.crushIn=false}

    // Vinyl crackle + hiss
    nd.vinylG=ctx.createGain();nd.vinylG.gain.value=0;nd.vinylG.connect(_out);
    nd.hissG=ctx.createGain();nd.hissG.gain.value=0;nd.hissG.connect(_out);
    nd.crackBuf=ctx.createBuffer(1,ctx.sampleRate*2,ctx.sampleRate);
    const cd=nd.crackBuf.getChannelData(0);for(let i=0;i<cd.length;i++)cd[i]=Math.random()>.97?(Math.random()*2-1)*.6:0;
    nd.crackSrc=ctx.createBufferSource();nd.crackSrc.buffer=nd.crackBuf;nd.crackSrc.loop=true;
    const crFlt=ctx.createBiquadFilter();crFlt.type='highpass';crFlt.frequency.value=1000;
    nd.crackSrc.connect(crFlt);crFlt.connect(nd.vinylG);nd.crackSrc.start();
    nd.hissBuf=ctx.createBuffer(1,ctx.sampleRate*2,ctx.sampleRate);
    const hd=nd.hissBuf.getChannelData(0);for(let i=0;i<hd.length;i++)hd[i]=(Math.random()*2-1)*.15;
    nd.hissSrc=ctx.createBufferSource();nd.hissSrc.buffer=nd.hissBuf;nd.hissSrc.loop=true;
    const hiFlt=ctx.createBiquadFilter();hiFlt.type='highpass';hiFlt.frequency.value=4000;
    nd.hissSrc.connect(hiFlt);hiFlt.connect(nd.hissG);nd.hissSrc.start();

    // Lo-fi noise layer
    nd.loNoiseG=ctx.createGain();nd.loNoiseG.gain.value=0;nd.loNoiseG.connect(_out);
    nd.loNoiseBuf=ctx.createBuffer(1,ctx.sampleRate*2,ctx.sampleRate);
    const lnd=nd.loNoiseBuf.getChannelData(0);for(let i=0;i<lnd.length;i++)lnd[i]=(Math.random()*2-1)*.08;
    nd.loNoiseSrc=ctx.createBufferSource();nd.loNoiseSrc.buffer=nd.loNoiseBuf;nd.loNoiseSrc.loop=true;
    const loNFlt=ctx.createBiquadFilter();loNFlt.type='bandpass';loNFlt.frequency.value=2000;loNFlt.Q.value=.5;
    nd.loNoiseSrc.connect(loNFlt);loNFlt.connect(nd.loNoiseG);nd.loNoiseSrc.start();

    // Saturation: pre-gain ‚Üí tanh waveshaper ‚Üí wet
    nd.satPre=ctx.createGain();nd.satPre.gain.value=1;
    nd.satWs=ctx.createWaveShaper();nd.satWs.oversample='4x';
    nd.satWet=ctx.createGain();nd.satWet.gain.value=0;
    function setSatCurve(drive){const n=44100,cv=new Float32Array(n);const k=1+drive*20;
      for(let i=0;i<n;i++){const x=i*2/n-1;cv[i]=Math.tanh(k*x)/Math.tanh(k)}
      nd.satWs.curve=cv}
    setSatCurve(st.sat.drive);nd._setSatCurve=setSatCurve;
    chG.connect(nd.satPre);nd.satPre.connect(nd.satWs);nd.satWs.connect(nd.satWet);nd.satWet.connect(_out);

    // Ring Modulator
    nd.ringOsc=ctx.createOscillator();nd.ringOsc.type='sine';nd.ringOsc.frequency.value=200;
    nd.ringG=ctx.createGain();nd.ringG.gain.value=0;
    nd.ringOsc.connect(nd.ringG.gain);nd.ringOsc.start();
    nd.ringWet=ctx.createGain();nd.ringWet.gain.value=0;
    chG.connect(nd.ringG);nd.ringG.connect(nd.ringWet);nd.ringWet.connect(_out);

    // Flanger: short modulated delay + feedback
    nd.flDl=ctx.createDelay(.02);nd.flDl.delayTime.value=.005;
    nd.flLfo=ctx.createOscillator();nd.flLfo.type='sine';nd.flLfo.frequency.value=.5;
    nd.flDepth=ctx.createGain();nd.flDepth.gain.value=0;
    nd.flLfo.connect(nd.flDepth);nd.flDepth.connect(nd.flDl.delayTime);nd.flLfo.start();
    nd.flFb=ctx.createGain();nd.flFb.gain.value=0;
    nd.flWet=ctx.createGain();nd.flWet.gain.value=0;
    chG.connect(nd.flDl);nd.flDl.connect(nd.flWet);nd.flWet.connect(_out);
    nd.flDl.connect(nd.flFb);nd.flFb.connect(nd.flDl);

    // Gate
    nd.gateNode=null;nd.gateWet=ctx.createGain();nd.gateWet.gain.value=1;
    try{
      nd.gateNode=ctx.createScriptProcessor(2048,1,1);
      let gateOpen=true,gateEnv=1;
      nd.gateNode.onaudioprocess=function(e){
        if(!st.gate.on){const inp=e.inputBuffer.getChannelData(0);e.outputBuffer.getChannelData(0).set(inp);return}
        const inp=e.inputBuffer.getChannelData(0),out=e.outputBuffer.getChannelData(0);
        const thr=st.gate.thr*st.gate.thr*.1;const att=.001+st.gate.att*.05;
        let rms=0;for(let i=0;i<inp.length;i++)rms+=inp[i]*inp[i];rms=Math.sqrt(rms/inp.length);
        gateOpen=rms>thr;
        for(let i=0;i<inp.length;i++){gateEnv+=(gateOpen?1:0-gateEnv)*att;out[i]=inp[i]*gateEnv}};
      nd.gateWetG=ctx.createGain();nd.gateWetG.gain.value=0;
      chG.connect(nd.gateNode);nd.gateNode.connect(nd.gateWetG);nd.gateWetG.connect(_out);
    }catch(e){}

    // Pitch Shift: detune via modulated delay + crossfade
    nd.psDl1=ctx.createDelay(.5);nd.psDl1.delayTime.value=.1;
    nd.psDl2=ctx.createDelay(.5);nd.psDl2.delayTime.value=.2;
    nd.psG1=ctx.createGain();nd.psG1.gain.value=0;
    nd.psG2=ctx.createGain();nd.psG2.gain.value=0;
    nd.psWet=ctx.createGain();nd.psWet.gain.value=0;
    nd.psDl1.connect(nd.psG1);nd.psDl2.connect(nd.psG2);
    nd.psG1.connect(nd.psWet);nd.psG2.connect(nd.psWet);nd.psWet.connect(_out);
    chG.connect(nd.psDl1);chG.connect(nd.psDl2);
    nd.psLfo1=ctx.createOscillator();nd.psLfo1.type='sawtooth';nd.psLfo1.frequency.value=2;
    nd.psLfoG1=ctx.createGain();nd.psLfoG1.gain.value=0;
    nd.psLfo1.connect(nd.psLfoG1);nd.psLfoG1.connect(nd.psDl1.delayTime);nd.psLfo1.start();
    nd.psLfo2=ctx.createOscillator();nd.psLfo2.type='sawtooth';nd.psLfo2.frequency.value=2;
    nd.psLfoG2=ctx.createGain();nd.psLfoG2.gain.value=0;
    nd.psLfo2.connect(nd.psLfoG2);nd.psLfoG2.connect(nd.psDl2.delayTime);
    nd.psLfo2.start(ctx.currentTime+.25/2);

    // === STEP 4: Re-attach oscilloscope analysers ===
    mods.forEach(x=>{if(x.type==='osc'&&x.ci===m.ci&&x._scopeAn){try{chG.connect(x._scopeAn)}catch(e){}}
      if(x.type==='osc'&&x.ci===m.ci&&x._scopeAnF){try{chG.connect(x._scopeAnF)}catch(e){}}});
  }
  function setDistCurve(ws,amt){
    const k=amt*100,n=44100,c=new Float32Array(n);
    for(let i=0;i<n;i++){const x=i*2/n-1;c[i]=(3+k)*x*20*(Math.PI/180)/(Math.PI+k*Math.abs(x))}
    ws.curve=c;
  }
  function updFx(){
    if(!nd.ok||nd._noRoute)return;
    // === SEND EFFECTS (wet gains control on/off) ===
    // Reverb
    nd.rvG.gain.value=st.reverb.on?st.reverb.mix*.6:0;
    if(st.reverb.on&&nd._lastDecay!==st.reverb.decay){nd._rebuildIR(st.reverb.decay);nd._lastDecay=st.reverb.decay}
    // Delay
    nd.dlG.gain.value=st.delay.on?st.delay.mix*.6:0;
    nd.dl.delayTime.value=st.delay.time;
    nd.dlFb.gain.value=st.delay.on?st.delay.fb:0;
    // Chorus
    if(st.chorus.on){nd.chLfo.frequency.value=.2+st.chorus.rate*6;nd.chDepth.gain.value=.0005+st.chorus.depth*.003;nd.chG.gain.value=.4}
    else{nd.chG.gain.value=0;nd.chDepth.gain.value=0}
    // Phaser
    if(st.phaser.on){
      nd.phLfo.frequency.value=.1+st.phaser.rate*4;
      const d=200+st.phaser.depth*2000;
      nd.phLfoGs.forEach(g=>{g.gain.value=d});
      nd.phAPs.forEach(ap=>{ap.frequency.value=800+st.phaser.depth*1500});
      nd.phG.gain.value=.4;
    }else{nd.phG.gain.value=0;nd.phLfoGs.forEach(g=>{g.gain.value=0})}
    // Bitcrush
    if(nd.crushIn){nd.crushWet.gain.value=st.crush.on?.5:0}
    // Vinyl (self-generating ‚Äî not a send)
    nd.vinylG.gain.value=st.vinyl.on?st.vinyl.crackle*.3:0;
    nd.hissG.gain.value=st.vinyl.on?st.vinyl.hiss*.15:0;
    // Lo-fi noise layer
    if(st.lofi.on){nd.loNoiseG.gain.value=st.lofi.noise*.2}
    else{nd.loNoiseG.gain.value=0}
    // Saturation
    if(st.sat.on){nd._setSatCurve(st.sat.drive);nd.satPre.gain.value=1+st.sat.drive*3;nd.satWet.gain.value=st.sat.mix*.5}
    else{nd.satWet.gain.value=0}
    // Ring Mod
    if(st.ring.on){nd.ringOsc.frequency.value=20+st.ring.freq*2000;nd.ringWet.gain.value=st.ring.mix*.5}
    else{nd.ringWet.gain.value=0}
    // Flanger
    if(st.flang.on){nd.flLfo.frequency.value=.05+st.flang.rate*3;nd.flDepth.gain.value=.001+st.flang.depth*.004;
      nd.flFb.gain.value=st.flang.fb*.85;nd.flWet.gain.value=.4}
    else{nd.flWet.gain.value=0;nd.flFb.gain.value=0;nd.flDepth.gain.value=0}
    // Gate
    if(nd.gateNode){nd.gateWetG.gain.value=st.gate.on?.6:0}
    // Pitch Shift
    if(st.pshift.on){const semi=(st.pshift.semi-.5)*24;const rate=Math.pow(2,semi/12)*2;
      nd.psLfo1.frequency.value=rate;nd.psLfo2.frequency.value=rate;
      nd.psLfoG1.gain.value=.05;nd.psLfoG2.gain.value=.05;
      nd.psG1.gain.value=.5;nd.psG2.gain.value=.5;nd.psWet.gain.value=st.pshift.mix*.5}
    else{nd.psWet.gain.value=0;nd.psG1.gain.value=0;nd.psG2.gain.value=0;nd.psLfoG1.gain.value=0;nd.psLfoG2.gain.value=0}

    // === INSERT CHAIN EFFECTS (always in chain, controlled via params) ===
    // Distortion (insert)
    if(st.dist.on){setDistCurve(nd.dist,st.dist.amt)}
    else{
      // Linear passthrough curve
      const lin=new Float32Array(2);lin[0]=-1;lin[1]=1;nd.dist.curve=lin}
    // Filter (insert)
    nd.flt.frequency.value=st.filter.on?st.filter.freq:20000;
    // Lo-fi filter (insert)
    nd.loFlt.frequency.value=st.lofi.on?st.lofi.cut:20000;
    // Compressor (insert)
    if(st.comp.on){nd.cmp.threshold.value=-50+st.comp.thr*40;nd.cmp.ratio.value=1+st.comp.rat*19}
    else{nd.cmp.threshold.value=0;nd.cmp.ratio.value=1}
    // Wobble (always in chain ‚Äî control via depth)
    if(st.wobble.on){nd.wobLfo.frequency.value=.2+st.wobble.rate*3;nd.wobDepth.gain.value=st.wobble.depth*.003}
    else{nd.wobDepth.gain.value=0}
    // Tremolo (always in chain ‚Äî control via depth)
    if(st.trem.on){nd.tremLfo.frequency.value=.5+st.trem.rate*15;nd.tremDepth.gain.value=st.trem.depth*.5}
    else{nd.tremDepth.gain.value=0}
    // EQ (always in chain ‚Äî control via gain dB)
    if(st.eq.on){nd.eqLo.gain.value=(st.eq.lo-50)/50*15;nd.eqMid.gain.value=(st.eq.mid-50)/50*15;nd.eqHi.gain.value=(st.eq.hi-50)/50*15}
    else{nd.eqLo.gain.value=0;nd.eqMid.gain.value=0;nd.eqHi.gain.value=0}
    // Limiter (always in chain ‚Äî control via threshold/ratio)
    if(st.limit.on){nd.limiter.threshold.value=-30+st.limit.thr*30;nd.limiter.ratio.value=20;nd.limiter.knee.value=0;nd.limiter.release.value=.01+st.limit.rel*.3}
    else{nd.limiter.threshold.value=0;nd.limiter.ratio.value=1;nd.limiter.knee.value=30}
  }
  const m={id,type:'fx',el,ci,ts:0,onStep:()=>{},clr:()=>{},initFx,_nd:nd,_st:st};
  m.destroy=()=>{if(nd.ok){
    [nd.crackSrc,nd.hissSrc,nd.loNoiseSrc,nd.chLfo,nd.phLfo,nd.wobLfo,nd.tremLfo,nd.ringOsc,nd.flLfo,nd.psLfo1,nd.psLfo2].forEach(n=>{try{if(n){n.stop();n.disconnect()}}catch(e){}});
    [nd.rvC,nd.rvG,nd.dl,nd.dlG,nd.dlFb,nd.dist,nd.flt,nd.loFlt,nd.cmp,nd.crushNode,nd.gateNode,nd.satWs,nd.satPre,nd.satWet,nd.chDl,nd.chG,nd.wobDl,nd.loNoiseG,nd.vinylG,nd.hissG,nd.phG,nd.crushWet,nd.gateWetG,nd.eqLo,nd.eqMid,nd.eqHi,nd.limiter,nd.flDl,nd.flFb,nd.flWet,nd.ringG,nd.ringWet,nd.tremG,nd.tremDepth,nd.psDl1,nd.psDl2,nd.psG1,nd.psG2,nd.psWet].forEach(n=>{try{if(n)n.disconnect()}catch(e){}});
    try{const chG=_fxConnectedNode||_fxSourceGain();if(chG){chG.disconnect();chG.connect(chs[m.ci].scDuck||mGain);
      // Re-attach oscilloscope analysers
      mods.forEach(x=>{if(x.type==='osc'&&x.ci===m.ci&&x._scopeAn){try{chG.connect(x._scopeAn)}catch(e){}}
        if(x.type==='osc'&&x.ci===m.ci&&x._scopeAnF){try{chG.connect(x._scopeAnF)}catch(e){}}})}}catch(e){}
    _fxConnectedNode=null;
    nd.ok=false;m._fxActive=false}};
  sel.addEventListener('change',()=>{if(nd.ok){try{const og=_fxConnectedNode||_fxSourceGain();if(og){og.disconnect();og.connect(chs[m.ci].scDuck||mGain);
    mods.forEach(x=>{if(x.type==='osc'&&x.ci===m.ci&&x._scopeAn){try{og.connect(x._scopeAn)}catch(e){}}
      if(x.type==='osc'&&x.ci===m.ci&&x._scopeAnF){try{og.connect(x._scopeAnF)}catch(e){}}})}}catch(e){}_fxConnectedNode=null}nd.ok=false;m._fxActive=false;m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});
  // Bus mode selector ‚Äî placed in header next to CH dropdown
  const busWrap=document.createElement('div');busWrap.style.cssText='display:flex;align-items:center;gap:2px;margin-left:2px';
  const busToggle=document.createElement('button');busToggle.style.cssText='background:none;border:1px solid var(--border);color:var(--dim);font-family:inherit;font-size:6px;font-weight:700;padding:1px 5px;border-radius:3px;cursor:pointer;transition:all .12s;letter-spacing:.3px';busToggle.textContent='BUS';busToggle.title='Toggle track bus source';
  const busNav=document.createElement('div');busNav.style.cssText='display:none;align-items:center;gap:1px';
  const bDown=document.createElement('span');bDown.style.cssText='font-size:7px;cursor:pointer;color:var(--dim);padding:0 1px;line-height:1';bDown.textContent='\u25c0';
  const bUp=document.createElement('span');bUp.style.cssText='font-size:7px;cursor:pointer;color:var(--dim);padding:0 1px;line-height:1';bUp.textContent='\u25b6';
  const bPill=document.createElement('span');bPill.style.cssText='font-size:6px;font-weight:900;padding:1px 5px;border-radius:10px;color:#fff;background:#e8364f;min-width:14px;text-align:center;line-height:1.4';bPill.textContent='1';
  function _updBusUI(){
    if(_fxBusMode){
      busToggle.style.borderColor='#a855f7';busToggle.style.color='#a855f7';busToggle.style.background='rgba(168,85,247,.1)';
      busNav.style.display='flex';
      bPill.textContent=_fxBusIdx+1;bPill.style.background=BUS_COLORS[_fxBusIdx]||BUS_COLORS[0];
    }else{
      busToggle.style.borderColor='var(--border)';busToggle.style.color='var(--dim)';busToggle.style.background='none';
      busNav.style.display='none';
    }
  }
  function _switchFxSource(){
    if(nd.ok){m.destroy()}
    nd.ok=false;m._fxActive=false;
    _updBusUI();
    initA();initFx();updFx();
  }
  busToggle.addEventListener('click',e=>{e.stopPropagation();_fxBusMode=!_fxBusMode;if(_fxBusMode&&_fxBusIdx<0)_fxBusIdx=0;_switchFxSource()});
  bDown.addEventListener('click',e=>{e.stopPropagation();_fxBusIdx=(_fxBusIdx-1+8)%8;_switchFxSource()});
  bUp.addEventListener('click',e=>{e.stopPropagation();_fxBusIdx=(_fxBusIdx+1)%8;_switchFxSource()});
  busNav.append(bDown,bPill,bUp);
  busWrap.append(busToggle,busNav);
  // Insert into header after the channel selector
  const _hd=el.querySelector('.wh');
  const _selEl=_hd.querySelector('.wsel');
  _selEl.after(busWrap);

  const rk=document.createElement('div');rk.className='fxg';
  function mkFx(t,k,knobs){
    const u=document.createElement('div');u.className='fxu';const h=document.createElement('div');h.className='fxh';const n=document.createElement('span');n.className='fxn';n.textContent=t;
    const sw=document.createElement('button');sw.className='fxsw';
    sw.addEventListener('click',()=>{st[k].on=!st[k].on;sw.classList.toggle('on');u.classList.toggle('active');initA();initFx();updFx()});
    h.append(n,sw);u.appendChild(h);
    const kr=document.createElement('div');kr.className='fxks';
    knobs.forEach(x=>{const w=document.createElement('div');w.className='fxk';const l=document.createElement('label');l.textContent=x.l;
      const i=document.createElement('input');i.type='range';i.min=x.mn;i.max=x.mx;i.value=x.v;
      i.addEventListener('input',()=>{
        const v=+i.value;
        if(k==='reverb'){if(x.k==='mix')st.reverb.mix=v/100;if(x.k==='dec')st.reverb.decay=v/100}
        else if(k==='delay'){if(x.k==='time')st.delay.time=v/200;if(x.k==='fb')st.delay.fb=v/100;if(x.k==='mix')st.delay.mix=v/100}
        else if(k==='dist')st.dist.amt=v/100;
        else if(k==='filter')st.filter.freq=v;
        else if(k==='chorus'){if(x.k==='rate')st.chorus.rate=v/100;if(x.k==='depth')st.chorus.depth=v/100}
        else if(k==='phaser'){if(x.k==='rate')st.phaser.rate=v/100;if(x.k==='depth')st.phaser.depth=v/100}
        else if(k==='comp'){if(x.k==='thr')st.comp.thr=v/100;if(x.k==='rat')st.comp.rat=v/100}
        else if(k==='crush'){if(x.k==='bits')st.crush.bits=v/100;if(x.k==='mix')st.crush.mix=v/100}
        else if(k==='vinyl'){if(x.k==='crackle')st.vinyl.crackle=v/100;if(x.k==='hiss')st.vinyl.hiss=v/100}
        else if(k==='wobble'){if(x.k==='rate')st.wobble.rate=v/100;if(x.k==='depth')st.wobble.depth=v/100}
        else if(k==='lofi'){if(x.k==='cut')st.lofi.cut=v;if(x.k==='noise')st.lofi.noise=v/100}
        else if(k==='sat'){if(x.k==='drive')st.sat.drive=v/100;if(x.k==='mix')st.sat.mix=v/100}
        else if(k==='trem'){if(x.k==='rate')st.trem.rate=v/100;if(x.k==='depth')st.trem.depth=v/100}
        else if(k==='ring'){if(x.k==='freq')st.ring.freq=v/100;if(x.k==='mix')st.ring.mix=v/100}
        else if(k==='flang'){if(x.k==='rate')st.flang.rate=v/100;if(x.k==='depth')st.flang.depth=v/100;if(x.k==='fb')st.flang.fb=v/100}
        else if(k==='limit'){if(x.k==='thr')st.limit.thr=v/100;if(x.k==='rel')st.limit.rel=v/100}
        else if(k==='gate'){if(x.k==='thr')st.gate.thr=v/100;if(x.k==='att')st.gate.att=v/100}
        else if(k==='eq'){if(x.k==='lo')st.eq.lo=v;if(x.k==='mid')st.eq.mid=v;if(x.k==='hi')st.eq.hi=v}
        else if(k==='pshift'){if(x.k==='semi')st.pshift.semi=v/100;if(x.k==='mix')st.pshift.mix=v/100}
        updFx()});
      w.append(l,i);kr.appendChild(w)});
    u.appendChild(kr);return u}
  rk.append(
    mkFx('Reverb','reverb',[{l:'Mix',k:'mix',mn:0,mx:100,v:30},{l:'Decay',k:'dec',mn:10,mx:100,v:80}]),
    mkFx('Delay','delay',[{l:'Time',k:'time',mn:5,mx:100,v:50},{l:'Feed',k:'fb',mn:0,mx:90,v:35},{l:'Mix',k:'mix',mn:0,mx:100,v:25}]),
    mkFx('Distort','dist',[{l:'Drive',k:'amt',mn:0,mx:100,v:40}]),
    mkFx('Filter','filter',[{l:'Freq',k:'freq',mn:100,mx:18000,v:2000}]),
    mkFx('Chorus','chorus',[{l:'Rate',k:'rate',mn:0,mx:100,v:40},{l:'Depth',k:'depth',mn:0,mx:100,v:40}]),
    mkFx('Phaser','phaser',[{l:'Rate',k:'rate',mn:0,mx:100,v:25},{l:'Depth',k:'depth',mn:0,mx:100,v:60}]),
    mkFx('Compress','comp',[{l:'Thr',k:'thr',mn:0,mx:100,v:50},{l:'Ratio',k:'rat',mn:0,mx:100,v:60}]),
    mkFx('Bitcrush','crush',[{l:'Bits',k:'bits',mn:0,mx:100,v:50},{l:'Mix',k:'mix',mn:0,mx:100,v:40}]),
    mkFx('Vinyl','vinyl',[{l:'Crackle',k:'crackle',mn:0,mx:100,v:30},{l:'Hiss',k:'hiss',mn:0,mx:100,v:20}]),
    mkFx('Wow/Flut','wobble',[{l:'Rate',k:'rate',mn:0,mx:100,v:25},{l:'Depth',k:'depth',mn:0,mx:100,v:30}]),
    mkFx('Lo-Fi','lofi',[{l:'Cutoff',k:'cut',mn:200,mx:8000,v:3000},{l:'Noise',k:'noise',mn:0,mx:100,v:15}]),
    mkFx('Saturate','sat',[{l:'Drive',k:'drive',mn:0,mx:100,v:50},{l:'Mix',k:'mix',mn:0,mx:100,v:70}]),
    mkFx('Tremolo','trem',[{l:'Rate',k:'rate',mn:0,mx:100,v:40},{l:'Depth',k:'depth',mn:0,mx:100,v:60}]),
    mkFx('Ring Mod','ring',[{l:'Freq',k:'freq',mn:0,mx:100,v:30},{l:'Mix',k:'mix',mn:0,mx:100,v:50}]),
    mkFx('Flanger','flang',[{l:'Rate',k:'rate',mn:0,mx:100,v:30},{l:'Depth',k:'depth',mn:0,mx:100,v:50},{l:'Feed',k:'fb',mn:0,mx:100,v:40}]),
    mkFx('Limiter','limit',[{l:'Thresh',k:'thr',mn:0,mx:100,v:70},{l:'Release',k:'rel',mn:0,mx:100,v:30}]),
    mkFx('Gate','gate',[{l:'Thresh',k:'thr',mn:0,mx:100,v:30},{l:'Speed',k:'att',mn:0,mx:100,v:50}]),
    mkFx('EQ','eq',[{l:'Lo',k:'lo',mn:0,mx:100,v:50},{l:'Mid',k:'mid',mn:0,mx:100,v:50},{l:'Hi',k:'hi',mn:0,mx:100,v:50}]),
    mkFx('Pitch','pshift',[{l:'Semi',k:'semi',mn:0,mx:100,v:50},{l:'Mix',k:'mix',mn:0,mx:100,v:60}])
  );
  bd.appendChild(rk);ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}


// === PIANO MODULE ===
function addPiano(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('PIANO<span>.EXE</span>','Keys','#f472b6',40+(mods.length%4)*30,60+(mods.length%4)*20,620,220,ci);
  el.id='m'+id;
  const NN=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const m={id,type:'piano',el,ci,ts:0,wv:'triangle',det:3,a:.005,d:.15,s:.6,r:.4,ff:6000,fr:.5,vol:.55,oct:3,an:{},sus:false};
  m.dst=()=>chs[m.ci].g||mGain;
  m.nf=(n,o)=>440*Math.pow(2,(n-9)/12+(o-4));
  m.play=(note,vel=.8)=>{if(!ctx)return;if(m.an[note])m.stopN(note);
    const freq=m.nf(note%12,m.oct+Math.floor(note/12)),t=ctx.currentTime,d=m.dst();
    const o1=ctx.createOscillator(),o2=ctx.createOscillator(),g=ctx.createGain(),f=ctx.createBiquadFilter();
    o1.type=m.wv;o1.frequency.value=freq;o2.type='sine';o2.frequency.value=freq;o2.detune.value=m.det;
    f.type='lowpass';f.frequency.value=m.ff;f.Q.value=m.fr;o1.connect(f);o2.connect(f);f.connect(g);g.connect(d);
    g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(m.vol*vel,t+m.a);g.gain.linearRampToValueAtTime(m.vol*vel*m.s,t+m.a+m.d);
    o1.start(t);o2.start(t);m.an[note]={o1,o2,g}};
  m.stopN=(note)=>{const n=m.an[note];if(!n)return;const t=ctx.currentTime;n.g.gain.cancelScheduledValues(t);n.g.gain.setValueAtTime(n.g.gain.value,t);n.g.gain.linearRampToValueAtTime(0,t+m.r);n.o1.stop(t+m.r+.05);n.o2.stop(t+m.r+.05);delete m.an[note]};
  m.relSus=()=>{Object.keys(m.an).forEach(n=>m.stopN(+n));m.an={}};
  m.onStep=()=>{};m.clr=()=>{};
  sel.addEventListener('change',()=>{
    // Release all notes before switching channels to prevent orphaned oscillators
    if(m.sus)m.relSus();
    Object.keys(m.an).forEach(n=>m.stopN(+n));
    el.querySelectorAll('.pk-w.active,.pk-b.active').forEach(k=>k.classList.remove('active'));
    m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()
  });
  const ctrl=document.createElement('div');ctrl.className='piano-ctrl';
  const wsel=document.createElement('div');wsel.className='sws';
  ['sine','triangle','sawtooth','square'].forEach(w=>{const b=document.createElement('button');b.className='swb'+(m.wv===w?' active':'');b.textContent=w==='sawtooth'?'SAW':w.slice(0,3).toUpperCase();b.addEventListener('click',()=>{m.wv=w;wsel.querySelectorAll('.swb').forEach(x=>x.classList.remove('active'));b.classList.add('active')});wsel.appendChild(b)});
  ctrl.appendChild(wsel);
  ctrl.append(mkK('Oct',1,5,m.oct,v=>{m.oct=Math.round(v)},1),mkK('Vol',0,100,m.vol*100,v=>{m.vol=v/100}),mkK('Atk',0,100,m.a*1000,v=>{m.a=v/1000}),mkK('Rel',0,100,m.r*100,v=>{m.r=v/100}));
  const susBtn=document.createElement('button');susBtn.className='pbtn';susBtn.textContent='SUS';
  susBtn.addEventListener('click',()=>{m.sus=!m.sus;susBtn.style.background=m.sus?'#f472b6':'';susBtn.style.color=m.sus?'#fff':'';if(!m.sus)m.relSus()});
  ctrl.appendChild(susBtn);bd.appendChild(ctrl);
  // 3-octave keyboard
  const kb=document.createElement('div');kb.className='piano-kb';
  const isB=[0,1,0,1,0,0,1,0,1,0,1,0];let wi=0;
  for(let i=0;i<36;i++){if(!isB[i%12]){const k=document.createElement('div');k.className='pk-w';k.dataset.note=i;
    const l=document.createElement('span');l.className='pkl';if(i%12===0)l.textContent='C'+(m.oct+Math.floor(i/12));k.appendChild(l);
    k.addEventListener('mousedown',e=>{e.preventDefault();initA();m.play(i);k.classList.add('active')});
    k.addEventListener('mouseup',()=>{if(!m.sus){m.stopN(i);k.classList.remove('active')}});
    k.addEventListener('mouseleave',()=>{if(!m.sus){m.stopN(i);k.classList.remove('active')}});
    kb.appendChild(k);wi++}}
  wi=0;for(let i=0;i<36;i++){if(!isB[i%12])wi++;else{const k=document.createElement('div');k.className='pk-b';k.dataset.note=i;
    const ww=100/(21);k.style.left=(wi*ww-ww*.3)+'%';k.style.width=(ww*.6)+'%';
    k.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();initA();m.play(i);k.classList.add('active')});
    k.addEventListener('mouseup',()=>{if(!m.sus){m.stopN(i);k.classList.remove('active')}});
    k.addEventListener('mouseleave',()=>{if(!m.sus){m.stopN(i);k.classList.remove('active')}});
    kb.appendChild(k)}}
  bd.appendChild(kb);
  // keyboard: letters = white keys in order, numbers = black keys in order
  const kbb=document.createElement('button');kbb.className='wb kb';kbb.title='Letters + Numbers';kbb.textContent='‚å®';kbb.dataset.mid=id;
  kbb.addEventListener('click',e=>{e.stopPropagation();setKb(id)});ct.prepend(kbb);
  const PKEYS={};
  // white keys: C D E F G A B across 3 octaves = 21 white keys + top C = 22
  const WK='abcdefghijklmnopqrstuv';
  // black keys: C# D# F# G# A# across 3 octaves = 15 black keys
  const BKS='1234567890qwert';
  // map note indices: build from chromatic scale, separating white vs black
  const isBlk=[0,1,0,1,0,0,1,0,1,0,1,0];
  let wki=0,bki=0;
  for(let i=0;i<36;i++){
    if(isBlk[i%12]){if(bki<BKS.length){PKEYS[BKS[bki]]=i;bki++}}
    else{if(wki<WK.length){PKEYS[WK[wki]]=i;wki++}}
  }
  const kd=e=>{if(e.repeat||_kb!==id)return;const ki=PKEYS[e.key.toLowerCase()];if(ki!==undefined){initA();m.play(ki);const k=kb.querySelector(`[data-note="${ki}"]`);if(k)k.classList.add('active')}};
  const ku=e=>{if(_kb!==id)return;const ki=PKEYS[e.key.toLowerCase()];if(ki!==undefined){if(!m.sus){m.stopN(ki);const k=kb.querySelector(`[data-note="${ki}"]`);if(k)k.classList.remove('active')}}};
  window.addEventListener('keydown',kd);window.addEventListener('keyup',ku);
  m.destroy=()=>{window.removeEventListener('keydown',kd);window.removeEventListener('keyup',ku);m.relSus();if(_kb===id)_kb=null;if(m._clipClean)m._clipClean()};
  addClipBtns(ct,m);ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}
function addBass(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('BASS<span>.EXE</span>','Bass','#818cf8',100+(mods.length%4)*30,380+(mods.length%4)*20,440,200,ci);
  el.id='m'+id;
  const modes={sub:{wv:'sine',ff:200,fr:0,det:0,a:.01,d:.1,s:.9,r:.15},growl:{wv:'sawtooth',ff:800,fr:8,det:15,a:.005,d:.05,s:.7,r:.1},pluck:{wv:'square',ff:2000,fr:3,det:5,a:.001,d:.08,s:.2,r:.08},acid:{wv:'sawtooth',ff:3000,fr:12,det:0,a:.001,d:.15,s:.3,r:.05}};
  const m={id,type:'bass',el,ci,ts:0,...modes.sub,vol:.7,oct:2,an:{},mode:'sub'};
  m.dst=()=>chs[m.ci].g||mGain;
  m.nf=(n,o)=>440*Math.pow(2,(n-9)/12+(o-4));
  m.play=(note,vel=.9)=>{if(!ctx)return;if(m.an[note])m.stopN(note);
    const freq=m.nf(note,m.oct),t=ctx.currentTime,dest=m.dst();
    const o1=ctx.createOscillator(),o2=ctx.createOscillator(),g=ctx.createGain(),f=ctx.createBiquadFilter();
    o1.type=m.wv;o1.frequency.value=freq;o2.type=m.wv;o2.frequency.value=freq;o2.detune.value=m.det;
    f.type='lowpass';f.frequency.setValueAtTime(m.ff,t);f.frequency.exponentialRampToValueAtTime(Math.max(50,m.ff*.2),t+m.d+.1);f.Q.value=m.fr;
    o1.connect(f);o2.connect(f);f.connect(g);g.connect(dest);
    g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(m.vol*vel,t+m.a);g.gain.linearRampToValueAtTime(m.vol*vel*m.s,t+m.a+m.d);
    o1.start(t);o2.start(t);m.an[note]={o1,o2,g,f}};
  m.stopN=(note)=>{const n=m.an[note];if(!n)return;const t=ctx.currentTime;n.g.gain.cancelScheduledValues(t);n.g.gain.setValueAtTime(n.g.gain.value,t);n.g.gain.linearRampToValueAtTime(0,t+m.r);n.o1.stop(t+m.r+.05);n.o2.stop(t+m.r+.05);delete m.an[note]};
  m.onStep=()=>{};m.clr=()=>{};
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});
  const ctrl=document.createElement('div');ctrl.className='bass-ctrl';
  const ms=document.createElement('div');ms.className='bass-sec';ms.innerHTML='<div class="sst" style="color:#818cf8">Mode</div>';
  const msel=document.createElement('div');msel.className='sws';
  ['sub','growl','pluck','acid'].forEach(md=>{const b=document.createElement('button');b.className='swb'+(m.mode===md?' active':'');b.textContent=md.toUpperCase();
    b.addEventListener('click',()=>{m.mode=md;Object.assign(m,modes[md]);msel.querySelectorAll('.swb').forEach(x=>x.classList.remove('active'));b.classList.add('active')});msel.appendChild(b)});
  ms.appendChild(msel);ctrl.appendChild(ms);
  const ps=document.createElement('div');ps.className='bass-sec';ps.innerHTML='<div class="sst" style="color:#818cf8">Tune</div>';
  const kr=document.createElement('div');kr.className='skr';
  kr.append(mkK('Oct',1,3,m.oct,v=>{m.oct=Math.round(v)},1),mkK('Vol',0,100,m.vol*100,v=>{m.vol=v/100}),mkK('Flt',50,3000,m.ff,v=>{m.ff=v}),mkK('Res',0,20,m.fr,v=>{m.fr=v}));
  ps.appendChild(kr);ctrl.appendChild(ps);bd.appendChild(ctrl);
  const NN=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const kb=document.createElement('div');kb.className='skb';kb.style.height='50px';
  const whites=[0,2,4,5,7,9,11,12],bp={1:1,3:2,6:4,8:5,10:6};
  whites.forEach(note=>{const k=document.createElement('div');k.className='swk';k.dataset.note=note;
    const l=document.createElement('span');l.className='kl';l.textContent=NN[note%12];k.appendChild(l);
    k.addEventListener('mousedown',e=>{e.preventDefault();initA();m.play(note);k.classList.add('active')});
    k.addEventListener('mouseup',()=>{m.stopN(note);k.classList.remove('active')});
    k.addEventListener('mouseleave',()=>{m.stopN(note);k.classList.remove('active')});kb.appendChild(k)});
  Object.entries(bp).forEach(([note,pos])=>{const k=document.createElement('div');k.className='sbk';k.dataset.note=note;k.style.left=((pos-1)/whites.length*100+100/whites.length*0.6)+'%';
    k.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();initA();m.play(+note);k.classList.add('active')});
    k.addEventListener('mouseup',()=>{m.stopN(+note);k.classList.remove('active')});
    k.addEventListener('mouseleave',()=>{m.stopN(+note);k.classList.remove('active')});kb.appendChild(k)});
  bd.appendChild(kb);
  const kbb=document.createElement('button');kbb.className='wb kb';kbb.title='A-K';kbb.textContent='‚å®';kbb.dataset.mid=id;
  kbb.addEventListener('click',e=>{e.stopPropagation();setKb(id)});ct.prepend(kbb);
  const KM={a:0,w:1,s:2,e:3,d:4,f:5,t:6,g:7,y:8,h:9,u:10,j:11,k:12};
  const kd=e=>{if(e.repeat||_kb!==id)return;const n=KM[e.key.toLowerCase()];if(n!==undefined){initA();m.play(n);const k=kb.querySelector(`[data-note="${n}"]`);if(k)k.classList.add('active')}};
  const ku=e=>{if(_kb!==id)return;const n=KM[e.key.toLowerCase()];if(n!==undefined){m.stopN(n);const k=kb.querySelector(`[data-note="${n}"]`);if(k)k.classList.remove('active')}};
  window.addEventListener('keydown',kd);window.addEventListener('keyup',ku);
  m.destroy=()=>{window.removeEventListener('keydown',kd);window.removeEventListener('keyup',ku);Object.keys(m.an).forEach(n=>m.stopN(+n));if(_kb===id)_kb=null;if(m._clipClean)m._clipClean()};
  addClipBtns(ct,m);ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}

// === NOTE MODULE ‚Äî piano roll ===
function addNote(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('NOTE<span>.EXE</span>','Roll','#fbbf24',200+(mods.length%4)*30,60+(mods.length%4)*20,680,280,ci);
  el.id='m'+id;
  const ROWS=13,COLS=16,NN=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B','C'];
  const grid=Array.from({length:ROWS},()=>new Array(COLS).fill(false));
  const m={id,type:'note',el,ci,ts:COLS,oct:4,wv:'sawtooth',vol:.4,a:.005,d:.1,s:.4,r:.15,ff:3000,fr:1,det:5,cellEls:[],dragVal:null,inst:'lead',wafIdx:-1,grid};
  m.dst=()=>chs[m.ci].g||mGain;
  m.nf=(n,o)=>440*Math.pow(2,(n-9)/12+(o-4));
  const INST={
    lead:{wv:'sawtooth',det:5,a:.005,d:.1,s:.4,r:.15,ff:3000,fr:1,col:'#fbbf24'},
    pad:{wv:'sawtooth',det:12,a:.15,d:.3,s:.7,r:.4,ff:2000,fr:.5,col:'#a78bfa'},
    pluck:{wv:'triangle',det:3,a:.001,d:.06,s:.1,r:.05,ff:5000,fr:2,col:'#34d399'},
    organ:{wv:'sine',det:0,a:.005,d:.01,s:.9,r:.08,ff:8000,fr:0,col:'#fb923c'},
    bell:{wv:'sine',det:50,a:.001,d:.4,s:.05,r:.6,ff:12000,fr:0,col:'#22d3ee'},
    strings:{wv:'sawtooth',det:8,a:.2,d:.2,s:.8,r:.5,ff:1800,fr:.3,col:'#f472b6'},
    brass:{wv:'square',det:3,a:.02,d:.08,s:.6,r:.12,ff:2500,fr:3,col:'#e8364f'},
    flute:{wv:'sine',det:1,a:.05,d:.1,s:.7,r:.2,ff:4000,fr:.5,col:'#818cf8'},
    chip:{wv:'square',det:0,a:.001,d:.05,s:.3,r:.02,ff:18000,fr:0,col:'#10b981'},
    bass:{wv:'sawtooth',det:2,a:.005,d:.12,s:.5,r:.1,ff:800,fr:4,col:'#f59e0b'}
  };
  function applyInst(name){
    const p=INST[name];if(!p)return;m.inst=name;m.wafIdx=-1;
    m.wv=p.wv;m.det=p.det;m.a=p.a;m.d=p.d;m.s=p.s;m.r=p.r;m.ff=p.ff;m.fr=p.fr;
  }
  // Synth playback
  const m_playAt=(c,note,t,dest)=>{const freq=m.nf(note,m.oct);
    const o1=c.createOscillator(),o2=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();
    o1.type=m.wv;o1.frequency.value=freq;o2.type=m.wv;o2.frequency.value=freq;o2.detune.value=m.det;
    f.type='lowpass';f.frequency.value=m.ff;f.Q.value=m.fr;o1.connect(f);o2.connect(f);f.connect(g);g.connect(dest);
    const dur=m.a+m.d+m.r+.05;
    g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(m.vol,t+m.a);g.gain.linearRampToValueAtTime(m.vol*m.s,t+m.a+m.d);g.gain.linearRampToValueAtTime(0,t+m.a+m.d+m.r);
    o1.start(t);o1.stop(t+dur);o2.start(t);o2.stop(t+dur)};
  // WAF instrument playback
  const m_wafPlayAt=(note,t,dest)=>{
    if(m.wafIdx<0||!_wafLoaded[_INSTS[m.wafIdx].vn])return;
    const preset=_wafLoaded[_INSTS[m.wafIdx].vn];
    const pitch=note+(m.oct*12)+12;
    const dur=.3;
    if(_waf)_waf.queueWaveTable(ctx,dest,preset,t,pitch,dur,m.vol)};
  m.playAt=(note,t)=>{if(!ctx)return;
    if(m.wafIdx>=0)m_wafPlayAt(note,t,m.dst());
    else m_playAt(ctx,note,t,m.dst())};
  m.onStep=(s,t)=>{if(s>=m.ts)return;for(let r=0;r<ROWS;r++){if(grid[r][s])m.playAt(ROWS-1-r,t)}
    m.cellEls.forEach((row,ri)=>row.forEach((c,si)=>c.classList.toggle('current',si===s)))};
  m.clr=()=>m.cellEls.forEach(r=>r.forEach(c=>c.classList.remove('current')));
  m.renderEx=(s,t,oc,dest)=>{if(s>=m.ts)return;for(let r=0;r<ROWS;r++){if(grid[r][s]){
    if(m.wafIdx>=0)m_wafPlayAt(ROWS-1-r,t,dest);
    else m_playAt(oc,ROWS-1-r,t,dest)}}};
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});
  const ctrl=document.createElement('div');ctrl.className='piano-ctrl';
  // Mode: synth presets vs real instruments
  const modeWrap=document.createElement('div');modeWrap.style.cssText='display:flex;gap:3px;align-items:center;flex-wrap:wrap;margin-bottom:2px';
  // Synth preset buttons
  const isel=document.createElement('div');isel.className='sws';isel.style.flexWrap='wrap';
  Object.keys(INST).forEach(name=>{const b=document.createElement('button');b.className='swb'+(m.inst===name?' active':'');b.textContent=name.toUpperCase();b.style.fontSize='5px';
    if(m.inst===name)b.style.background=INST[name].col;
    b.addEventListener('click',()=>{applyInst(name);isel.querySelectorAll('.swb').forEach(x=>{x.classList.remove('active');x.style.background=''});b.classList.add('active');b.style.background=INST[name].col;wafSel.selectedIndex=0});isel.appendChild(b)});
  // WAF instrument dropdown
  const wafSel=document.createElement('select');
  wafSel.style.cssText='background:var(--s3);border:1px solid #d946ef40;color:#d946ef;font-family:inherit;font-size:6px;font-weight:700;padding:2px 4px;border-radius:3px;cursor:pointer;outline:none;min-width:80px';
  const wafDef=document.createElement('option');wafDef.value=-1;wafDef.textContent='üéª INSTRUMENT';wafDef.disabled=true;wafDef.selected=true;wafSel.appendChild(wafDef);
  const cats={};_INSTS.forEach((ins,idx)=>{if(!cats[ins.cat])cats[ins.cat]=[];cats[ins.cat].push({ins,idx})});
  Object.entries(cats).forEach(([cat,items])=>{const og=document.createElement('optgroup');og.label=cat;
    items.forEach(({ins,idx})=>{const o=document.createElement('option');o.value=idx;o.textContent=ins.name;og.appendChild(o)});
    wafSel.appendChild(og)});
  const wafStatus=document.createElement('span');wafStatus.style.cssText='font-size:5px;color:var(--dim)';
  wafSel.addEventListener('change',()=>{
    const idx=+wafSel.value;m.wafIdx=idx;m.inst='_waf';
    isel.querySelectorAll('.swb').forEach(x=>{x.classList.remove('active');x.style.background=''});
    wafStatus.textContent='Loading...';
    _wafLoad(idx,(preset)=>{wafStatus.textContent=preset?_INSTS[idx].name+' ‚úî':'Failed'})});
  modeWrap.append(isel,wafSel,wafStatus);
  ctrl.appendChild(modeWrap);
  ctrl.append(mkK('Oct',2,6,m.oct,v=>{m.oct=Math.round(v);buildNR()},1),mkK('Vol',0,100,m.vol*100,v=>{m.vol=v/100}));
  // step count toggle
  const stog=document.createElement('div');stog.className='stog';
  [16,32].forEach(n=>{const b=document.createElement('button');b.textContent=n;b.className=n===COLS?'active':'';
    b.addEventListener('click',()=>{if(n===m.ts)return;m.ts=n;stog.querySelectorAll('button').forEach(x=>x.classList.toggle('active',+x.textContent===n));
      if(n>grid[0].length){grid.forEach(r=>{while(r.length<n)r.push(false)})}buildNR()});stog.appendChild(b)});
  ctrl.appendChild(stog);
  const clrBtn=document.createElement('button');clrBtn.className='pbtn';clrBtn.textContent='CLR';clrBtn.addEventListener('click',()=>{grid.forEach(r=>r.fill(false));buildNR()});
  ctrl.appendChild(clrBtn);bd.appendChild(ctrl);
  const wrap=document.createElement('div');wrap.className='nr-wrap';wrap.style.maxHeight='190px';
  function buildNR(){
    wrap.innerHTML='';m.cellEls=[];
    const g=document.createElement('div');g.className='nr-grid';g.style.gridTemplateColumns=`28px repeat(${m.ts},1fr)`;g.style.gridTemplateRows=`repeat(${ROWS},14px)`;
    for(let r=0;r<ROWS;r++){
      const noteIdx=ROWS-1-r;
      const lbl=document.createElement('div');lbl.className='nr-label';lbl.textContent=NN[noteIdx%12]+(m.oct+Math.floor(noteIdx/12));
      if([1,3,6,8,10].includes(noteIdx%12))lbl.style.background='var(--s3)';
      lbl.style.gridRow=r+1;lbl.style.gridColumn=1;g.appendChild(lbl);
      const rowEls=[];
      for(let c=0;c<m.ts;c++){
        const cell=document.createElement('div');cell.className='nr-cell'+(c%4===0?' bar':'');
        if([1,3,6,8,10].includes(noteIdx%12))cell.style.background='rgba(255,255,255,.015)';
        cell.style.gridRow=r+1;cell.style.gridColumn=c+2;
        if(grid[r][c]){cell.classList.add('on');cell.style.background='rgba(251,191,36,.55)'}
        cell.addEventListener('mousedown',e=>{e.preventDefault();grid[r][c]=!grid[r][c];m.dragVal=grid[r][c];
          cell.classList.toggle('on');cell.style.background=grid[r][c]?'rgba(251,191,36,.55)':([1,3,6,8,10].includes(noteIdx%12)?'rgba(255,255,255,.015)':'');
          if(grid[r][c]){initA();m.playAt(noteIdx,ctx.currentTime)}});
        cell.addEventListener('mouseenter',()=>{if(m.dragVal===null)return;grid[r][c]=m.dragVal;cell.classList.toggle('on',m.dragVal);
          cell.style.background=m.dragVal?'rgba(251,191,36,.55)':([1,3,6,8,10].includes(noteIdx%12)?'rgba(255,255,255,.015)':'')});
        g.appendChild(cell);rowEls.push(cell)}
      m.cellEls.push(rowEls)}
    wrap.appendChild(g);
    window.addEventListener('mouseup',()=>{m.dragVal=null})}
  buildNR();bd.appendChild(wrap);
  m.buildNR=buildNR;
  addClipBtns(ct,m);ct.querySelector('.close').addEventListener('click',()=>{if(m._clipClean)m._clipClean();rmMod(id)});
  wsI.appendChild(el);mods.push(m);filt();
}

// === SAMPLE MODULE ‚Äî Launchpad ===
function addSample(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('SAMPLE<span>.EXE</span>','Launchpad','#34d399',560+(mods.length%4)*30,320+(mods.length%4)*20,380,310,ci);
  el.id='m'+id;
  const PAD_COLORS=['#e8364f','#f59e0b','#22d3ee','#a855f7','#f97316','#06b6d4','#10b981','#ec4899','#818cf8','#34d399','#fbbf24','#fb923c','#ef4444','#14b8a6','#8b5cf6','#f43f5e'];
  const PADS=16;
  const m={id,type:'sample',el,ci,ts:0,slots:new Array(PADS).fill(null),onStep:()=>{},clr:()=>{}};
  m.dst=()=>chs[m.ci].g||mGain;
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});
  // drop zone (compact)
  const drop=document.createElement('div');drop.className='smp-drop';drop.style.cssText='padding:6px;min-height:24px;font-size:6px;margin-bottom:6px';
  drop.textContent='‚¨Ü Drop audio files to fill pads';
  const fin=document.createElement('input');fin.type='file';fin.accept='audio/*,.wav,.mp3,.m4a,.aac,.ogg,.flac,.aiff,.caf';fin.multiple=true;fin.style.cssText='position:absolute;left:-9999px;opacity:0;width:1px;height:1px';
  drop.addEventListener('click',()=>fin.click());
  drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('over')});
  drop.addEventListener('dragleave',()=>drop.classList.remove('over'));
  drop.addEventListener('drop',e=>{e.preventDefault();drop.classList.remove('over');loadF(e.dataTransfer.files)});
  fin.addEventListener('change',()=>{if(fin.files.length)loadF(fin.files)});
  bd.appendChild(drop);bd.appendChild(fin);
  // 4x4 grid
  const grid=document.createElement('div');
  grid.style.cssText='display:grid;grid-template-columns:repeat(4,1fr);gap:4px';
  const padEls=[];
  for(let i=0;i<PADS;i++){
    const pad=document.createElement('div');
    pad.style.cssText=`height:46px;background:var(--s2);border:2px solid var(--border);border-radius:5px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;transition:all .08s;position:relative;overflow:hidden`;
    const num=document.createElement('span');num.style.cssText='font-size:8px;font-weight:800;color:rgba(255,255,255,.12);pointer-events:none';num.textContent=i+1;
    const nm=document.createElement('span');nm.style.cssText='font-size:5px;color:var(--dim);pointer-events:none;max-width:90%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap';
    pad.append(num,nm);
    // play on click
    pad.addEventListener('mousedown',e=>{e.preventDefault();trigPad(i)});
    // right-click to assign file to specific pad
    pad.addEventListener('contextmenu',e=>{e.preventDefault();
      const inp=document.createElement('input');inp.type='file';inp.accept='audio/*,.wav,.mp3,.m4a,.aac,.ogg,.flac,.aiff,.caf';
      inp.addEventListener('change',()=>{if(inp.files[0])loadToPad(i,inp.files[0])});inp.click()});
    grid.appendChild(pad);padEls.push({pad,num,nm});
  }
  bd.appendChild(grid);
  function loadF(files){
    let idx=m.slots.findIndex(s=>s===null);
    Array.from(files).forEach(f=>{
      if(idx>=PADS)return;
      const si=idx;idx=m.slots.findIndex((s,j)=>j>si&&s===null);if(idx<0)idx=PADS;
      loadToPad(si,f)})}
  function loadToPad(i,file){
    const r=new FileReader();
    r.onload=async()=>{initA();const buf=await ctx.decodeAudioData(r.result);
      m.slots[i]={name:file.name.replace(/\.[^.]+$/,'').slice(0,10),buf,src:null};
      updPad(i)};
    r.readAsArrayBuffer(file)}
  function updPad(i){
    const p=padEls[i],s=m.slots[i];
    if(s){p.pad.style.borderColor=PAD_COLORS[i];p.nm.textContent=s.name;p.num.style.color=PAD_COLORS[i]}
    else{p.pad.style.borderColor='var(--border)';p.nm.textContent='';p.num.style.color='rgba(255,255,255,.12)';p.pad.style.background='var(--s2)'}}
  function trigPad(i){
    initA();const s=m.slots[i];if(!s)return;
    if(s.src){try{s.src.stop()}catch(e){}}
    s.src=ctx.createBufferSource();s.src.buffer=s.buf;s.src.connect(m.dst());s.src.start();
    const p=padEls[i].pad;p.style.background=PAD_COLORS[i];p.style.boxShadow='0 0 16px '+PAD_COLORS[i]+'60';
    p.style.transform='scale(.95)';
    s.src.onended=()=>{p.style.background='var(--s2)';p.style.boxShadow='none';p.style.transform=''};
    setTimeout(()=>{p.style.transform=''},100)}
  m.updPad=updPad;m.trigPad=trigPad;
  // keyboard: top 2 rows = 1234 qwer, bottom 2 = asdf zxcv
  const kbb=document.createElement('button');kbb.className='wb kb';kbb.title='Grid keys';kbb.textContent='‚å®';kbb.dataset.mid=id;
  kbb.addEventListener('click',e=>{e.stopPropagation();setKb(id)});ct.prepend(kbb);
  const KMAP={'1':0,'2':1,'3':2,'4':3,'q':4,'w':5,'e':6,'r':7,'a':8,'s':9,'d':10,'f':11,'z':12,'x':13,'c':14,'v':15};
  const kd=e=>{if(e.repeat||_kb!==id)return;const i=KMAP[e.key.toLowerCase()];if(i!==undefined)trigPad(i)};
  window.addEventListener('keydown',kd);
  m.destroy=()=>{window.removeEventListener('keydown',kd);if(_kb===id)_kb=null;
    m.slots.forEach(s=>{if(s&&s.src){try{s.src.stop()}catch(e){}}})};
  // clear pad on middle-click or add clear all button
  const clrBtn=document.createElement('button');clrBtn.className='pbtn';clrBtn.style.cssText='margin-top:4px;font-size:6px';clrBtn.textContent='CLEAR ALL';
  clrBtn.addEventListener('click',()=>{m.slots.forEach((s,i)=>{if(s&&s.src){try{s.src.stop()}catch(e){}}m.slots[i]=null;updPad(i)})});
  bd.appendChild(clrBtn);
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}

// === FILE BANK MODULE ‚Äî bulk audio library ===
function addBank(){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('FILES<span>.EXE</span>','Bank','#60a5fa',40+(mods.length%4)*30,40+(mods.length%4)*20,520,440,-1);
  el.id='m'+id;el.style.zIndex=200;
  const m={id,type:'bank',el,ci:-1,ts:0,onStep:()=>{},clr:()=>{},files:[],playing:null};
  // drop zone
  const drop=document.createElement('div');drop.className='smp-drop';
  drop.style.cssText='padding:10px 8px;min-height:36px;font-size:7px;margin-bottom:4px;text-align:center;cursor:pointer;border:2px dashed rgba(96,165,250,.25);border-radius:6px;background:rgba(96,165,250,.04);color:rgba(96,165,250,.7);font-weight:700;transition:all .15s';
  drop.innerHTML='<span style="font-size:14px;display:block;margin-bottom:2px">üìÇ</span>DROP AUDIO FILES HERE<br><span style="font-size:5px;opacity:.6">or click to browse ¬∑ mp3 wav ogg flac aac</span>';
  const fin=document.createElement('input');fin.type='file';fin.accept='audio/*,.wav,.mp3,.m4a,.aac,.ogg,.flac,.aiff,.caf';fin.multiple=true;fin.style.cssText='position:absolute;left:-9999px;opacity:0;width:1px;height:1px';
  drop.addEventListener('click',()=>fin.click());
  drop.addEventListener('dragover',e=>{e.preventDefault();drop.style.borderColor='#60a5fa';drop.style.background='rgba(96,165,250,.12)'});
  drop.addEventListener('dragleave',()=>{drop.style.borderColor='rgba(96,165,250,.25)';drop.style.background='rgba(96,165,250,.04)'});
  drop.addEventListener('drop',e=>{e.preventDefault();drop.style.borderColor='rgba(96,165,250,.25)';drop.style.background='rgba(96,165,250,.04)';loadFiles(e.dataTransfer.files)});
  fin.addEventListener('change',()=>{if(fin.files.length)loadFiles(fin.files);fin.value=''});
  bd.appendChild(drop);bd.appendChild(fin);
  // toolbar
  const tbar=document.createElement('div');tbar.style.cssText='display:flex;gap:4px;align-items:center;padding:0 2px;margin-bottom:4px';
  const countEl=document.createElement('span');countEl.style.cssText='font-size:6px;color:var(--dim);font-weight:700';countEl.textContent='0 files';
  const searchIn=document.createElement('input');searchIn.type='text';searchIn.placeholder='Search...';
  searchIn.style.cssText='flex:1;background:var(--s2);border:1px solid var(--border);border-radius:3px;padding:3px 5px;color:var(--text);font-family:inherit;font-size:6px;outline:none';
  searchIn.addEventListener('input',()=>renderList());
  const sortSel=document.createElement('select');sortSel.style.cssText='background:var(--s3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:6px;font-weight:700;padding:2px 3px;border-radius:2px;cursor:pointer;outline:none';
  ['Name ‚Üë','Name ‚Üì','Duration ‚Üë','Duration ‚Üì','Added ‚Üë','Added ‚Üì'].forEach((t,i)=>{const o=document.createElement('option');o.value=i;o.textContent=t;sortSel.appendChild(o)});
  sortSel.addEventListener('change',()=>renderList());
  const clrAll=document.createElement('button');clrAll.className='pbtn';clrAll.style.cssText='font-size:5px;padding:2px 6px';clrAll.textContent='‚úï CLEAR';
  clrAll.addEventListener('click',()=>{stopPrev();m.files=[];renderList()});
  tbar.append(countEl,searchIn,sortSel,clrAll);bd.appendChild(tbar);
  // file list container
  const listWrap=document.createElement('div');listWrap.style.cssText='flex:1;overflow-y:auto;overflow-x:hidden;border:1px solid var(--border);border-radius:4px;background:var(--s2)';
  bd.appendChild(listWrap);
  // format helpers
  function fmtDur(s){if(!s||!isFinite(s))return'--:--';const m=Math.floor(s/60),ss=Math.floor(s%60);return m+':'+String(ss).padStart(2,'0')}
  function fmtSize(b){if(b<1024)return b+'B';if(b<1048576)return(b/1024).toFixed(1)+'KB';return(b/1048576).toFixed(1)+'MB'}
  function fmtSR(sr){return sr>=1000?(sr/1000).toFixed(1)+'kHz':sr+'Hz'}
  // load files
  function loadFiles(fileList){
    const arr=Array.from(fileList).filter(f=>f.type.startsWith('audio/')||/\.(mp3|wav|ogg|flac|aac|m4a|webm)$/i.test(f.name));
    if(!arr.length)return;
    let loaded=0;
    drop.innerHTML='<span style="font-size:10px">‚è≥</span> Loading '+arr.length+' file'+(arr.length>1?'s':'')+'...';
    arr.forEach(f=>{
      const r=new FileReader();
      r.onload=async()=>{
        try{
          initA();
          const buf=await ctx.decodeAudioData(r.result.slice(0));
          m.files.push({name:f.name.replace(/\.[^.]+$/,''),ext:f.name.split('.').pop().toLowerCase(),buf,size:f.size,sr:buf.sampleRate,ch:buf.numberOfChannels,dur:buf.duration,added:Date.now()});
        }catch(e){console.warn('Bank: failed to decode',f.name,e)}
        loaded++;
        if(loaded>=arr.length){
          drop.innerHTML='<span style="font-size:14px;display:block;margin-bottom:2px">üìÇ</span>DROP AUDIO FILES HERE<br><span style="font-size:5px;opacity:.6">or click to browse ¬∑ mp3 wav ogg flac aac</span>';
          renderList();
        }
      };
      r.readAsArrayBuffer(f);
    });
  }
  // stop current preview
  function stopPrev(){
    if(m.playing){try{m.playing.src.stop()}catch(e){}m.playing.row.style.background='';m.playing=null}
  }
  // preview play
  function playFile(entry,row){
    initA();if(ctx.state==='suspended')ctx.resume();
    if(m.playing&&m.playing.entry===entry){stopPrev();return}
    stopPrev();
    const src=ctx.createBufferSource();src.buffer=entry.buf;src.connect(mGain);src.start();
    row.style.background='rgba(96,165,250,.12)';
    m.playing={entry,src,row};
    src.onended=()=>{if(m.playing&&m.playing.entry===entry){row.style.background='';m.playing=null}};
  }
  // send to sample pad
  function sendToSample(entry){
    const sampleMods=mods.filter(x=>x.type==='sample');
    if(!sampleMods.length){showToast('No Sample module open');return}
    const sm=sampleMods[0];
    const idx=sm.slots.findIndex(s=>s===null);
    if(idx<0){showToast('All pads full');return}
    sm.slots[idx]={name:entry.name.slice(0,10),buf:entry.buf,src:null};
    if(sm.updPad)sm.updPad(idx);
    showToast('‚Üí Pad '+(idx+1));
  }
  // send to tape
  function sendToTape(entry){
    const tapeMods=mods.filter(x=>x.type==='tape');
    if(!tapeMods.length){showToast('No Tape module open');return}
    const tm=tapeMods[0];
    tm.buf=entry.buf;
    if(tm.drawW)tm.drawW();
    showToast('‚Üí Tape loaded');
  }
  // send to edit
  function sendToEdit(entry){
    const editMods=mods.filter(x=>x.type==='edit');
    if(!editMods.length){showToast('No Edit module open');return}
    const em=editMods[0];
    if(em.loadBuf)em.loadBuf(entry.buf);
    showToast('‚Üí Edit loaded');
  }
  // send to tracks
  function sendToTrack(entry){
    const trackMods=mods.filter(x=>x.type==='arrange');
    if(!trackMods.length){showToast('No Tracks module open');return}
    const tm=trackMods[0];
    if(tm.addTrack){tm.addTrack(entry.name,entry.buf);if(tm.render)tm.render()}
    showToast('‚Üí Track added');
  }
  // toast
  function showToast(msg){
    const t=document.createElement('div');t.style.cssText='position:fixed;bottom:60px;left:50%;transform:translateX(-50%);background:#60a5fa;color:#000;padding:4px 12px;border-radius:4px;font-size:7px;font-weight:800;z-index:9999;pointer-events:none;animation:fadeUp .4s ease';
    t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),1200);
  }
  // draw mini waveform on canvas
  function drawMiniWave(cvs,buf,color){
    const c=cvs.getContext('2d');const w=cvs.width=cvs.offsetWidth*2;const h=cvs.height=cvs.offsetHeight*2;
    c.clearRect(0,0,w,h);
    const data=buf.getChannelData(0);const step=Math.max(1,Math.floor(data.length/w));
    c.strokeStyle=color;c.lineWidth=1.5;c.beginPath();
    for(let i=0;i<w;i++){
      const idx=i*step;let mn=1,mx=-1;
      for(let j=0;j<step&&idx+j<data.length;j++){const v=data[idx+j];if(v<mn)mn=v;if(v>mx)mx=v}
      const y1=(1-mx)*h/2;const y2=(1-mn)*h/2;
      c.moveTo(i,y1);c.lineTo(i,y2);
    }
    c.stroke();
  }
  // render file list
  function renderList(){
    listWrap.innerHTML='';
    const q=searchIn.value.toLowerCase().trim();
    let list=q?m.files.filter(f=>f.name.toLowerCase().includes(q)):m.files.slice();
    // sort
    const si=+sortSel.value;
    switch(si){
      case 0:list.sort((a,b)=>a.name.localeCompare(b.name));break;
      case 1:list.sort((a,b)=>b.name.localeCompare(a.name));break;
      case 2:list.sort((a,b)=>a.dur-b.dur);break;
      case 3:list.sort((a,b)=>b.dur-a.dur);break;
      case 4:list.sort((a,b)=>a.added-b.added);break;
      case 5:list.sort((a,b)=>b.added-a.added);break;
    }
    countEl.textContent=m.files.length+' file'+(m.files.length!==1?'s':'')+(q?' ('+list.length+' match)':'');
    if(!list.length){
      const emp=document.createElement('div');emp.style.cssText='padding:20px;text-align:center;color:var(--dim);font-size:7px';
      emp.textContent=m.files.length?'No matches':'Drop files above to build your library';
      listWrap.appendChild(emp);return;
    }
    list.forEach(entry=>{
      const row=document.createElement('div');
      row.style.cssText='display:grid;grid-template-columns:28px 1fr auto;gap:0;align-items:center;padding:3px 4px;border-bottom:1px solid rgba(255,255,255,.04);cursor:pointer;transition:background .1s;min-height:30px';
      row.addEventListener('mouseenter',()=>{if(!m.playing||m.playing.entry!==entry)row.style.background='rgba(255,255,255,.03)'});
      row.addEventListener('mouseleave',()=>{if(!m.playing||m.playing.entry!==entry)row.style.background=''});
      // play button
      const playBtn=document.createElement('div');
      playBtn.style.cssText='width:20px;height:20px;border-radius:50%;background:rgba(96,165,250,.12);border:1px solid rgba(96,165,250,.3);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:8px;color:#60a5fa;transition:all .1s;flex-shrink:0';
      playBtn.textContent='‚ñ∂';
      playBtn.addEventListener('mouseenter',()=>{playBtn.style.background='rgba(96,165,250,.25)'});
      playBtn.addEventListener('mouseleave',()=>{playBtn.style.background='rgba(96,165,250,.12)'});
      playBtn.addEventListener('click',e=>{e.stopPropagation();playFile(entry,row)});
      // info block
      const info=document.createElement('div');info.style.cssText='display:flex;flex-direction:column;gap:1px;min-width:0;padding:0 6px';
      const nameRow=document.createElement('div');nameRow.style.cssText='display:flex;align-items:center;gap:4px';
      const nameEl=document.createElement('span');nameEl.style.cssText='font-size:7px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis';nameEl.textContent=entry.name;nameEl.title=entry.name+'.'+entry.ext;
      const extEl=document.createElement('span');extEl.style.cssText='font-size:5px;font-weight:700;padding:1px 3px;border-radius:2px;background:rgba(96,165,250,.15);color:#60a5fa;flex-shrink:0';extEl.textContent=entry.ext.toUpperCase();
      nameRow.append(nameEl,extEl);
      const metaRow=document.createElement('div');metaRow.style.cssText='display:flex;gap:6px;font-size:5px;color:var(--dim)';
      const dur=document.createElement('span');dur.textContent=fmtDur(entry.dur);dur.style.fontWeight='700';
      const sr=document.createElement('span');sr.textContent=fmtSR(entry.sr);
      const ch=document.createElement('span');ch.textContent=entry.ch===1?'MONO':'STEREO';
      const sz=document.createElement('span');sz.textContent=fmtSize(entry.size);
      metaRow.append(dur,sr,ch,sz);
      // mini waveform
      const waveWrap=document.createElement('div');waveWrap.style.cssText='height:14px;margin-top:1px;border-radius:2px;overflow:hidden;background:rgba(96,165,250,.04)';
      const waveCvs=document.createElement('canvas');waveCvs.style.cssText='width:100%;height:100%';
      waveWrap.appendChild(waveCvs);
      info.append(nameRow,metaRow,waveWrap);
      // action buttons
      const acts=document.createElement('div');acts.style.cssText='display:flex;flex-direction:column;gap:2px;flex-shrink:0';
      const mkABtn=(txt,title,fn)=>{
        const b=document.createElement('button');b.style.cssText='padding:2px 5px;font-size:5px;font-weight:800;font-family:inherit;border-radius:2px;border:1px solid rgba(96,165,250,.2);background:rgba(96,165,250,.08);color:#60a5fa;cursor:pointer;white-space:nowrap;transition:all .1s';
        b.textContent=txt;b.title=title;
        b.addEventListener('mouseenter',()=>{b.style.background='rgba(96,165,250,.2)'});
        b.addEventListener('mouseleave',()=>{b.style.background='rgba(96,165,250,.08)'});
        b.addEventListener('click',e=>{e.stopPropagation();fn()});return b;
      };
      acts.appendChild(mkABtn('‚Üí PAD','Send to Sample pad',()=>sendToSample(entry)));
      acts.appendChild(mkABtn('‚Üí TAPE','Load into Tape',()=>sendToTape(entry)));
      acts.appendChild(mkABtn('‚Üí EDIT','Load into Edit',()=>sendToEdit(entry)));
      acts.appendChild(mkABtn('‚Üí TRACK','Add as Track clip',()=>sendToTrack(entry)));
      const delBtn=mkABtn('‚úï','Remove from bank',()=>{stopPrev();m.files=m.files.filter(f=>f!==entry);renderList()});
      delBtn.style.borderColor='rgba(239,68,68,.2)';delBtn.style.color='#ef4444';delBtn.style.background='rgba(239,68,68,.06)';
      delBtn.addEventListener('mouseenter',()=>{delBtn.style.background='rgba(239,68,68,.15)'});
      delBtn.addEventListener('mouseleave',()=>{delBtn.style.background='rgba(239,68,68,.06)'});
      acts.appendChild(delBtn);
      row.append(playBtn,info,acts);listWrap.appendChild(row);
      // draw waveform after DOM insertion
      requestAnimationFrame(()=>drawMiniWave(waveCvs,entry.buf,'rgba(96,165,250,.5)'));
    });
  }
  // global file bank ref
  m.getFiles=()=>m.files;
  m.addFile=(name,buf,size)=>{m.files.push({name,ext:'wav',buf,size:size||0,sr:buf.sampleRate,ch:buf.numberOfChannels,dur:buf.duration,added:Date.now()});renderList()};
  m.destroy=()=>{stopPrev()};
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  // fadeUp animation
  if(!document.getElementById('bankAnim')){const sty=document.createElement('style');sty.id='bankAnim';sty.textContent='@keyframes fadeUp{from{opacity:0;transform:translateX(-50%) translateY(10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}';document.head.appendChild(sty)}
  wsI.appendChild(el);mods.push(m);filt();
}

// === TAPE MODULE ‚Äî mic looper ===
function addTape(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('TAPE<span>.EXE</span>','Looper','#fb923c',700+(mods.length%4)*30,380+(mods.length%4)*20,380,240,ci);
  el.id='m'+id;
  const m={id,type:'tape',el,ci,ts:0,onStep:()=>{},clr:()=>{},
    stream:null,mr:null,chunks:[],buf:null,src:null,rec:false,loop:false,playing:false,speed:1,startTime:0};
  m.dst=()=>chs[m.ci].g||mGain;
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});
  // === WAVEFORM DISPLAY ===
  const viz=document.createElement('div');viz.className='tape-viz';
  const cvs=document.createElement('canvas');cvs.id='tc'+id;viz.appendChild(cvs);
  // Animated reels
  const reels=document.createElement('div');reels.className='tape-reels';
  const rL=document.createElement('div');rL.className='tape-reel';rL.innerHTML='<div class="tape-reel-inner"></div>';
  const rR=document.createElement('div');rR.className='tape-reel';rR.innerHTML='<div class="tape-reel-inner"></div>';
  reels.append(rL,rR);viz.appendChild(reels);
  // Tape label
  const tLabel=document.createElement('div');tLabel.className='tape-label';tLabel.textContent='TAPE.EXE';viz.appendChild(tLabel);
  bd.appendChild(viz);
  // === TRANSPORT ===
  const transport=document.createElement('div');transport.className='tape-transport';
  const recBtn=document.createElement('button');recBtn.className='tape-btn rec';recBtn.textContent='‚óè REC';
  const playBtn=document.createElement('button');playBtn.className='tape-btn';playBtn.textContent='‚ñ∂ PLAY';
  const loopBtn=document.createElement('button');loopBtn.className='tape-btn';loopBtn.textContent='‚ü≥ LOOP';
  const stopBtn=document.createElement('button');stopBtn.className='tape-btn';stopBtn.textContent='‚ñ† STOP';
  const clrBtn=document.createElement('button');clrBtn.className='tape-btn';clrBtn.textContent='‚úï';clrBtn.title='Clear';
  // Speed control
  const spdWrap=document.createElement('div');spdWrap.style.cssText='display:flex;align-items:center;gap:2px;margin-left:auto';
  const spdLbl=document.createElement('span');spdLbl.style.cssText='font-size:5px;color:rgba(251,146,60,.4);font-weight:700';spdLbl.textContent='SPD';
  const spdSl=document.createElement('input');spdSl.type='range';spdSl.min=25;spdSl.max=200;spdSl.value=100;
  spdSl.style.cssText='width:40px;accent-color:#fb923c;height:10px';
  const spdVal=document.createElement('span');spdVal.style.cssText='font-size:5px;color:rgba(251,146,60,.5);font-weight:700;min-width:22px;text-align:center';spdVal.textContent='1.0√ó';
  spdSl.addEventListener('input',()=>{m.speed=spdSl.value/100;spdVal.textContent=m.speed.toFixed(1)+'√ó';
    if(m.src)m.src.playbackRate.value=m.speed});
  spdWrap.append(spdLbl,spdSl,spdVal);
  transport.append(recBtn,playBtn,loopBtn,stopBtn,clrBtn,spdWrap);
  bd.appendChild(transport);
  // === INFO BAR ===
  const info=document.createElement('div');info.className='tape-info';
  const infoDur=document.createElement('span');infoDur.textContent='--:--';
  const infoState=document.createElement('span');infoState.textContent='READY';
  const infoPos=document.createElement('span');infoPos.textContent='';
  info.append(infoDur,infoState,infoPos);bd.appendChild(info);
  // === REEL ANIMATION ===
  function setReels(spinning){rL.classList.toggle('spin',spinning);rR.classList.toggle('spin',spinning)}
  // === RECORDING ===
  recBtn.addEventListener('click',async()=>{
    if(m.rec){m.mr.stop();m.rec=false;recBtn.classList.remove('active');infoState.textContent='PROCESSING';setReels(false);return}
    try{m.stream=await navigator.mediaDevices.getUserMedia({audio:true});
      m.mr=new MediaRecorder(m.stream);m.chunks=[];
      m.mr.ondataavailable=e=>{if(e.data.size>0)m.chunks.push(e.data)};
      m.mr.onstop=async()=>{m.stream.getTracks().forEach(t=>t.stop());
        const blob=new Blob(m.chunks,{type:'audio/webm'});const ab=await blob.arrayBuffer();
        initA();m.buf=await ctx.decodeAudioData(ab);drawW();
        infoDur.textContent=fmtTime(m.buf.duration);infoState.textContent='READY';
        tLabel.textContent=fmtTime(m.buf.duration)+' ¬∑ '+Math.round(m.buf.sampleRate/1000)+'kHz'};
      m.mr.start();m.rec=true;recBtn.classList.add('active');infoState.textContent='‚óè RECORDING';setReels(true);
    }catch(e){infoState.textContent='‚ö† NO MIC'}});
  // === PLAYBACK ===
  function playSrc(loop){if(!m.buf||!ctx)return;stopSrc();
    m.src=ctx.createBufferSource();m.src.buffer=m.buf;m.src.connect(m.dst());
    m.src.loop=loop;m.src.playbackRate.value=m.speed;
    m.src.onended=()=>{if(!loop){m.playing=false;setReels(false);infoState.textContent='READY';playBtn.classList.remove('active')}};
    m.src.start();m.playing=true;m.startTime=ctx.currentTime;setReels(true)}
  playBtn.addEventListener('click',()=>{if(m.playing&&!m.loop){stopSrc();return}
    initA();playSrc(false);infoState.textContent='‚ñ∂ PLAYING';playBtn.classList.add('active');loopBtn.classList.remove('active');m.loop=false});
  loopBtn.addEventListener('click',()=>{if(!m.buf||!ctx)return;initA();m.loop=!m.loop;
    loopBtn.classList.toggle('active',m.loop);
    if(m.loop){playSrc(true);infoState.textContent='‚ü≥ LOOPING';playBtn.classList.remove('active')}
    else{stopSrc();infoState.textContent='READY'}});
  stopBtn.addEventListener('click',()=>{stopSrc();infoState.textContent='READY';loopBtn.classList.remove('active');playBtn.classList.remove('active');m.loop=false});
  clrBtn.addEventListener('click',()=>{stopSrc();m.buf=null;m.loop=false;
    loopBtn.classList.remove('active');playBtn.classList.remove('active');
    infoDur.textContent='--:--';infoState.textContent='READY';infoPos.textContent='';
    tLabel.textContent='TAPE.EXE';drawW()});
  function stopSrc(){if(m.src){try{m.src.stop()}catch(e){}}m.src=null;m.playing=false;setReels(false)}
  function fmtTime(s){const m2=Math.floor(s/60),ss=Math.floor(s%60);return m2+':'+(ss<10?'0':'')+ss}
  // === WAVEFORM DRAWING ===
  function drawW(){
    const c=document.getElementById('tc'+id);if(!c)return;const x=c.getContext('2d');
    c.width=c.parentElement.clientWidth;c.height=c.parentElement.clientHeight;
    const W=c.width,H=c.height;
    x.clearRect(0,0,W,H);
    // Background grid lines
    x.strokeStyle='rgba(251,146,60,.04)';x.lineWidth=1;
    x.beginPath();x.moveTo(0,H/2);x.lineTo(W,H/2);x.stroke();
    for(let i=1;i<4;i++){x.beginPath();x.moveTo(0,H*i/4);x.lineTo(W,H*i/4);x.stroke()}
    if(!m.buf){
      x.fillStyle='rgba(251,146,60,.08)';x.font='9px JetBrains Mono';x.textAlign='center';
      x.fillText('Press REC or drop audio',W/2,H/2+3);return}
    const data=m.buf.getChannelData(0),step=Math.ceil(data.length/W);
    // Filled waveform
    x.beginPath();
    for(let i=0;i<W;i++){let min=1,max=-1;
      for(let j=0;j<step;j++){const v=data[i*step+j]||0;if(v<min)min=v;if(v>max)max=v}
      const yMin=(1+min)/2*H,yMax=(1+max)/2*H;
      if(i===0){x.moveTo(0,yMin)}x.lineTo(i,yMin)}
    for(let i=W-1;i>=0;i--){let min=1,max=-1;
      for(let j=0;j<step;j++){const v=data[i*step+j]||0;if(v<min)min=v;if(v>max)max=v}
      const yMax=(1+max)/2*H;x.lineTo(i,yMax)}
    x.closePath();x.fillStyle='rgba(251,146,60,.2)';x.fill();
    // Stroke outline
    x.beginPath();x.strokeStyle='#fb923c';x.lineWidth=1;
    for(let i=0;i<W;i++){let min=1,max=-1;
      for(let j=0;j<step;j++){const v=data[i*step+j]||0;if(v<min)min=v;if(v>max)max=v}
      x.moveTo(i,(1+min)/2*H);x.lineTo(i,(1+max)/2*H)}
    x.stroke()}
  // === PLAYHEAD ANIMATION ===
  function animPlayhead(){
    if(!document.getElementById('m'+id))return;
    requestAnimationFrame(animPlayhead);
    if(!m.playing||!m.buf||!ctx)return;
    const elapsed=(ctx.currentTime-m.startTime)*m.speed;
    const pos=m.loop?elapsed%m.buf.duration:Math.min(elapsed,m.buf.duration);
    const pct=pos/m.buf.duration;
    infoPos.textContent=fmtTime(pos)+' / '+fmtTime(m.buf.duration);
    const c=document.getElementById('tc'+id);if(!c)return;
    drawW();const x=c.getContext('2d');
    // Playhead line
    const px=pct*c.width;
    x.strokeStyle='rgba(255,255,255,.6)';x.lineWidth=1.5;
    x.beginPath();x.moveTo(px,0);x.lineTo(px,c.height);x.stroke();
    // Played region tint
    x.fillStyle='rgba(251,146,60,.06)';x.fillRect(0,0,px,c.height)}
  requestAnimationFrame(animPlayhead);
  // === DROP AUDIO FILE ===
  viz.addEventListener('dragover',e=>{e.preventDefault();viz.style.borderColor='#fb923c'});
  viz.addEventListener('dragleave',()=>{viz.style.borderColor=''});
  viz.addEventListener('drop',async e=>{e.preventDefault();viz.style.borderColor='';
    const f=e.dataTransfer.files[0];if(!f||!f.type.startsWith('audio'))return;
    initA();const ab=await f.arrayBuffer();m.buf=await ctx.decodeAudioData(ab);drawW();
    infoDur.textContent=fmtTime(m.buf.duration);infoState.textContent='READY';
    tLabel.textContent=f.name.slice(0,20)+' ¬∑ '+fmtTime(m.buf.duration)});
  // Click to upload
  const fIn=document.createElement('input');fIn.type='file';fIn.accept='audio/*,.wav,.mp3,.m4a,.aac,.ogg,.flac,.aiff,.caf';fIn.style.cssText='position:absolute;left:-9999px;opacity:0;width:1px;height:1px';
  fIn.addEventListener('change',async()=>{const f=fIn.files[0];if(!f)return;
    initA();const ab=await f.arrayBuffer();m.buf=await ctx.decodeAudioData(ab);drawW();
    infoDur.textContent=fmtTime(m.buf.duration);infoState.textContent='READY';
    tLabel.textContent=f.name.slice(0,20)+' ¬∑ '+fmtTime(m.buf.duration)});
  viz.addEventListener('click',()=>{if(!m.buf)fIn.click()});
  bd.appendChild(fIn);
  m.destroy=()=>{stopSrc();if(m.stream)m.stream.getTracks().forEach(t=>t.stop())};
  m.drawW=drawW;
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}


// === DRUM MODULE ‚Äî battleship grid + bottom edit bar ===
function addDrum(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('DRUM<span>.EXE</span>','Machine','#f97316',20+(mods.length%4)*30,40+(mods.length%4)*20,940,480,ci);
  el.id='m'+id;el.style.minWidth='650px';bd.style.display='flex';bd.style.flexDirection='column';bd.style.overflow='hidden';

  // === SOUND ENGINE ‚Äî multi-mode synthesis ===
  // Shared: create drive node
  function mkDrive(c,drive,input,output){
    if(drive<.01){input.connect(output);return}
    const ws=c.createWaveShaper(),k=2+drive*40;
    const cv=new Float32Array(512);for(let i=0;i<512;i++){const x=i*2/511-1;cv[i]=Math.tanh(k*x)}
    ws.curve=cv;ws.oversample='2x';input.connect(ws);ws.connect(output)}
  // Shared: create noise buffer
  function mkNoise(c,dur,stereo){
    const ch=stereo?2:1,b=c.createBuffer(ch,Math.max(1,Math.round(c.sampleRate*dur)),c.sampleRate);
    for(let i=0;i<ch;i++){const a=b.getChannelData(i);for(let j=0;j<a.length;j++)a[j]=Math.random()*2-1}return b}

  function synthKick(t,v,c,d,p){
    const pitch=p.pitch||1,decay=p.decay||1,tone=p.tone||.5,drive=p.drive||0,body=p.body||.5;
    const pan=c.createStereoPanner();pan.pan.value=p.pan||0;pan.connect(d);
    const out=c.createGain();mkDrive(c,drive,out,pan);
    // Fundamental: pitch sweep determines character
    // body=0: 40Hz fundamental (sub bass), body=1: 180Hz (punchy mid)
    const fundF=40+140*body;
    // Sweep range: tone controls how high the sweep starts
    // tone=0: starts at 1.5x fund (minimal sweep=pure sub), tone=1: starts at 8x fund (clicky attack)
    const sweepRatio=1.5+6.5*tone;
    const startF=fundF*sweepRatio*pitch;
    const endF=fundF*pitch;
    // Sweep speed: tone also controls how fast the pitch drops
    // tone=0: slow sweep (boomy), tone=1: fast sweep (clicky)
    const sweepTime=.005+.055*(1-tone);
    // Envelope: decay controls overall length
    const envLen=.08+.6*decay;
    // Main osc
    const o=c.createOscillator(),g=c.createGain();
    o.type='sine';o.connect(g);g.connect(out);
    o.frequency.setValueAtTime(startF,t);
    o.frequency.exponentialRampToValueAtTime(Math.max(20,endF),t+sweepTime*decay);
    o.frequency.exponentialRampToValueAtTime(20,t+envLen);
    g.gain.setValueAtTime(v*1.2,t);
    g.gain.setValueAtTime(v*1.2,t+.003); // hold attack
    g.gain.exponentialRampToValueAtTime(.001,t+envLen);
    o.start(t);o.stop(t+envLen+.01);
    // Sub layer: body controls how much sub
    if(body>.15){const s=c.createOscillator(),sg=c.createGain();
      s.type='sine';s.connect(sg);sg.connect(out);
      s.frequency.setValueAtTime(endF*.8,t);
      s.frequency.exponentialRampToValueAtTime(20,t+envLen*1.2);
      sg.gain.setValueAtTime(v*body*.7,t);
      sg.gain.exponentialRampToValueAtTime(.001,t+envLen*1.2);
      s.start(t);s.stop(t+envLen*1.2+.01)}
    // Click transient: tone controls presence
    if(tone>.1){const cl=c.createOscillator(),clg=c.createGain();
      cl.type='square';cl.connect(clg);clg.connect(out);
      // Higher tone = higher click freq = more beater attack
      cl.frequency.value=(800+3000*tone)*pitch;
      clg.gain.setValueAtTime(v*tone*.25,t);
      clg.gain.exponentialRampToValueAtTime(.001,t+.004+.004*tone);
      cl.start(t);cl.stop(t+.01)}
    // Noise click for extra attack presence at high tone
    if(tone>.5){const nb=mkNoise(c,.008);const ns=c.createBufferSource();ns.buffer=nb;
      const nf=c.createBiquadFilter();nf.type='highpass';nf.frequency.value=2000+4000*tone;
      const ng=c.createGain();ns.connect(nf);nf.connect(ng);ng.connect(out);
      ng.gain.setValueAtTime(v*(tone-.5)*.3,t);ng.gain.exponentialRampToValueAtTime(.001,t+.006);
      ns.start(t);ns.stop(t+.01)}
  }

  function synthSnare(t,v,c,d,p){
    const pitch=p.pitch||1,decay=p.decay||1,tone=p.tone||.5,drive=p.drive||0,body=p.body||.5;
    const pan=c.createStereoPanner();pan.pan.value=p.pan||0;pan.connect(d);
    const out=c.createGain();mkDrive(c,drive,out,pan);
    // Noise body: tone controls filter character
    // tone=0: lowpass noise (dark, fat), tone=1: highpass noise (bright, crispy)
    const noiseDur=.04+.2*decay;
    const nb=mkNoise(c,noiseDur);const ns=c.createBufferSource();ns.buffer=nb;
    const nf=c.createBiquadFilter();
    // Crossfade between lowpass and highpass via tone
    if(tone<.4){nf.type='lowpass';nf.frequency.value=2000+6000*tone;nf.Q.value=.8}
    else if(tone<.7){nf.type='bandpass';nf.frequency.value=1500+5000*tone;nf.Q.value=.5+tone*2}
    else{nf.type='highpass';nf.frequency.value=1000+5000*(tone-.5);nf.Q.value=.5+tone}
    const ng=c.createGain();ns.connect(nf);nf.connect(ng);ng.connect(out);
    // Envelope shape: body controls snap vs sustain
    // body=0: fast decay (tight snap), body=1: sustained ring
    const snapFactor=.2+.8*body;
    ng.gain.setValueAtTime(v*.85,t);
    ng.gain.setValueAtTime(v*.85*snapFactor,t+.015); // snap point
    ng.gain.exponentialRampToValueAtTime(.001,t+noiseDur);
    ns.start(t);ns.stop(t+noiseDur+.01);
    // Tonal body: pitched triangle wave gives the snare its "note"
    // body=0: no tonal body (pure noise), body=1: strong tonal fundamental
    if(body>.05){
      const o=c.createOscillator(),og=c.createGain();
      o.type=tone>.6?'sine':'triangle'; // sine at high tone for less mud
      const bodyF=180+120*body; // 180-300Hz tonal range
      o.frequency.setValueAtTime(bodyF*pitch*1.5,t);
      o.frequency.exponentialRampToValueAtTime(bodyF*pitch*.7,t+.03*decay);
      o.connect(og);og.connect(out);
      og.gain.setValueAtTime(v*body*.45,t);
      og.gain.exponentialRampToValueAtTime(.001,t+.05*decay);
      o.start(t);o.stop(t+.06*decay)}
    // Wire snap: high freq transient for stick attack
    if(tone>.2){const w=c.createOscillator(),wg=c.createGain();
      w.type='square';w.frequency.value=(3000+5000*tone)*pitch;
      w.connect(wg);wg.connect(out);
      wg.gain.setValueAtTime(v*tone*.12,t);
      wg.gain.exponentialRampToValueAtTime(.001,t+.005);
      w.start(t);w.stop(t+.008)}
  }

  function synthHat(t,v,c,d,p){
    const pitch=p.pitch||1,decay=p.decay||1,tone=p.tone||.5,body=p.body||.5,drive=p.drive||0;
    const pan=c.createStereoPanner();pan.pan.value=p.pan||0;pan.connect(d);
    const out=c.createGain();mkDrive(c,drive,out,pan);
    // body: 0=tight closed, 1=open/sustained
    // tone: 0=dark/smooth, 1=bright/harsh
    const dur=.008+(.005+.3*body)*decay;
    // Noise layer
    const nb=mkNoise(c,dur);const ns=c.createBufferSource();ns.buffer=nb;
    const nf=c.createBiquadFilter();nf.type='highpass';
    // tone controls cutoff: dark hats sit lower, bright hats sit higher
    nf.frequency.value=(3000+9000*tone)*pitch;
    nf.Q.value=.5+tone*1.5; // resonance adds character at high tone
    const ng=c.createGain();ns.connect(nf);nf.connect(ng);ng.connect(out);
    ng.gain.setValueAtTime(v*.35,t);
    // Envelope shape: tight closed vs open sustain
    if(body<.4){
      ng.gain.exponentialRampToValueAtTime(.001,t+dur); // quick decay
    }else{
      ng.gain.setValueAtTime(v*.35*(.3+.7*body),t+.005); // sustain level
      ng.gain.exponentialRampToValueAtTime(.001,t+dur); // then decay
    }
    ns.start(t);ns.stop(t+dur+.01);
    // Metallic partials: square waves at inharmonic frequencies
    // These give hats their metallic shimmer vs just being filtered noise
    if(tone>.15){
      const freqs=[6047,6890,8230,10540]; // inharmonic metal frequencies
      const numPartials=Math.ceil(tone*4);
      for(let i=0;i<numPartials;i++){
        const o=c.createOscillator(),og=c.createGain();
        o.type='square';o.frequency.value=freqs[i]*pitch*(1+tone*.3);
        o.connect(og);og.connect(out);
        og.gain.setValueAtTime(v*(.02+.03*tone)/(i+1),t);
        og.gain.exponentialRampToValueAtTime(.001,t+dur*.6);
        o.start(t);o.stop(t+dur*.7)}}
  }

  function synthClap(t,v,c,d,p){
    const pitch=p.pitch||1,decay=p.decay||1,tone=p.tone||.5,body=p.body||.5,drive=p.drive||0;
    const pan=c.createStereoPanner();pan.pan.value=p.pan||0;pan.connect(d);
    const out=c.createGain();mkDrive(c,drive,out,pan);
    // body: 0=tight single hit, 1=loose multi-layered spread
    // tone: 0=dark muffled, 1=bright snappy
    const layers=2+Math.floor(body*5); // 2-7 layers based on body
    const spread=.003+.012*body; // time between layers
    for(let i=0;i<layers;i++){
      const tt=t+i*spread;
      const layerDur=.01+.04*decay;
      const nb=mkNoise(c,layerDur);const ns=c.createBufferSource();ns.buffer=nb;
      const nf=c.createBiquadFilter();nf.type='bandpass';
      nf.frequency.value=(800+4000*tone)*pitch;
      nf.Q.value=.5+tone*3; // tighter Q at high tone for snappier sound
      const ng=c.createGain();ns.connect(nf);nf.connect(ng);ng.connect(out);
      // Each layer slightly quieter
      ng.gain.setValueAtTime(v*.35*(1-i*.12),tt);
      ng.gain.exponentialRampToValueAtTime(.001,tt+layerDur);
      ns.start(tt);ns.stop(tt+layerDur+.01)}
    // Reverb tail
    const tailDur=.05+.25*decay*body;
    const tb=mkNoise(c,tailDur);const ts=c.createBufferSource();ts.buffer=tb;
    const tf=c.createBiquadFilter();tf.type='bandpass';tf.frequency.value=(1200+3000*tone)*pitch;tf.Q.value=.8;
    const tg=c.createGain();ts.connect(tf);tf.connect(tg);tg.connect(out);
    const tailStart=t+layers*spread;
    tg.gain.setValueAtTime(v*.2*body,tailStart);
    tg.gain.exponentialRampToValueAtTime(.001,tailStart+tailDur);
    ts.start(tailStart);ts.stop(tailStart+tailDur+.01);
  }

  function synthPerc(t,v,c,d,p){
    const pitch=p.pitch||1,decay=p.decay||1,tone=p.tone||.5,body=p.body||.5,drive=p.drive||0;
    const pan=c.createStereoPanner();pan.pan.value=p.pan||0;pan.connect(d);
    const out=c.createGain();mkDrive(c,drive,out,pan);
    // Versatile percussive synth: conga, bongo, woodblock, cowbell territory
    // body: 0=high pitched small (woodblock/clave), 1=low pitched large (conga/djembe)
    // tone: 0=pure sine (warm wood), 0.5=triangle (plastic/skin), 1=square (metallic/cowbell)
    const baseF=200+600*(1-body); // inverted: low body = high freq
    const o=c.createOscillator(),g=c.createGain();
    o.type=tone<.33?'sine':tone<.66?'triangle':'square';
    o.connect(g);g.connect(out);
    // Pitch envelope: wood has fast sweep, skin has slower
    const sweepRange=tone<.33?1.2:tone<.66?1.8:1.1; // less sweep for metallic
    o.frequency.setValueAtTime(baseF*sweepRange*pitch,t);
    o.frequency.exponentialRampToValueAtTime(baseF*pitch,t+.01+.02*body);
    const envLen=.03+.2*decay*(.3+.7*body); // bigger instruments ring longer
    g.gain.setValueAtTime(v*.7,t);
    g.gain.exponentialRampToValueAtTime(.001,t+envLen);
    o.start(t);o.stop(t+envLen+.01);
    // Second partial for richness (detuned)
    if(tone>.3||body>.5){
      const o2=c.createOscillator(),g2=c.createGain();
      o2.type=tone>.5?'square':'triangle';
      o2.frequency.value=baseF*pitch*(tone>.5?2.62:1.48); // inharmonic partial
      o2.connect(g2);g2.connect(out);
      g2.gain.setValueAtTime(v*(.05+.15*tone),t);
      g2.gain.exponentialRampToValueAtTime(.001,t+envLen*.6);
      o2.start(t);o2.stop(t+envLen*.7)}
    // Attack noise for skin instruments
    if(body>.3&&tone<.7){
      const nb=mkNoise(c,.008);const ns=c.createBufferSource();ns.buffer=nb;
      const nf=c.createBiquadFilter();nf.type='bandpass';nf.frequency.value=1500+2000*body;nf.Q.value=1;
      const ng=c.createGain();ns.connect(nf);nf.connect(ng);ng.connect(out);
      ng.gain.setValueAtTime(v*body*.2,t);ng.gain.exponentialRampToValueAtTime(.001,t+.008);
      ns.start(t);ns.stop(t+.01)}
  }

  function synthCymbal(t,v,c,d,p){
    const pitch=p.pitch||1,decay=p.decay||1,tone=p.tone||.5,body=p.body||.5,drive=p.drive||0;
    const pan=c.createStereoPanner();pan.pan.value=p.pan||0;pan.connect(d);
    const out=c.createGain();mkDrive(c,drive,out,pan);
    // body: 0=short splash, 1=long sustain wash
    // tone: 0=dark mellow, 1=bright cutting
    const dur=.1+1.2*decay*(.2+.8*body);
    // Stereo noise body
    const nb=mkNoise(c,dur,true);const ns=c.createBufferSource();ns.buffer=nb;
    const nf=c.createBiquadFilter();nf.type='highpass';
    nf.frequency.value=(2000+6000*tone)*pitch;
    const ng=c.createGain();ns.connect(nf);nf.connect(ng);ng.connect(out);
    ng.gain.setValueAtTime(v*.25,t);
    ng.gain.exponentialRampToValueAtTime(v*.25*body*.4,t+.02); // initial hit
    ng.gain.exponentialRampToValueAtTime(.001,t+dur);
    ns.start(t);ns.stop(t+dur+.01);
    // Bell partials: define the cymbal's pitch character
    const bellFreqs=[2450,3680,5100,6870,8500];
    const numBells=2+Math.ceil(tone*3);
    for(let i=0;i<numBells;i++){
      const o=c.createOscillator(),og=c.createGain();
      o.type='sine';o.frequency.value=bellFreqs[i%5]*pitch;
      o.connect(og);og.connect(out);
      og.gain.setValueAtTime(v*(.04-.005*i)*(1+tone),t);
      og.gain.exponentialRampToValueAtTime(.001,t+dur*(.3+.5/(i+1)));
      o.start(t);o.stop(t+dur+.01)}
  }

  function synthTom(t,v,c,d,p){
    const pitch=p.pitch||1,decay=p.decay||1,tone=p.tone||.5,body=p.body||.5,drive=p.drive||0;
    const pan=c.createStereoPanner();pan.pan.value=p.pan||0;pan.connect(d);
    const out=c.createGain();mkDrive(c,drive,out,pan);
    // body: 0=high tom (small), 1=floor tom (large)
    // tone: 0=warm rounded, 1=bright attack
    const baseF=70+260*(1-body); // 70-330Hz
    const envLen=.06+.35*decay*(.5+.5*body);
    const o=c.createOscillator(),g=c.createGain();
    o.type=tone>.6?'triangle':'sine';
    o.connect(g);g.connect(out);
    // Pitch sweep: bigger toms have wider sweep
    const sweepMul=2+body*1.5;
    o.frequency.setValueAtTime(baseF*sweepMul*pitch,t);
    o.frequency.exponentialRampToValueAtTime(baseF*pitch,t+.02+.04*body);
    o.frequency.exponentialRampToValueAtTime(baseF*pitch*.8,t+envLen);
    g.gain.setValueAtTime(v*.9,t);
    g.gain.exponentialRampToValueAtTime(.001,t+envLen);
    o.start(t);o.stop(t+envLen+.01);
    // Attack noise (stick/mallet)
    if(tone>.15){
      const nb=mkNoise(c,.01);const ns=c.createBufferSource();ns.buffer=nb;
      const nf=c.createBiquadFilter();nf.type='bandpass';nf.frequency.value=2000+4000*tone;nf.Q.value=1;
      const ng=c.createGain();ns.connect(nf);nf.connect(ng);ng.connect(out);
      ng.gain.setValueAtTime(v*tone*.2,t);ng.gain.exponentialRampToValueAtTime(.001,t+.008);
      ns.start(t);ns.stop(t+.01)}
    // Resonance body (membrane)
    if(body>.3){
      const o2=c.createOscillator(),g2=c.createGain();
      o2.type='sine';o2.frequency.value=baseF*pitch*1.58; // shell resonance
      o2.connect(g2);g2.connect(out);
      g2.gain.setValueAtTime(v*body*.12,t);
      g2.gain.exponentialRampToValueAtTime(.001,t+envLen*.5);
      o2.start(t);o2.stop(t+envLen*.6)}
  }

  function synthRim(t,v,c,d,p){
    const pitch=p.pitch||1,decay=p.decay||1,tone=p.tone||.5,body=p.body||.5,drive=p.drive||0;
    const pan=c.createStereoPanner();pan.pan.value=p.pan||0;pan.connect(d);
    const out=c.createGain();mkDrive(c,drive,out,pan);
    // body: 0=thin stick click, 1=full cross-stick with body
    // tone: 0=dull wood, 1=bright metallic
    const dur=.01+.04*decay*(.3+.7*body);
    // Main click
    const o=c.createOscillator(),g=c.createGain();
    o.type=tone>.5?'square':'triangle';
    const clickF=(400+800*tone)*pitch;
    o.frequency.setValueAtTime(clickF*2,t);
    o.frequency.exponentialRampToValueAtTime(clickF,t+.003);
    o.connect(g);g.connect(out);
    g.gain.setValueAtTime(v*.5,t);
    g.gain.exponentialRampToValueAtTime(.001,t+dur);
    o.start(t);o.stop(t+dur+.01);
    // Shell resonance
    if(body>.2){
      const o2=c.createOscillator(),g2=c.createGain();
      o2.type='sine';o2.frequency.value=(200+150*body)*pitch;
      o2.connect(g2);g2.connect(out);
      g2.gain.setValueAtTime(v*body*.2,t);
      g2.gain.exponentialRampToValueAtTime(.001,t+dur*1.5);
      o2.start(t);o2.stop(t+dur*1.6)}
    // Noise transient
    if(tone>.3){
      const nb=mkNoise(c,.005);const ns=c.createBufferSource();ns.buffer=nb;
      const nf=c.createBiquadFilter();nf.type='highpass';nf.frequency.value=4000+6000*tone;
      const ng=c.createGain();ns.connect(nf);nf.connect(ng);ng.connect(out);
      ng.gain.setValueAtTime(v*tone*.15,t);ng.gain.exponentialRampToValueAtTime(.001,t+.004);
      ns.start(t);ns.stop(t+.006)}
  }

  const ENG={kick:synthKick,snare:synthSnare,hh:synthHat,clap:synthClap,rim:synthRim,perc:synthPerc,crash:synthCymbal,ride:synthCymbal,tomhi:synthTom,tomlo:synthTom};
  function trig(p,t,vel,dest){const e=ENG[p.cat];if(e)e(t,p.v*vel,ctx,dest,p)}

  // === PARTS ===
  const PARTS=[
    {name:'KICK', cat:'kick', col:'#e8364f',v:.9,pitch:1,decay:1,tone:.5,drive:0,body:.5,pan:0,prob:100,hum:0,swing:0},
    {name:'KICK2',cat:'kick', col:'#dc2626',v:.8,pitch:.8,decay:.7,tone:.3,drive:0,body:.8,pan:0,prob:100,hum:0,swing:0},
    {name:'SNARE',cat:'snare',col:'#f59e0b',v:.8,pitch:1,decay:1,tone:.5,drive:0,body:.5,pan:0,prob:100,hum:0,swing:0},
    {name:'SNR 2',cat:'snare',col:'#eab308',v:.7,pitch:1.2,decay:.6,tone:.8,drive:.1,body:.3,pan:0,prob:100,hum:0,swing:0},
    {name:'CH',   cat:'hh',   col:'#22d3ee',v:.65,pitch:1,decay:.2,tone:.6,drive:0,body:.15,pan:0,prob:100,hum:0,swing:0},
    {name:'OH',   cat:'hh',   col:'#06b6d4',v:.55,pitch:1,decay:.8,tone:.5,drive:0,body:.7,pan:0,prob:100,hum:0,swing:0},
    {name:'CLAP', cat:'clap', col:'#a855f7',v:.7,pitch:1,decay:1,tone:.5,drive:0,body:.5,pan:0,prob:100,hum:0,swing:0},
    {name:'SNAP', cat:'clap', col:'#c084fc',v:.65,pitch:1.5,decay:.4,tone:.9,drive:0,body:.1,pan:0,prob:100,hum:0,swing:0},
    {name:'RIM',  cat:'rim',  col:'#f472b6',v:.6,pitch:1,decay:1,tone:.5,drive:0,body:.5,pan:0,prob:100,hum:0,swing:0},
    {name:'PERC', cat:'perc', col:'#fb923c',v:.55,pitch:1,decay:1,tone:.5,drive:0,body:.5,pan:0,prob:100,hum:0,swing:0},
    {name:'PERC2',cat:'perc', col:'#f97316',v:.5,pitch:1.8,decay:.5,tone:.7,drive:0,body:.3,pan:.3,prob:100,hum:0,swing:0},
    {name:'CRASH',cat:'crash',col:'#818cf8',v:.4,pitch:1,decay:1,tone:.5,drive:0,body:.5,pan:-.1,prob:100,hum:0,swing:0},
    {name:'RIDE', cat:'ride', col:'#34d399',v:.45,pitch:1,decay:.6,tone:.7,drive:0,body:.4,pan:.2,prob:100,hum:0,swing:0},
    {name:'TOM H',cat:'tomhi',col:'#fbbf24',v:.65,pitch:1.2,decay:.8,tone:.4,drive:0,body:.2,pan:-.3,prob:100,hum:0,swing:0},
    {name:'TOM M',cat:'tomhi',col:'#f59e0b',v:.65,pitch:.9,decay:1,tone:.4,drive:0,body:.5,pan:0,prob:100,hum:0,swing:0},
    {name:'TOM L',cat:'tomlo',col:'#d97706',v:.7,pitch:.7,decay:1.2,tone:.3,drive:0,body:.85,pan:.3,prob:100,hum:0,swing:0}
  ];
  const NP=PARTS.length,VMUL=[0,.4,1,1.4];
  const NPAT=4,mkPat=()=>({steps:16,grid:Array.from({length:NP},()=>new Array(64).fill(0))});
  const pats=[mkPat(),mkPat(),mkPat(),mkPat()];
  let curPat=0,chain=[0],chainIdx=0,chainMode=false,globalSwing=0;
  let selRow=-1,selCol=-1;
  let mode='grid';
  const freeEvents=[[],[],[],[]];
  // Needle element (appended to gridArea later)
  const needle=document.createElement('div');needle.style.cssText='position:absolute;top:0;bottom:0;width:2px;background:#f97316;z-index:5;pointer-events:none;opacity:.7;transition:left .05s linear;display:none';

  const m={id,type:'drum',el,ci,ts:16,se:[],parts:PARTS.map(p=>({...p})),
    getPats:()=>pats,setPats:d=>{d.forEach((p,i)=>{if(pats[i]){pats[i].steps=p.steps;p.grid.forEach((row,ri)=>{if(pats[i].grid[ri])pats[i].grid[ri]=row.slice()})}})}};
  m.dst=()=>chs[m.ci].g||mGain;
  m.aud=(i)=>{const a=m.parts.some(p=>p.solo);return a?m.parts[i].solo&&!m.parts[i].mut:!m.parts[i].mut};
  m.snd=(p)=>(t,v2,c,d)=>trig(p,t,v2/p.v,d);

  m.onStep=(s,t)=>{
    const pat=pats[chainMode?chain[chainIdx%chain.length]:curPat];
    const ns=pat.steps,step=s%ns;if(chainMode&&s>0&&step===0)chainIdx++;
    const cpat=pats[chainMode?chain[chainIdx%chain.length]:curPat];m.ts=cpat.steps;
    const dest=m.dst(),bpm=chs[m.ci].bpm,stepDur=60/bpm/4;
    m.parts.forEach((p,i)=>{const vel=cpat.grid[i][step];
      if(vel>0&&m.aud(i)){if(p.prob<100&&Math.random()*100>p.prob)return;let tt=t;
        const sw=Math.max(p.swing,globalSwing);if(sw>0&&step%2===1)tt+=stepDur*sw*.6;
        if(p.hum>0)tt+=((Math.random()-.5)*p.hum*.02);trig(p,tt,VMUL[vel],dest)}});
    if(mode==='free'){const fe=freeEvents[chainMode?chain[chainIdx%chain.length]:curPat];
      const barDur=stepDur*ns,stepStart=step*stepDur,stepEnd=stepStart+stepDur;
      fe.forEach(ev=>{if(!m.aud(ev.part))return;const evTime=ev.time*barDur;
        if(evTime>=stepStart&&evTime<stepEnd){trig(m.parts[ev.part],t+(evTime-stepStart),VMUL[ev.vel||2],dest)}})}
    m.se.forEach((row,ri)=>row.forEach((e,si)=>e.classList.toggle('current',si===step)));
    if(m.se[0]&&m.se[0][step]){needle.style.display='';const cell=m.se[0][step];needle.style.left=cell.offsetLeft+'px'}};
  m.clr=()=>{m.se.forEach(r=>r.forEach(e=>e.classList.remove('current')));needle.style.display='none';chainIdx=0};
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});

  // === PRESETS WITH MEANINGFUL SOUND DESIGN ===
  // Key insight: each param fundamentally changes the synthesis, not just tweaks numbers
  // pitch: frequency multiplier | decay: envelope length | tone: brightness/filter/waveshape
  // drive: saturation amount | body: fundamental freq / size / sub amount | pan: stereo position
  const DRUM_PR={
    // ===== HIP-HOP =====
    'Boom Bap':{p:{KICK:[0,5,8,13],SNARE:[4,12],CH:[0,2,4,6,8,10,12,14],OH:[14],SNAP:[4]},
      snd:{
        KICK:{pitch:1,decay:1.3,tone:.15,drive:.08,body:.65,v:.9},     // sine sweep, heavy sub, warm saturation, medium-long tail
        SNARE:{pitch:1,tone:.25,decay:1.2,drive:.2,body:.65,v:.8},     // dark noise, strong tonal body, tape-saturated
        CH:{pitch:.9,tone:.35,decay:.2,body:.15,v:.55},                 // dark soft hats, minimal metallic partials
        OH:{pitch:.9,tone:.3,decay:.7,body:.65,v:.4},                   // dark breathy open hat
        SNAP:{pitch:1.2,tone:.85,decay:.3,body:.1,v:.6}}},              // bright thin snap
    'Hip-Hop':{p:{KICK:[0,6,10],SNARE:[4,12],CH:[0,2,4,6,8,10,12,14],OH:[6,14],CLAP:[4,12]},
      snd:{
        KICK:{pitch:1,decay:1,tone:.25,drive:.04,body:.55,v:.88},       // medium body, slight click, clean
        SNARE:{pitch:1,tone:.45,decay:.9,drive:.05,body:.5,v:.8},       // balanced bright/dark, medium body
        CH:{pitch:1,tone:.5,decay:.15,body:.12,v:.55},                  // neutral crisp hat
        CLAP:{pitch:1,tone:.5,decay:.7,body:.5,v:.65}}},                // natural multi-layer clap
    'Trap':{p:{KICK:[0,3,6,10,14],SNARE:[4,12],CH:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],OH:[7,15],CLAP:[4,12],SNAP:[8],PERC:[12]},
      snd:{
        KICK:{pitch:.8,decay:1.9,tone:.02,drive:0,body:.95,v:1},       // pure 808: sine only, max sub, very long sustain, no click
        SNARE:{pitch:1.1,tone:.65,decay:.5,drive:0,body:.3,v:.7},      // bright tight noise, minimal body (sits above 808)
        CH:{pitch:1.3,tone:.85,decay:.12,body:.05,v:.55},              // very bright metallic ticks, ultra short
        OH:{pitch:1.3,tone:.8,decay:.5,body:.55,v:.38},                // bright metallic open hat
        CLAP:{pitch:1.1,tone:.7,decay:.5,body:.2,v:.68},               // tight bright clap, minimal tail
        SNAP:{pitch:1.5,tone:.95,decay:.2,body:.05,v:.5}}},            // razor sharp snap transient
    'Trap Soul':{p:{KICK:[0,7,10],SNARE:[4,12],CH:[0,2,4,6,8,10,12,14],OH:[6],SNAP:[4,12],RIM:[2,10]},
      snd:{
        KICK:{pitch:.85,decay:1.6,tone:.05,drive:.02,body:.85,v:.9},   // warm long 808, pure sine, gentle warmth
        SNARE:{pitch:1,tone:.3,decay:1,drive:.03,body:.55,v:.55},      // dark warm snare, supporting role
        CH:{pitch:.95,tone:.4,decay:.12,body:.15,v:.45},                // soft warm hats
        SNAP:{pitch:1.3,tone:.8,decay:.3,body:.08,v:.7},               // forward snap, main backbeat
        RIM:{pitch:1,tone:.4,decay:.5,body:.4,v:.42}}},                // warm woodblock-like rim
    'Phonk':{p:{KICK:[0,7,10],KICK2:[3],SNARE:[4,12],CH:[0,2,4,6,8,10,12,14],CLAP:[4,12],PERC:[2,10],'TOM H':[14]},
      snd:{
        KICK:{pitch:.75,decay:1.5,tone:.2,drive:.35,body:.9,v:1},      // HEAVY: deep sub + triangle wave + lots of saturation
        KICK2:{pitch:.6,decay:1.7,tone:.3,drive:.45,body:1,v:.85},     // even more destroyed, sawtooth-ish
        SNARE:{pitch:.9,tone:.2,decay:1.2,drive:.35,body:.6,v:.82},    // dark fat snare, heavy saturation
        CH:{pitch:1,tone:.45,decay:.08,body:.1,v:.5},                   // muted lo-fi hat
        CLAP:{pitch:.9,tone:.3,decay:.7,body:.6,v:.6},                  // dark loose clap
        'TOM H':{pitch:1.3,decay:.5,tone:.35,body:.2,v:.55}}},
    'Memphis':{p:{KICK:[0,3,8,11],SNARE:[4,12],CH:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],OH:[7],CLAP:[4,12],PERC:[2,6,10,14],'TOM H':[14,15]},
      snd:{
        KICK:{pitch:.7,decay:1.4,tone:.15,drive:.3,body:.9,v:.95},     // boomy 808 + grit
        SNARE:{pitch:.85,tone:.2,decay:1.1,drive:.28,body:.55,v:.78},  // crushed dark snare
        CH:{pitch:1.15,tone:.6,decay:.04,body:.05,v:.55},              // rapid bright ticks
        PERC:{pitch:2.5,tone:.75,body:.1,decay:.15,v:.45},             // high cowbell: square wave, high pitch, metallic
        'TOM H':{pitch:1.5,decay:.4,body:.15,tone:.4,v:.52}}},
    'Drill':{p:{KICK:[0,7,10],SNARE:[4,12],CH:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],OH:[3,11],CLAP:[4,12],RIM:[2,6,10,14]},
      snd:{
        KICK:{pitch:.9,decay:1,tone:.2,drive:.06,body:.65,v:.9},       // punchy but not too sub, medium tail
        SNARE:{pitch:1.05,tone:.55,decay:.6,drive:.04,body:.4,v:.8},   // bright snappy
        CH:{pitch:1.25,tone:.75,decay:.04,body:.06,v:.58},             // metallic rapid ticks
        CLAP:{pitch:1.05,tone:.6,decay:.45,body:.3,v:.65},             // tight clap
        RIM:{pitch:1.3,tone:.75,decay:.35,body:.25,v:.42}}},           // bright clicking rim
    'UK Drill':{p:{KICK:[0,10],KICK2:[6],SNARE:[4,12],CH:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],OH:[3,7,11],CLAP:[4],SNAP:[12]},
      snd:{
        KICK:{pitch:.85,decay:1.3,tone:.1,drive:.04,body:.75,v:.92},   // deeper than Chicago, more sub
        KICK2:{pitch:.7,decay:1.5,tone:.05,body:.88,v:.75},            // sub accent
        SNARE:{pitch:1,tone:.48,decay:.65,body:.4,v:.75},
        CH:{pitch:1.2,tone:.7,decay:.035,body:.05,v:.55},              // ultra tight bright
        SNAP:{pitch:1.4,tone:.9,decay:.2,body:.05,v:.58}}},
    'Cloud Rap':{p:{KICK:[0,8],SNARE:[4,12],CH:[0,4,8,12],OH:[6],CLAP:[4],RIM:[2,10]},
      snd:{
        KICK:{pitch:.8,decay:1.7,tone:.03,drive:0,body:.82,v:.78},     // pure sine pillow, very long, very soft
        SNARE:{pitch:.9,tone:.2,decay:1.4,drive:0,body:.6,v:.5},       // dark distant snare
        CH:{pitch:.85,tone:.35,decay:.2,body:.2,v:.38},                 // dark soft hats, barely there
        CLAP:{pitch:.9,tone:.25,decay:1,body:.6,v:.4}}},                // distant dark clap

    // ===== ELECTRONIC =====
    'House':{p:{KICK:[0,4,8,12],CH:[0,2,4,6,8,10,12,14],OH:[2,6,10,14],CLAP:[4,12]},
      snd:{
        KICK:{pitch:1.05,decay:.75,tone:.3,drive:.03,body:.45,v:.88},  // punchy mid-range, slight click, tight tail
        CH:{pitch:1.05,tone:.55,decay:.08,body:.1,v:.52},               // crisp clean hat
        OH:{pitch:1,tone:.5,decay:.5,body:.6,v:.38},                    // smooth open hat
        CLAP:{pitch:1,tone:.5,decay:.7,body:.5,v:.65}}},                // natural clap
    'Deep House':{p:{KICK:[0,4,8,12],CH:[0,2,4,6,8,10,12,14],OH:[6,14],CLAP:[4,12],RIM:[2,10],PERC:[3,11]},
      snd:{
        KICK:{pitch:.9,decay:1.1,tone:.12,drive:.02,body:.7,v:.85},    // warm sub-focused, long tail, no click
        CH:{pitch:.92,tone:.4,decay:.1,body:.1,v:.45},                  // warm muted
        CLAP:{pitch:.95,tone:.35,decay:.9,body:.6,v:.55},               // loose warm clap
        PERC:{pitch:.8,body:.7,tone:.2,decay:.7,v:.35}}},               // warm sine conga-like
    'Tech House':{p:{KICK:[0,4,8,12],CH:[0,2,4,6,8,10,12,14],OH:[4,12],CLAP:[4,12],RIM:[2,6,10,14],PERC:[3,7,11,15]},
      snd:{
        KICK:{pitch:1.15,decay:.6,tone:.45,drive:.06,body:.35,v:.85},  // short clicky, strong beater attack, minimal sub
        CH:{pitch:1.15,tone:.65,decay:.055,body:.07,v:.52},             // tight bright
        RIM:{pitch:1.35,tone:.75,decay:.35,body:.2,v:.42},              // bright metallic rim
        PERC:{pitch:1.7,body:.25,tone:.65,decay:.3,v:.38}}},            // tight high percussion
    'Techno':{p:{KICK:[0,4,8,12],CH:[2,6,10,14],OH:[4,12],CLAP:[4,12],RIM:[0,4,8,12]},
      snd:{
        KICK:{pitch:1.15,decay:.7,tone:.5,drive:.12,body:.32,v:.9},    // hard mid-range, strong click transient, driven
        CH:{pitch:1.3,tone:.8,decay:.035,body:.05,v:.5},                // harsh metallic ticks
        CLAP:{pitch:1.1,tone:.65,decay:.4,body:.25,v:.6},
        RIM:{pitch:1.4,tone:.8,decay:.28,body:.15,v:.45}}},
    'Hard Techno':{p:{KICK:[0,4,8,12],CH:[0,2,4,6,8,10,12,14],CLAP:[4,12],RIM:[2,6,10,14],PERC:[1,5,9,13],PERC2:[3,7,11,15]},
      snd:{
        KICK:{pitch:1.3,decay:.5,tone:.8,drive:.4,body:.2,v:.95},      // AGGRESSIVE: high pitch, fast sweep, sawtooth territory, heavy drive
        CH:{pitch:1.4,tone:.9,decay:.025,body:.03,v:.5},                // harsh ultra-short metallic
        CLAP:{pitch:1.15,tone:.8,decay:.3,body:.2,drive:.15,v:.6},
        PERC:{pitch:2.2,body:.1,tone:.85,decay:.15,drive:.1,v:.4},     // metallic stab
        PERC2:{pitch:2.8,body:.05,tone:.95,decay:.1,drive:.15,v:.32}}},
    'Acid':{p:{KICK:[0,4,8,12],CH:[0,2,4,6,8,10,12,14],OH:[2,10],CLAP:[4,12],RIM:[0,8],PERC:[6,14]},
      snd:{
        KICK:{pitch:1.1,decay:.7,tone:.4,drive:.08,body:.4,v:.85},
        CH:{pitch:1.15,tone:.68,decay:.05,body:.07,v:.5},
        RIM:{pitch:1.45,tone:.82,decay:.28,body:.15,v:.42}}},
    'Trance':{p:{KICK:[0,4,8,12],CH:[0,2,4,6,8,10,12,14],OH:[2,6,10,14],CLAP:[4,12],CRASH:[0],RIDE:[0,4,8,12]},
      snd:{
        KICK:{pitch:1,decay:.85,tone:.35,drive:.04,body:.5,v:.88},     // full rounded
        CRASH:{pitch:.95,tone:.55,decay:1.2,body:.75,v:.3},             // long wash
        RIDE:{pitch:1.05,tone:.58,decay:.55,body:.45,v:.35}}},
    'Minimal':{p:{KICK:[0,8],CH:[4,12],CLAP:[4],RIM:[8]},
      snd:{
        KICK:{pitch:1,decay:.65,tone:.28,drive:.02,body:.42,v:.82},
        CH:{pitch:1.05,tone:.55,decay:.06,body:.07,v:.45},
        RIM:{pitch:1.25,tone:.65,decay:.35,body:.3,v:.4}}},
    'Electro':{p:{KICK:[0,4,8,12],SNARE:[4,12],CH:[0,2,4,6,8,10,12,14],'SNR 2':[7,15],CLAP:[4],PERC:[2,10],'TOM H':[13],'TOM L':[14,15]},
      snd:{
        KICK:{pitch:1.08,decay:.72,tone:.38,drive:.08,body:.4,v:.88},
        SNARE:{pitch:1.1,tone:.6,decay:.55,drive:.04,body:.4,v:.78},
        'SNR 2':{pitch:1.25,tone:.75,decay:.35,body:.2,v:.52},
        'TOM H':{pitch:1.3,decay:.55,body:.2,tone:.35,v:.52},
        'TOM L':{pitch:.6,decay:.8,body:.75,tone:.25,v:.55}}},

    // ===== BASS MUSIC =====
    'DnB':{p:{KICK:[0,10],SNARE:[4,14],CH:[0,2,4,6,8,10,12,14],OH:[4],RIM:[2,8,14],'TOM L':[14]},
      snd:{
        KICK:{pitch:1,decay:.65,tone:.35,drive:.05,body:.45,v:.85},    // tight mid punch, not too sub (bass from synth)
        SNARE:{pitch:1.1,tone:.6,decay:.55,drive:.06,body:.35,v:.82},  // bright snappy
        CH:{pitch:1.2,tone:.7,decay:.04,body:.05,v:.52}}},
    'Liquid DnB':{p:{KICK:[0,10],SNARE:[4,14],CH:[0,2,4,6,8,10,12,14],OH:[6],RIM:[2,8],PERC:[3,11]},
      snd:{
        KICK:{pitch:.95,decay:.8,tone:.2,drive:.02,body:.55,v:.82},    // warmer rounder
        SNARE:{pitch:1,tone:.4,decay:.7,drive:.02,body:.5,v:.7},       // softer
        PERC:{pitch:1.15,body:.5,tone:.25,decay:.55,v:.32}}},          // warm organic perc
    'Jungle':{p:{KICK:[0,9],SNARE:[4,10,14],CH:[0,2,4,6,8,10,12,14],OH:[2,6],RIM:[8,12],'TOM H':[14,15],RIDE:[0,4,8,12]},
      snd:{
        KICK:{pitch:1,decay:.6,tone:.35,drive:.1,body:.42,v:.85},      // tight punchy, breakbeat character
        SNARE:{pitch:1.05,tone:.52,decay:.55,drive:.12,body:.4,v:.8},  // bit of drive for break crunch
        RIDE:{pitch:.95,tone:.48,decay:.5,body:.48,v:.35}}},
    'Dubstep':{p:{KICK:[0,8],SNARE:[4,12],CH:[0,4,8,12],CLAP:[4,12],PERC:[2,6,10,14],'TOM L':[14,15]},
      snd:{
        KICK:{pitch:.7,decay:1.5,tone:.08,drive:.08,body:.88,v:.95},   // massive sub 808
        SNARE:{pitch:.9,tone:.35,decay:1.1,drive:.15,body:.55,v:.85},  // big reverby snare, driven
        'TOM L':{pitch:.55,decay:1,body:.85,tone:.18,drive:.08,v:.55}}},
    'Garage':{p:{KICK:[0,6,10,14],SNARE:[4,12],CH:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],OH:[3,7],CLAP:[4,12],PERC:[2,10]},
      snd:{
        KICK:{pitch:.92,decay:.82,tone:.22,drive:.03,body:.55,v:.82},
        CH:{pitch:1.08,tone:.55,decay:.05,body:.07,v:.5}}},
    'Breakbeat':{p:{KICK:[0,4,10],SNARE:[4,12],CH:[0,2,4,6,8,10,12,14],OH:[2,14],RIM:[6,8],'TOM H':[13],'TOM M':[14],'TOM L':[15]},
      snd:{
        KICK:{pitch:1,decay:.8,tone:.32,drive:.08,body:.5,v:.88},
        SNARE:{pitch:1.05,tone:.5,decay:.62,drive:.1,body:.45,v:.8},
        'TOM H':{pitch:1.25,decay:.55,body:.18,tone:.35,v:.55},
        'TOM M':{pitch:.9,decay:.65,body:.45,tone:.3,v:.55},
        'TOM L':{pitch:.6,decay:.8,body:.75,tone:.22,v:.58}}},

    // ===== WORLD =====
    'Reggaeton':{p:{KICK:[0,3,4,7,8,11,12,15],SNARE:[4,12],CH:[0,2,4,6,8,10,12,14],CLAP:[4,12],RIM:[2,6,10,14]},
      snd:{
        KICK:{pitch:.9,decay:.8,tone:.2,drive:.03,body:.6,v:.85},
        RIM:{pitch:1.15,tone:.55,decay:.42,body:.35,v:.42}}},
    'Afrobeats':{p:{KICK:[0,5,8,12],SNARE:[4,10],CH:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],OH:[3,7,11,15],RIM:[2,6,10,14],PERC:[0,4,8,12],PERC2:[1,5,9,13]},
      snd:{
        KICK:{pitch:.85,decay:.9,tone:.12,drive:.02,body:.65,v:.82},   // warm round
        CH:{pitch:1,tone:.45,decay:.04,body:.05,v:.48},                 // tight shaker
        PERC:{pitch:1.2,body:.6,tone:.2,decay:.6,v:.42},               // warm conga: sine wave, big body, long sustain
        PERC2:{pitch:1.8,body:.15,tone:.55,decay:.25,pan:.25,v:.35}}}, // high bongo: triangle wave, small body, bright
    'Amapiano':{p:{KICK:[0,4,8,12],CH:[0,2,4,6,8,10,12,14],OH:[4,12],CLAP:[4,12],PERC:[0,3,6,10,14],PERC2:[1,5,9,13],RIM:[2,10]},
      snd:{
        KICK:{pitch:.8,decay:1.15,tone:.06,drive:.01,body:.75,v:.85},  // deep warm log drum kick
        PERC:{pitch:1.35,body:.45,tone:.15,decay:.45,v:.45},            // log drum: sine, warm, medium
        PERC2:{pitch:2.1,body:.1,tone:.6,decay:.2,pan:.3,v:.35}}},      // high shaker
    'Dancehall':{p:{KICK:[0,4,8,12],CH:[0,2,4,6,8,10,12,14],OH:[4,12],CLAP:[4,12],RIM:[2,6,10,14],PERC:[0,8]},
      snd:{
        KICK:{pitch:.85,decay:.92,tone:.15,drive:.02,body:.62,v:.82},
        RIM:{pitch:1.1,tone:.5,decay:.45,body:.38,v:.42},
        PERC:{pitch:1.1,body:.55,tone:.25,decay:.55,v:.38}}},
    'Bossa Nova':{p:{KICK:[0,6,10],CH:[0,2,4,6,8,10,12,14],RIM:[2,4,8,10,14],PERC:[0,4,8,12],PERC2:[3,7,11]},
      snd:{
        KICK:{pitch:.8,decay:1,tone:.05,drive:0,body:.65,v:.7},         // pure sine, whisper soft
        CH:{pitch:.85,tone:.3,decay:.15,body:.18,v:.35},                 // brushy soft
        RIM:{pitch:1,tone:.35,decay:.5,body:.4,v:.38},                   // wood click
        PERC:{pitch:.95,body:.6,tone:.15,decay:.6,v:.35},                // warm low wood
        PERC2:{pitch:1.6,body:.25,tone:.35,decay:.3,pan:.2,v:.28}}},
    'Samba':{p:{KICK:[0,6,10,14],SNARE:[4,12],CH:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],RIM:[0,2,4,6,8,10,12,14],PERC:[1,3,5,7,9,11,13,15],PERC2:[0,4,8,12],'TOM H':[2,10]},
      snd:{
        KICK:{pitch:.82,decay:.8,tone:.12,drive:.04,body:.6,v:.85},
        CH:{pitch:1.1,tone:.58,decay:.03,body:.04,v:.48},               // ultra rapid tamborim
        PERC:{pitch:1.5,body:.2,tone:.5,decay:.2,v:.4},                 // high agogo
        PERC2:{pitch:2,body:.1,tone:.65,decay:.12,v:.32}}},
    'Cumbia':{p:{KICK:[0,4,8,12],CH:[0,2,4,6,8,10,12,14],PERC:[0,3,8,11],PERC2:[2,6,10,14],RIM:[4,12],'TOM H':[6],'TOM L':[14]},
      snd:{
        KICK:{pitch:.82,decay:.88,tone:.1,drive:.02,body:.6,v:.82},
        PERC:{pitch:1.15,body:.5,tone:.25,decay:.52,v:.4},
        'TOM L':{pitch:.6,decay:.75,body:.75,tone:.2,v:.48}}},

    // ===== R&B / POP =====
    'R&B':{p:{KICK:[0,6,10],SNARE:[4,12],CH:[0,4,8,12],OH:[6],SNAP:[4,12],RIM:[2,10]},
      snd:{
        KICK:{pitch:.82,decay:1.2,tone:.06,drive:.01,body:.75,v:.82},   // warm round sub
        SNAP:{pitch:1.3,tone:.82,decay:.28,body:.08,v:.7},              // forward bright snap
        CH:{pitch:.92,tone:.4,decay:.12,body:.12,v:.4}}},
    'Pop':{p:{KICK:[0,4,8,12],SNARE:[4,12],CH:[0,2,4,6,8,10,12,14],CLAP:[4,12]},
      snd:{
        KICK:{pitch:1,decay:.8,tone:.3,drive:.03,body:.48,v:.85},       // balanced, radio-ready
        SNARE:{pitch:1,tone:.5,decay:.65,body:.45,v:.78},
        CLAP:{pitch:1,tone:.52,decay:.62,body:.45,v:.62}}},
    'Synthwave':{p:{KICK:[0,4,8,12],SNARE:[4,12],CH:[0,2,4,6,8,10,12,14],'TOM H':[13],'TOM M':[14],'TOM L':[15],CRASH:[0]},
      snd:{
        KICK:{pitch:1.08,decay:.7,tone:.38,drive:.05,body:.4,v:.85},
        SNARE:{pitch:1.1,tone:.55,decay:.8,drive:.04,body:.4,v:.78},    // gated reverb character (longer decay)
        'TOM H':{pitch:1.3,decay:.58,body:.18,tone:.35,v:.52},
        'TOM M':{pitch:1,decay:.68,body:.42,tone:.3,v:.52},
        'TOM L':{pitch:.68,decay:.82,body:.68,tone:.22,v:.55}}},
    'Disco':{p:{KICK:[0,4,8,12],SNARE:[4,12],CH:[0,2,4,6,8,10,12,14],OH:[2,6,10,14],PERC:[0,8]},
      snd:{
        KICK:{pitch:1,decay:.75,tone:.25,drive:.02,body:.45,v:.85},
        OH:{pitch:1,tone:.48,decay:.52,body:.58,v:.4}}},

    // ===== LO-FI =====
    'Lo-Fi':{p:{KICK:[0,6,10],SNARE:[4,12],CH:[0,4,8,10,14],OH:[6],RIM:[2]},
      snd:{
        KICK:{pitch:.78,decay:1.3,tone:.06,drive:.15,body:.75,v:.8},   // warm + tape saturation = the lo-fi sound
        SNARE:{pitch:.85,tone:.2,decay:1.2,drive:.22,body:.6,v:.7},    // very dark + heavily saturated noise
        CH:{pitch:.82,tone:.28,decay:.15,body:.15,v:.42},               // muffled dark
        OH:{pitch:.8,tone:.25,decay:.58,body:.55,v:.32}}},
    'Lo-Fi Jazz':{p:{KICK:[0,5,10],SNARE:[4,12],CH:[0,2,6,8,12],OH:[4,10],RIM:[2,8,14],RIDE:[0,4,8,12]},
      snd:{
        KICK:{pitch:.72,decay:1.2,tone:.04,drive:.12,body:.72,v:.75},
        SNARE:{pitch:.8,tone:.18,decay:1.1,drive:.18,body:.6,v:.62},
        RIDE:{pitch:.82,tone:.4,decay:.6,body:.5,v:.38}}},
    'Chillhop':{p:{KICK:[0,6,10],SNARE:[4,12],CH:[0,2,4,6,8,10,12,14],OH:[6],SNAP:[4,12],PERC:[2,10]},
      snd:{
        KICK:{pitch:.8,decay:1.1,tone:.08,drive:.05,body:.7,v:.8},
        SNAP:{pitch:1.2,tone:.75,decay:.28,body:.08,v:.62}}},
    'Bedroom Pop':{p:{KICK:[0,8],SNARE:[4,12],CH:[0,4,8,12],SNAP:[4,12],RIM:[6,14]},
      snd:{
        KICK:{pitch:.8,decay:1,tone:.06,drive:.02,body:.62,v:.72},
        SNAP:{pitch:1.2,tone:.72,decay:.26,body:.08,v:.58}}},

    // ===== AGGRESSIVE =====
    'Industrial':{p:{KICK:[0,4,8,12],SNARE:[4,12],CH:[0,2,4,6,8,10,12,14],CLAP:[4,12],PERC:[2,6,10,14],PERC2:[1,5,9,13]},
      snd:{
        KICK:{pitch:1.35,decay:.45,tone:.85,drive:.45,body:.18,v:.95}, // noise click + heavy drive = mechanical punch
        SNARE:{pitch:1.15,tone:.75,decay:.4,drive:.4,body:.25,v:.85},  // bright destroyed noise
        CH:{pitch:1.45,tone:.92,decay:.02,body:.03,drive:.12,v:.5},    // harsh metallic ticks
        PERC:{pitch:2.2,body:.08,tone:.88,decay:.12,drive:.15,v:.42},  // metallic stab
        PERC2:{pitch:2.8,body:.04,tone:.95,decay:.08,drive:.2,v:.32}}},
    'Glitch':{p:{KICK:[0,5,11],SNARE:[3,9],CH:[0,1,3,5,7,8,10,13],SNAP:[2,6],RIM:[4,11,15],PERC:[1,7,12],PERC2:[3,8,14]},
      snd:{
        KICK:{pitch:1.2,decay:.4,tone:.6,drive:.12,body:.25,v:.8},
        SNARE:{pitch:1.25,tone:.7,decay:.32,drive:.08,body:.25,v:.7},
        RIM:{pitch:1.8,tone:.85,decay:.2,body:.1,v:.4},
        PERC:{pitch:2,body:.15,tone:.78,decay:.18,v:.38}}},
    'Hardstyle':{p:{KICK:[0,4,8,12],CH:[2,6,10,14],CLAP:[4,12],PERC:[0,2,4,6,8,10,12,14]},
      snd:{
        KICK:{pitch:1.4,decay:.55,tone:.9,drive:.5,body:.15,v:1},      // THE hardstyle kick: very high pitch, sawtooth, maximum drive
        CH:{pitch:1.4,tone:.88,decay:.025,body:.03,v:.48},
        CLAP:{pitch:1.12,tone:.72,decay:.32,body:.2,drive:.1,v:.58}}},

    // ===== JAZZ =====
    'Jazz Swing':{p:{KICK:[0,10],RIDE:[0,2,4,6,8,10,12,14],SNAP:[4,12],RIM:[2,6,10,14],'TOM H':[14]},
      snd:{
        KICK:{pitch:.82,decay:.95,tone:.06,drive:0,body:.62,v:.7},     // pure warm, gentle
        RIDE:{pitch:.85,tone:.42,decay:.6,body:.52,v:.42},              // dark warm ride, lots of bell
        SNAP:{pitch:1.1,tone:.6,decay:.32,body:.15,v:.5},              // light brush hit
        RIM:{pitch:.98,tone:.35,decay:.48,body:.4,v:.35}}},
    'Brushes':{p:{KICK:[0,6,10],CH:[0,2,4,6,8,10,12,14],RIDE:[0,4,8,12],RIM:[4,12],PERC:[2,10]},
      snd:{
        KICK:{pitch:.75,decay:1,tone:.04,drive:0,body:.65,v:.6},        // whisper
        CH:{pitch:.8,tone:.25,decay:.18,body:.2,v:.32},                  // barely-there brush
        RIDE:{pitch:.85,tone:.38,decay:.58,body:.5,v:.35}}},

    // ===== CLUB =====
    'Jersey Club':{p:{KICK:[0,2,4,6,8,10,12,14],SNARE:[3,7,11,15],CH:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],CLAP:[4,12]},
      snd:{
        KICK:{pitch:1,decay:.58,tone:.32,drive:.04,body:.4,v:.82},
        CH:{pitch:1.2,tone:.68,decay:.03,body:.04,v:.52}}},
    'Baltimore Club':{p:{KICK:[0,2,4,8,10,12],SNARE:[6,14],CH:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],CLAP:[4,12],PERC:[3,7,11,15]},
      snd:{
        KICK:{pitch:1.05,decay:.52,tone:.35,drive:.05,body:.38,v:.82},
        PERC:{pitch:1.8,body:.15,tone:.68,decay:.18,v:.4}}},
    'Footwork':{p:{KICK:[0,4,8,12],SNARE:[2,6,10,14],CH:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],CLAP:[3,7,11,15],PERC:[1,5,9,13]},
      snd:{
        KICK:{pitch:1.02,decay:.52,tone:.35,drive:.05,body:.38,v:.82},
        CH:{pitch:1.28,tone:.72,decay:.028,body:.04,v:.5}}},

    // ===== MISC =====
    'Reggae':{p:{KICK:[0,10],RIM:[4,12],CH:[2,6,10,14],PERC:[0,4,8,12],PERC2:[2,6,10,14]},
      snd:{
        KICK:{pitch:.78,decay:1.1,tone:.06,drive:.01,body:.7,v:.8},     // one drop: deep warm
        RIM:{pitch:1,tone:.4,decay:.5,body:.4,v:.58},                    // forward rim = the main backbeat
        PERC:{pitch:1.05,body:.55,tone:.2,decay:.52,v:.38}}},
    'Funk':{p:{KICK:[0,4,10,12],SNARE:[4,12],CH:[0,2,4,6,8,10,12,14],OH:[6,14],CLAP:[4],PERC:[2,8],'TOM H':[13],'TOM L':[14,15]},
      snd:{
        KICK:{pitch:.95,decay:.72,tone:.28,drive:.04,body:.48,v:.82},
        SNARE:{pitch:1,tone:.48,decay:.58,drive:.03,body:.45,v:.75},
        'TOM H':{pitch:1.2,decay:.52,body:.2,tone:.3,v:.5},
        'TOM L':{pitch:.62,decay:.72,body:.7,tone:.2,v:.52}}},
    'Marching':{p:{KICK:[0,8],SNARE:[0,2,4,6,8,10,12,14],'SNR 2':[1,3,5,7,9,11,13,15],CRASH:[0],'TOM H':[4,12],'TOM M':[5,13],'TOM L':[6,14]},
      snd:{
        KICK:{pitch:.88,decay:.7,tone:.18,drive:.04,body:.55,v:.85},
        SNARE:{pitch:1.1,tone:.55,decay:.5,drive:.06,body:.45,v:.8},    // tight military snare
        'SNR 2':{pitch:1.2,tone:.65,decay:.35,drive:.04,body:.3,v:.58}, // ghost roll layer
        'TOM H':{pitch:1.28,decay:.52,body:.18,tone:.32,v:.55},
        'TOM M':{pitch:1,decay:.62,body:.42,tone:.28,v:.55},
        'TOM L':{pitch:.65,decay:.75,body:.72,tone:.2,v:.58}}}
  };
  function applyPr(name){const pr=DRUM_PR[name];if(!pr)return;const cp=pats[curPat],ns=cp.steps;
    m.parts.forEach((p,i)=>{const hits=pr.p[p.name]||[];for(let s=0;s<ns;s++)cp.grid[i][s]=0;
      for(let tile=0;tile<Math.ceil(ns/16);tile++){hits.forEach(h=>{const pos=tile*16+h;if(pos<ns)cp.grid[i][pos]=2})}});
    if(pr.snd){m.parts.forEach(p=>{const s=pr.snd[p.name];if(s){
      if(s.pitch!==undefined)p.pitch=s.pitch;if(s.decay!==undefined)p.decay=s.decay;
      if(s.tone!==undefined)p.tone=s.tone;if(s.drive!==undefined)p.drive=s.drive;
      if(s.body!==undefined)p.body=s.body;if(s.pan!==undefined)p.pan=s.pan;
      if(s.v!==undefined)p.v=s.v}})}
    buildAll()}
  // === CONFIG BAR ===
  const cfg=document.createElement('div');cfg.style.cssText='display:flex;align-items:center;gap:4px;padding:3px 6px;background:var(--s1);border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap';

  // Mode toggle
  const gridMBtn=document.createElement('button');gridMBtn.className='pbtn active';gridMBtn.textContent='GRID';
  const freeMBtn=document.createElement('button');freeMBtn.className='pbtn';freeMBtn.textContent='FREE';
  gridMBtn.addEventListener('click',()=>{mode='grid';gridMBtn.classList.add('active');freeMBtn.classList.remove('active');buildAll()});
  freeMBtn.addEventListener('click',()=>{mode='free';freeMBtn.classList.add('active');gridMBtn.classList.remove('active');buildAll()});
  cfg.appendChild(gridMBtn);cfg.appendChild(freeMBtn);

  // Steps toggle
  const stog=document.createElement('span');stog.style.cssText='display:flex;gap:2px;margin-left:4px';
  [16,32,64].forEach(n=>{const b=document.createElement('button');b.className='pbtn';b.textContent=n;
    if(n===16)b.classList.add('active');
    b.addEventListener('click',()=>{pats[curPat].steps=n;m.ts=n;stog.querySelectorAll('button').forEach(x=>x.classList.toggle('active',+x.textContent===n));buildAll()});stog.appendChild(b)});
  cfg.appendChild(stog);

  // Pattern select
  const ptog=document.createElement('span');ptog.style.cssText='display:flex;gap:2px;margin-left:4px';
  for(let i=0;i<NPAT;i++){const b=document.createElement('button');b.className='pbtn';b.textContent='P'+(i+1);
    if(i===0)b.classList.add('active');
    b.addEventListener('click',()=>{curPat=i;m.ts=pats[i].steps;ptog.querySelectorAll('button').forEach(x=>x.classList.remove('active'));b.classList.add('active');
      stog.querySelectorAll('button').forEach(x=>x.classList.toggle('active',+x.textContent===pats[i].steps));buildAll()});ptog.appendChild(b)};
  cfg.appendChild(ptog);

  // Swing
  const swL=document.createElement('label');swL.style.cssText='font-size:6px;color:var(--dim);margin-left:4px';swL.textContent='SW';
  const swI=document.createElement('input');swI.type='range';swI.min=0;swI.max=100;swI.value=0;swI.style.cssText='width:40px;height:2px';
  swI.addEventListener('input',()=>{globalSwing=+swI.value/100});cfg.appendChild(swL);cfg.appendChild(swI);

  // Euclid random
  const eucBtn=document.createElement('button');eucBtn.className='pbtn';eucBtn.textContent='üé≤EUCLID';
  const dens={KICK:[1,4],KICK2:[0,2],SNARE:[1,3],'SNR 2':[0,2],CH:[3,8],OH:[1,3],CLAP:[1,2],SNAP:[0,2],RIM:[1,3],PERC:[1,4],PERC2:[0,3],CRASH:[0,1],RIDE:[2,6],'TOM H':[0,2],'TOM M':[0,2],'TOM L':[0,2]};
  function euclid(hits,len){const r=[];let a=Array(hits).fill([1]),b=Array(len-hits).fill([0]);
    while(b.length>1){const c=[];const mn=Math.min(a.length,b.length);
      for(let i=0;i<mn;i++)c.push([...a[i],...b[i]]);
      if(a.length>mn)b=a.slice(mn);else if(b.length>mn)b=b.slice(mn);else b=[];a=c}
    return a.concat(b).flat()}
  eucBtn.addEventListener('click',()=>{const cp=pats[curPat],ns=cp.steps;
    m.parts.forEach((p,i)=>{const d=dens[p.name]||[0,3];const hits=d[0]+Math.floor(Math.random()*(d[1]-d[0]+1));
      if(hits===0){for(let s=0;s<ns;s++)cp.grid[i][s]=0}
      else{const pt=euclid(hits,ns),rot=Math.floor(Math.random()*ns);for(let s=0;s<ns;s++)cp.grid[i][s]=pt[(s+rot)%ns]?2:0}});buildAll()});
  cfg.appendChild(eucBtn);

  // Preset + CLR
  const preSel=document.createElement('select');preSel.style.cssText='background:var(--s3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:7px;font-weight:700;padding:2px 4px;border-radius:2px;cursor:pointer';
  const def=document.createElement('option');def.textContent='PRESET';def.disabled=true;def.selected=true;preSel.appendChild(def);
  Object.keys(DRUM_PR).forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;preSel.appendChild(o)});
  preSel.addEventListener('change',()=>{applyPr(preSel.value);preSel.selectedIndex=0});cfg.appendChild(preSel);
  const clrBtn=document.createElement('button');clrBtn.className='pbtn';clrBtn.textContent='CLR';
  clrBtn.addEventListener('click',()=>{if(mode==='free')freeEvents[curPat]=[];else pats[curPat].grid.forEach(r=>r.fill(0));buildAll()});cfg.appendChild(clrBtn);
  bd.appendChild(cfg);

  // === GRID AREA (scrollable) ===
  const gridArea=document.createElement('div');gridArea.style.cssText='flex:1;overflow:auto;position:relative';
  gridArea.appendChild(needle);
  const HDW=64; // header width

  function buildAll(){
    gridArea.innerHTML='';m.se=[];
    gridArea.appendChild(needle);needle.style.display='none';
    const savedRow=selRow,savedCol=selCol;
    selRow=-1;selCol=-1;
    if(mode==='grid'){buildGrid();selRow=savedRow;selCol=savedCol;updSelection()}
    else buildFreeCanvas();
    updEditBar();
  }
  function buildGrid(){
    const cp=pats[curPat],ns=cp.steps;
    const tbl=document.createElement('div');tbl.style.cssText='display:grid;grid-template-columns:'+HDW+'px repeat('+ns+',1fr);min-width:'+(HDW+ns*28)+'px';

    // === TOP-LEFT CORNER (empty) ===
    const corner=document.createElement('div');corner.style.cssText='background:var(--s1);border-bottom:1px solid var(--border);border-right:1px solid var(--border);position:sticky;left:0;z-index:3';
    tbl.appendChild(corner);

    // === COLUMN HEADERS (step numbers ‚Äî clickable to select column) ===
    for(let s=0;s<ns;s++){
      const hd=document.createElement('div');
      hd.style.cssText='font-size:7px;font-weight:700;color:var(--dim);text-align:center;padding:2px 0;cursor:pointer;border-bottom:1px solid var(--border);user-select:none;transition:background .1s'+(s%4===0?';color:var(--text)':'');
      hd.textContent=s+1;
      hd.addEventListener('click',()=>{selCol=selCol===s?-1:s;selRow=-1;updSelection();updEditBar()});
      hd._colIdx=s;tbl.appendChild(hd)}

    // === ROWS ===
    m.parts.forEach((p,pi)=>{
      // Row header ‚Äî clickable to select row
      const hd=document.createElement('div');
      hd.style.cssText='display:flex;align-items:center;gap:3px;padding:2px 4px;cursor:pointer;border-bottom:1px solid var(--border);border-right:1px solid var(--border);position:sticky;left:0;z-index:2;background:var(--s1);user-select:none;transition:background .15s';
      const dot=document.createElement('span');dot.style.cssText='width:5px;height:5px;border-radius:50%;background:'+p.col+';flex-shrink:0';
      const nm=document.createElement('span');nm.style.cssText='font-size:7px;font-weight:700;color:'+p.col+';flex:1';nm.textContent=p.name;
      hd.append(dot,nm);
      hd.addEventListener('click',()=>{selRow=selRow===pi?-1:pi;selCol=-1;updSelection();updEditBar();
        initA();trig(p,ctx.currentTime,VMUL[2],m.dst())});
      hd._rowIdx=pi;tbl.appendChild(hd);

      // Step cells
      const sr=[];
      for(let s=0;s<ns;s++){
        const cell=document.createElement('div');
        cell.style.cssText='height:26px;border-bottom:1px solid var(--border);border-right:1px solid rgba(255,255,255,.02);cursor:pointer;transition:background .08s;position:relative'+(s%4===0?';border-left:1px solid rgba(255,255,255,.05)':'');
        updCell(cell,cp.grid[pi][s],p.col);
        cell.addEventListener('mousedown',e=>{e.preventDefault();
          if(e.button===0){cp.grid[pi][s]=cp.grid[pi][s]===0?2:cp.grid[pi][s]===2?3:0;updCell(cell,cp.grid[pi][s],p.col);
            if(cp.grid[pi][s]>0&&m.aud(pi)){initA();trig(p,ctx.currentTime,VMUL[cp.grid[pi][s]],m.dst())}}});
        cell.addEventListener('contextmenu',e=>{e.preventDefault();cp.grid[pi][s]=0;updCell(cell,0,p.col)});
        cell._r=pi;cell._c=s;tbl.appendChild(cell);sr.push(cell)}
      m.se.push(sr)});
    gridArea.appendChild(tbl);
  }

  function buildFreeCanvas(){
    selRow=-1;selCol=-1;
    const fe=freeEvents[curPat];const ns=pats[curPat].steps;
    const NP_=NP;const ROW_H=28;const totalH=NP_*ROW_H;
    // Part headers
    const wrap=document.createElement('div');wrap.style.cssText='display:flex;min-width:600px';
    const hdCol=document.createElement('div');hdCol.style.cssText='width:'+HDW+'px;flex-shrink:0';
    m.parts.forEach((p,i)=>{
      const hd=document.createElement('div');
      hd.style.cssText='height:'+ROW_H+'px;display:flex;align-items:center;gap:3px;padding:0 4px;cursor:pointer;border-bottom:1px solid var(--border);border-right:1px solid var(--border);background:var(--s1);user-select:none;transition:background .1s';
      const dot=document.createElement('span');dot.style.cssText='width:5px;height:5px;border-radius:50%;background:'+p.col;
      const nm=document.createElement('span');nm.style.cssText='font-size:7px;font-weight:700;color:'+p.col;nm.textContent=p.name;
      hd.append(dot,nm);
      hd.addEventListener('click',()=>{selRow=selRow===i?-1:i;selCol=-1;
        hdCol.querySelectorAll('div').forEach((h,j)=>{h.style.background=j===selRow?'var(--s3)':'var(--s1)'});
        updEditBar();initA();trig(p,ctx.currentTime,VMUL[2],m.dst())});
      hdCol.appendChild(hd)});
    wrap.appendChild(hdCol);

    const cvs=document.createElement('canvas');cvs.style.cssText='flex:1;height:'+totalH+'px;cursor:crosshair';
    wrap.appendChild(cvs);gridArea.appendChild(wrap);

    function draw(){
      const dpr=window.devicePixelRatio||1;
      const W=cvs.width=Math.round(cvs.clientWidth*dpr);const H=cvs.height=Math.round(totalH*dpr);
      const x=cvs.getContext('2d');x.clearRect(0,0,W,H);
      // Row bgs
      m.parts.forEach((p,i)=>{const y=i*ROW_H*dpr,h=ROW_H*dpr;
        x.fillStyle=i%2===0?'rgba(255,255,255,.012)':'rgba(0,0,0,.04)';x.fillRect(0,y,W,h);
        x.strokeStyle='rgba(255,255,255,.04)';x.beginPath();x.moveTo(0,y+h);x.lineTo(W,y+h);x.stroke()});
      // Beat lines
      for(let s=0;s<=ns;s++){const xp=s/ns*W;x.strokeStyle=s%4===0?'rgba(255,255,255,.1)':'rgba(255,255,255,.03)';
        x.lineWidth=s%4===0?1.5:1;x.beginPath();x.moveTo(xp,0);x.lineTo(xp,H);x.stroke();
        if(s%4===0&&s<ns){x.fillStyle='rgba(255,255,255,.2)';x.font=(7*dpr)+'px monospace';x.fillText(s+1,xp+2*dpr,8*dpr)}}
      // Events
      fe.forEach(ev=>{const p=m.parts[ev.part];if(!p)return;
        const xp=ev.time*W,y=(ev.part+.5)*ROW_H*dpr;
        const r=(ev.vel===3?6:ev.vel===1?2.5:4)*dpr;
        x.beginPath();x.arc(xp,y,r,0,Math.PI*2);
        x.fillStyle=p.col+(ev.vel===1?'55':ev.vel===3?'ff':'99');x.fill();
        x.strokeStyle=p.col;x.lineWidth=1.5;x.stroke()});
    }
    requestAnimationFrame(draw);

    cvs.addEventListener('mousedown',e=>{e.preventDefault();
      const rect=cvs.getBoundingClientRect();const xFrac=(e.clientX-rect.left)/rect.width;
      const partIdx=Math.floor((e.clientY-rect.top)/ROW_H);
      if(partIdx<0||partIdx>=NP_)return;
      if(e.button===2||e.ctrlKey){// Remove nearest
        let best=-1,bestD=Infinity;fe.forEach((ev,i)=>{if(ev.part===partIdx){const d=Math.abs(ev.time-xFrac);if(d<bestD){bestD=d;best=i}}});
        if(best>=0&&bestD<.03){fe.splice(best,1);draw()}return}
      const vel=e.shiftKey?3:e.altKey?1:2;
      fe.push({part:partIdx,time:xFrac,vel});fe.sort((a,b)=>a.time-b.time);draw();
      if(m.aud(partIdx)){initA();trig(m.parts[partIdx],ctx.currentTime,VMUL[vel],m.dst())}});
    cvs.addEventListener('contextmenu',e=>e.preventDefault());
  }

  function updCell(el,vel,col){
    if(vel===0){el.style.background='';el.innerHTML=''}
    else{
      const op=vel===3?1:vel===2?.7:.3;
      el.style.background=col+Math.round(op*40).toString(16).padStart(2,'0');
      el.innerHTML='<div style="position:absolute;inset:3px;border-radius:2px;background:'+col+';opacity:'+op+'"></div>'}
  }

  // === SELECTION HIGHLIGHT ===
  function updSelection(){
    const cells=gridArea.querySelectorAll('div[style*="height:26px"]');
    cells.forEach(c=>{c.style.outline=''});
    const hdrs=gridArea.querySelectorAll('div[style*="sticky"]');
    hdrs.forEach(h=>{if(h._rowIdx!==undefined)h.style.background=h._rowIdx===selRow?'var(--s3)':'var(--s1)';});
    // Column headers
    const colHdrs=gridArea.querySelectorAll('div[style*="text-align:center"]');
    colHdrs.forEach(h=>{if(h._colIdx!==undefined)h.style.background=h._colIdx===selCol?'var(--s3)':''});
    // Highlight cells
    if(selRow>=0&&selCol>=0){
      // Single cell selected
      cells.forEach(c=>{if(c._r===selRow&&c._c===selCol)c.style.outline='2px solid #f97316'});
    }else if(selRow>=0){
      // Whole row
      cells.forEach(c=>{if(c._r===selRow)c.style.outline='1px solid '+m.parts[selRow].col+'60'});
    }else if(selCol>=0){
      // Whole column
      cells.forEach(c=>{if(c._c===selCol)c.style.outline='1px solid #f9731640'});
    }
  }

  // === BOTTOM EDIT BAR ‚Äî context-sensitive, one control at a time ===
  const editBar=document.createElement('div');
  editBar.style.cssText='min-height:48px;border-top:1px solid var(--border);padding:6px 10px;display:flex;gap:8px;align-items:center;background:var(--s1);flex-shrink:0;overflow-x:auto';
  let editParam=null; // currently editing param name

  function updEditBar(){
    editBar.innerHTML='';editParam=editParam; // preserve
    if(selRow<0&&selCol<0){
      const hint=document.createElement('span');hint.style.cssText='font-size:7px;color:var(--dim);font-style:italic';
      hint.textContent='\u25C0 Click a part name to shape its sound \u2022 Click a step number to edit a column';
      editBar.appendChild(hint);return}

    if(selRow>=0){
      // === ROW: Sound design for selected part ===
      const p=m.parts[selRow];
      // Name + M/S
      const hdr=document.createElement('div');hdr.style.cssText='display:flex;align-items:center;gap:4px;min-width:70px;flex-shrink:0';
      const nm=document.createElement('span');nm.style.cssText='font-size:10px;font-weight:800;color:'+p.col;nm.textContent=p.name;
      const mt=document.createElement('div');mt.className='bm'+(p.mut?' muted':'');mt.textContent='M';
      mt.addEventListener('click',()=>{p.mut=!p.mut;mt.classList.toggle('muted')});
      const so=document.createElement('div');so.className='bs_btn'+(p.solo?' soloed':'');so.textContent='S';
      so.addEventListener('click',()=>{p.solo=!p.solo;so.classList.toggle('soloed')});
      hdr.append(nm,mt,so);editBar.appendChild(hdr);

      // Param buttons ‚Äî click one to reveal its slider
      const params=[
        {k:'v',l:'VOL',min:0,max:100,get:()=>p.v*100,set:v=>{p.v=v/100},fmt:v=>Math.round(v)+'%'},
        {k:'pitch',l:'PITCH',min:25,max:300,get:()=>p.pitch*100,set:v=>{p.pitch=v/100},fmt:v=>(v/100).toFixed(2)+'x'},
        {k:'decay',l:'DECAY',min:5,max:200,get:()=>p.decay*100,set:v=>{p.decay=v/100},fmt:v=>(v/100).toFixed(2)+'x'},
        {k:'tone',l:'TONE',min:0,max:100,get:()=>p.tone*100,set:v=>{p.tone=v/100},fmt:v=>Math.round(v)+'%'},
        {k:'body',l:'BODY',min:0,max:100,get:()=>p.body*100,set:v=>{p.body=v/100},fmt:v=>Math.round(v)+'%'},
        {k:'drive',l:'DRIVE',min:0,max:100,get:()=>p.drive*100,set:v=>{p.drive=v/100},fmt:v=>Math.round(v)+'%'},
        {k:'pan',l:'PAN',min:-100,max:100,get:()=>p.pan*100,set:v=>{p.pan=v/100},fmt:v=>{const x=Math.round(v);return x<0?'L'+(-x):x>0?'R'+x:'C'}},
        {k:'prob',l:'PROB',min:0,max:100,get:()=>p.prob,set:v=>{p.prob=v},fmt:v=>Math.round(v)+'%'},
        {k:'hum',l:'HUMAN',min:0,max:100,get:()=>p.hum,set:v=>{p.hum=v},fmt:v=>Math.round(v)+'%'},
        {k:'swing',l:'SWING',min:0,max:100,get:()=>p.swing*100,set:v=>{p.swing=v/100},fmt:v=>Math.round(v)+'%'},
      ];

      // Param button strip
      const strip=document.createElement('div');strip.style.cssText='display:flex;gap:2px;flex-shrink:0';
      params.forEach(pr=>{
        const btn=document.createElement('button');
        const isActive=editParam===pr.k;
        btn.style.cssText='font-family:inherit;font-size:6px;font-weight:700;padding:4px 6px;border-radius:3px;cursor:pointer;transition:all .1s;border:1px solid '+
          (isActive?p.col:p.col+'30')+';background:'+(isActive?p.col+'20':'transparent')+';color:'+(isActive?p.col:'var(--dim)')+';letter-spacing:.3px;white-space:nowrap';
        btn.textContent=pr.l;
        btn.addEventListener('click',()=>{editParam=editParam===pr.k?null:pr.k;updEditBar()});
        strip.appendChild(btn)});
      editBar.appendChild(strip);

      // Active slider area
      const active=params.find(pr=>pr.k===editParam);
      if(active){
        const slWrap=document.createElement('div');slWrap.style.cssText='display:flex;align-items:center;gap:8px;flex:1;min-width:160px';
        const sl=document.createElement('input');sl.type='range';sl.min=active.min;sl.max=active.max;sl.value=active.get();
        sl.style.cssText='-webkit-appearance:none;appearance:none;flex:1;height:6px;background:'+p.col+'25;border-radius:3px;outline:none;cursor:pointer';
        const valDisp=document.createElement('span');valDisp.style.cssText='font-size:9px;font-weight:800;color:'+p.col+';min-width:44px;text-align:center;font-variant-numeric:tabular-nums';
        valDisp.textContent=active.fmt(active.get());
        sl.addEventListener('input',()=>{active.set(+sl.value);valDisp.textContent=active.fmt(+sl.value)});
        sl.addEventListener('change',()=>{initA();trig(p,ctx.currentTime,VMUL[2],m.dst())});
        slWrap.append(sl,valDisp);editBar.appendChild(slWrap);
      }

      // Action buttons
      const acts=document.createElement('div');acts.style.cssText='display:flex;gap:3px;flex-shrink:0;margin-left:auto';
      const rnd=document.createElement('button');rnd.className='pbtn';rnd.textContent='\u{1F3B2}';rnd.title='Randomize sound';
      rnd.addEventListener('click',()=>{p.pitch=.5+Math.random()*1.5;p.decay=.2+Math.random()*.8;p.tone=Math.random();
        p.drive=Math.random()*.6;p.body=Math.random();p.pan=(Math.random()-.5)*.8;
        updEditBar();initA();trig(p,ctx.currentTime,VMUL[2],m.dst())});
      const fillBtn=document.createElement('button');fillBtn.className='pbtn';fillBtn.textContent='FILL';
      fillBtn.addEventListener('click',()=>{const cp=pats[curPat],ns=cp.steps;for(let s=0;s<ns;s++)if(cp.grid[selRow][s]===0)cp.grid[selRow][s]=2;buildAll()});
      const clrRow=document.createElement('button');clrRow.className='pbtn';clrRow.textContent='CLR';
      clrRow.addEventListener('click',()=>{const cp=pats[curPat],ns=cp.steps;for(let s=0;s<ns;s++)cp.grid[selRow][s]=0;buildAll()});
      acts.append(rnd,fillBtn,clrRow);editBar.appendChild(acts);
    }

    if(selCol>=0&&selRow<0){
      // === COLUMN: toggle parts on this step ===
      const cp=pats[curPat],s=selCol;
      const info=document.createElement('span');info.style.cssText='font-size:10px;font-weight:800;color:#f97316;min-width:46px;flex-shrink:0';
      info.textContent='STEP '+(s+1);editBar.appendChild(info);
      m.parts.forEach((p,i)=>{
        const on=cp.grid[i][s]>0;
        const btn=document.createElement('button');
        btn.style.cssText='font-family:inherit;font-size:7px;font-weight:700;padding:5px 10px;border-radius:3px;cursor:pointer;border:1px solid '+p.col+'50;transition:all .12s;'+
          (on?'background:'+p.col+';color:#000':'background:transparent;color:'+p.col);
        btn.textContent=p.name;
        btn.addEventListener('click',()=>{cp.grid[i][s]=cp.grid[i][s]>0?0:2;buildAll();selCol=s;updSelection();updEditBar();
          if(cp.grid[i][s]>0){initA();trig(p,ctx.currentTime,VMUL[2],m.dst())}});
        editBar.appendChild(btn)});
    }
  }

    function updStepVis(el,vel,col){
    el.classList.toggle('on',vel>0);
    if(vel===0){el.style.background='';el.style.borderColor='';el.style.opacity=''}
    else if(vel===1){el.style.background=col;el.style.borderColor=col;el.style.opacity='.35'}
    else if(vel===2){el.style.background=col;el.style.borderColor=col;el.style.opacity='.75'}
    else if(vel===3){el.style.background=col;el.style.borderColor=col;el.style.opacity='1'}
  }
  function euclid(k,n){const p=[];let b=Array.from({length:k},()=>[1]),r=Array.from({length:n-k},()=>[0]);
    while(r.length>1){const nb=[],nr=[];const mn=Math.min(b.length,r.length);
      for(let i=0;i<mn;i++)nb.push([...b[i],...r[i]]);if(b.length>mn)nr.push(...b.slice(mn));else nr.push(...r.slice(mn));b=nb;r=nr}
    b.concat(r).forEach(x=>p.push(...x));return p}

  bd.appendChild(gridArea);
  bd.appendChild(editBar);
  buildAll();
  addClipBtns(ct,m);ct.querySelector('.close').addEventListener('click',()=>{if(m._clipClean)m._clipClean();rmMod(id)});
  m.buildGrid=()=>buildAll();
  wsI.appendChild(el);mods.push(m);filt();
}

// === CHORD MODULE ‚Äî progression builder ===
function addChord(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('CHORD<span>.EXE</span>','Chords','#14b8a6',300+(mods.length%4)*30,100+(mods.length%4)*20,540,260,ci);
  el.id='m'+id;
  const NN=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const CHORDS={
    // Triads
    maj:[0,4,7],min:[0,3,7],dim:[0,3,6],aug:[0,4,8],
    // Suspended
    sus2:[0,2,7],sus4:[0,5,7],
    // Sevenths
    maj7:[0,4,7,11],min7:[0,3,7,10],dom7:[0,4,7,10],'m/M7':[0,3,7,11],dim7:[0,3,6,9],'√∏7':[0,3,6,10],
    // Extended
    add9:[0,4,7,14],add11:[0,4,7,17],maj9:[0,4,7,11,14],min9:[0,3,7,10,14],dom9:[0,4,7,10,14],'9sus4':[0,5,7,10,14],
    min11:[0,3,7,10,14,17],maj13:[0,4,7,11,14,21],dom13:[0,4,7,10,14,21],
    // Sixths
    '6':[0,4,7,9],'m6':[0,3,7,9],
    // Power / Special
    '5':[0,7],'5oct':[0,7,12],
    // Altered
    '7#9':[0,4,7,10,15],'7b9':[0,4,7,10,13],'7#5':[0,4,8,10],'7b5':[0,4,6,10]
  };
  const PROGS={
    // Pop / Rock
    'I-V-vi-IV':[{r:0,t:'maj'},{r:7,t:'maj'},{r:9,t:'min'},{r:5,t:'maj'}],
    'I-vi-IV-V':[{r:0,t:'maj'},{r:9,t:'min'},{r:5,t:'maj'},{r:7,t:'maj'}],
    'vi-IV-I-V':[{r:9,t:'min'},{r:5,t:'maj'},{r:0,t:'maj'},{r:7,t:'maj'}],
    'I-IV-vi-V':[{r:0,t:'maj'},{r:5,t:'maj'},{r:9,t:'min'},{r:7,t:'maj'}],
    // Jazz
    'ii-V-I':[{r:2,t:'min7'},{r:7,t:'dom7'},{r:0,t:'maj7'},{r:0,t:'maj7'}],
    'I-vi-ii-V':[{r:0,t:'maj7'},{r:9,t:'min7'},{r:2,t:'min7'},{r:7,t:'dom7'}],
    'iii-vi-ii-V':[{r:4,t:'min7'},{r:9,t:'min7'},{r:2,t:'min7'},{r:7,t:'dom7'}],
    'I‚ñ≥-IV‚ñ≥':[{r:0,t:'maj9'},{r:0,t:'maj9'},{r:5,t:'maj9'},{r:5,t:'maj9'}],
    // Dark / Minor
    'i-VI-III-VII':[{r:0,t:'min'},{r:8,t:'maj'},{r:3,t:'maj'},{r:10,t:'maj'}],
    'i-iv-v-i':[{r:0,t:'min'},{r:5,t:'min'},{r:7,t:'min'},{r:0,t:'min'}],
    'i-VII-VI-V':[{r:0,t:'min'},{r:10,t:'maj'},{r:8,t:'maj'},{r:7,t:'maj'}],
    'i-iv-VII-III':[{r:0,t:'min7'},{r:5,t:'min7'},{r:10,t:'dom7'},{r:3,t:'maj7'}],
    // Neo-Soul / Lofi
    'NeoSoul':[{r:2,t:'min9'},{r:7,t:'dom9'},{r:0,t:'maj9'},{r:5,t:'maj7'}],
    'LoFi Chill':[{r:0,t:'maj7'},{r:9,t:'min7'},{r:5,t:'maj7'},{r:7,t:'dom9'}],
    'Gospel':[{r:0,t:'maj9'},{r:3,t:'dim7'},{r:2,t:'min9'},{r:7,t:'dom13'}],
    // Blues
    '12 Bar':[{r:0,t:'dom7'},{r:0,t:'dom7'},{r:5,t:'dom7'},{r:0,t:'dom7'}],
    'Minor Blues':[{r:0,t:'min7'},{r:5,t:'min7'},{r:0,t:'min7'},{r:7,t:'dom7'}],
    // Modal / Ambient
    'Dorian':[{r:0,t:'min7'},{r:5,t:'maj'},{r:7,t:'min'},{r:3,t:'maj'}],
    'Mixolydian':[{r:0,t:'dom7'},{r:10,t:'maj'},{r:5,t:'maj'},{r:7,t:'min'}],
    'Lydian':[{r:0,t:'maj7'},{r:2,t:'maj'},{r:7,t:'maj'},{r:4,t:'min'}],
    // Trap / Hip-Hop
    'Trap Dark':[{r:0,t:'min'},{r:3,t:'maj'},{r:8,t:'maj'},{r:7,t:'5'}],
    'Trap Sad':[{r:0,t:'min7'},{r:10,t:'maj'},{r:8,t:'maj'},{r:3,t:'maj'}]
  };
  const m={id,type:'chord',el,ci,ts:16,oct:4,vol:.3,wv:'sawtooth',det:8,a:.02,d:.15,s:.5,r:.3,slots:[
    {root:0,type:'maj'},{root:7,type:'maj'},{root:9,type:'min'},{root:5,type:'maj'}
  ],stepsPerChord:4};
  m.dst=()=>chs[m.ci].g||mGain;
  m.nf=(n,o)=>440*Math.pow(2,(n-9)/12+(o-4));
  m.playChord=(slot,t)=>{if(!ctx)return;const dest=m.dst(),notes=CHORDS[slot.type];if(!notes)return;
    notes.forEach(n=>{const freq=m.nf((slot.root+n)%12,m.oct+Math.floor((slot.root+n)/12));
      const o1=ctx.createOscillator(),o2=ctx.createOscillator(),g=ctx.createGain(),f=ctx.createBiquadFilter();
      o1.type=m.wv;o1.frequency.value=freq;o2.type=m.wv;o2.frequency.value=freq;o2.detune.value=m.det;
      f.type='lowpass';f.frequency.value=2500;f.Q.value=.5;o1.connect(f);o2.connect(f);f.connect(g);g.connect(dest);
      const dur=m.a+m.d+m.r+.1;
      g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(m.vol/notes.length,t+m.a);
      g.gain.linearRampToValueAtTime(m.vol*m.s/notes.length,t+m.a+m.d);g.gain.linearRampToValueAtTime(0,t+m.a+m.d+m.r);
      o1.start(t);o1.stop(t+dur);o2.start(t);o2.stop(t+dur)})};
  m.onStep=(s,t)=>{const ci2=Math.floor(s/m.stepsPerChord)%m.slots.length;
    if(s%m.stepsPerChord===0)m.playChord(m.slots[ci2],t);
    slotEls.forEach((e,i)=>{if(e._setActive)e._setActive(i===ci2);else e.classList.toggle('active',i===ci2)})};
  m.clr=()=>slotEls.forEach(e=>{if(e._setActive)e._setActive(false);else e.classList.remove('active')});
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});
  // controls row 1: waveform + oct/vol/det
  const ctrl=document.createElement('div');ctrl.className='piano-ctrl';
  const wsel=document.createElement('div');wsel.className='sws';
  ['sawtooth','square','triangle','sine'].forEach(w=>{const b=document.createElement('button');b.className='swb'+(m.wv===w?' active':'');b.textContent=w==='sawtooth'?'SAW':w.slice(0,3).toUpperCase();
    b.addEventListener('click',()=>{m.wv=w;wsel.querySelectorAll('.swb').forEach(x=>x.classList.remove('active'));b.classList.add('active')});wsel.appendChild(b)});
  ctrl.appendChild(wsel);
  ctrl.append(mkK('Oct',2,6,m.oct,v=>{m.oct=Math.round(v)},1),mkK('Vol',0,100,m.vol*100,v=>{m.vol=v/100}),mkK('Det',0,50,m.det,v=>{m.det=v}));
  bd.appendChild(ctrl);
  // controls row 2: ADSR
  const envR=document.createElement('div');envR.className='piano-ctrl';envR.style.borderTop='none';envR.style.paddingTop='0';envR.style.marginTop='-2px';
  envR.append(mkK('A',0,100,m.a*100,v=>{m.a=v/100}),mkK('D',0,100,m.d*100,v=>{m.d=v/100}),mkK('S',0,100,m.s*100,v=>{m.s=v/100}),mkK('R',0,200,m.r*100,v=>{m.r=v/100}));
  bd.appendChild(envR);
  // Preset bar: category dropdown + buttons for that category + steps/chord
  const preRow=document.createElement('div');preRow.style.cssText='display:flex;align-items:center;gap:5px;margin-bottom:6px;flex-wrap:wrap';
  const pGroups={
    'Pop/Rock':['I-V-vi-IV','I-vi-IV-V','vi-IV-I-V','I-IV-vi-V'],
    'Jazz':['ii-V-I','I-vi-ii-V','iii-vi-ii-V','I‚ñ≥-IV‚ñ≥'],
    'Dark/Minor':['i-VI-III-VII','i-iv-v-i','i-VII-VI-V','i-iv-VII-III'],
    'Neo-Soul/Lofi':['NeoSoul','LoFi Chill','Gospel'],
    'Blues':['12 Bar','Minor Blues'],
    'Modal':['Dorian','Mixolydian','Lydian'],
    'Trap':['Trap Dark','Trap Sad']
  };
  const catNames=Object.keys(pGroups);
  const catSel=document.createElement('select');
  catSel.style.cssText='background:var(--s3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:7px;font-weight:700;padding:2px 4px;border-radius:3px;outline:none;cursor:pointer';
  catNames.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;catSel.appendChild(o)});
  preRow.appendChild(catSel);
  const preBtns=document.createElement('div');preBtns.style.cssText='display:flex;gap:3px;flex-wrap:wrap;flex:1';
  function showCatPresets(cat){
    preBtns.innerHTML='';
    (pGroups[cat]||[]).forEach(name=>{if(!PROGS[name])return;
      const b=document.createElement('button');b.className='pbtn';b.textContent=name;
      b.addEventListener('click',()=>{m.slots=PROGS[name].map(p=>({...p,root:p.r,type:p.t}));renSlots()});
      preBtns.appendChild(b)});
  }
  showCatPresets(catNames[0]);
  catSel.addEventListener('change',()=>showCatPresets(catSel.value));
  preRow.appendChild(preBtns);
  // Steps per chord inline
  const spcSep=document.createElement('div');spcSep.style.cssText='width:1px;height:14px;background:var(--border)';
  preRow.appendChild(spcSep);
  const spcLbl=document.createElement('span');spcLbl.style.cssText='font-size:6px;color:var(--dim);letter-spacing:.3px;font-weight:700;white-space:nowrap';spcLbl.textContent='STEPS';
  preRow.appendChild(spcLbl);
  const spcBtns=[];
  [2,4,8,16].forEach(n=>{
    const b=document.createElement('button');b.className='pbtn';b.textContent=n;
    if(n===m.stepsPerChord){b.style.borderColor='#14b8a6';b.style.color='#14b8a6'}
    b.addEventListener('click',()=>{m.stepsPerChord=n;m.ts=m.slots.length*n;
      spcBtns.forEach(x=>{x.style.borderColor='';x.style.color=''});
      b.style.borderColor='#14b8a6';b.style.color='#14b8a6'});
    spcBtns.push(b);preRow.appendChild(b);
  });
  bd.appendChild(preRow);
  // chord slots
  const slotsWrap=document.createElement('div');slotsWrap.style.cssText='display:flex;gap:4px;flex-wrap:wrap';
  const slotEls=[];
  function renSlots(){
    slotsWrap.innerHTML='';slotEls.length=0;
    m.slots.forEach((slot,i)=>{
      const s=document.createElement('div');
      s.style.cssText='background:var(--s2);border:2px solid var(--border);border-radius:5px;padding:6px 8px;flex:1;min-width:90px;cursor:pointer;transition:all .15s';
      const hd=document.createElement('div');hd.style.cssText='display:flex;justify-content:space-between;align-items:center;margin-bottom:4px';
      const num=document.createElement('span');num.style.cssText='font-size:6px;color:var(--dim)';num.textContent=i+1;
      const nm=document.createElement('span');nm.style.cssText='font-size:10px;font-weight:800;color:#fff';nm.textContent=NN[slot.root]+' '+slot.type;
      hd.append(num,nm);s.appendChild(hd);
      // Root + Type selectors side by side
      const selRow=document.createElement('div');selRow.style.cssText='display:flex;gap:3px';
      const sstyle='background:var(--s3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:7px;padding:2px 3px;border-radius:2px;flex:1;outline:none;cursor:pointer';
      const rsel=document.createElement('select');rsel.style.cssText=sstyle;
      NN.forEach((n,ni)=>{const o=document.createElement('option');o.value=ni;o.textContent=n;if(ni===slot.root)o.selected=true;rsel.appendChild(o)});
      rsel.addEventListener('change',()=>{slot.root=+rsel.value;nm.textContent=NN[slot.root]+' '+slot.type});
      const tsel=document.createElement('select');tsel.style.cssText=sstyle;
      Object.keys(CHORDS).forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;if(t===slot.type)o.selected=true;tsel.appendChild(o)});
      tsel.addEventListener('change',()=>{slot.type=tsel.value;nm.textContent=NN[slot.root]+' '+slot.type});
      selRow.append(rsel,tsel);s.appendChild(selRow);
      // click to preview
      s.addEventListener('click',e=>{if(e.target.tagName==='SELECT')return;initA();m.playChord(slot,ctx.currentTime)});
      // Active highlight
      s._setActive=(on)=>{s.style.borderColor=on?'#14b8a6':'var(--border)';s.style.background=on?'rgba(20,184,166,.08)':'var(--s2)'};
      slotsWrap.appendChild(s);slotEls.push(s)});
    // +/- buttons
    const ab=document.createElement('div');ab.style.cssText='display:flex;flex-direction:column;gap:3px;justify-content:center';
    const addB=document.createElement('button');addB.className='pbtn';addB.textContent='+';addB.style.fontSize='10px';
    addB.addEventListener('click',()=>{if(m.slots.length<8){m.slots.push({root:0,type:'maj'});m.ts=m.slots.length*m.stepsPerChord;renSlots()}});
    const rmB=document.createElement('button');rmB.className='pbtn';rmB.textContent='‚àí';rmB.style.fontSize='10px';
    rmB.addEventListener('click',()=>{if(m.slots.length>2){m.slots.pop();m.ts=m.slots.length*m.stepsPerChord;renSlots()}});
    ab.append(addB,rmB);slotsWrap.appendChild(ab);
    m.ts=m.slots.length*m.stepsPerChord}
  renSlots();bd.appendChild(slotsWrap);
  m.renSlots=renSlots;
  addClipBtns(ct,m);ct.querySelector('.close').addEventListener('click',()=>{if(m._clipClean)m._clipClean();rmMod(id)});
  wsI.appendChild(el);mods.push(m);filt();
}

// === EDIT MODULE ‚Äî audio editor ===
function addEdit(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('EDIT<span>.EXE</span>','Editor','#06b6d4',400+(mods.length%4)*30,340+(mods.length%4)*20,620,430,ci);
  el.id='m'+id;
  const EC='#06b6d4';
  const m={id,type:'edit',el,ci,ts:0,buf:null,edited:null,src:null,rate:1,onStep:()=>{},clr:()=>{}};
  let sL=0,sR=1;const undoStack=[];const MAX_UNDO=20;
  m.dst=()=>chs[m.ci].g||mGain;
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});
  function pushUndo(){if(!m.edited)return;undoStack.push(copyBuf(m.edited));if(undoStack.length>MAX_UNDO)undoStack.shift();updUndoCt()}
  function eBtn(label,fn,tip){
    const b=document.createElement('button');
    b.style.cssText='background:rgba(6,182,212,.05);border:1px solid rgba(6,182,212,.15);color:rgba(6,182,212,.65);font-family:inherit;font-size:6px;font-weight:700;padding:4px 0;border-radius:3px;cursor:pointer;transition:all .12s;letter-spacing:.3px;text-align:center;white-space:nowrap';
    b.textContent=label;if(tip)b.title=tip;
    b.addEventListener('mouseenter',()=>{b.style.borderColor='rgba(6,182,212,.5)';b.style.color=EC;b.style.background='rgba(6,182,212,.12)'});
    b.addEventListener('mouseleave',()=>{b.style.borderColor='rgba(6,182,212,.15)';b.style.color='rgba(6,182,212,.65)';b.style.background='rgba(6,182,212,.05)'});
    b.addEventListener('click',fn);return b}
  function eSec(label){
    const w=document.createElement('div');w.style.cssText='margin-bottom:4px';
    const h=document.createElement('div');h.style.cssText='font-size:5px;color:rgba(6,182,212,.3);font-weight:800;letter-spacing:1px;margin-bottom:3px';
    h.textContent=label;w.appendChild(h);
    const g=document.createElement('div');g.style.cssText='display:grid;grid-template-columns:repeat(auto-fill,minmax(54px,1fr));gap:2px';
    w.appendChild(g);return{w,g}}
  // === DROP ===
  const drop=document.createElement('div');drop.className='smp-drop';drop.style.cssText='padding:5px;min-height:16px;font-size:6px;margin-bottom:3px;text-align:center';
  drop.textContent='\u2b06 Drop audio or click to load';
  const fin=document.createElement('input');fin.type='file';fin.accept='audio/*,.wav,.mp3,.m4a,.aac,.ogg,.flac,.aiff,.caf';fin.style.cssText='position:absolute;left:-9999px;opacity:0;width:1px;height:1px';
  drop.addEventListener('click',()=>fin.click());
  drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('over')});
  drop.addEventListener('dragleave',()=>drop.classList.remove('over'));
  drop.addEventListener('drop',e=>{e.preventDefault();drop.classList.remove('over');if(e.dataTransfer.files[0])loadFile(e.dataTransfer.files[0])});
  fin.addEventListener('change',()=>{if(fin.files[0])loadFile(fin.files[0])});
  bd.appendChild(drop);bd.appendChild(fin);
  const finfo=document.createElement('div');finfo.style.cssText='font-size:5px;color:var(--dim);padding:0 0 2px 2px;display:none';
  bd.appendChild(finfo);
  // === WAVEFORM ===
  const vizWrap=document.createElement('div');vizWrap.style.cssText='position:relative;height:90px;background:#0a0e14;border:1px solid var(--border);border-radius:4px;margin-bottom:4px;overflow:hidden;user-select:none';
  const cvs=document.createElement('canvas');cvs.style.cssText='width:100%;height:100%';
  const dimL=document.createElement('div');dimL.style.cssText='position:absolute;top:0;left:0;height:100%;background:rgba(0,0,0,.5);pointer-events:none';
  const dimR=document.createElement('div');dimR.style.cssText='position:absolute;top:0;right:0;height:100%;background:rgba(0,0,0,.5);pointer-events:none';
  const selBg=document.createElement('div');selBg.style.cssText='position:absolute;top:0;height:100%;background:rgba(6,182,212,.08);pointer-events:none';
  const hL=document.createElement('div');hL.style.cssText='position:absolute;top:0;width:8px;height:100%;cursor:ew-resize;z-index:2;display:flex;align-items:center;justify-content:center';
  hL.innerHTML='<div style="width:3px;height:24px;background:#06b6d4;border-radius:2px;box-shadow:0 0 6px #06b6d488"></div>';
  const hR=document.createElement('div');hR.style.cssText='position:absolute;top:0;width:8px;height:100%;cursor:ew-resize;z-index:2;display:flex;align-items:center;justify-content:center';
  hR.innerHTML='<div style="width:3px;height:24px;background:#06b6d4;border-radius:2px;box-shadow:0 0 6px #06b6d488"></div>';
  const cur=document.createElement('div');cur.style.cssText='position:absolute;top:0;width:2px;height:100%;background:#fff;pointer-events:none;display:none';
  const tL=document.createElement('div');tL.style.cssText='position:absolute;bottom:2px;font-size:6px;font-weight:700;color:#06b6d4;pointer-events:none';
  const tR=document.createElement('div');tR.style.cssText='position:absolute;bottom:2px;font-size:6px;font-weight:700;color:#06b6d4;pointer-events:none';
  const tDur=document.createElement('div');tDur.style.cssText='position:absolute;top:2px;right:4px;font-size:5px;color:var(--dim);pointer-events:none';
  const flsh=document.createElement('div');flsh.style.cssText='position:absolute;inset:0;background:rgba(6,182,212,.25);pointer-events:none;opacity:0;transition:opacity .15s';
  vizWrap.append(cvs,dimL,dimR,selBg,hL,hR,cur,tL,tR,tDur,flsh);bd.appendChild(vizWrap);
  function doFlash(){flsh.style.opacity='1';setTimeout(()=>{flsh.style.opacity='0'},150)}
  let dragH=null;
  hL.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();dragH='L'});
  hR.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();dragH='R'});
  vizWrap.addEventListener('mousedown',e=>{if(!m.edited||dragH)return;
    const x=(e.clientX-vizWrap.getBoundingClientRect().left)/vizWrap.clientWidth;
    if(Math.abs(x-sL)<Math.abs(x-sR)){sL=Math.max(0,Math.min(sR-.01,x));dragH='L'}
    else{sR=Math.max(sL+.01,Math.min(1,x));dragH='R'}updSel()});
  window.addEventListener('mousemove',e=>{if(!dragH||!m.edited)return;
    const x=Math.max(0,Math.min(1,(e.clientX-vizWrap.getBoundingClientRect().left)/vizWrap.clientWidth));
    if(dragH==='L')sL=Math.min(sR-.01,x);else sR=Math.max(sL+.01,x);updSel()});
  window.addEventListener('mouseup',()=>{dragH=null});
  function updSel(){hL.style.left=(sL*100-1)+'%';hR.style.left=(sR*100-1)+'%';
    dimL.style.width=(sL*100)+'%';dimR.style.width=((1-sR)*100)+'%';
    selBg.style.left=(sL*100)+'%';selBg.style.width=((sR-sL)*100)+'%';
    if(m.edited){const dur=m.edited.duration;
      tL.textContent=(sL*dur).toFixed(2)+'s';tL.style.left=(sL*100+.5)+'%';
      tR.textContent=(sR*dur).toFixed(2)+'s';tR.style.left=(sR*100-5)+'%';
      tDur.textContent='sel: '+((sR-sL)*dur).toFixed(2)+'s / '+dur.toFixed(2)+'s'}}
  let curAf=null,pSt=0,pOf=0,pDu=0;
  function startCur(off,dur){pSt=ctx.currentTime;pOf=off;pDu=dur;cur.style.display='';animCur()}
  function animCur(){const e=ctx.currentTime-pSt;if(e>=pDu/m.rate){cur.style.display='none';curAf=null;return}
    cur.style.left=(pOf+(e*m.rate)/m.edited.duration)*100+'%';curAf=requestAnimationFrame(animCur)}
  function stopCur(){if(curAf)cancelAnimationFrame(curAf);cur.style.display='none';curAf=null}
  // === TRANSPORT BAR ===
  const transport=document.createElement('div');transport.style.cssText='display:flex;gap:3px;align-items:center;margin-bottom:4px;padding-bottom:4px;border-bottom:1px solid rgba(6,182,212,.1)';
  const playB=eBtn('\u25b6 Play',()=>{if(!m.edited||!ctx)return;stopSrc();stopCur();initA();
    m.src=ctx.createBufferSource();m.src.buffer=m.edited;m.src.playbackRate.value=m.rate;m.src.connect(m.dst());
    const off=sL*m.edited.duration,dur=(sR-sL)*m.edited.duration;
    m.src.start(0,off,dur);startCur(sL,dur);m.src.onended=()=>{stopCur()}},'Play selection');
  playB.style.cssText+='padding:4px 12px;background:rgba(6,182,212,.12);color:#06b6d4;font-weight:800';
  const stopB=eBtn('\u25a0 Stop',()=>{stopSrc();stopCur()});stopB.style.padding='4px 10px';
  const allB=eBtn('Sel All',()=>{sL=0;sR=1;updSel()});allB.style.padding='4px 8px';
  const undoB=eBtn('\u21b6 Undo',()=>{if(!undoStack.length)return;m.edited=undoStack.pop();sL=0;sR=1;drawWave();updInfo();doFlash()});undoB.style.padding='4px 8px';
  const resetB=eBtn('\u27f3 Reset',()=>{if(!m.buf)return;m.edited=copyBuf(m.buf);undoStack.length=0;sL=0;sR=1;m.rate=1;rV.textContent='1.00\u00d7';drawWave();updInfo()});resetB.style.padding='4px 8px';
  const rWrap=document.createElement('div');rWrap.style.cssText='display:flex;align-items:center;gap:2px;margin-left:auto';
  const rM=eBtn('\u2013',()=>{m.rate=Math.max(.25,m.rate-.25);rV.textContent=m.rate.toFixed(2)+'\u00d7'});rM.style.padding='3px 6px';
  const rV=document.createElement('span');rV.style.cssText='font-size:6px;color:rgba(6,182,212,.5);font-weight:700;min-width:24px;text-align:center';rV.textContent='1.00\u00d7';
  const rP=eBtn('+',()=>{m.rate=Math.min(4,m.rate+.25);rV.textContent=m.rate.toFixed(2)+'\u00d7'});rP.style.padding='3px 6px';
  rWrap.append(rM,rV,rP);
  const undoCt=document.createElement('span');undoCt.style.cssText='font-size:5px;color:rgba(6,182,212,.3);font-weight:700;min-width:12px';
  function updUndoCt(){undoCt.textContent=undoStack.length?undoStack.length+'':''}
  transport.append(playB,stopB,allB,undoB,resetB,undoCt,rWrap);
  bd.appendChild(transport);
  // === 3-COLUMN TOOLBAR ===
  const toolWrap=document.createElement('div');toolWrap.style.cssText='display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:4px';
  // COL 1: Edit
  const s1=eSec('EDIT');
  s1.g.style.gridTemplateColumns='1fr 1fr';
  s1.g.append(
    eBtn('\u2702 Keep',()=>{if(!m.edited)return;pushUndo();trim(sL,sR);doFlash()},'Keep selected'),
    eBtn('\ud83d\uddd1 Delete',()=>{if(!m.edited)return;pushUndo();delSel();doFlash()}),
    eBtn('\u27f2 Reverse',()=>{if(!m.edited)return;pushUndo();revSel();doFlash()}),
    eBtn('\u2205 Silence',()=>{if(!m.edited)return;pushUndo();silenceSel();doFlash()}),
    eBtn('\u2397 Duplicate',()=>{if(!m.edited)return;pushUndo();dupSel();doFlash()}),
    eBtn('\u2571 Fade In',()=>{if(!m.edited)return;pushUndo();fadeSel(true);doFlash()}),
    eBtn('\u2572 Fade Out',()=>{if(!m.edited)return;pushUndo();fadeSel(false);doFlash()}));
  // COL 2: Gain/Pitch
  const s2=eSec('GAIN / PITCH');
  s2.g.style.gridTemplateColumns='1fr 1fr';
  const gainRow=document.createElement('div');gainRow.style.cssText='display:flex;gap:2px;align-items:center;margin-bottom:3px';
  const gainSl=document.createElement('input');gainSl.type='range';gainSl.min=-20;gainSl.max=20;gainSl.value=0;
  gainSl.style.cssText='flex:1;accent-color:#06b6d4;height:12px';
  const gainV=document.createElement('span');gainV.style.cssText='font-size:5px;color:rgba(6,182,212,.4);font-weight:700;min-width:20px;text-align:center';gainV.textContent='0dB';
  gainSl.addEventListener('input',()=>{gainV.textContent=gainSl.value+'dB'});
  const gainA=eBtn('\u2713',()=>{if(!m.edited)return;pushUndo();applyGain(+gainSl.value);doFlash()},'Apply gain');
  gainA.style.padding='2px 6px';
  gainRow.append(gainSl,gainV,gainA);
  s2.w.insertBefore(gainRow,s2.g);
  s2.g.append(
    eBtn('Normalize',()=>{if(!m.edited)return;pushUndo();norm();doFlash()}),
    eBtn('\u2191 Pitch +5%',()=>{if(!m.edited)return;pushUndo();resample(1.05);doFlash()}),
    eBtn('\u2193 Pitch -5%',()=>{if(!m.edited)return;pushUndo();resample(.95);doFlash()}),
    eBtn('+1 Octave',()=>{if(!m.edited)return;pushUndo();resample(2);doFlash()}),
    eBtn('-1 Octave',()=>{if(!m.edited)return;pushUndo();resample(.5);doFlash()}));
  // COL 3: FX
  const s3=eSec('FX PROCESS');
  s3.g.style.gridTemplateColumns='1fr 1fr';
  s3.g.append(
    eBtn('Lowpass',()=>{if(!m.edited)return;pushUndo();applyFilter('lowpass',1200);doFlash()},'1.2kHz'),
    eBtn('Highpass',()=>{if(!m.edited)return;pushUndo();applyFilter('highpass',300);doFlash()},'300Hz'),
    eBtn('Distort',()=>{if(!m.edited)return;pushUndo();applyDistort();doFlash()}),
    eBtn('Bitcrush',()=>{if(!m.edited)return;pushUndo();applyBitcrush(8);doFlash()},'8-bit'),
    eBtn('Chorus',()=>{if(!m.edited)return;pushUndo();applyChorus();doFlash()}),
    eBtn('Echo',()=>{if(!m.edited)return;pushUndo();applyEcho(.25,.4);doFlash()},'250ms'),
    eBtn('Reverb',()=>{if(!m.edited)return;pushUndo();applyReverb();doFlash()}),
    eBtn('Compress',()=>{if(!m.edited)return;pushUndo();applyCompress();doFlash()},'4:1'),
    eBtn('Slow 2\u00d7',()=>{if(!m.edited)return;pushUndo();timeStretch(2);doFlash()}),
    eBtn('Fast \u00bd',()=>{if(!m.edited)return;pushUndo();timeStretch(.5);doFlash()}));
  toolWrap.append(s1.w,s2.w,s3.w);bd.appendChild(toolWrap);
  // === EXPORT BAR ===
  const expBar=document.createElement('div');expBar.style.cssText='display:flex;gap:4px;padding-top:4px;border-top:1px solid rgba(6,182,212,.1)';
  const wavB=eBtn('\u2193 Export WAV',()=>{if(!m.edited)return;const wav=bufToWav(m.edited);
    const url=URL.createObjectURL(wav),a=document.createElement('a');a.href=url;a.download='edited.wav';a.click();URL.revokeObjectURL(url)});
  wavB.style.cssText+='padding:4px 14px;background:rgba(6,182,212,.1);color:#06b6d4;font-weight:800';
  const smpB=eBtn('\u2192 Sampler',()=>{if(!m.edited)return;initA();
    const smp=mods.find(x=>x.type==='sample');if(!smp){smpB.textContent='\u26a0 No Sampler';setTimeout(()=>{smpB.textContent='\u2192 Sampler'},1500);return}
    const si=smp.slots.findIndex(s=>s===null);if(si<0)return;
    smp.slots[si]={name:'edit-'+Date.now()%10000,buf:copyBuf(m.edited),src:null};
    smp.updPad(si);smpB.textContent='\u2713 Sent!';setTimeout(()=>{smpB.textContent='\u2192 Sampler'},1200);doFlash()});
  smpB.style.padding='4px 14px';
  expBar.append(wavB,smpB);bd.appendChild(expBar);
  // === CORE FUNCTIONS ===
  function stopSrc(){if(m.src){try{m.src.stop()}catch(e){}}m.src=null}
  function copyBuf(b){const nb=ctx.createBuffer(b.numberOfChannels,b.length,b.sampleRate);
    for(let c=0;c<b.numberOfChannels;c++)nb.getChannelData(c).set(b.getChannelData(c));return nb}
  function smp2(r){return Math.floor(r*m.edited.length)}
  function trim(l,r){const nc=m.edited.numberOfChannels,sr=m.edited.sampleRate,s0=smp2(l),s1=smp2(r),len=s1-s0;
    if(len<10)return;const nb=ctx.createBuffer(nc,len,sr);
    for(let c=0;c<nc;c++){const od=m.edited.getChannelData(c),nd=nb.getChannelData(c);for(let i=0;i<len;i++)nd[i]=od[s0+i]}
    m.edited=nb;sL=0;sR=1;drawWave();updInfo()}
  function delSel(){const nc=m.edited.numberOfChannels,sr=m.edited.sampleRate,s0=smp2(sL),s1=smp2(sR);
    const kl=m.edited.length-(s1-s0);if(kl<10)return;const nb=ctx.createBuffer(nc,kl,sr);
    for(let c=0;c<nc;c++){const od=m.edited.getChannelData(c),nd=nb.getChannelData(c);
      for(let i=0;i<s0;i++)nd[i]=od[i];for(let i=s1;i<m.edited.length;i++)nd[s0+(i-s1)]=od[i]}
    m.edited=nb;sL=0;sR=1;drawWave();updInfo()}
  function revSel(){const nc=m.edited.numberOfChannels,s0=smp2(sL),s1=smp2(sR);
    for(let c=0;c<nc;c++){const d=m.edited.getChannelData(c);const seg=d.slice(s0,s1);seg.reverse();d.set(seg,s0)}drawWave()}
  function silenceSel(){const nc=m.edited.numberOfChannels,s0=smp2(sL),s1=smp2(sR);
    for(let c=0;c<nc;c++){const d=m.edited.getChannelData(c);for(let i=s0;i<s1;i++)d[i]=0}drawWave()}
  function dupSel(){const nc=m.edited.numberOfChannels,sr=m.edited.sampleRate,s0=smp2(sL),s1=smp2(sR),sl=s1-s0;
    const nb=ctx.createBuffer(nc,m.edited.length+sl,sr);
    for(let c=0;c<nc;c++){const od=m.edited.getChannelData(c),nd=nb.getChannelData(c);
      for(let i=0;i<s1;i++)nd[i]=od[i];for(let i=s0;i<s1;i++)nd[s1+(i-s0)]=od[i];
      for(let i=s1;i<m.edited.length;i++)nd[sl+i]=od[i]}
    m.edited=nb;sL=0;sR=1;drawWave();updInfo()}
  function fadeSel(isIn){const nc=m.edited.numberOfChannels,s0=smp2(sL),s1=smp2(sR),len=s1-s0;
    for(let c=0;c<nc;c++){const d=m.edited.getChannelData(c);for(let i=s0;i<s1;i++){const r=(i-s0)/len;d[i]*=isIn?r:1-r}}drawWave()}
  function applyGain(db){const nc=m.edited.numberOfChannels,s0=smp2(sL),s1=smp2(sR),g=Math.pow(10,db/20);
    for(let c=0;c<nc;c++){const d=m.edited.getChannelData(c);for(let i=s0;i<s1;i++)d[i]=Math.max(-1,Math.min(1,d[i]*g))}drawWave();updInfo()}
  function resample(ratio){const ob=m.edited,nc=ob.numberOfChannels,sr=ob.sampleRate,nl=Math.floor(ob.length/ratio);
    const nb=ctx.createBuffer(nc,nl,sr);
    for(let c=0;c<nc;c++){const od=ob.getChannelData(c),nd=nb.getChannelData(c);
      for(let i=0;i<nl;i++){const src=i*ratio,si=Math.floor(src),frac=src-si;nd[i]=(od[si]||0)*(1-frac)+(od[si+1]||0)*frac}}
    m.edited=nb;sL=0;sR=1;drawWave();updInfo()}
  function norm(){const nc=m.edited.numberOfChannels;let peak=0;
    for(let c=0;c<nc;c++){const d=m.edited.getChannelData(c);for(let i=0;i<d.length;i++){const a=Math.abs(d[i]);if(a>peak)peak=a}}
    if(peak<.001)return;const g=.944/peak;
    for(let c=0;c<nc;c++){const d=m.edited.getChannelData(c);for(let i=0;i<d.length;i++)d[i]*=g}drawWave();updInfo()}
  function timeStretch(factor){const ob=m.edited,nc=ob.numberOfChannels,sr=ob.sampleRate;
    const s0=smp2(sL),s1=smp2(sR),sl=s1-s0,nl=Math.floor(sl*factor);
    const newLen=m.edited.length-sl+nl;const nb=ctx.createBuffer(nc,newLen,sr);
    for(let c=0;c<nc;c++){const od=ob.getChannelData(c),nd=nb.getChannelData(c);
      for(let i=0;i<s0;i++)nd[i]=od[i];
      for(let i=0;i<nl;i++){const src=i/factor,si=Math.floor(src)+s0,frac=src-Math.floor(src);
        nd[s0+i]=(od[si]||0)*(1-frac)+(od[si+1]||0)*frac}
      for(let i=s1;i<ob.length;i++)nd[s0+nl+(i-s1)]=od[i]}
    m.edited=nb;sL=0;sR=1;drawWave();updInfo()}
  function applyFilter(type,freq){
    const nc=m.edited.numberOfChannels,sr=m.edited.sampleRate,s0=smp2(sL),s1=smp2(sR);
    const w0=2*Math.PI*freq/sr,alpha=Math.sin(w0)/2;
    let b0,b1,b2,a0,a1,a2;
    if(type==='lowpass'){b0=(1-Math.cos(w0))/2;b1=1-Math.cos(w0);b2=b0}
    else{b0=(1+Math.cos(w0))/2;b1=-(1+Math.cos(w0));b2=b0}
    a0=1+alpha;a1=-2*Math.cos(w0);a2=1-alpha;
    for(let c=0;c<nc;c++){const d=m.edited.getChannelData(c);let x1=0,x2=0,y1=0,y2=0;
      for(let i=s0;i<s1;i++){const x0=d[i];
        d[i]=(b0/a0)*x0+(b1/a0)*x1+(b2/a0)*x2-(a1/a0)*y1-(a2/a0)*y2;
        x2=x1;x1=x0;y2=y1;y1=d[i]}}drawWave();updInfo()}
  function applyDistort(){const nc=m.edited.numberOfChannels,s0=smp2(sL),s1=smp2(sR);
    for(let c=0;c<nc;c++){const d=m.edited.getChannelData(c);for(let i=s0;i<s1;i++)d[i]=Math.tanh(d[i]*3)}drawWave()}
  function applyBitcrush(bits){const nc=m.edited.numberOfChannels,s0=smp2(sL),s1=smp2(sR);const lv=Math.pow(2,bits);
    for(let c=0;c<nc;c++){const d=m.edited.getChannelData(c);for(let i=s0;i<s1;i++)d[i]=Math.round(d[i]*lv)/lv}drawWave()}
  function applyChorus(){const nc=m.edited.numberOfChannels,sr=m.edited.sampleRate,s0=smp2(sL),s1=smp2(sR);
    const ds=Math.floor(.02*sr),dp=Math.floor(.005*sr);
    for(let c=0;c<nc;c++){const d=m.edited.getChannelData(c);const o=d.slice(s0,s1);
      for(let i=0;i<o.length;i++){const lfo=Math.sin(2*Math.PI*1.5*i/sr)*dp;
        const di=Math.floor(i-ds-lfo);d[s0+i]=o[i]*.7+(di>=0&&di<o.length?o[di]:0)*.5}}drawWave()}
  function applyEcho(time,fb){const nc=m.edited.numberOfChannels,sr=m.edited.sampleRate,s0=smp2(sL),s1=smp2(sR);
    const ds=Math.floor(time*sr);
    for(let c=0;c<nc;c++){const d=m.edited.getChannelData(c);
      for(let i=s0;i<s1;i++){const di=i-ds;if(di>=s0)d[i]=Math.max(-1,Math.min(1,d[i]+d[di]*fb))}}drawWave()}
  function applyReverb(){const nc=m.edited.numberOfChannels,sr=m.edited.sampleRate,s0=smp2(sL),s1=smp2(sR);
    const taps=[{d:.023,g:.4},{d:.041,g:.3},{d:.067,g:.25},{d:.098,g:.2},{d:.131,g:.15},{d:.173,g:.1}];
    for(let c=0;c<nc;c++){const d=m.edited.getChannelData(c);const o=d.slice(s0,s1);
      for(let i=0;i<o.length;i++){let w=0;taps.forEach(t=>{const di=i-Math.floor(t.d*sr);if(di>=0)w+=o[di]*t.g});
        d[s0+i]=Math.max(-1,Math.min(1,o[i]*.6+w))}}drawWave()}
  function applyCompress(){const nc=m.edited.numberOfChannels,s0=smp2(sL),s1=smp2(sR);
    const th=.3,rat=4,mu=Math.pow(10,.3);
    for(let c=0;c<nc;c++){const d=m.edited.getChannelData(c);let env=0;
      for(let i=s0;i<s1;i++){env=env*.995+Math.abs(d[i])*.005;
        d[i]*=(env>th?(th+(env-th)/rat)/env:1)*mu;
        d[i]=Math.max(-1,Math.min(1,d[i]))}}drawWave();updInfo()}
  function updInfo(){if(!m.edited)return;const nc=m.edited.numberOfChannels,sr=m.edited.sampleRate;
    let pk=0;for(let c=0;c<nc;c++){const d=m.edited.getChannelData(c);for(let i=0;i<d.length;i++){const a=Math.abs(d[i]);if(a>pk)pk=a}}
    finfo.textContent=m.edited.duration.toFixed(2)+'s \u00b7 '+sr+'Hz \u00b7 '+nc+'ch \u00b7 peak: '+(pk>0?(20*Math.log10(pk)).toFixed(1):'-\u221e')+'dB';finfo.style.display='';updUndoCt()}
  function loadFile(file){const r=new FileReader();r.onload=async()=>{initA();m.buf=await ctx.decodeAudioData(r.result);
    m.edited=copyBuf(m.buf);undoStack.length=0;sL=0;sR=1;m.rate=1;rV.textContent='1.00\u00d7';drawWave();updInfo();
    drop.textContent='\ud83d\udcc1 '+file.name.slice(0,30)};r.readAsArrayBuffer(file)}
  function drawWave(){const c=cvs;c.width=vizWrap.clientWidth;c.height=vizWrap.clientHeight;
    const x=c.getContext('2d'),W=c.width,H=c.height;x.clearRect(0,0,W,H);
    x.strokeStyle='rgba(6,182,212,.06)';x.lineWidth=1;
    for(let i=0;i<5;i++){const y=H*i/4;x.beginPath();x.moveTo(0,y);x.lineTo(W,y);x.stroke()}
    if(!m.edited){x.fillStyle='rgba(6,182,212,.08)';x.font='9px JetBrains Mono';x.textAlign='center';
      x.fillText('Drop audio or click to load',W/2,H/2+3);return}
    const data=m.edited.getChannelData(0),step=Math.ceil(data.length/W);
    x.beginPath();
    for(let i=0;i<W;i++){let mn=1,mx=-1;
      for(let j=0;j<step;j++){const v=data[i*step+j]||0;if(v<mn)mn=v;if(v>mx)mx=v}
      if(i===0)x.moveTo(0,(1+mn)/2*H);x.lineTo(i,(1+mn)/2*H)}
    for(let i=W-1;i>=0;i--){let mn=1,mx=-1;
      for(let j=0;j<step;j++){const v=data[i*step+j]||0;if(v<mn)mn=v;if(v>mx)mx=v}
      x.lineTo(i,(1+mx)/2*H)}
    x.closePath();x.fillStyle='rgba(6,182,212,.2)';x.fill();
    x.beginPath();x.strokeStyle='#06b6d4';x.lineWidth=1;
    for(let i=0;i<W;i++){let mn=1,mx=-1;
      for(let j=0;j<step;j++){const v=data[i*step+j]||0;if(v<mn)mn=v;if(v>mx)mx=v}
      x.moveTo(i,(1+mn)/2*H);x.lineTo(i,(1+mx)/2*H)}
    x.stroke();updSel()}
  new ResizeObserver(()=>{if(m.edited)drawWave()}).observe(vizWrap);
  m.destroy=()=>{stopSrc();stopCur()};
  m.drawWave=drawWave;m.updInfo=updInfo;m.loadBuf=(buf)=>{m.buf=buf;m.edited=copyBuf(buf);sL=0;sR=1;drawWave();updInfo()};
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}



// === INST MODULE ‚Äî orchestral/band instruments ===
// Uses WebAudioFont for real sampled instrument sounds
function addInst(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('INST<span>.EXE</span>','Instruments','#d946ef',0,0,600,340,ci);
  el.id='m'+id;
  const wafPlayer=_waf;
  const INSTS=_INSTS;
  // chord intervals from root
  const CHORDS={off:[0],maj:[0,4,7],min:[0,3,7],maj7:[0,4,7,11],min7:[0,3,7,10],
    dom7:[0,4,7,10],dim:[0,3,6],aug:[0,4,8],sus4:[0,5,7],pow:[0,7,12]};
  const m={id,type:'inst',el,ci,ts:0,
    iIdx:0,i2Idx:-1, // layer: -1=off
    oct:5,vol:.7,detune:0,
    sustain:false,sustainedNotes:{},
    chord:'off',bend:0,
    rvbMix:.15,dlMix:.1,dlTime:.25,
    notes:{},loaded:{}};
  m.onStep=()=>{};m.clr=()=>{};
  // === AUDIO CHAIN: inst ‚Üí dry+reverb+delay ‚Üí channel ===
  let rvbNode=null,dlNode=null,dlFb=null,rvbG=null,dlG=null,dryG=null;
  function initChain(){
    if(dryG)return;initA();
    const dest=chs[m.ci].g||mGain;
    dryG=ctx.createGain();dryG.gain.value=1;dryG.connect(dest);
    // reverb via convolver
    rvbNode=ctx.createConvolver();
    const rl=ctx.sampleRate*1.8,rb=ctx.createBuffer(2,rl,ctx.sampleRate);
    for(let c=0;c<2;c++){const d=rb.getChannelData(c);for(let i=0;i<rl;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/rl,2.5)}
    rvbNode.buffer=rb;rvbG=ctx.createGain();rvbG.gain.value=m.rvbMix;
    rvbNode.connect(rvbG);rvbG.connect(dest);
    // delay
    dlNode=ctx.createDelay(1);dlNode.delayTime.value=m.dlTime;
    dlFb=ctx.createGain();dlFb.gain.value=.35;
    dlG=ctx.createGain();dlG.gain.value=m.dlMix;
    dlNode.connect(dlFb);dlFb.connect(dlNode);dlNode.connect(dlG);dlG.connect(dest);
  }
  m.dst=()=>{initChain();return dryG};
  m.sendRvb=()=>{initChain();return rvbNode};
  m.sendDl=()=>{initChain();return dlNode};
  // load instrument
  function loadInst(idx,cb){
    const ins=INSTS[idx];if(!ins)return;
    if(_wafLoaded[ins.vn]){m.loaded[ins.vn]=_wafLoaded[ins.vn];status.textContent=ins.name+' ready';if(cb)cb();return}
    status.textContent='Loading '+ins.name+'...';
    _wafLoad(idx,(preset)=>{if(preset){m.loaded[ins.vn]=preset;status.textContent=ins.name+' ready'}else{status.textContent='Failed: '+ins.name}if(cb)cb()});
  }
  // play note with all features
  function playNote(note,vel){
    if(!ctx)return;initA();initChain();
    const intervals=CHORDS[m.chord]||[0];
    intervals.forEach(iv=>{
      const n=note+iv;
      if(m.notes[n])stopNoteSingle(n);
      const pitch=n+(m.oct*12)+12+(m.detune/100)+(m.bend/100);
      // primary instrument
      const ins=INSTS[m.iIdx],preset=m.loaded[ins.vn];
      if(!preset)return;
      const env=wafPlayer.queueWaveTable(ctx,dryG,preset,0,pitch,9999,m.vol*vel);
      // send to reverb+delay
      const env2=m.rvbMix>0?wafPlayer.queueWaveTable(ctx,rvbNode,preset,0,pitch,9999,m.vol*vel*m.rvbMix):null;
      const env3=m.dlMix>0?wafPlayer.queueWaveTable(ctx,dlNode,preset,0,pitch,9999,m.vol*vel*m.dlMix):null;
      // layer 2
      let env4=null;
      if(m.i2Idx>=0){const ins2=INSTS[m.i2Idx],p2=m.loaded[ins2.vn];
        if(p2)env4=wafPlayer.queueWaveTable(ctx,dryG,p2,0,pitch,9999,m.vol*vel*.7)}
      m.notes[n]={env,env2,env3,env4};
    });
  }
  function stopNoteSingle(n){
    const e=m.notes[n];if(!e)return;
    if(e.env)e.env.cancel();if(e.env2)e.env2.cancel();
    if(e.env3)e.env3.cancel();if(e.env4)e.env4.cancel();
    delete m.notes[n];
  }
  function stopNote(note){
    const intervals=CHORDS[m.chord]||[0];
    intervals.forEach(iv=>{
      const n=note+iv;
      if(m.sustain){m.sustainedNotes[n]=true;return}
      stopNoteSingle(n);
    });
  }
  function releaseSustain(){
    Object.keys(m.sustainedNotes).forEach(n=>stopNoteSingle(+n));
    m.sustainedNotes={};
  }
  sel.addEventListener('change',()=>{
    // Release all notes before switching channels
    if(m.sustain)releaseSustain();
    Object.keys(m.notes).forEach(n=>stopNoteSingle(+n));
    m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);
    dryG=null;rvbNode=null;dlNode=null;filt()});
  // === UI: Instrument Selector (categorized dropdown) ===
  const CATS={
    'Strings':[0,1,2,3,15,19,20],
    'Brass':[4,5,6,7],
    'Woodwind':[8,9,10,11,14],
    'Guitar/Keys':[12,13,17,18],
    'Vocal/Choir':[16]
  };
  const iRow=document.createElement('div');iRow.style.cssText='display:flex;gap:4px;align-items:center;margin-bottom:4px;flex-wrap:wrap';
  const iSel=document.createElement('select');
  iSel.style.cssText='background:var(--s3);border:2px solid #d946ef40;color:#d946ef;font-family:inherit;font-size:8px;font-weight:800;padding:4px 6px;border-radius:4px;cursor:pointer;outline:none;flex:1;min-width:100px';
  Object.entries(CATS).forEach(([cat,idxs])=>{
    const og=document.createElement('optgroup');og.label=cat;
    idxs.forEach(idx=>{const o=document.createElement('option');o.value=idx;o.textContent=INSTS[idx].name;if(idx===0)o.selected=true;og.appendChild(o)});
    iSel.appendChild(og)});
  iSel.addEventListener('change',()=>{
    const idx=+iSel.value;Object.keys(m.notes).forEach(n=>stopNoteSingle(+n));
    m.iIdx=idx;m.oct=INSTS[idx].oct;octD.textContent='OCT '+m.oct;updKeys();
    loadInst(idx)});
  // Layer selector
  const lSel=document.createElement('select');
  lSel.style.cssText='background:var(--s3);border:1px solid var(--border);color:var(--dim);font-family:inherit;font-size:6px;font-weight:700;padding:3px 4px;border-radius:3px;cursor:pointer;outline:none;width:70px';
  const lOff=document.createElement('option');lOff.value=-1;lOff.textContent='LAYER OFF';lSel.appendChild(lOff);
  INSTS.forEach((ins,idx)=>{const o=document.createElement('option');o.value=idx;o.textContent='+'+ins.name;lSel.appendChild(o)});
  lSel.addEventListener('change',()=>{const idx=+lSel.value;m.i2Idx=idx;if(idx>=0)loadInst(idx)});
  const status=document.createElement('span');status.style.cssText='font-size:5px;color:var(--dim);font-weight:600';
  iRow.append(iSel,lSel,status);bd.appendChild(iRow);
  // === CONTROLS: Oct, Vol, Tune, Bend, Sustain, Chord, Reverb, Delay ===
  const c1=document.createElement('div');c1.style.cssText='display:flex;gap:4px;align-items:center;margin-bottom:3px;flex-wrap:wrap';
  const octM=document.createElement('button');octM.className='pbtn';octM.textContent='\u2013';
  octM.addEventListener('click',()=>{if(m.oct>1){m.oct--;octD.textContent='OCT '+m.oct;updKeys()}});
  const octD=document.createElement('span');octD.style.cssText='font-size:7px;font-weight:700;color:var(--text);min-width:28px;text-align:center';octD.textContent='OCT '+m.oct;
  const octP=document.createElement('button');octP.className='pbtn';octP.textContent='+';
  octP.addEventListener('click',()=>{if(m.oct<7){m.oct++;octD.textContent='OCT '+m.oct;updKeys()}});
  function mkSl(lab,mn,mx,val,w,cb,fmt){
    const wr=document.createElement('div');wr.style.cssText='display:flex;align-items:center;gap:2px';
    const l=document.createElement('span');l.style.cssText='font-size:5px;color:var(--dim)';l.textContent=lab;
    const s=document.createElement('input');s.type='range';s.className='bv';s.style.width=w||'40px';
    s.min=mn;s.max=mx;s.value=val;
    const v=document.createElement('span');v.style.cssText='font-size:5px;color:var(--dim);min-width:18px;text-align:center';
    v.textContent=fmt?fmt(val):val;
    s.addEventListener('input',()=>{cb(+s.value);v.textContent=fmt?fmt(+s.value):s.value});
    s.addEventListener('dblclick',()=>{s.value=val;cb(val);v.textContent=fmt?fmt(val):val});
    wr.append(l,s,v);return wr}
  const susBtn=document.createElement('button');susBtn.className='pbtn';susBtn.textContent='SUS';susBtn.style.fontSize='6px';
  susBtn.addEventListener('click',()=>{m.sustain=!m.sustain;susBtn.style.background=m.sustain?'#d946ef':'';
    susBtn.style.color=m.sustain?'#fff':'';if(!m.sustain)releaseSustain()});
  const chSel=document.createElement('select');chSel.className='bsel';chSel.style.cssText+='width:48px;font-size:6px';
  Object.keys(CHORDS).forEach(k=>{const o=document.createElement('option');o.value=k;o.textContent=k.toUpperCase();chSel.appendChild(o)});
  chSel.addEventListener('change',()=>{m.chord=chSel.value});
  c1.append(octM,octD,octP,
    mkSl('VOL',0,100,70,'32px',v=>{m.vol=v/100},v=>Math.round(v)+'%'),
    mkSl('TUNE',-100,100,0,'28px',v=>{m.detune=v},v=>v+'\u00a2'),
    susBtn,chSel,
    mkSl('RVB',0,100,15,'28px',v=>{m.rvbMix=v/100;if(rvbG)rvbG.gain.value=m.rvbMix},v=>Math.round(v)+'%'),
    mkSl('DLY',0,100,10,'28px',v=>{m.dlMix=v/100;if(dlG)dlG.gain.value=m.dlMix},v=>Math.round(v)+'%'));
  bd.appendChild(c1);
  // === 2-OCTAVE KEYBOARD (using .skb class) ===
  const kb=document.createElement('div');kb.className='skb';kb.style.height='70px';
  const NN=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const kEls=[];
  function velFromY(e,el){const r=el.getBoundingClientRect(),y=(e.clientY-r.top)/r.height;return .3+y*.7}
  // White key indices for 2 octaves: C D E F G A B | C D E F G A B C
  const whites2=[];const blackMap2={};
  for(let oct=0;oct<2;oct++){
    [0,2,4,5,7,9,11].forEach(n=>{whites2.push(n+oct*12)});
    [{n:1,p:0},{n:3,p:1},{n:6,p:3},{n:8,p:4},{n:10,p:5}].forEach(b=>{blackMap2[b.n+oct*12]=b.p+oct*7})}
  whites2.push(24);// high C
  function buildKb(){
    kb.innerHTML='';kEls.length=0;
    whites2.forEach(note=>{
      const k=document.createElement('div');k.className='swk';k.dataset.note=note;
      const lb=document.createElement('span');lb.className='kl';lb.textContent=NN[note%12]+(note<12?m.oct:note===24?m.oct+2:m.oct+1);
      k.appendChild(lb);
      k.addEventListener('mousedown',e=>{e.preventDefault();const v=velFromY(e,k);playNote(note,v);k.classList.add('active');k.style.background=INSTS[m.iIdx].col+'50'});
      k.addEventListener('mouseup',()=>{stopNote(note);if(!m.sustain)k.classList.remove('active');k.style.background=''});
      k.addEventListener('mouseleave',()=>{if(m.notes[note]&&!m.sustain){stopNote(note);k.classList.remove('active');k.style.background=''}});
      kb.appendChild(k);kEls.push({el:k,note,lb,isBlack:false})});
    Object.entries(blackMap2).forEach(([note,pos])=>{
      const n=+note;const k=document.createElement('div');k.className='sbk';k.dataset.note=n;
      k.style.left=((pos)/whites2.length*100+100/whites2.length*0.6)+'%';
      k.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();const v=velFromY(e,k);playNote(n,v);k.classList.add('active');k.style.background=INSTS[m.iIdx].col+'80'});
      k.addEventListener('mouseup',()=>{stopNote(n);if(!m.sustain)k.classList.remove('active');k.style.background=''});
      k.addEventListener('mouseleave',()=>{if(m.notes[n]&&!m.sustain){stopNote(n);k.classList.remove('active');k.style.background=''}});
      kb.appendChild(k);kEls.push({el:k,note:n,isBlack:true})});
  }
  function updKeys(){kEls.forEach(k=>{if(k.lb){const n=k.note;k.lb.textContent=NN[n%12]+(n<12?m.oct:n===24?m.oct+2:m.oct+1)}})}
  buildKb();bd.appendChild(kb);
  // === KEYBOARD FOCUS ===
  const kbb=document.createElement('button');kbb.className='wb kb';kbb.title='Keyboard';kbb.textContent='\u2328';kbb.dataset.mid=id;
  kbb.addEventListener('click',e=>{e.stopPropagation();setKb(id)});ct.prepend(kbb);
  const KMAP={a:0,w:1,s:2,e:3,d:4,f:5,t:6,g:7,y:8,h:9,u:10,j:11,k:12};
  const held={};
  const kdn=e=>{if(e.repeat||_kb!==id)return;
    // spacebar = sustain pedal toggle
    if(e.key===' '){e.preventDefault();m.sustain=!m.sustain;susBtn.style.background=m.sustain?'#d946ef':'';
      susBtn.style.color=m.sustain?'#fff':'';if(!m.sustain)releaseSustain();return}
    const n=KMAP[e.key.toLowerCase()];if(n!==undefined&&!held[n]){held[n]=true;playNote(n,.85);
      const ke=kEls.find(x=>x.note===n);if(ke)ke.el.style.background=INSTS[m.iIdx].col+(ke.isBlack?'80':'60')}};
  const kup=e=>{const n=KMAP[e.key.toLowerCase()];if(n!==undefined&&held[n]){held[n]=false;stopNote(n);
    const ke=kEls.find(x=>x.note===n);if(ke&&!m.sustainedNotes[n])ke.el.style.background=ke.isBlack?'#111':'#1a1a24'}};
  window.addEventListener('keydown',kdn);window.addEventListener('keyup',kup);
  loadInst(0);
  m.destroy=()=>{window.removeEventListener('keydown',kdn);window.removeEventListener('keyup',kup);
    Object.keys(m.notes).forEach(n=>stopNoteSingle(+n));if(_kb===id)_kb=null;if(m._clipClean)m._clipClean()};
  addClipBtns(ct,m);ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}

// === WAVEFORM OSCILLATOR MODULE ===
function addOsc(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('OSC<span>.EXE</span>','Oscillator','#60a5fa',400+(mods.length%4)*30,80+(mods.length%4)*20,560,420,ci);
  el.id='m'+id;
  const NN=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const m={id,type:'osc',el,ci,ts:0,freq:440,vol:.5,oct:4,wv:'sine',det:0,
    a:.01,d:.1,s:.8,r:.2,ff:8000,fr:0,
    custom:new Float32Array(128),useCustom:false,
    harmonics:[1,0,0,0,0,0,0,0],
    looping:false,an:{}};
  for(let i=0;i<128;i++)m.custom[i]=Math.sin(i/128*Math.PI*2);
  m.dst=()=>chs[m.ci].g||mGain;
  m.nf=(n,o)=>440*Math.pow(2,(n-9)/12+(o-4));
  // Freq to note name
  function freqToNote(f){const n=12*Math.log2(f/440)+69;const ni=Math.round(n);const cents=Math.round((n-ni)*100);
    return NN[ni%12]+(Math.floor(ni/12)-1)+(cents>=0?'+':'')+cents+'¬¢'}
  // Note name to freq
  function noteToFreq(note,oct){return 440*Math.pow(2,(note-9)/12+(oct-4))}
  function buildPW(){if(!ctx)return null;const n=m.harmonics.length+1;
    const real=new Float32Array(n);const imag=new Float32Array(n);
    m.harmonics.forEach((v,i)=>{imag[i+1]=v});
    return ctx.createPeriodicWave(real,imag,{disableNormalization:false})}
  function buildCustomPW(){if(!ctx)return null;const N=m.custom.length,nH=32;
    const real=new Float32Array(nH+1),imag=new Float32Array(nH+1);
    for(let h=1;h<=nH;h++){let rc=0,ic=0;
      for(let i=0;i<N;i++){const a=2*Math.PI*h*i/N;rc+=m.custom[i]*Math.cos(a);ic+=m.custom[i]*Math.sin(a)}
      real[h]=rc*2/N;imag[h]=ic*2/N}
    return ctx.createPeriodicWave(real,imag,{disableNormalization:false})}
  // Play at exact frequency
  m.playFreq=(freq,vel=.8)=>{if(!ctx)return;const t=ctx.currentTime,dest=m.dst();
    const o1=ctx.createOscillator(),g=ctx.createGain(),f=ctx.createBiquadFilter();
    if(m.useCustom){const pw=buildCustomPW();if(pw)o1.setPeriodicWave(pw)}
    else if(m.wv==='harmonics'){const pw=buildPW();if(pw)o1.setPeriodicWave(pw)}
    else o1.type=m.wv;
    o1.frequency.value=freq;if(m.det)o1.detune.value=m.det;
    f.type='lowpass';f.frequency.value=m.ff;f.Q.value=m.fr;
    o1.connect(f);f.connect(g);g.connect(dest);
    g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(m.vol*vel,t+m.a);
    g.gain.linearRampToValueAtTime(m.vol*vel*m.s,t+m.a+m.d);
    o1.start(t);return{o:o1,g,f}};
  // Play by note index (for keyboard) ‚Äî uses exact m.freq
  m.play=(note,vel=.8)=>{if(!ctx)return;ensureAn();
    m.an[note]=m.playFreq(m.freq,vel)};
  m.stop=(note)=>{const n=m.an[note];if(!n)return;const t=ctx.currentTime;
    n.g.gain.cancelScheduledValues(t);n.g.gain.setValueAtTime(n.g.gain.value,t);
    n.g.gain.linearRampToValueAtTime(0,t+m.r);n.o.stop(t+m.r+.05);delete m.an[note]};
  // Loop state
  let loopNode=null;
  function startLoop(){if(!ctx)return;ensureAn();stopLoop();
    const dest=m.dst();const o1=ctx.createOscillator(),g=ctx.createGain(),f=ctx.createBiquadFilter();
    if(m.useCustom){const pw=buildCustomPW();if(pw)o1.setPeriodicWave(pw)}
    else if(m.wv==='harmonics'){const pw=buildPW();if(pw)o1.setPeriodicWave(pw)}
    else o1.type=m.wv;
    o1.frequency.value=m.freq;if(m.det)o1.detune.value=m.det;
    f.type='lowpass';f.frequency.value=m.ff;f.Q.value=m.fr;
    o1.connect(f);f.connect(g);g.connect(dest);
    const t=ctx.currentTime;g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(m.vol,t+m.a);
    g.gain.linearRampToValueAtTime(m.vol*m.s,t+m.a+m.d);
    o1.start(t);loopNode={o:o1,g,f};m.looping=true;loopBtn.classList.add('active');loopBtn.textContent='‚ñ† STOP'}
  function stopLoop(){if(!loopNode)return;const t=ctx.currentTime;
    loopNode.g.gain.cancelScheduledValues(t);loopNode.g.gain.setValueAtTime(loopNode.g.gain.value,t);
    loopNode.g.gain.linearRampToValueAtTime(0,t+.05);loopNode.o.stop(t+.1);loopNode=null;m.looping=false;
    loopBtn.classList.remove('active');loopBtn.textContent='‚ñ∂ LOOP'}
  // Update loop freq in realtime
  function updateLoopFreq(){if(loopNode)loopNode.o.frequency.setValueAtTime(m.freq,ctx.currentTime)}
  m.onStep=()=>{};m.clr=()=>{};
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});

  // === SCOPE ===
  const scopeWrap=document.createElement('div');scopeWrap.style.cssText='position:relative;height:120px;background:#0a0e14;border:1px solid var(--border);border-radius:4px;margin-bottom:4px;overflow:hidden';
  const scopeCvs=document.createElement('canvas');scopeCvs.style.cssText='width:100%;height:100%';
  scopeWrap.appendChild(scopeCvs);
  // Scope overlay: readouts
  const scopeInfo=document.createElement('div');scopeInfo.style.cssText='position:absolute;top:3px;left:5px;font-size:6px;color:rgba(96,165,250,.7);font-weight:700;pointer-events:none;line-height:1.4';
  scopeWrap.appendChild(scopeInfo);
  // Scope controls
  const scopeCtrl=document.createElement('div');scopeCtrl.style.cssText='position:absolute;top:3px;right:5px;display:flex;gap:3px';
  let scopeFrozen=false,scopeMode='wave'; // wave or fft
  const freezeBtn=document.createElement('button');freezeBtn.className='pbtn';freezeBtn.textContent='‚ùö‚ùö';freezeBtn.title='Freeze';freezeBtn.style.cssText+='font-size:5px;padding:1px 4px;opacity:.7';
  freezeBtn.addEventListener('click',()=>{scopeFrozen=!scopeFrozen;freezeBtn.style.opacity=scopeFrozen?'1':'.7';freezeBtn.style.borderColor=scopeFrozen?'#60a5fa':''});
  const fftBtn=document.createElement('button');fftBtn.className='pbtn';fftBtn.textContent='FFT';fftBtn.title='Spectrum';fftBtn.style.cssText+='font-size:5px;padding:1px 4px;opacity:.7';
  fftBtn.addEventListener('click',()=>{scopeMode=scopeMode==='wave'?'fft':'wave';fftBtn.style.opacity=scopeMode==='fft'?'1':'.7';fftBtn.style.borderColor=scopeMode==='fft'?'#60a5fa':''});
  scopeCtrl.append(freezeBtn,fftBtn);scopeWrap.appendChild(scopeCtrl);
  bd.appendChild(scopeWrap);
  // Analyser
  let scopeAn=null,scopeAnF=null;
  function ensureAn(){
    if(!ctx)return;
    if(!scopeAn){scopeAn=ctx.createAnalyser();scopeAn.fftSize=4096;scopeAn.smoothingTimeConstant=0.3;
      scopeAnF=ctx.createAnalyser();scopeAnF.fftSize=8192;scopeAnF.smoothingTimeConstant=0.8;
      m._scopeAn=scopeAn;m._scopeAnF=scopeAnF;
      const chG=chs[m.ci].g;if(chG){chG.connect(scopeAn);chG.connect(scopeAnF)}}}
  let frozenBuf=null,frozenFreq=null;
  function drawScope(){
    if(!document.getElementById('m'+id))return;
    requestAnimationFrame(drawScope);
    const oscEl=document.getElementById('m'+id);if(oscEl&&(oscEl.classList.contains('collapsed')||oscEl.classList.contains('hidden')))return;
    const c=scopeCvs,x=c.getContext('2d');
    if(c.width!==c.parentElement.clientWidth||c.height!==c.parentElement.clientHeight){c.width=c.parentElement.clientWidth;c.height=c.parentElement.clientHeight}
    const W=c.width,H=c.height;x.clearRect(0,0,W,H);
    // Grid
    x.strokeStyle='rgba(96,165,250,.06)';x.lineWidth=1;
    for(let i=0;i<5;i++){const y=H*i/4;x.beginPath();x.moveTo(0,y);x.lineTo(W,y);x.stroke()}
    for(let i=0;i<9;i++){const xp=W*i/8;x.beginPath();x.moveTo(xp,0);x.lineTo(xp,H);x.stroke()}
    if(scopeMode==='wave'){
      // Waveform
      if(scopeAn){
        const buf=new Float32Array(scopeAn.fftSize);
        if(!scopeFrozen){scopeAn.getFloatTimeDomainData(buf);frozenBuf=buf}
        const data=scopeFrozen&&frozenBuf?frozenBuf:buf;
        // Auto-trigger: find zero crossing
        let trigger=0;for(let i=1;i<data.length/2;i++){if(data[i-1]<0&&data[i]>=0){trigger=i;break}}
        const samplesPerScreen=Math.min(data.length-trigger,2048);
        // Detect amplitude
        let maxA=0;for(let i=trigger;i<trigger+samplesPerScreen;i++){const v=Math.abs(data[i]);if(v>maxA)maxA=v}
        const scale=maxA>0?Math.min(1/maxA*.9,10):1;
        x.beginPath();x.strokeStyle='#60a5fa';x.lineWidth=2;x.shadowBlur=4;x.shadowColor='#60a5fa';
        for(let i=0;i<samplesPerScreen;i++){const px=i/samplesPerScreen*W;const py=H/2-data[trigger+i]*scale*H/2;
          i===0?x.moveTo(px,py):x.lineTo(px,py)}
        x.stroke();x.shadowBlur=0;
        // Detect frequency via autocorrelation
        let bestOff=-1,bestCorr=-1;const minP=Math.floor(ctx.sampleRate/4000),maxP=Math.floor(ctx.sampleRate/20);
        for(let off=minP;off<maxP;off++){let corr=0;
          for(let i=0;i<512;i++)corr+=data[trigger+i]*data[trigger+i+off];
          if(corr>bestCorr){bestCorr=corr;bestOff=off}}
        const detectedHz=bestOff>0?ctx.sampleRate/bestOff:0;
        const rms=Math.sqrt(data.slice(trigger,trigger+samplesPerScreen).reduce((s,v)=>s+v*v,0)/samplesPerScreen);
        const dbVal=rms>0?20*Math.log10(rms):-Infinity;
        scopeInfo.innerHTML=detectedHz>20?
          `${detectedHz.toFixed(1)} Hz ¬∑ ${freqToNote(detectedHz)}<br>${dbVal.toFixed(1)} dB ¬∑ RMS ${(rms*100).toFixed(1)}%`:
          `-- Hz<br>${dbVal>-80?dbVal.toFixed(1)+' dB':'silent'}`;
      } else {scopeInfo.innerHTML='-- Hz<br>no signal'}
    } else {
      // FFT spectrum
      if(scopeAnF){
        const freqData=new Uint8Array(scopeAnF.frequencyBinCount);
        if(!scopeFrozen){scopeAnF.getByteFrequencyData(freqData);frozenFreq=freqData}
        const data=scopeFrozen&&frozenFreq?frozenFreq:freqData;
        const nyq=ctx.sampleRate/2;const maxF=Math.min(nyq,8000);const maxBin=Math.floor(maxF/nyq*data.length);
        x.fillStyle='rgba(96,165,250,.4)';
        for(let i=0;i<maxBin;i++){const bw=W/maxBin;const h2=data[i]/255*H;x.fillRect(i*bw,H-h2,bw-.5,h2)}
        // Peak frequency
        let peakBin=0,peakVal=0;for(let i=1;i<maxBin;i++){if(data[i]>peakVal){peakVal=data[i];peakBin=i}}
        const peakHz=peakBin*nyq/data.length;
        if(peakVal>10){x.strokeStyle='#f59e0b';x.lineWidth=1;x.setLineDash([2,2]);
          const px=peakBin/maxBin*W;x.beginPath();x.moveTo(px,0);x.lineTo(px,H);x.stroke();x.setLineDash([])}
        scopeInfo.innerHTML=peakVal>10?`Peak: ${peakHz.toFixed(1)} Hz ¬∑ ${freqToNote(peakHz)}`:'FFT ¬∑ no signal';
      }
    }
    // Custom waveform ghost
    if(m.useCustom){x.beginPath();x.strokeStyle='rgba(96,165,250,.15)';x.lineWidth=1;
      for(let i=0;i<m.custom.length;i++){const px=i/m.custom.length*W;const py=H/2-m.custom[i]*H/2*.7;
        i===0?x.moveTo(px,py):x.lineTo(px,py)}
      x.stroke()}
  }
  requestAnimationFrame(drawScope);

  // === FREQUENCY INPUT ROW ===
  const freqRow=document.createElement('div');freqRow.style.cssText='display:flex;gap:4px;align-items:center;margin-bottom:4px;flex-wrap:wrap';
  // Hz input
  const hzLbl=document.createElement('span');hzLbl.style.cssText='font-size:6px;color:var(--dim);font-weight:700';hzLbl.textContent='Hz';
  const hzIn=document.createElement('input');hzIn.type='number';hzIn.min=20;hzIn.max=20000;hzIn.step=0.1;hzIn.value=m.freq;
  hzIn.style.cssText='background:var(--s3);border:1px solid var(--border);color:#60a5fa;font-family:inherit;font-size:9px;font-weight:800;padding:3px 6px;border-radius:3px;width:75px;outline:none;text-align:center';
  const noteDisp=document.createElement('span');noteDisp.style.cssText='font-size:7px;color:var(--dim);font-weight:700;min-width:55px';
  noteDisp.textContent=freqToNote(m.freq);
  hzIn.addEventListener('input',()=>{m.freq=Math.max(20,Math.min(20000,+hzIn.value||440));noteDisp.textContent=freqToNote(m.freq);updateLoopFreq()});
  hzIn.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();initA();ensureAn();
    m.freq=Math.max(20,Math.min(20000,+hzIn.value||440));noteDisp.textContent=freqToNote(m.freq);updateLoopFreq();
    const nd=m.playFreq(m.freq);if(nd){const dur=m.a+m.d+m.r+.2;nd.g.gain.linearRampToValueAtTime(0,ctx.currentTime+dur);nd.o.stop(ctx.currentTime+dur+.05)}}});
  // Quick frequency buttons
  const qRow=document.createElement('div');qRow.style.cssText='display:flex;gap:2px;flex-wrap:wrap;align-items:center';
  [110,220,432,440,528,741,852,963].forEach(f=>{
    const b=document.createElement('button');b.className='pbtn';b.textContent=f;b.style.fontSize='5px';
    b.addEventListener('click',()=>{m.freq=f;hzIn.value=f;noteDisp.textContent=freqToNote(f);updateLoopFreq();
      initA();ensureAn();const nd=m.playFreq(f);if(nd){const dur=m.a+m.d+m.r+.2;nd.g.gain.linearRampToValueAtTime(0,ctx.currentTime+dur);nd.o.stop(ctx.currentTime+dur+.05)}});
    qRow.appendChild(b)});
  // === SEND TO SYNTH ===
  const sendBtn=document.createElement('button');sendBtn.style.cssText='background:rgba(34,211,238,.08);border:1.5px solid rgba(34,211,238,.3);color:#22d3ee;font-family:inherit;font-size:6px;font-weight:800;padding:3px 8px;border-radius:3px;cursor:pointer;transition:all .15s;letter-spacing:.4px;margin-left:auto';
  sendBtn.textContent='‚Üí SYNTH';sendBtn.title='Send waveform & settings to a Synth module';
  sendBtn.addEventListener('click',()=>{
    const synths=mods.filter(x=>x.type==='synth');
    if(!synths.length){sendBtn.textContent='No Synth!';setTimeout(()=>{sendBtn.textContent='‚Üí SYNTH'},1500);return}
    synths.forEach(s=>{
      s.wv=m.useCustom?'sine':m.wv==='harmonics'?'sine':m.wv;
      s.det=m.det;s.vol=m.vol;s.oct=m.oct;
      s.a=m.a;s.d=m.d;s.s=m.s;s.r=m.r;s.ff=m.ff;s.fr=m.fr;
      s._oscFreq=m.freq;
    });
    sendBtn.textContent='‚úì Sent!';sendBtn.style.borderColor='#22d3ee';
    setTimeout(()=>{sendBtn.textContent='‚Üí SYNTH';sendBtn.style.borderColor='rgba(34,211,238,.3)'},1200)});
  qRow.appendChild(sendBtn);
  // Loop button
  const loopBtn=document.createElement('button');loopBtn.style.cssText='background:rgba(96,165,250,.1);border:2px solid #60a5fa40;color:#60a5fa;font-family:inherit;font-size:7px;font-weight:800;padding:4px 10px;border-radius:4px;cursor:pointer;transition:all .15s;letter-spacing:.5px';
  loopBtn.textContent='‚ñ∂ LOOP';
  loopBtn.addEventListener('click',()=>{initA();if(m.looping)stopLoop();else startLoop()});
  loopBtn.addEventListener('mouseenter',()=>{loopBtn.style.borderColor='#60a5fa';loopBtn.style.background='rgba(96,165,250,.2)'});
  loopBtn.addEventListener('mouseleave',()=>{loopBtn.style.borderColor=m.looping?'#60a5fa':'#60a5fa40';loopBtn.style.background=m.looping?'rgba(96,165,250,.25)':'rgba(96,165,250,.1)'});
  // Oneshot button
  const shotBtn=document.createElement('button');shotBtn.style.cssText='background:rgba(96,165,250,.06);border:1px solid var(--border);color:var(--dim);font-family:inherit;font-size:7px;font-weight:700;padding:4px 8px;border-radius:4px;cursor:pointer;transition:all .12s';
  shotBtn.textContent='‚ô™ PLAY';
  shotBtn.addEventListener('click',()=>{initA();ensureAn();const nd=m.playFreq(m.freq);
    if(nd){const dur=m.a+m.d+m.r+.2;nd.g.gain.linearRampToValueAtTime(0,ctx.currentTime+dur);nd.o.stop(ctx.currentTime+dur+.05)}});
  freqRow.append(hzIn,hzLbl,noteDisp,loopBtn,shotBtn);
  bd.appendChild(freqRow);
  bd.appendChild(qRow);

  // === WAVEFORM SELECT ===
  const wRow=document.createElement('div');wRow.style.cssText='display:flex;gap:3px;align-items:center;margin-bottom:4px;margin-top:4px;flex-wrap:wrap';
  const wLbl=document.createElement('span');wLbl.style.cssText='font-size:6px;color:var(--dim);font-weight:700;letter-spacing:.5px';wLbl.textContent='WAVE';
  wRow.appendChild(wLbl);
  const wvBtns=[];
  ['sine','triangle','sawtooth','square','harmonics','custom'].forEach(w=>{
    const b=document.createElement('button');b.className='swb';
    b.textContent=w==='sawtooth'?'SAW':w==='harmonics'?'HARM':w==='custom'?'DRAW':w.slice(0,3).toUpperCase();
    if((w==='custom'&&m.useCustom)||(w==='harmonics'&&m.wv==='harmonics')||(w!=='custom'&&w!=='harmonics'&&m.wv===w&&!m.useCustom))b.classList.add('active');
    b.addEventListener('click',()=>{
      m.useCustom=w==='custom';m.wv=w==='custom'?m.wv:w;
      wvBtns.forEach(x=>x.classList.remove('active'));b.classList.add('active');
      harmRow.style.display=w==='harmonics'?'flex':'none';
      drawRow.style.display=w==='custom'?'block':'none';
      if(m.looping){stopLoop();startLoop()}
    });wvBtns.push(b);wRow.appendChild(b)});
  bd.appendChild(wRow);

  // === KNOBS ===
  const knobRow=document.createElement('div');knobRow.style.cssText='display:flex;gap:4px;align-items:center;margin-bottom:4px;flex-wrap:wrap';
  knobRow.append(
    mkK('Oct',1,7,m.oct,v=>{m.oct=Math.round(v)},1),
    mkK('Vol',0,100,m.vol*100,v=>{m.vol=v/100;if(loopNode)loopNode.g.gain.setValueAtTime(m.vol*m.s,ctx.currentTime)}),
    mkK('Det',0,50,m.det,v=>{m.det=v;if(loopNode)loopNode.o.detune.setValueAtTime(v,ctx.currentTime)}),
    mkK('A',0,100,m.a*100,v=>{m.a=v/100}),mkK('D',0,100,m.d*100,v=>{m.d=v/100}),
    mkK('S',0,100,m.s*100,v=>{m.s=v/100}),mkK('R',0,100,m.r*100,v=>{m.r=v/100}),
    mkK('Freq',50,18000,m.ff,v=>{m.ff=v;if(loopNode)loopNode.f.frequency.setValueAtTime(v,ctx.currentTime)}),
    mkK('Res',0,20,m.fr,v=>{m.fr=v;if(loopNode)loopNode.f.Q.setValueAtTime(v,ctx.currentTime)})
  );bd.appendChild(knobRow);

  // === HARMONICS ===
  const harmRow=document.createElement('div');harmRow.style.cssText='display:none;gap:3px;align-items:flex-end;margin-bottom:4px;padding:4px;background:var(--s2);border:1px solid var(--border);border-radius:4px';
  const harmLbl=document.createElement('span');harmLbl.style.cssText='font-size:5px;color:var(--dim);font-weight:700;letter-spacing:.5px;writing-mode:vertical-lr;transform:rotate(180deg)';
  harmLbl.textContent='HARMONICS';harmRow.appendChild(harmLbl);
  for(let h=0;h<8;h++){
    const col=document.createElement('div');col.style.cssText='display:flex;flex-direction:column;align-items:center;gap:2px;flex:1';
    const sl=document.createElement('input');sl.type='range';sl.min=0;sl.max=100;sl.value=m.harmonics[h]*100;
    sl.style.cssText='writing-mode:vertical-lr;height:50px;width:14px;accent-color:#60a5fa';
    sl.addEventListener('input',()=>{m.harmonics[h]=sl.value/100;if(m.looping&&m.wv==='harmonics'){stopLoop();startLoop()}});
    const lb=document.createElement('span');lb.style.cssText='font-size:5px;color:var(--dim);font-weight:700';lb.textContent=h===0?'Fund':(h+1)+'√ó';
    col.append(sl,lb);harmRow.appendChild(col)}
  bd.appendChild(harmRow);

  // === CUSTOM DRAW ===
  const drawRow=document.createElement('div');drawRow.style.cssText='display:none;margin-bottom:4px';
  const drawCvs=document.createElement('canvas');
  const _isTouch='ontouchstart'in window||navigator.maxTouchPoints>0;
  drawCvs.style.cssText='width:100%;height:'+(_isTouch?'100':'60')+'px;background:var(--s2);border:1px solid var(--border);border-radius:4px;cursor:crosshair;touch-action:none;-webkit-touch-callout:none;-ms-touch-action:none';
  drawCvs.width=512;drawCvs.height=_isTouch?100:60;
  function renderDraw(){const c=drawCvs,x=c.getContext('2d'),W=c.width,H=c.height;
    x.clearRect(0,0,W,H);x.strokeStyle='rgba(255,255,255,.06)';x.lineWidth=1;
    x.beginPath();x.moveTo(0,H/2);x.lineTo(W,H/2);x.stroke();
    x.beginPath();x.strokeStyle='#60a5fa';x.lineWidth=2;
    for(let i=0;i<m.custom.length;i++){const px=i/(m.custom.length-1)*W;const py=H/2-m.custom[i]*H/2*.9;
      i===0?x.moveTo(px,py):x.lineTo(px,py)}
    x.stroke()}
  let drawDown=false;
  function drawAt(e){const rect=drawCvs.getBoundingClientRect();const x=(e.clientX-rect.left)/rect.width;const y=(e.clientY-rect.top)/rect.height;
    const idx=Math.floor(x*m.custom.length);const val=1-y*2;
    if(idx>=0&&idx<m.custom.length){m.custom[idx]=Math.max(-1,Math.min(1,val));renderDraw()}}
  drawCvs.addEventListener('mousedown',e=>{drawDown=true;drawAt(e)});
  drawCvs.addEventListener('mousemove',e=>{if(drawDown)drawAt(e)});
  window.addEventListener('mouseup',()=>{if(drawDown&&m.looping&&m.useCustom){stopLoop();startLoop()}drawDown=false});
  drawCvs.addEventListener('touchstart',e=>{e.preventDefault();e.stopPropagation();drawDown=true;lockWsScroll();
    // Disable parent scroll while drawing
    const wb=drawCvs.closest('.wbody');if(wb){wb.style.overflow='hidden';wb.style.touchAction='none'}
    drawAt(e.touches[0])},{passive:false});
  drawCvs.addEventListener('touchmove',e=>{e.preventDefault();e.stopPropagation();if(drawDown)drawAt(e.touches[0])},{passive:false});
  drawCvs.addEventListener('touchend',e=>{e.preventDefault();e.stopPropagation();
    // Re-enable parent scroll
    const wb=drawCvs.closest('.wbody');if(wb){wb.style.overflow='auto';wb.style.touchAction=''}
    unlockWsScroll();
    if(drawDown&&m.looping&&m.useCustom){stopLoop();startLoop()}drawDown=false},{passive:false});
  const drawCtrl=document.createElement('div');drawCtrl.style.cssText='display:flex;gap:3px;margin-top:3px';
  ['Sine','Saw','Sqr','Noise','Clear'].forEach(name=>{
    const b=document.createElement('button');b.className='pbtn';b.textContent=name;
    b.addEventListener('click',()=>{for(let i=0;i<128;i++){const t=i/128;
      if(name==='Sine')m.custom[i]=Math.sin(t*Math.PI*2);
      else if(name==='Saw')m.custom[i]=1-2*t;
      else if(name==='Sqr')m.custom[i]=t<.5?1:-1;
      else if(name==='Noise')m.custom[i]=Math.random()*2-1;
      else m.custom[i]=0}
      renderDraw();if(m.looping&&m.useCustom){stopLoop();startLoop()}});
    drawCtrl.appendChild(b)});
  drawRow.append(drawCvs,drawCtrl);bd.appendChild(drawRow);renderDraw();

  // === KEYBOARD ===
  const keybd=document.createElement('div');keybd.className='skb';
  const whites=[0,2,4,5,7,9,11,12],bp={1:1,3:2,6:4,8:5,10:6};
  whites.forEach(note=>{const k=document.createElement('div');k.className='swk';k.dataset.note=note;
    const l=document.createElement('span');l.className='kl';l.textContent=NN[note%12];k.appendChild(l);
    k.addEventListener('mousedown',e=>{e.preventDefault();initA();m.play(note);k.classList.add('active')});
    k.addEventListener('mouseup',()=>{m.stop(note);k.classList.remove('active')});
    k.addEventListener('mouseleave',()=>{m.stop(note);k.classList.remove('active')});keybd.appendChild(k)});
  Object.entries(bp).forEach(([note,pos])=>{const k=document.createElement('div');k.className='sbk';k.dataset.note=note;
    k.style.left=((pos-1)/whites.length*100+100/whites.length*0.6)+'%';
    k.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();initA();m.play(+note);k.classList.add('active')});
    k.addEventListener('mouseup',()=>{m.stop(+note);k.classList.remove('active')});
    k.addEventListener('mouseleave',()=>{m.stop(+note);k.classList.remove('active')});keybd.appendChild(k)});
  bd.appendChild(keybd);
  const kbb=document.createElement('button');kbb.className='wb kb';kbb.title='A-K';kbb.textContent='‚å®';kbb.dataset.mid=id;
  kbb.addEventListener('click',e=>{e.stopPropagation();setKb(id)});ct.prepend(kbb);
  const km={a:0,w:1,s:2,e:3,d:4,f:5,t:6,g:7,y:8,h:9,u:10,j:11,k:12};
  const kd=e=>{if(e.repeat||_kb!==id)return;const n=km[e.key.toLowerCase()];if(n!==undefined){initA();m.play(n);
    const k=keybd.querySelector(`[data-note="${n}"]`);if(k)k.classList.add('active')}};
  const ku=e=>{if(_kb!==id)return;const n=km[e.key.toLowerCase()];if(n!==undefined){m.stop(n);
    const k=keybd.querySelector(`[data-note="${n}"]`);if(k)k.classList.remove('active')}};
  window.addEventListener('keydown',kd);window.addEventListener('keyup',ku);
  m.destroy=()=>{window.removeEventListener('keydown',kd);window.removeEventListener('keyup',ku);
    stopLoop();Object.keys(m.an).forEach(n=>m.stop(+n));if(_kb===id)_kb=null;if(m._clipClean)m._clipClean()};
  addClipBtns(ct,m);ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}

// === SAVE MODULE ===
function addSave(){
  const id=mid++;
  const{el,bd,ct}=mkW('SAVE<span>.EXE</span>','Save/Load','#10b981',0,0,320,320,0);
  el.id='m'+id;
  const m={id,type:'save',el,ci:-1,ts:0,onStep:()=>{},clr:()=>{}};

  // === SERIALIZE ===
  function getState(){
    const state={v:1,ts:Date.now(),
      channels:chs.map(ch=>({bpm:ch.bpm,sw:ch.sw,on:ch.on})),
      seq:{mode:seqState.mode,barsPerCh:seqState.barsPerCh,order:[...seqState.order],customPattern:seqState.customPattern.map(s=>[...s])},
      theme:{},modules:[]};
    // capture theme/workspace style
    const r=document.documentElement.style;
    ['--bg','--surface','--s2','--s3','--border','--text','--dim','--accent'].forEach(k=>{
      state.theme[k]=r.getPropertyValue(k)});
    state.theme.wsBg=document.getElementById('wsI').style.backgroundColor||'';
    state.theme.wsBgImg=document.getElementById('wsI').style.backgroundImage||'';
    // capture each module
    mods.forEach(mod=>{
      const d={type:mod.type,ci:mod.ci,
        x:parseInt(mod.el.style.left)||0,y:parseInt(mod.el.style.top)||0,
        w:mod.el.offsetWidth,h:mod.el.offsetHeight};
      const mt=mod.el.getAttribute('data-mod-theme');if(mt)d.modTheme=mt;
      switch(mod.type){
        case 'beat':
          d.ts=mod.ts;d.cm=mod.cm;
          d.ch=mod.ch.map(c=>({n:c.n,name:c.name,t:c.t,s:c.s,c:c.c,v:c.v,mut:c.mut,solo:c.solo,
            steps:[...c.steps]}));
          break;
        case 'synth':
          d.wv=mod.wv;d.det=mod.det;d.a=mod.a;d.d=mod.d;d.s=mod.s;d.r=mod.r;
          d.ff=mod.ff;d.fr=mod.fr;d.vol=mod.vol;d.oct=mod.oct;
          break;
        case 'fx':
          // capture slider values AND toggle on/off states
          d.sliders=[];
          mod.el.querySelectorAll('input[type=range]').forEach(s=>{d.sliders.push(+s.value)});
          d.toggles=[];
          mod.el.querySelectorAll('.fxsw').forEach(s=>{d.toggles.push(s.classList.contains('on'))});
          break;
        case 'piano':
          d.wv=mod.wv;d.det=mod.det;d.a=mod.a;d.d=mod.d;d.s=mod.s;d.r=mod.r;
          d.ff=mod.ff;d.fr=mod.fr;d.vol=mod.vol;d.oct=mod.oct;d.sus=mod.sus;
          break;
        case 'bass':
          d.vol=mod.vol;d.oct=mod.oct;d.mode=mod.mode;
          break;
        case 'note':
          d.ts=mod.ts;d.oct=mod.oct;d.wv=mod.wv;d.vol=mod.vol;
          d.a=mod.a;d.d=mod.d;d.s=mod.s;d.r=mod.r;d.ff=mod.ff;d.fr=mod.fr;d.det=mod.det;
          d.inst=mod.inst;
          // capture grid cells from grid array
          d.cells=[];
          if(mod.grid)mod.grid.forEach((row,ri)=>row.forEach((v,ci)=>{if(v)d.cells.push([ri,ci])}));
          break;
        case 'drum':
          d.ts=mod.ts;
          d.parts=mod.parts.map(p=>({name:p.name,cat:p.cat,col:p.col,v:p.v,pitch:p.pitch,decay:p.decay,
            tone:p.tone,drive:p.drive,body:p.body,pan:p.pan,prob:p.prob,hum:p.hum,swing:p.swing,
            mut:p.mut,solo:p.solo,snd:p.snd}));
          if(mod.getPats){d.pats=mod.getPats().map(p=>({steps:p.steps,grid:p.grid.map(r=>[...r])}))}
          break;
        case 'chord':
          d.ts=mod.ts;d.oct=mod.oct;d.vol=mod.vol;d.wv=mod.wv;d.det=mod.det;
          d.a=mod.a;d.d=mod.d;d.s=mod.s;d.r=mod.r;
          d.slots=mod.slots.map(s=>({root:s.root,type:s.type}));
          if(mod.stepsPerChord)d.stepsPerChord=mod.stepsPerChord;
          break;
        case 'inst':
          d.iIdx=mod.iIdx;d.i2Idx=mod.i2Idx;d.oct=mod.oct;d.vol=mod.vol;
          d.detune=mod.detune;d.chord=mod.chord;d.bend=mod.bend;
          d.rvbMix=mod.rvbMix;d.dlMix=mod.dlMix;d.dlTime=mod.dlTime;
          break;
        case 'osc':
          d.wv=mod.wv;d.oct=mod.oct;d.vol=mod.vol;d.det=mod.det;
          d.a=mod.a;d.d=mod.d;d.s=mod.s;d.r=mod.r;d.ff=mod.ff;d.fr=mod.fr;
          d.useCustom=mod.useCustom;d.custom=[...mod.custom];
          d.harmonics=[...mod.harmonics];
          break;
        case 'edit':case 'tape':case 'sample':case 'mixer':case 'save':case 'bank':case 'collab':
          // these are stateless or have audio buffers we can't serialize
          break;
        case 'auto':
          d.ts=mod.ts;d.activeParam=mod.activeParam;d.curves={};
          Object.keys(mod.curves).forEach(k=>d.curves[k]=[...mod.curves[k]]);
          break;
        case 'sidechain':
          d.depth=mod.depth;d.attack=mod.attack;d.release=mod.release;d.pattern=[...mod.pattern];
          break;
      }
      state.modules.push(d);
    });
    return state;
  }

  // === DESERIALIZE ===
  function loadState(state){
    if(!state||!state.modules)return;
    // stop everything
    chs.forEach(ch=>{ch.on=false;ch.step=0});
    // destroy all modules
    while(mods.length){const mod=mods.pop();if(mod.destroy)mod.destroy();if(mod.el&&mod.el.parentNode)mod.el.parentNode.removeChild(mod.el)}
    mid=0;
    // restore channels
    if(state.channels)state.channels.forEach((ch,i)=>{
      if(chs[i]){chs[i].bpm=ch.bpm||120;chs[i].sw=ch.sw||0}});
    // restore sequencing
    if(state.seq){
      seqState.mode=state.seq.mode||'all';
      seqState.barsPerCh=state.seq.barsPerCh||2;
      if(state.seq.order)seqState.order=state.seq.order;
      if(state.seq.customPattern)seqState.customPattern=state.seq.customPattern;
      seqState.curIdx=0;seqState.barCount=0;seqState.stepInBar=0;
    }
    // restore theme
    if(state.theme){const r=document.documentElement.style;
      Object.keys(state.theme).forEach(k=>{
        if(k==='wsBg'){document.getElementById('wsI').style.backgroundColor=state.theme[k];
          document.getElementById('workspace').style.backgroundColor=state.theme[k]}
        else if(k==='wsBgImg'){document.getElementById('wsI').style.backgroundImage=state.theme[k]}
        else r.setProperty(k,state.theme[k])});
    }
    // recreate modules
    const adders={beat:addBeat,synth:addSynth,fx:addFx,piano:addPiano,bass:addBass,
      note:addNote,sample:addSample,tape:addTape,drum:addDrum,chord:addChord,
      edit:addEdit,inst:addInst,mixer:addMixer,save:addSave,osc:addOsc,midi:addMidi,arrange:addTracks,bank:addBank,
      auto:addAuto,sidechain:addSidechain,collab:addCollab};
    state.modules.forEach(d=>{
      const fn=adders[d.type];if(!fn)return;
      if(d.type==='mixer')fn();
      else if(d.type==='save')fn();
      else if(d.type==='bank')fn();
      else fn(d.ci||0);
      const mod=mods[mods.length-1];if(!mod)return;
      // restore position
      mod.el.style.left=(d.x||0)+'px';
      mod.el.style.top=(d.y||0)+'px';
      if(d.w)mod.el.style.width=d.w+'px';
      if(d.h)mod.el.style.height=d.h+'px';
      // restore per-module theme
      if(d.modTheme){const t=THEMES.find(th=>th.name===d.modTheme);if(t){
        mod.el.style.setProperty('--bg',t.bg);mod.el.style.setProperty('--surface',t.surface);
        mod.el.style.setProperty('--s2',t.s2);mod.el.style.setProperty('--s3',t.s3);
        mod.el.style.setProperty('--border',t.border);mod.el.style.setProperty('--text',t.text);
        mod.el.style.setProperty('--dim',t.dim);mod.el.setAttribute('data-mod-theme',d.modTheme)}}
      // restore module-specific state
      switch(d.type){
        case 'beat':
          if(d.ch&&mod.ch){d.ch.forEach((c,i)=>{
            if(mod.ch[i]){
              if(c.n)mod.ch[i].n=c.n;if(c.t)mod.ch[i].t=c.t;if(c.s)mod.ch[i].s=c.s;if(c.c)mod.ch[i].c=c.c;
              mod.ch[i].v=c.v;mod.ch[i].mut=c.mut;mod.ch[i].solo=c.solo;
              c.steps.forEach((s,si)=>{mod.ch[i].steps[si]=s})}});
            // rebuild grid
            if(mod.el.querySelector('.wbody'))buildBG(mod,mod.el.querySelector('.wbody'))}
          break;
        case 'synth':
          ['wv','det','a','d','s','r','ff','fr','vol','oct'].forEach(k=>{if(d[k]!==undefined)mod[k]=d[k]});
          // Sync knob UI: find all range inputs and set from mod state
          {const sls=mod.el.querySelectorAll('.sk');
           const map=[['det',mod.det],['oct',mod.oct],['a',mod.a*100],['d',mod.d*100],['s',mod.s*100],['r',mod.r*100],['freq',mod.ff],['res',mod.fr],['vol',mod.vol*100]];
           sls.forEach(sl=>{const lb=sl.querySelector('label');const inp=sl.querySelector('input');const vd=sl.querySelector('.kv');
             if(!lb||!inp)return;const n=lb.textContent.toLowerCase();
             const hit=map.find(([k])=>n.startsWith(k));
             if(hit){inp.value=hit[1];if(vd)vd.textContent=n==='oct'?Math.round(hit[1]):Math.round(hit[1])}
           })}
          // Sync waveform selector
          {const wsel=mod.el.querySelector('.wsel');if(wsel&&d.wv)wsel.value=d.wv}
          break;
        case 'piano':
          ['wv','det','a','d','s','r','ff','fr','vol','oct','sus'].forEach(k=>{if(d[k]!==undefined)mod[k]=d[k]});
          {const sls=mod.el.querySelectorAll('.sk');
           const map=[['oct',mod.oct],['vol',mod.vol*100],['atk',mod.a*1000],['rel',mod.r*100]];
           sls.forEach(sl=>{const lb=sl.querySelector('label');const inp=sl.querySelector('input');const vd=sl.querySelector('.kv');
             if(!lb||!inp)return;const n=lb.textContent.toLowerCase();
             const hit=map.find(([k])=>n.startsWith(k));
             if(hit){inp.value=hit[1];if(vd)vd.textContent=Math.round(hit[1])}
           })}
          {const wsel=mod.el.querySelector('.wsel');if(wsel&&d.wv)wsel.value=d.wv}
          break;
        case 'bass':
          if(d.vol!==undefined)mod.vol=d.vol;
          if(d.oct!==undefined)mod.oct=d.oct;
          if(d.mode!==undefined)mod.mode=d.mode;
          {const sls=mod.el.querySelectorAll('.sk');
           const map=[['oct',mod.oct],['vol',mod.vol*100],['flt',mod.ff||200],['res',mod.fr||0]];
           sls.forEach(sl=>{const lb=sl.querySelector('label');const inp=sl.querySelector('input');const vd=sl.querySelector('.kv');
             if(!lb||!inp)return;const n=lb.textContent.toLowerCase();
             const hit=map.find(([k])=>n.startsWith(k));
             if(hit){inp.value=hit[1];if(vd)vd.textContent=Math.round(hit[1])}
           })}
          break;
        case 'note':
          ['ts','oct','wv','vol','a','d','s','r','ff','fr','det','inst'].forEach(k=>{if(d[k]!==undefined)mod[k]=d[k]});
          if(mod.grid)mod.grid.forEach(r=>r.fill(false));
          if(d.cells&&mod.grid){
            if(d.ts&&d.ts>mod.grid[0].length)mod.grid.forEach(r=>{while(r.length<d.ts)r.push(false)});
            d.cells.forEach(([r,c])=>{if(mod.grid[r])mod.grid[r][c]=true})}
          if(mod.buildNR)mod.buildNR();
          break;
        case 'chord':
          ['ts','oct','vol','wv','det','a','d','s','r'].forEach(k=>{if(d[k]!==undefined)mod[k]=d[k]});
          if(d.stepsPerChord)mod.stepsPerChord=d.stepsPerChord;
          if(d.slots){mod.slots=d.slots.map(s=>({root:s.root,type:s.type}));
            mod.ts=mod.slots.length*mod.stepsPerChord;
            if(mod.renSlots)mod.renSlots()}
          break;
        case 'inst':
          ['iIdx','i2Idx','oct','vol','detune','chord','bend','rvbMix','dlMix','dlTime'].forEach(k=>{if(d[k]!==undefined)mod[k]=d[k]});
          {const sls=mod.el.querySelectorAll('.sk');
           const map=[['oct',mod.oct],['vol',mod.vol*100],['det',mod.detune||0]];
           sls.forEach(sl=>{const lb=sl.querySelector('label');const inp=sl.querySelector('input');const vd=sl.querySelector('.kv');
             if(!lb||!inp)return;const n=lb.textContent.toLowerCase();
             const hit=map.find(([k])=>n.startsWith(k));
             if(hit){inp.value=hit[1];if(vd)vd.textContent=Math.round(hit[1])}
           })}
          break;
        case 'drum':
          if(d.parts&&mod.parts){d.parts.forEach((p,i)=>{
            if(mod.parts[i]){
              ['name','cat','col','v','pitch','decay','tone','drive','body','pan','prob','hum','swing','mut','solo','snd'].forEach(k=>{
                if(p[k]!==undefined)mod.parts[i][k]=p[k]})}})}
          if(d.pats&&mod.setPats)mod.setPats(d.pats);
          if(mod.buildGrid)mod.buildGrid();
          break;
        case 'fx':
          if(d.sliders){const sliders=mod.el.querySelectorAll('input[type=range]');
            d.sliders.forEach((v,i)=>{if(sliders[i]){sliders[i].value=v;sliders[i].dispatchEvent(new Event('input',{bubbles:true}))}})}
          if(d.toggles){const toggles=mod.el.querySelectorAll('.fxsw');
            d.toggles.forEach((on,i)=>{if(toggles[i]){
              const isOn=toggles[i].classList.contains('on');
              if(on&&!isOn)toggles[i].click();
              else if(!on&&isOn)toggles[i].click()}})}
          if(d.sliders){const sliders=mod.el.querySelectorAll('input[type=range]');
            d.sliders.forEach((v,i)=>{if(sliders[i]){sliders[i].value=v;sliders[i].dispatchEvent(new Event('input',{bubbles:true}))}})}
          break;
        case 'osc':
          ['wv','oct','vol','det','a','d','s','r','ff','fr','useCustom'].forEach(k=>{if(d[k]!==undefined)mod[k]=d[k]});
          if(d.custom)for(let i=0;i<d.custom.length&&i<mod.custom.length;i++)mod.custom[i]=d.custom[i];
          if(d.harmonics)d.harmonics.forEach((v,i)=>{if(i<mod.harmonics.length)mod.harmonics[i]=v});
          break;
        case 'auto':
          if(d.ts)mod.ts=d.ts;if(d.activeParam)mod.activeParam=d.activeParam;
          if(d.curves)Object.keys(d.curves).forEach(k=>{mod.curves[k]=d.curves[k]});
          break;
        case 'sidechain':
          if(d.depth!==undefined)mod.depth=d.depth;if(d.attack)mod.attack=d.attack;
          if(d.release)mod.release=d.release;if(d.pattern)mod.pattern=d.pattern;
          break;
      }
    });
    updMx();filt();
    status.textContent='Loaded \u2714';status.style.color='#10b981';
    setTimeout(()=>{status.style.color='var(--dim)'},1500);
  }

  // === UI ===
  const status=document.createElement('div');status.style.cssText='font-size:6px;color:var(--dim);text-align:center;padding:4px;min-height:14px;font-weight:700';
  status.textContent='Ready';
  bd.appendChild(status);

  // name input
  const nameRow=document.createElement('div');nameRow.style.cssText='display:flex;gap:4px;align-items:center;margin-bottom:6px;padding:0 4px';
  const nameL=document.createElement('span');nameL.style.cssText='font-size:6px;color:var(--dim);white-space:nowrap';nameL.textContent='Project:';
  const nameIn=document.createElement('input');nameIn.type='text';nameIn.value='My Project';
  nameIn.style.cssText='flex:1;background:var(--s2);border:1px solid var(--border);border-radius:3px;padding:3px 5px;color:var(--text);font-family:inherit;font-size:6px;outline:none';
  nameRow.append(nameL,nameIn);bd.appendChild(nameRow);

  // buttons
  const btns=document.createElement('div');btns.style.cssText='display:grid;grid-template-columns:1fr 1fr;gap:4px;padding:0 4px;margin-bottom:6px';
  function mkB(txt,col,fn){
    const b=document.createElement('button');
    b.style.cssText='padding:8px;border-radius:4px;border:2px solid '+col+'40;background:'+col+'18;color:'+col+';font-family:inherit;font-size:7px;font-weight:800;letter-spacing:.5px;cursor:pointer;transition:all .12s';
    b.textContent=txt;
    b.addEventListener('mouseenter',()=>{b.style.background=col+'30';b.style.borderColor=col});
    b.addEventListener('mouseleave',()=>{b.style.background=col+'18';b.style.borderColor=col+'40'});
    b.addEventListener('click',fn);return b;
  }

  // SAVE TO FILE
  btns.appendChild(mkB('\u2193 SAVE FILE','#10b981',()=>{
    const state=getState();
    state.name=nameIn.value||'project';
    const json=JSON.stringify(state,null,2);
    const blob=new Blob([json],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;
    a.download=(nameIn.value||'studio-project').replace(/[^a-zA-Z0-9_-]/g,'_')+'.json';
    a.click();URL.revokeObjectURL(url);
    status.textContent='Saved: '+a.download;status.style.color='#10b981';
    setTimeout(()=>{status.style.color='var(--dim)'},2000);
  }));

  // LOAD FROM FILE
  const loadIn=document.createElement('input');loadIn.type='file';loadIn.accept='.json';loadIn.style.cssText='position:absolute;left:-9999px;opacity:0;width:1px;height:1px';
  btns.appendChild(mkB('\u2191 LOAD FILE','#3b82f6',()=>loadIn.click()));
  loadIn.addEventListener('change',()=>{if(!loadIn.files[0])return;
    const r=new FileReader();r.onload=()=>{
      try{const state=JSON.parse(r.result);
        if(!state.modules){status.textContent='Invalid file';status.style.color='#ef4444';return}
        if(state.name)nameIn.value=state.name;
        loadState(state);
      }catch(e){status.textContent='Parse error';status.style.color='#ef4444'}
    };r.readAsText(loadIn.files[0]);loadIn.value='';
  });
  bd.appendChild(btns);bd.appendChild(loadIn);

  // QUICK SAVE/LOAD to localStorage
  const qRow=document.createElement('div');qRow.style.cssText='display:grid;grid-template-columns:1fr 1fr;gap:4px;padding:0 4px;margin-bottom:6px';
  qRow.appendChild(mkB('QUICK SAVE','#f59e0b',()=>{
    try{const state=getState();state.name=nameIn.value||'project';
      localStorage.setItem('studio_quicksave',JSON.stringify(state));
      status.textContent='Quick saved \u2714';status.style.color='#f59e0b';
      qTime.textContent='Last: '+new Date().toLocaleTimeString();
      setTimeout(()=>{status.style.color='var(--dim)'},1500);
    }catch(e){status.textContent='Save failed (storage full?)';status.style.color='#ef4444'}
  }));
  qRow.appendChild(mkB('QUICK LOAD','#f59e0b',()=>{
    try{const raw=localStorage.getItem('studio_quicksave');
      if(!raw){status.textContent='No quicksave found';status.style.color='#ef4444';return}
      const state=JSON.parse(raw);if(state.name)nameIn.value=state.name;
      loadState(state);
    }catch(e){status.textContent='Load failed';status.style.color='#ef4444'}
  }));
  bd.appendChild(qRow);

  const qTime=document.createElement('div');qTime.style.cssText='font-size:5px;color:var(--dim);text-align:center;opacity:.5';
  try{const qs=localStorage.getItem('studio_quicksave');
    if(qs){const d=JSON.parse(qs);qTime.textContent='Quicksave: '+(d.name||'untitled')+' \u2022 '+new Date(d.ts).toLocaleString()}}catch(e){}
  bd.appendChild(qTime);

  // AI FEED ‚Äî copy prompt + schema to clipboard for any AI
  const aiRow=document.createElement('div');aiRow.style.cssText='display:grid;grid-template-columns:1fr 1fr;gap:4px;padding:0 4px;margin:6px 0 2px';
  aiRow.appendChild(mkB('ü§ñ FEED AI','#a855f7',()=>{
    const P=`You are an expert music producer generating projects for STUDIO.EXE, a browser DAW. You output ONLY valid JSON ‚Äî no markdown, no fences, no explanation. Just raw JSON the user pastes directly into the app.

YOUR GOAL: Create COMPLETE, POLISHED tracks ‚Äî not loops. Real songs with structure, variation, dynamics, and cohesive sound design.

=== SONG STRUCTURE (CRITICAL) ===
Use the 4 channels as SONG SECTIONS and chain mode to arrange them:
- Channel 0: Intro / sparse section (fewer elements, building energy)
- Channel 1: Verse / main groove (core beat + melody, medium energy)
- Channel 2: Drop / chorus (full energy, all elements hitting)
- Channel 3: Breakdown / bridge (stripped back, tension builder)

Set seq.mode to "chain" and seq.order to arrange sections into a real track, e.g.:
"seq":{"mode":"chain","barsPerCh":2,"order":[0,0,1,1,1,1,2,2,2,2,1,1,3,3,2,2,2,2],"customPattern":[[],[],[],[]]}
This plays: 4 bars intro, 8 bars verse, 8 bars drop, 4 bars verse, 4 bars breakdown, 8 bars drop = full track.

=== PATTERN VARIATION (CRITICAL) ===
ALWAYS use ts:32 (32 steps). The second half (steps 16-31) should DIFFER from the first half:
- Add fills on steps 29-31 (snare roll, tom fill, hihat open)
- Remove or add kick hits for variation
- Shift percussion timing in second half
- Add ghost notes (low velocity 0.3-0.5 hits)
NEVER just repeat the same 16 steps twice. Real music breathes.

=== EACH CHANNEL NEEDS DIFFERENT PATTERNS ===
Ch0 (intro): Only kick + hihat, maybe a perc. Sparse. Let the listener ease in.
Ch1 (verse): Full beat but leave space. Bass pattern present but not dominant.
Ch2 (drop): Everything hitting. Harder kick, fuller hat pattern, bass on every kick, synth stabs. Maximum energy.
Ch3 (breakdown): Remove kick. Hihats only or offbeat perc. Let pads/chords carry it. Create tension for the return.

=== SOUND DESIGN PRINCIPLES ===
Frequency separation ‚Äî don't stack everything in the same range:
- Kick + Bass: Low end (sub-200Hz). Use "Kick 808" or "Kick Deep" for weight.
- Snare + Clap: Mid (200-2kHz). Layer snare+clap on same step for thickness.
- HiHats + Perc: High (2kHz+). These provide rhythm and air.
- Synth/Chord: Mid-high (300-5kHz). Don't compete with bass.

Synth settings that actually sound good:
- Pads: wv:triangle, a:0.15+, d:0.4, s:0.7, r:1.0+, ff:3000-5000, det:8-15
- Leads: wv:sawtooth, a:0.005, d:0.15, s:0.4, r:0.2, ff:1500-3000, fr:5-12, det:5-10
- Bass: wv:square or sawtooth, a:0.001, d:0.3, s:0.2, r:0.1, ff:400-1200, oct:2-3
- Plucks: wv:sawtooth, a:0.001, d:0.1, s:0.05, r:0.1, ff:2000, fr:3
- Stabs: wv:square, a:0.001, d:0.08, s:0, r:0.05, ff:1800, det:15-25

=== CHORD PROGRESSIONS THAT WORK ===
Don't just pick random chords. Use these proven progressions:
Minor key (dark): Am-F-C-G | Am-Dm-E-Am | Cm-Ab-Eb-Bb | Am-Em-F-G
Major key (bright): C-G-Am-F | F-G-Am-G | Eb-Bb-Cm-Ab
Jazz/soul: Fmaj7-Em7-Dm7-Cmaj7 | Am9-Dm7-Gmaj7-Cmaj7
Dark/tense: Am-Bdim-E-Am | Dm-Bb-Gm-A
Set stepsPerChord:8 for slow changes (pads) or 4 for faster (rhythm).
Match chord oct to 3-4. Avoid oct:5+ for chords (too thin).

=== NOTE/MELODY WRITING ===
Melodies should follow the chord tones. Row mapping (13 rows top to bottom at oct:4):
Row 0=C5, 1=B4, 2=A#4, 3=A4, 4=G#4, 5=G4, 6=F#4, 7=F4, 8=E4, 9=D#4, 10=D4, 11=C#4, 12=C4
Tips: Use chord tones on strong beats (steps 0,4,8,12,16,20,24,28). Use passing tones between. Leave gaps ‚Äî silence is musical. Repeat a motif then shift it. Don't fill every step.

=== FX MIXING ===
Less is more. Don't max everything out.
Drums: Light reverb (wet:15-25), gentle compression (thresh:-14, ratio:3-4). Maybe light saturation (drive:5-12).
Melody/lead: More reverb (wet:25-40), delay with moderate feedback (fb:35-50, wet:15-25).
Pads: Heavy reverb (wet:35-55) for space, usually no delay.
General: Keep distortion subtle (amount:5-15). Filter sweep via automation is more effective than static filter.
Slider order: [rvb-size,rvb-damp,rvb-wet, dly-time,dly-fb,dly-wet, chr-rate,chr-depth,chr-wet, phs-rate,phs-depth,phs-wet, dist-amt,bits,bits-wet, flt-freq,flt-Q, comp-thresh,comp-ratio,comp-wet, sat-drive,sat-wet, eq-lo,eq-mid,eq-hi]
Toggles: [reverb,delay,chorus,phaser,dist,bitcrush,filter,comp,sat,eq]

=== AUTOMATION ===
Use filter automation for movement and energy. Values 0-100. ALWAYS use 32 values for ts:32.
Builds: [20,22,25,30,35,42,48,55,60,65,70,76,80,84,88,92,20,25,32,40,50,58,65,72,78,84,90,94,96,98,99,100]
Sweeps: [20,30,45,60,80,95,100,90,75,55,35,20,15,25,45,65,85,100,95,80,60,40,25,15,20,35,55,75,90,100,85,60]
Pumping: [100,55,75,45,100,55,80,50,100,60,75,40,100,55,85,50,100,50,70,40,100,55,80,45,100,60,75,50,95,45,80,100]

=== SIDECHAIN ===
Essential for making kicks punch through. Put sidechain on the chord/pad channel, triggered on kick hits.
depth:0.6-0.85, attack:0.002-0.005, release:0.08-0.15 (shorter for fast genres, longer for chill).
Pattern should match kick pattern from ch2 (drop channel) for maximum pump.

=== SCHEMA ===
{"v":1,"channels":[{"bpm":120,"sw":0},{"bpm":120,"sw":0},{"bpm":120,"sw":0},{"bpm":120,"sw":0}],"seq":{"mode":"chain","barsPerCh":2,"order":[0,0,1,1,1,1,2,2,2,2,1,1,3,3,2,2,2,2],"customPattern":[[],[],[],[]]},"theme":{},"modules":[]}

BEAT: {"type":"beat","ci":0,"x":20,"y":20,"w":840,"h":320,"ts":32,"cm":8,"ch":[
{"n":"Kick","t":"kick","s":"Kick 808","c":"var(--kick)","v":0.9,"mut":false,"solo":false,"steps":[32 booleans]},
{"n":"Snare","t":"snare","s":"Snare Crack","c":"var(--snare)","v":0.8,"mut":false,"solo":false,"steps":[32 booleans]},
{"n":"HiHat","t":"hihat","s":"HH Closed","c":"var(--hihat)","v":0.7,"mut":false,"solo":false,"steps":[32 booleans]},
{"n":"Clap","t":"clap","s":"Clap Tight","c":"var(--clap)","v":0.75,"mut":false,"solo":false,"steps":[32 booleans]},
{"n":"Tom","t":"tom","s":"Tom Mid","c":"var(--tom)","v":0.7,"mut":false,"solo":false,"steps":[32 booleans]},
{"n":"Perc","t":"perc","s":"Perc Click","c":"var(--perc)","v":0.65,"mut":false,"solo":false,"steps":[32 booleans]},
{"n":"Bass","t":"bass","s":"Bass Sub","c":"var(--bass)","v":0.8,"mut":false,"solo":false,"steps":[32 booleans]},
{"n":"Synth","t":"synth","s":"Synth Stab","c":"var(--synth)","v":0.6,"mut":false,"solo":false,"steps":[32 booleans]}]}
Sounds ‚Äî kick: Kick 808/Punchy/Deep/Tight/Dist/Boom | snare: Snare Crack/Tight/Lo-Fi/Rim/Clap | hihat: HH Closed/Open/Crispy/Shaker | clap: Clap Tight/Snap/Big | tom: Tom High/Mid/Floor | perc: Perc Click/Rim/Cowbell/Conga | bass: Bass Sub/Saw/Square/Pluck/808/Dist | synth: Synth Stab/Pluck/Chord/Zap/Pad/Keys
YOU MUST include a beat module on EVERY channel (ci:0,1,2,3) with DIFFERENT patterns per section.

SYNTH: {"type":"synth","ci":0,"x":880,"y":20,"w":500,"h":280,"wv":"sawtooth","det":5,"a":0.01,"d":0.2,"s":0.5,"r":0.3,"ff":4000,"fr":1,"vol":0.6,"oct":4}
NOTE: {"type":"note","ci":0,"x":200,"y":60,"w":680,"h":280,"ts":32,"oct":4,"wv":"sawtooth","vol":0.4,"a":0.005,"d":0.1,"s":0.4,"r":0.15,"ff":3000,"fr":1,"det":5,"inst":"lead","cells":[[row,col],...]}
13 rows top-to-bottom: C5,B4,A#,A,G#,G,F#,F,E,D#,D,C#,C4. inst: lead/pad/bass/pluck/keys/organ.
CHORD: {"type":"chord","ci":1,"x":300,"y":100,"w":540,"h":260,"ts":32,"oct":3,"vol":0.5,"wv":"triangle","det":3,"a":0.02,"d":0.3,"s":0.6,"r":0.5,"stepsPerChord":8,"slots":[{"root":"C","type":"min7"},{"root":"Ab","type":"maj7"},...]}
Types: maj/min/dim/aug/sus2/sus4/maj7/min7/dom7/dim7/add9/madd9/6/min6/9/min9/maj9/11/13/power
FX: {"type":"fx","ci":0,"x":20,"y":350,"w":620,"h":280,"sliders":[25 numbers],"toggles":[10 booleans]}
AUTO: {"type":"auto","ci":0,"x":20,"y":500,"w":600,"h":200,"ts":32,"activeParam":"filter","curves":{"filter":[32 values 0-100]}}
SIDECHAIN: {"type":"sidechain","ci":2,"x":640,"y":500,"w":380,"h":180,"depth":0.8,"attack":0.005,"release":0.15,"pattern":[32 values 0 or 1]}
PIANO: {"type":"piano","ci":0,"x":100,"y":350,"w":460,"h":180,"wv":"triangle","det":3,"a":0.01,"d":0.3,"s":0.6,"r":0.4,"ff":5000,"fr":1,"vol":0.5,"oct":4,"sus":false}
BASS: {"type":"bass","ci":0,"x":100,"y":400,"w":420,"h":160,"vol":0.7,"oct":2,"mode":"sub"} modes: sub/saw/square/fm
MIXER: {"type":"mixer","ci":0,"x":700,"y":400,"w":500,"h":300}

=== MANDATORY CHECKLIST ===
Your output MUST include ALL of these:
1. A beat module on EACH channel (ci:0,1,2,3) with DIFFERENT patterns reflecting that section's energy
2. seq.mode:"chain" with a meaningful order array (at least 12 entries for a full track)
3. ts:32 on all sequenced modules with real variation in the second 16 steps
4. At least one chord module with a musically correct progression
5. At least one synth+note pair for melody
6. FX on at least the drum channel with reverb+compression enabled
7. Sidechain on the chord/pad channel synced to kick
8. Filter automation on at least one channel
9. A mixer module
10. Proper volume balance: kicks 0.85-0.95, snare 0.7-0.85, hats 0.5-0.7, bass 0.7-0.85, chords 0.3-0.5, lead 0.4-0.6
GENRE BPM: trap=140, lofi=82, house=124, drill=140, dnb=174, rnb=95, pop=118, reggaeton=96, afrobeats=108

Generate the project now based on the user's request.`;
    navigator.clipboard.writeText(P).then(()=>{
      status.textContent='AI prompt copied! Paste into any AI ‚úì';status.style.color='#a855f7';
      setTimeout(()=>{status.style.color='var(--dim)';status.textContent='Ready'},3000);
    }).catch(()=>{
      const ta=document.createElement('textarea');ta.value=P;ta.style.cssText='position:fixed;left:-9999px';
      document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);
      status.textContent='AI prompt copied! Paste into any AI ‚úì';status.style.color='#a855f7';
      setTimeout(()=>{status.style.color='var(--dim)';status.textContent='Ready'},3000);
    });
  }));
  aiRow.appendChild(mkB('üìã COPY PROJECT','#a855f7',()=>{
    const state=getState();state.name=nameIn.value||'project';
    const json=JSON.stringify(state);
    navigator.clipboard.writeText(json).then(()=>{
      status.textContent='Project JSON copied! Paste to AI for edits ‚úì';status.style.color='#a855f7';
      setTimeout(()=>{status.style.color='var(--dim)';status.textContent='Ready'},3000);
    }).catch(()=>{
      const ta=document.createElement('textarea');ta.value=json;ta.style.cssText='position:fixed;left:-9999px';
      document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);
      status.textContent='Project JSON copied!';status.style.color='#a855f7';
      setTimeout(()=>{status.style.color='var(--dim)';status.textContent='Ready'},3000);
    });
  }));
  bd.appendChild(aiRow);

  // AI paste-load
  const aiRow2=document.createElement('div');aiRow2.style.cssText='display:grid;grid-template-columns:1fr;gap:4px;padding:0 4px;margin-bottom:6px';
  aiRow2.appendChild(mkB('üì• PASTE AI RESPONSE','#a855f7',()=>{
    navigator.clipboard.readText().then(txt=>{
      // strip markdown fences if AI wrapped it
      txt=txt.replace(/^```(?:json)?\s*/,'').replace(/\s*```$/,'').trim();
      try{const state=JSON.parse(txt);
        if(!state.modules){status.textContent='Invalid JSON ‚Äî no modules found';status.style.color='#ef4444';return}
        if(state.name)nameIn.value=state.name;
        loadState(state);
        status.textContent='AI project loaded! ‚úì';status.style.color='#a855f7';
        setTimeout(()=>{status.style.color='var(--dim)';status.textContent='Ready'},2500);
      }catch(e){status.textContent='Parse error ‚Äî AI response not valid JSON';status.style.color='#ef4444'}
    }).catch(()=>{status.textContent='Clipboard access denied ‚Äî paste manually';status.style.color='#ef4444'});
  }));
  bd.appendChild(aiRow2);

  // module info
  const info=document.createElement('div');info.style.cssText='font-size:5px;color:var(--dim);text-align:center;padding:4px;opacity:.5';
  function updInfo(){info.textContent=mods.length+' modules \u2022 '+['beat','synth','fx','piano','bass','note','sample','tape','drum','chord','edit','inst'].filter(t=>mods.some(m=>m.type===t)).join(', ')}
  updInfo();const _ui=setInterval(updInfo,2000);
  bd.appendChild(info);

  m.destroy=()=>{clearInterval(_ui)};
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}

// === MIXER MODULE ===
let _mxUp=[];function updMx(){_mxUp.forEach(f=>f())}
function addMixer(){
  const id=mid++;
  const{el,bd,ct}=mkW('MIXER<span>.EXE</span>','Mix','var(--green)',20+(mods.length%4)*30,20+(mods.length%4)*20,720,320,0);
  el.id='m'+id;el.querySelector('.wsel').remove();el.querySelector('.wbadge').remove();
  const m={id,type:'mixer',el,ci:-1,ts:0,onStep:()=>{},clr:()=>{}};
  const strips=document.createElement('div');strips.className='mxchs';const els=[];
  for(let ci=0;ci<NCH;ci++){
    const s=document.createElement('div');s.className='mxch';
    s.innerHTML=`<div class="mxhd"><div class="mxdot" style="background:${CHR[ci]}"></div><span class="mxnm">CH ${ci+1}</span></div>`;
    const tr=document.createElement('div');tr.className='mxtr';
    const pb=document.createElement('button');pb.className='mxb';pb.innerHTML='&#9654;';pb.addEventListener('click',()=>togCh(ci));
    const sb=document.createElement('button');sb.className='mxb';sb.innerHTML='&#9632;';sb.addEventListener('click',()=>stopCh(ci));
    tr.append(pb,sb);s.appendChild(tr);
    const ctrl=document.createElement('div');ctrl.style='display:flex;flex-direction:column;gap:3px';
    const bR=document.createElement('div');bR.className='mxr';bR.innerHTML='<label>BPM</label>';
    const bI=document.createElement('input');bI.type='range';bI.min=40;bI.max=220;bI.value=chs[ci].bpm;
    const bV=document.createElement('span');bV.className='mxv';bV.style.color=CHR[ci];bV.textContent=chs[ci].bpm;
    bI.addEventListener('input',()=>{chs[ci].bpm=+bI.value;bV.textContent=bI.value});bR.append(bI,bV);
    const sR=document.createElement('div');sR.className='mxr';sR.innerHTML='<label>SW</label>';
    const sI=document.createElement('input');sI.type='range';sI.min=0;sI.max=80;sI.value=0;
    const sV=document.createElement('span');sV.className='mxv';sV.style.color=CHR[ci];sV.textContent='0';
    sI.addEventListener('input',()=>{chs[ci].sw=+sI.value;sV.textContent=sI.value});sR.append(sI,sV);
    const vR=document.createElement('div');vR.className='mxr';vR.innerHTML='<label>VOL</label>';
    const vI=document.createElement('input');vI.type='range';vI.min=0;vI.max=100;vI.value=75;
    const vV=document.createElement('span');vV.className='mxv';vV.style.color=CHR[ci];vV.textContent='75';
    vI.addEventListener('input',()=>{chs[ci].vol=+vI.value;if(chs[ci].g)chs[ci].g.gain.value=vI.value/100;vV.textContent=vI.value});vR.append(vI,vV);
    ctrl.append(bR,sR,vR);s.appendChild(ctrl);
    const ms=document.createElement('div');ms.className='mxms';
    const mb=document.createElement('button');mb.className='mxmb';mb.textContent='M';
    mb.addEventListener('click',()=>{chs[ci].mut=!chs[ci].mut;mb.classList.toggle('muted');applyChGains()});
    const sb2=document.createElement('button');sb2.className='mxmb';sb2.textContent='S';
    sb2.addEventListener('click',()=>{chs[ci].solo=!chs[ci].solo;sb2.classList.toggle('soloed');applyChGains()});
    ms.append(mb,sb2);s.appendChild(ms);strips.appendChild(s);els.push({pb,bI,bV});
  }
  bd.appendChild(strips);
  // === CHANNEL SEQUENCING SECTION ===
  const seqWrap=document.createElement('div');
  seqWrap.style.cssText='border-top:1px solid var(--border);padding:6px 8px;display:flex;flex-wrap:wrap;gap:6px;align-items:center';

  // Play All / Stop All
  const paBtn=document.createElement('button');paBtn.className='mxb';paBtn.style.cssText='font-size:8px;padding:2px 8px;height:22px;border-radius:3px;letter-spacing:.5px';
  paBtn.innerHTML='&#9654; ALL';
  paBtn.addEventListener('click',()=>playAll());
  const saBtn=document.createElement('button');saBtn.className='mxb';saBtn.style.cssText='font-size:8px;padding:2px 8px;height:22px;border-radius:3px';
  saBtn.innerHTML='&#9632; ALL';
  saBtn.addEventListener('click',()=>stopAll());
  seqWrap.append(paBtn,saBtn);

  // Separator
  const ss=document.createElement('div');ss.style.cssText='width:1px;height:18px;background:var(--border)';
  seqWrap.appendChild(ss);

  // Mode selector
  const modeLbl=document.createElement('span');modeLbl.style.cssText='font-size:6px;color:var(--dim);letter-spacing:1px;font-weight:700';modeLbl.textContent='SEQ:';
  seqWrap.appendChild(modeLbl);

  const modes=[
    {id:'all',label:'ALL',tip:'All channels play simultaneously'},
    {id:'chain',label:'CHAIN',tip:'Channels play in order, one at a time'},
    {id:'ab',label:'A/B',tip:'Alternate between two groups'},
    {id:'custom',label:'CUSTOM',tip:'Define exactly which channels play each step'}
  ];
  const modeBtns=[];
  modes.forEach(md=>{
    const b=document.createElement('button');b.className='mxmb';
    b.style.cssText='font-size:6px;font-weight:700;padding:2px 6px;border-radius:3px;cursor:pointer;letter-spacing:.3px;border:1px solid var(--border);background:var(--s2);color:var(--dim);transition:all .15s';
    b.textContent=md.label;b.title=md.tip;
    if(md.id===seqState.mode){b.style.borderColor=CHR[0];b.style.color=CHR[0];b.style.background='rgba(232,54,79,.1)'}
    b.addEventListener('click',()=>{
      seqState.mode=md.id;seqState.curIdx=0;seqState.barCount=0;seqState.stepInBar=0;
      modeBtns.forEach(x=>{x.style.borderColor='var(--border)';x.style.color='var(--dim)';x.style.background='var(--s2)'});
      b.style.borderColor=CHR[0];b.style.color=CHR[0];b.style.background='rgba(232,54,79,.1)';
      applySeqGains();updSeqUI();_seqUp.forEach(fn=>fn());
    });
    modeBtns.push(b);seqWrap.appendChild(b);
  });

  // Bars per channel
  const ss2=document.createElement('div');ss2.style.cssText='width:1px;height:18px;background:var(--border)';
  seqWrap.appendChild(ss2);
  const bpcLbl=document.createElement('span');bpcLbl.style.cssText='font-size:6px;color:var(--dim);letter-spacing:.5px;font-weight:700';bpcLbl.textContent='BARS:';
  const bpcIn=document.createElement('input');bpcIn.type='range';bpcIn.min=1;bpcIn.max=8;bpcIn.value=seqState.barsPerCh;
  bpcIn.style.cssText='width:50px;height:6px;accent-color:var(--accent)';
  const bpcV=document.createElement('span');bpcV.style.cssText='font-size:7px;color:'+CHR[0]+';font-weight:700;min-width:10px';bpcV.textContent=seqState.barsPerCh;
  bpcIn.addEventListener('input',()=>{seqState.barsPerCh=+bpcIn.value;bpcV.textContent=bpcIn.value});
  seqWrap.append(bpcLbl,bpcIn,bpcV);
  bd.appendChild(seqWrap);

  // Chain order / custom pattern editor
  const seqDetail=document.createElement('div');
  seqDetail.style.cssText='border-top:1px solid var(--border);padding:6px 8px;display:none;gap:4px;flex-direction:column';

  // Chain order row
  const orderRow=document.createElement('div');orderRow.style.cssText='display:flex;align-items:center;gap:4px;flex-wrap:wrap';
  const orderLbl=document.createElement('span');orderLbl.style.cssText='font-size:6px;color:var(--dim);letter-spacing:.5px;font-weight:700;width:38px';orderLbl.textContent='ORDER:';
  orderRow.appendChild(orderLbl);
  const orderBtns=[];
  function buildOrderUI(){
    orderRow.querySelectorAll('.sq-ord').forEach(e=>e.remove());
    seqState.order.forEach((ci,idx)=>{
      const b=document.createElement('button');b.className='sq-ord';
      b.style.cssText='font-size:7px;font-weight:800;padding:2px 6px;border-radius:3px;cursor:pointer;border:1px solid '+CHR[ci]+';color:'+CHR[ci]+';background:'+CHR[ci]+'18;min-width:20px;transition:all .12s';
      b.textContent='CH'+(ci+1);
      b.addEventListener('click',()=>{
        // Cycle to next channel
        seqState.order[idx]=(seqState.order[idx]+1)%4;
        buildOrderUI();
      });
      b.addEventListener('contextmenu',e=>{e.preventDefault();
        if(seqState.order.length>1){seqState.order.splice(idx,1);buildOrderUI()}
      });
      orderRow.appendChild(b);
    });
    // Add button
    const ab=document.createElement('button');ab.className='sq-ord';
    ab.style.cssText='font-size:8px;font-weight:700;padding:2px 6px;border-radius:3px;cursor:pointer;border:1px dashed var(--border);color:var(--dim);background:none';
    ab.textContent='+';ab.title='Add channel to sequence';
    ab.addEventListener('click',()=>{seqState.order.push(0);buildOrderUI()});
    orderRow.appendChild(ab);
  }
  buildOrderUI();
  seqDetail.appendChild(orderRow);

  // Custom pattern editor (grid of toggles)
  const custRow=document.createElement('div');custRow.style.cssText='display:none;flex-direction:column;gap:3px';
  const custLbl=document.createElement('span');custLbl.style.cssText='font-size:6px;color:var(--dim);letter-spacing:.5px;font-weight:700;margin-bottom:2px';custLbl.textContent='PATTERN STEPS (click to toggle channels per step):';
  custRow.appendChild(custLbl);
  const custGrid=document.createElement('div');custGrid.style.cssText='display:flex;gap:2px;flex-wrap:wrap';
  function buildCustUI(){
    custGrid.innerHTML='';
    seqState.customPattern.forEach((step,si)=>{
      const col=document.createElement('div');col.style.cssText='display:flex;flex-direction:column;gap:1px;align-items:center';
      const slbl=document.createElement('span');slbl.style.cssText='font-size:5px;color:var(--dim)';slbl.textContent=si+1;
      col.appendChild(slbl);
      for(let ci=0;ci<NCH;ci++){
        const b=document.createElement('button');
        const on=step.includes(ci);
        b.style.cssText='width:14px;height:10px;border-radius:2px;border:1px solid '+(on?CHR[ci]:CHR[ci]+'40')+';background:'+(on?CHR[ci]+'60':'transparent')+';cursor:pointer;transition:all .1s;padding:0';
        b.addEventListener('click',()=>{
          const idx=step.indexOf(ci);
          if(idx>=0)step.splice(idx,1);else step.push(ci);
          buildCustUI();
        });
        col.appendChild(b);
      }
      custGrid.appendChild(col);
    });
    // Add/remove step buttons
    const ctrl2=document.createElement('div');ctrl2.style.cssText='display:flex;flex-direction:column;gap:1px;align-items:center;justify-content:center';
    const addS=document.createElement('button');addS.style.cssText='font-size:7px;width:14px;height:10px;border:1px dashed var(--border);border-radius:2px;color:var(--dim);background:none;cursor:pointer;padding:0';
    addS.textContent='+';addS.addEventListener('click',()=>{seqState.customPattern.push([0]);buildCustUI()});
    const remS=document.createElement('button');remS.style.cssText='font-size:7px;width:14px;height:10px;border:1px dashed var(--border);border-radius:2px;color:var(--dim);background:none;cursor:pointer;padding:0';
    remS.textContent='‚àí';remS.addEventListener('click',()=>{if(seqState.customPattern.length>1){seqState.customPattern.pop();buildCustUI()}});
    ctrl2.append(addS,remS);custGrid.appendChild(ctrl2);
  }
  buildCustUI();
  custRow.appendChild(custGrid);
  seqDetail.appendChild(custRow);

  // Active indicator ‚Äî shows which channel is currently playing in sequence
  const seqInd=document.createElement('div');seqInd.style.cssText='display:flex;gap:3px;align-items:center;margin-top:2px';
  const indLbl=document.createElement('span');indLbl.style.cssText='font-size:6px;color:var(--dim);letter-spacing:.5px;font-weight:700;width:38px';indLbl.textContent='NOW:';
  seqInd.appendChild(indLbl);
  const indDots=[];
  for(let i=0;i<NCH;i++){
    const d=document.createElement('div');
    d.style.cssText='width:18px;height:12px;border-radius:2px;border:1px solid '+CHR[i]+';background:transparent;transition:all .15s;display:flex;align-items:center;justify-content:center;font-size:6px;font-weight:800;color:'+CHR[i];
    d.textContent=i+1;
    indDots.push(d);seqInd.appendChild(d);
  }
  seqDetail.appendChild(seqInd);

  function updSeqUI(){
    const show=seqState.mode!=='all';
    seqDetail.style.display=show?'flex':'none';
    orderRow.style.display=(seqState.mode==='chain'||seqState.mode==='ab')?'flex':'none';
    custRow.style.display=seqState.mode==='custom'?'flex':'none';
    // Update indicator dots
    for(let i=0;i<NCH;i++){
      const active=seqIsActive(i);
      indDots[i].style.background=active?CHR[i]+'40':'transparent';
      indDots[i].style.borderColor=active?CHR[i]:CHR[i]+'30';
      indDots[i].style.color=active?'#fff':CHR[i]+'40';
    }
  }
  updSeqUI();
  _seqUp.push(updSeqUI);
  bd.appendChild(seqDetail);

  const viz=document.createElement('div');viz.className='vizr';
  viz.innerHTML=`<div class="vizb"><span class="vizl">Wave</span><canvas id="wc${id}"></canvas></div><div class="vizb" style="max-width:130px"><span class="vizl">Spec</span><canvas id="sc${id}"></canvas></div>`;
  bd.appendChild(viz);
  const upFn=()=>{els.forEach((e,i)=>{e.pb.classList.toggle('playing',chs[i].on);e.pb.innerHTML=chs[i].on?'&#10074;&#10074;':'&#9654;';e.bI.value=chs[i].bpm;e.bV.textContent=chs[i].bpm});
    const anyOn=chs.some(c=>c.on);paBtn.classList.toggle('playing',anyOn);paBtn.innerHTML=anyOn?'&#10074;&#10074; ALL':'&#9654; ALL';
    updSeqUI()};
  _mxUp.push(upFn);
  m.destroy=()=>{const i=_mxUp.indexOf(upFn);if(i>=0)_mxUp.splice(i,1)};
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
  setTimeout(()=>{
    const wC=document.getElementById('wc'+id),sC=document.getElementById('sc'+id);if(!wC||!sC)return;
    const wX=wC.getContext('2d'),sX=sC.getContext('2d');
    const rs=()=>{wC.width=wC.parentElement.clientWidth;wC.height=wC.parentElement.clientHeight;sC.width=sC.parentElement.clientWidth;sC.height=sC.parentElement.clientHeight};
    rs();new ResizeObserver(rs).observe(wC.parentElement);
    (function draw(){if(!document.getElementById('m'+id))return;requestAnimationFrame(draw);
      // Skip render when collapsed or not visible
      const modEl=document.getElementById('m'+id);if(modEl&&(modEl.classList.contains('collapsed')||modEl.classList.contains('hidden')))return;
      const ap=chs.some(c=>c.on),wW=wC.width,wH=wC.height;wX.clearRect(0,0,wW,wH);
      if(anW&&ap){const b=new Uint8Array(anW.frequencyBinCount);anW.getByteTimeDomainData(b);wX.beginPath();wX.strokeStyle='rgba(232,54,79,.8)';wX.lineWidth=1.5;const sl=wW/b.length;let x=0;for(let i=0;i<b.length;i++){const y=(b[i]/128)*wH/2;i===0?wX.moveTo(x,y):wX.lineTo(x,y);x+=sl}wX.stroke()}
      const sW=sC.width,sH=sC.height;sX.clearRect(0,0,sW,sH);
      if(anF&&ap){const b=new Uint8Array(anF.frequencyBinCount);anF.getByteFrequencyData(b);const bw=sW/b.length;for(let i=0;i<b.length;i++){const v=b[i]/255;sX.fillStyle='hsla('+(i/b.length*40+340)+',70%,55%,'+(0.3+v*0.7)+')';sX.fillRect(i*bw,sH-v*sH,bw+.5,v*sH)}}
    })()},60);
}
function applyChGains(){const any=chs.some(c=>c.solo);chs.forEach(c=>{if(c.g){if(any)c.g.gain.value=(c.solo&&!c.mut)?c.vol/100:0;else c.g.gain.value=c.mut?0:c.vol/100}})}

// === MODULE MGMT ===
function rmMod(id){const i=mods.findIndex(m=>m.id===id);if(i<0)return;const m=mods[i];if(m.destroy)m.destroy();mods.splice(i,1);document.getElementById('m'+id)?.remove();_rebuildModIndex()}
document.getElementById('addBeat').addEventListener('click',()=>addBeat(aTab==='all'?0:+aTab));
document.getElementById('addSynth').addEventListener('click',()=>addSynth(aTab==='all'?0:+aTab));
document.getElementById('addPiano').addEventListener('click',()=>addPiano(aTab==='all'?0:+aTab));
document.getElementById('addBass').addEventListener('click',()=>addBass(aTab==='all'?0:+aTab));
document.getElementById('addNote').addEventListener('click',()=>addNote(aTab==='all'?0:+aTab));
document.getElementById('addSample').addEventListener('click',()=>addSample(aTab==='all'?0:+aTab));
document.getElementById('addTape').addEventListener('click',()=>addTape(aTab==='all'?0:+aTab));
document.getElementById('addDrum').addEventListener('click',()=>addDrum(aTab==='all'?0:+aTab));
document.getElementById('addChord').addEventListener('click',()=>addChord(aTab==='all'?0:+aTab));
document.getElementById('addInst').addEventListener('click',()=>addInst(aTab==='all'?0:+aTab));
document.getElementById('addSave').addEventListener('click',()=>addSave());
document.getElementById('addEdit').addEventListener('click',()=>addEdit(aTab==='all'?0:+aTab));
document.getElementById('addFx').addEventListener('click',()=>addFx(aTab==='all'?0:+aTab));
document.getElementById('addOsc').addEventListener('click',()=>addOsc(aTab==='all'?0:+aTab));
document.getElementById('addMixer').addEventListener('click',()=>addMixer());
document.getElementById('addMidi').addEventListener('click',()=>addMidi(aTab==='all'?0:+aTab));
document.getElementById('addBank').addEventListener('click',()=>addBank());
document.getElementById('addTracks').addEventListener('click',()=>addTracks(aTab==='all'?0:+aTab));
document.getElementById('addAuto').addEventListener('click',()=>addAuto(aTab==='all'?0:+aTab));
document.getElementById('addSidechain').addEventListener('click',()=>addSidechain(aTab==='all'?0:+aTab));
document.getElementById('addCollab').addEventListener('click',()=>addCollab());
document.getElementById('addLearn').addEventListener('click',()=>addLearn());

// === AUDIO CONTEXT RESUME ‚Äî prevent background suspension killing audio ===
document.addEventListener('visibilitychange',()=>{
  if(!document.hidden&&ctx&&ctx.state==='suspended'){ctx.resume().then(()=>console.log('[STUDIO] AudioContext resumed from visibility change'))}
});
window.addEventListener('focus',()=>{
  if(ctx&&ctx.state==='suspended'){ctx.resume().then(()=>console.log('[STUDIO] AudioContext resumed from focus'))}
});
// Also catch touch/click anywhere as a resume trigger (iOS requires user gesture)
document.addEventListener('touchstart',()=>{
  if(ctx&&ctx.state==='suspended')ctx.resume();
},{passive:true,once:false});
document.addEventListener('mousedown',()=>{
  if(ctx&&ctx.state==='suspended')ctx.resume();
},{once:false});

// === GLOBAL KEYS ===
window.addEventListener('keydown',e=>{if(e.repeat)return;if(e.code==='Space'&&_kb!==null){return}if(e.code==='Space'){e.preventDefault();const any=chs.some(c=>c.on);if(any)chs.forEach((c,i)=>{if(c.on)stopCh(i)});else startCh(0);return}if(e.code==='Escape'){chs.forEach((c,i)=>stopCh(i));return}});

// === RECORDER ‚Äî captures master output in real-time ===
let _rec={on:false,mr:null,dest:null,chunks:[],blob:null,url:null,startT:0,timer:null};
const recBtn=document.getElementById('recBtn'),dlBtn=document.getElementById('dlBtn'),recInd=document.getElementById('recInd'),recTime=document.getElementById('recTime');

recBtn.addEventListener('click',()=>{
  if(_rec.on){stopRec();return}
  initA();if(ctx.state==='suspended')ctx.resume();
  // create MediaStream from master output
  _rec.dest=ctx.createMediaStreamDestination();
  mGain.connect(_rec.dest);
  _rec.chunks=[];_rec.blob=null;if(_rec.url){URL.revokeObjectURL(_rec.url);_rec.url=null}
  dlBtn.style.display='none';
  _rec.mr=new MediaRecorder(_rec.dest.stream,{mimeType:'audio/webm;codecs=opus'});
  _rec.mr.ondataavailable=e=>{if(e.data.size>0)_rec.chunks.push(e.data)};
  _rec.mr.onstop=async()=>{
    mGain.disconnect(_rec.dest);
    _rec.blob=new Blob(_rec.chunks,{type:'audio/webm'});
    // convert to WAV for download
    const ab=await _rec.blob.arrayBuffer();
    const audioBuf=await ctx.decodeAudioData(ab);
    const wavBlob=bufToWav(audioBuf);
    _rec.url=URL.createObjectURL(wavBlob);
    dlBtn.style.display='';
  };
  _rec.mr.start(100);_rec.on=true;_rec.startT=Date.now();
  recBtn.style.background='#ef4444';recBtn.style.color='#fff';recBtn.textContent='‚ñ† STOP';
  recInd.style.display='flex';
  _rec.timer=setInterval(()=>{const s=Math.floor((Date.now()-_rec.startT)/1000);recTime.textContent=Math.floor(s/60)+':'+String(s%60).padStart(2,'0')},200);
});

function stopRec(){
  if(!_rec.on)return;_rec.on=false;
  _rec.mr.stop();clearInterval(_rec.timer);
  recBtn.style.background='';recBtn.style.color='#ef4444';recBtn.textContent='‚óè REC';
  recInd.style.display='none';recTime.textContent='0:00';
}

dlBtn.addEventListener('click',()=>{
  if(!_rec.url)return;
  const a=document.createElement('a');a.href=_rec.url;
  a.download='studio-'+new Date().toISOString().slice(0,19).replace(/[T:]/g,'-')+'.wav';
  a.click();
});

function bufToWav(audioBuf){
  const nc=audioBuf.numberOfChannels,sr=audioBuf.sampleRate,len=audioBuf.length;
  const ba=nc*2,dl=len*ba,tl=44+dl;
  const w=new ArrayBuffer(tl),v=new DataView(w);
  function ws(o,s){for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i))}
  ws(0,'RIFF');v.setUint32(4,tl-8,true);ws(8,'WAVE');ws(12,'fmt ');v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,nc,true);v.setUint32(24,sr,true);v.setUint32(28,sr*ba,true);v.setUint16(32,ba,true);v.setUint16(34,16,true);ws(36,'data');v.setUint32(40,dl,true);
  const cd=[];for(let c=0;c<nc;c++)cd.push(audioBuf.getChannelData(c));let o=44;
  for(let i=0;i<len;i++)for(let c=0;c<nc;c++){let s=Math.max(-1,Math.min(1,cd[c][i]));v.setInt16(o,s<0?s*0x8000:s*0x7FFF,true);o+=2}
  return new Blob([w],{type:'audio/wav'});
}

// === SETTINGS ===
document.getElementById('settingsBtn').addEventListener('click',()=>{
  const p=document.getElementById('settingsPanel');p.style.display=p.style.display==='none'?'flex':'none';
  document.getElementById('helpPanel').style.display='none'});
document.getElementById('helpBtn').addEventListener('click',()=>{
  const p=document.getElementById('helpPanel');p.style.display=p.style.display==='none'?'block':'none';
  document.getElementById('settingsPanel').style.display='none'});
document.getElementById('helpClose').addEventListener('click',()=>{document.getElementById('helpPanel').style.display='none'});
document.getElementById('settingsClose').addEventListener('click',()=>{document.getElementById('settingsPanel').style.display='none'});
document.addEventListener('click',e=>{const p=document.getElementById('settingsPanel');const h=document.getElementById('helpPanel');
  if(p.style.display!=='none'&&!p.contains(e.target)&&e.target.id!=='settingsBtn')p.style.display='none';
  if(h.style.display!=='none'&&!h.contains(e.target)&&e.target.id!=='helpBtn')h.style.display='none'});
const THEMES=[
  {name:'VOID',bg:'#08080c',surface:'#101015',s2:'#18181f',s3:'#202028',border:'#2a2a35',text:'#e0e0e8',dim:'#555568',dot:'rgba(255,255,255,.1)'},
  {name:'NEON BLEED',bg:'#0a0008',surface:'#14000f',s2:'#22001a',s3:'#330028',border:'#ff00aa30',text:'#ff88dd',dim:'#aa3388',dot:'rgba(255,0,170,.15)'},
  {name:'ACID',bg:'#020a00',surface:'#041400',s2:'#082200',s3:'#0c3300',border:'#00ff4430',text:'#00ff44',dim:'#009922',dot:'rgba(0,255,68,.15)'},
  {name:'BRUISE',bg:'#0c0418',surface:'#160828',s2:'#220e3e',s3:'#2e1454',border:'#8833ff40',text:'#c488ff',dim:'#7744bb',dot:'rgba(136,51,255,.15)'},
  {name:'RUST',bg:'#140800',surface:'#1e0e00',s2:'#2c1600',s3:'#3a1e00',border:'#ff660030',text:'#ff9944',dim:'#aa5500',dot:'rgba(255,102,0,.15)'},
  {name:'BLOOD',bg:'#140000',surface:'#200000',s2:'#300000',s3:'#440000',border:'#ff000030',text:'#ff4444',dim:'#aa2222',dot:'rgba(255,0,0,.15)'},
  {name:'ELECTRIC',bg:'#000814',surface:'#001028',s2:'#001a40',s3:'#002458',border:'#0088ff30',text:'#44bbff',dim:'#2266aa',dot:'rgba(0,136,255,.15)'},
  {name:'TOXIC',bg:'#0a0a00',surface:'#141400',s2:'#222200',s3:'#333300',border:'#ccff0030',text:'#ccff00',dim:'#88aa00',dot:'rgba(204,255,0,.15)'},
  {name:'STATIC',bg:'#0e0e0e',surface:'#1a1a1a',s2:'#262626',s3:'#333',border:'#ffffff18',text:'#fff',dim:'#888',dot:'rgba(255,255,255,.15)'},
  {name:'HEAT',bg:'#140004',surface:'#1e0008',s2:'#2c0010',s3:'#3e001a',border:'#ff224430',text:'#ff6688',dim:'#cc2244',dot:'rgba(255,34,68,.15)'},
  {name:'CYBER',bg:'#000a0c',surface:'#00141a',s2:'#001e28',s3:'#002836',border:'#00ffcc30',text:'#00ffcc',dim:'#00aa88',dot:'rgba(0,255,204,.15)'},
  {name:'GHOST',bg:'#0c0c10',surface:'#161620',s2:'#202030',s3:'#2a2a40',border:'#8888ff20',text:'#aaaadd',dim:'#5555aa',dot:'rgba(136,136,255,.15)'},
  {name:'CLEAN',bg:'#f5f5f7',surface:'#ffffff',s2:'#f0f0f2',s3:'#e8e8ec',border:'#d2d2d7',text:'#1d1d1f',dim:'#86868b',dot:'rgba(0,0,0,.06)'},
  {name:'SUNSET',bg:'#fff5eb',surface:'#fff9f2',s2:'#fff0e0',s3:'#ffe6cc',border:'#ffb366',text:'#5c2d00',dim:'#b8721a',dot:'rgba(255,120,0,.1)'},
  {name:'OCEAN',bg:'#eaf6ff',surface:'#f2faff',s2:'#ddf0ff',s3:'#c8e6ff',border:'#5cb8ff',text:'#003366',dim:'#3388bb',dot:'rgba(0,140,255,.1)'},
  {name:'MINT',bg:'#edfff6',surface:'#f5fff9',s2:'#e0fff0',s3:'#ccffe6',border:'#4dd99a',text:'#0a4d2e',dim:'#2d9960',dot:'rgba(0,200,100,.1)'},
  {name:'LAVENDER',bg:'#f3eeff',surface:'#f8f4ff',s2:'#ece4ff',s3:'#dfd4ff',border:'#a880ff',text:'#2e1860',dim:'#7755bb',dot:'rgba(130,80,255,.1)'},
  {name:'CORAL',bg:'#fff0f0',surface:'#fff6f5',s2:'#ffe6e4',s3:'#ffd6d2',border:'#ff7b72',text:'#5c1a15',dim:'#cc5550',dot:'rgba(255,100,90,.1)'},
  {name:'LEMON',bg:'#fffde6',surface:'#fffef2',s2:'#fff9cc',s3:'#fff5b3',border:'#e6c700',text:'#4a3d00',dim:'#b39b00',dot:'rgba(200,170,0,.12)'},
  {name:'SAKURA',bg:'#fff0f6',surface:'#fff5f9',s2:'#ffe4ef',s3:'#ffd4e5',border:'#ff6eb4',text:'#5c0a32',dim:'#cc4488',dot:'rgba(255,100,170,.1)'},
  {name:'SKY',bg:'#e8f8ff',surface:'#f0fbff',s2:'#d8f2ff',s3:'#c0eaff',border:'#00b4d8',text:'#003845',dim:'#0088a8',dot:'rgba(0,180,216,.1)'},
  // === VIVID / GRADIENT ===
  {name:'VAPORWAVE',bg:'#1a0030',surface:'#2a0848',s2:'#3a1060',s3:'#4c1878',border:'#ff71ce40',text:'#ff71ce',dim:'#b44e90',dot:'rgba(255,113,206,.12)'},
  {name:'MIAMI',bg:'#0d001a',surface:'#1a0033',s2:'#2d004d',s3:'#400066',border:'#00e5ff30',text:'#00e5ff',dim:'#ff6ec7',dot:'rgba(0,229,255,.12)'},
  {name:'SUNSET BLVD',bg:'#1a0a00',surface:'#2d1200',s2:'#401c00',s3:'#552800',border:'#ff6b3540',text:'#ffaa44',dim:'#ff6b35',dot:'rgba(255,107,53,.12)'},
  {name:'AURORA',bg:'#000c14',surface:'#001420',s2:'#002030',s3:'#003040',border:'#00ff8830',text:'#00ff88',dim:'#4488ff',dot:'rgba(0,255,136,.1)'},
  {name:'BUBBLEGUM',bg:'#ffe0f0',surface:'#fff0f8',s2:'#ffd0e8',s3:'#ffc0dd',border:'#ff69b4',text:'#880044',dim:'#cc3388',dot:'rgba(255,105,180,.12)'},
  {name:'SLIME',bg:'#0a1a00',surface:'#142800',s2:'#1e3800',s3:'#284a00',border:'#88ff0030',text:'#88ff00',dim:'#55aa00',dot:'rgba(136,255,0,.12)'},
  {name:'PEACH',bg:'#fff0e8',surface:'#fff6f0',s2:'#ffe8d8',s3:'#ffdcc8',border:'#ff9966',text:'#5c2a10',dim:'#cc6633',dot:'rgba(255,153,102,.1)'},
  {name:'DEEP PURPLE',bg:'#0a0014',surface:'#140028',s2:'#1e003c',s3:'#280050',border:'#aa44ff40',text:'#cc88ff',dim:'#8844cc',dot:'rgba(170,68,255,.12)'},
  {name:'GOLDBAR',bg:'#1a1400',surface:'#2a2000',s2:'#3a2e00',s3:'#4a3c00',border:'#ffd70040',text:'#ffd700',dim:'#aa8800',dot:'rgba(255,215,0,.15)'},
  {name:'COTTON CANDY',bg:'#f0e8ff',surface:'#f8f0ff',s2:'#e8deff',s3:'#ddd0ff',border:'#bb88ff',text:'#4400aa',dim:'#8855cc',dot:'rgba(187,136,255,.1)'},
  {name:'NEON MINT',bg:'#001a10',surface:'#002a1a',s2:'#003c28',s3:'#004e36',border:'#00ffaa30',text:'#00ffaa',dim:'#00aa66',dot:'rgba(0,255,170,.12)'},
  {name:'HOT PINK',bg:'#1a000e',surface:'#2d001a',s2:'#400028',s3:'#550038',border:'#ff008840',text:'#ff4499',dim:'#cc2266',dot:'rgba(255,0,136,.12)'},
  {name:'ICE',bg:'#e8f4ff',surface:'#f0f8ff',s2:'#dceeff',s3:'#c8e4ff',border:'#88bbee',text:'#1a3a5c',dim:'#5588aa',dot:'rgba(100,160,220,.08)'},
  // === REAL-WORLD THEMED ===
  {name:'WAREHOUSE',bg:'#1c1a18',surface:'#262320',s2:'#302c28',s3:'#3a3530',border:'#5a504540',text:'#d4c8b8',dim:'#8a7e6e',dot:'rgba(180,160,130,.08)'},
  {name:'CONSTRUCT',bg:'#2a2000',surface:'#3a2c00',s2:'#4a3800',s3:'#5a4400',border:'#ffaa0050',text:'#ffcc00',dim:'#cc8800',dot:'rgba(255,170,0,.12)'},
  {name:'BUNKER',bg:'#0c0e0c',surface:'#161a16',s2:'#202620',s3:'#2a322a',border:'#44553830',text:'#88aa77',dim:'#557744',dot:'rgba(100,140,80,.1)'},
  {name:'FACTORY',bg:'#14120f',surface:'#1e1c18',s2:'#2a2822',s3:'#36342c',border:'#ff880030',text:'#ee8833',dim:'#aa6622',dot:'rgba(255,136,0,.1)'},
  {name:'DARKROOM',bg:'#0e0000',surface:'#1a0404',s2:'#260808',s3:'#320c0c',border:'#ff000015',text:'#ff3333',dim:'#881818',dot:'rgba(255,0,0,.06)'},
  {name:'SUBMARINE',bg:'#000e14',surface:'#001820',s2:'#00222e',s3:'#002c3c',border:'#22aacc30',text:'#44ccdd',dim:'#227788',dot:'rgba(34,170,204,.1)'},
  {name:'CONCRETE',bg:'#d8d4d0',surface:'#e4e0dc',s2:'#ccc8c4',s3:'#c0bcb8',border:'#a8a4a0',text:'#3a3836',dim:'#787470',dot:'rgba(0,0,0,.05)'},
  {name:'BLUEPRINT',bg:'#0a1e3a',surface:'#122a4a',s2:'#1a365a',s3:'#22426a',border:'#4488cc40',text:'#88ccff',dim:'#4488bb',dot:'rgba(136,204,255,.08)'},
  {name:'CAMPFIRE',bg:'#1a0e04',surface:'#281808',s2:'#36220e',s3:'#442c14',border:'#ff660030',text:'#ff9944',dim:'#cc6622',dot:'rgba(255,102,0,.1)'},
  {name:'JUNGLE',bg:'#040e04',surface:'#081a08',s2:'#0e260e',s3:'#143214',border:'#22cc4430',text:'#44ee66',dim:'#228844',dot:'rgba(34,204,68,.1)'},
  {name:'TERMINAL',bg:'#000000',surface:'#0a0a0a',s2:'#141414',s3:'#1e1e1e',border:'#00ff0018',text:'#00ff00',dim:'#008800',dot:'rgba(0,255,0,.06)'},
  {name:'SANDSTORM',bg:'#f0e4c8',surface:'#f8ecd4',s2:'#e8d8b8',s3:'#dccca8',border:'#c4a86e',text:'#4a3818',dim:'#9a8050',dot:'rgba(160,120,40,.08)'},
  {name:'GARAGE',bg:'#161616',surface:'#202020',s2:'#2a2a2a',s3:'#343434',border:'#e8364f25',text:'#d0d0d0',dim:'#707070',dot:'rgba(232,54,79,.06)'},
  {name:'STUDIO B',bg:'#12101a',surface:'#1c1828',s2:'#262236',s3:'#302c44',border:'#6644aa30',text:'#bb99ee',dim:'#7755aa',dot:'rgba(102,68,170,.1)'},
  // === ANTI BLUE LIGHT ===
  {name:'WARM NIGHT',bg:'#1a1410',surface:'#231c16',s2:'#2c241e',s3:'#362e26',border:'#443a3040',text:'#d4c8b0',dim:'#8a7e66',dot:'rgba(180,150,100,.06)'},
  {name:'CANDLELIGHT',bg:'#1c1608',surface:'#28200e',s2:'#342a16',s3:'#40341e',border:'#50402840',text:'#e8d8b4',dim:'#9a8860',dot:'rgba(200,170,80,.06)'},
  {name:'SEPIA',bg:'#2a2018',surface:'#362a20',s2:'#423428',s3:'#4e3e30',border:'#5e4c3c40',text:'#dccca8',dim:'#9a886a',dot:'rgba(180,150,100,.06)'},
  {name:'CAMPFIRE+',bg:'#1a1008',surface:'#281a0e',s2:'#382414',s3:'#48301c',border:'#5c3e2640',text:'#e8d0a8',dim:'#987850',dot:'rgba(200,140,60,.08)'},
  {name:'PARCHMENT',bg:'#f0e8d8',surface:'#e6dcc8',s2:'#dcd0b8',s3:'#d0c4a8',border:'#c0b49440',text:'#3a3020',dim:'#7a6e54',dot:'rgba(80,60,30,.05)'},
  {name:'AMBER',bg:'#181008',surface:'#241a0c',s2:'#302410',s3:'#3e2e18',border:'#503c2240',text:'#f0d898',dim:'#a08440',dot:'rgba(220,180,60,.06)'},
  {name:'EMBER+',bg:'#1a0e08',surface:'#261610',s2:'#321e18',s3:'#3e2820',border:'#543a2c40',text:'#e4c4a0',dim:'#946c48',dot:'rgba(200,130,70,.06)'},
];
const tg=document.getElementById('themeGrid');
THEMES.forEach(t=>{const b=document.createElement('button');
  b.style.cssText=`width:100%;height:26px;border-radius:4px;border:2px solid ${t.border};cursor:pointer;background:linear-gradient(135deg,${t.bg},${t.surface});position:relative;transition:all .15s`;
  const l=document.createElement('span');l.style.cssText='font-size:5px;color:'+t.text+';font-weight:700;letter-spacing:.5px';l.textContent=t.name;
  b.appendChild(l);
  b.addEventListener('click',()=>{applyTheme(t);tg.querySelectorAll('button').forEach(x=>x.style.borderColor=THEMES.find(th=>th.name===x.textContent)?.border||'var(--border)');b.style.borderColor='#fff'});
  tg.appendChild(b)});
function applyTheme(t){const r=document.documentElement.style;
  r.setProperty('--bg',t.bg);r.setProperty('--surface',t.surface);r.setProperty('--s2',t.s2);r.setProperty('--s3',t.s3);
  r.setProperty('--border',t.border);r.setProperty('--text',t.text);r.setProperty('--dim',t.dim);
  document.getElementById('wsI').style.backgroundImage=`radial-gradient(circle,${t.dot} 1px,transparent 1px)`}
// dot style
const dg=document.getElementById('dotGrid');
[{name:'Dots',v:'radial-gradient(circle,var(--dot,rgba(255,255,255,.1)) 1px,transparent 1px)'},{name:'Lines',v:'repeating-linear-gradient(90deg,var(--dot,rgba(255,255,255,.08)) 0 1px,transparent 1px 24px)'},{name:'Cross',v:'repeating-linear-gradient(90deg,var(--dot,rgba(255,255,255,.07)) 0 1px,transparent 1px 24px),repeating-linear-gradient(0deg,var(--dot,rgba(255,255,255,.07)) 0 1px,transparent 1px 24px)'},{name:'None',v:'none'}].forEach(d=>{
  const b=document.createElement('button');b.className='pbtn';b.style.fontSize='5px';b.textContent=d.name;
  b.addEventListener('click',()=>{document.getElementById('wsI').style.backgroundImage=d.v});dg.appendChild(b)});
// accent colors
const ag=document.getElementById('accentGrid');
// workspace bg color
document.getElementById('wsBgColor').addEventListener('input',e=>{
  document.getElementById('wsI').style.backgroundColor=e.target.value;
  document.getElementById('workspace').style.backgroundColor=e.target.value});
const wsBgP=document.getElementById('wsBgPresets');
['#0a0a0f','#000000','#0a1628','#0a150e','#180a0a','#10081a','#1a0a0a','#0c1418',
 '#1a1020','#0e0800','#001010','#080016','#101010','#0d0d00','#000a0d','#100008'].forEach(c=>{
  const b=document.createElement('button');
  b.style.cssText='width:100%;height:14px;border-radius:2px;border:1px solid rgba(255,255,255,.1);cursor:pointer;background:'+c;
  b.addEventListener('click',()=>{document.getElementById('wsI').style.backgroundColor=c;document.getElementById('workspace').style.backgroundColor=c;document.getElementById('wsBgColor').value=c});
  wsBgP.appendChild(b)});
['#e8364f','#f97316','#fbbf24','#10b981','#22d3ee','#3b82f6','#8b5cf6','#ec4899','#06b6d4','#f43f5e'].forEach(c=>{
  const b=document.createElement('button');b.style.cssText=`width:100%;height:18px;border-radius:3px;border:2px solid transparent;cursor:pointer;background:${c};transition:all .15s`;
  b.addEventListener('click',()=>{document.documentElement.style.setProperty('--accent',c);
    ag.querySelectorAll('button').forEach(x=>x.style.borderColor='transparent');b.style.borderColor='#fff'});ag.appendChild(b)});

document.getElementById('resetStudio').addEventListener('click',()=>{
  if(!confirm('Reset studio? All modules and patterns will be cleared.'))return;
  // stop all channels
  chs.forEach((ch,i)=>{ch.on=false;ch.step=0});
  // destroy all modules
  while(mods.length){const m=mods.pop();if(m.destroy)m.destroy();if(m.el&&m.el.parentNode)m.el.parentNode.removeChild(m.el)}
  mid=0;
  // reset theme
  applyTheme(THEMES[0]);
  document.documentElement.style.setProperty('--accent','#e8364f');
  document.getElementById('wsI').style.backgroundImage='radial-gradient(circle,rgba(255,255,255,.04) 1px,transparent 1px)';
  // close settings
  document.getElementById('settingsPanel').style.display='none';
  // spawn defaults
  addBeat(0);addMixer();
});

// === AUTOMATE.EXE ‚Äî parameter automation curves ===
function addAuto(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('AUTO<span>.EXE</span>','Automate','#f59e0b',100+(mods.length%4)*30,60+(mods.length%4)*20,600,300,ci);
  el.id='m'+id;
  const PARAMS=[
    {name:'Volume',key:'vol',min:0,max:100,def:75,unit:'%'},
    {name:'LP Filter',key:'flt',min:20,max:20000,def:20000,unit:'Hz'},
    {name:'HP Filter',key:'hpf',min:20,max:20000,def:20,unit:'Hz'},
    {name:'Pan',key:'pan',min:-100,max:100,def:0,unit:''},
    {name:'Swing',key:'sw',min:0,max:100,def:0,unit:'%'},
    {name:'Send FX',key:'send',min:0,max:100,def:0,unit:'%'},
  ];
  const m={id,type:'auto',el,ci,ts:0,curves:{},activeParam:'vol',playing:false,
    onStep:(s,t)=>{const cs=m.curves[m.activeParam]?m.curves[m.activeParam].length:32;applyCurves(s%cs)},clr:()=>{}};
  m.dst=()=>chs[m.ci].g||mGain;
  // init flat curves
  PARAMS.forEach(p=>{m.curves[p.key]=new Array(32).fill(p.def)});
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});
  // config bar
  const cfg=document.createElement('div');cfg.style.cssText='display:flex;gap:3px;align-items:center;padding:0 0 4px;flex-wrap:wrap';
  const pSel=document.createElement('select');pSel.style.cssText='background:var(--s2);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:7px;font-weight:700;padding:2px 4px;border-radius:3px;cursor:pointer;outline:none';
  PARAMS.forEach(p=>{const o=document.createElement('option');o.value=p.key;o.textContent=p.name;pSel.appendChild(o)});
  pSel.addEventListener('change',()=>{m.activeParam=pSel.value;drawCurve()});
  const stSel=document.createElement('select');stSel.style.cssText='background:var(--s2);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:6px;font-weight:700;padding:2px 4px;border-radius:3px;cursor:pointer;outline:none';
  [16,32,64].forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v+' steps';if(v===32)o.selected=true;stSel.appendChild(o)});
  stSel.addEventListener('change',()=>{const ns=+stSel.value;PARAMS.forEach(p=>{const old=m.curves[p.key];const nw=new Array(ns);
    for(let i=0;i<ns;i++){const oi=i*old.length/ns;const lo=Math.floor(oi);const hi=Math.min(lo+1,old.length-1);const f=oi-lo;nw[i]=old[lo]*(1-f)+old[hi]*f}
    m.curves[p.key]=nw});m.ts=ns;drawCurve()});
  // shape buttons
  function mkSh(txt,title,fn){const b=document.createElement('button');b.className='pbtn';b.style.fontSize='5px';b.textContent=txt;b.title=title;b.addEventListener('click',fn);return b}
  const flatBtn=mkSh('‚Äî','Flat',()=>{const p=PARAMS.find(x=>x.key===m.activeParam);m.curves[m.activeParam].fill(p.def);drawCurve();applyNow()});
  const rampUp=mkSh('‚Üó','Ramp up',()=>{const p=PARAMS.find(x=>x.key===m.activeParam);const c=m.curves[m.activeParam];for(let i=0;i<c.length;i++)c[i]=p.min+(p.max-p.min)*(i/(c.length-1));drawCurve();applyNow()});
  const rampDn=mkSh('‚Üò','Ramp down',()=>{const p=PARAMS.find(x=>x.key===m.activeParam);const c=m.curves[m.activeParam];for(let i=0;i<c.length;i++)c[i]=p.max-(p.max-p.min)*(i/(c.length-1));drawCurve();applyNow()});
  const sineBtn=mkSh('‚àø','Sine LFO',()=>{const p=PARAMS.find(x=>x.key===m.activeParam);const c=m.curves[m.activeParam];for(let i=0;i<c.length;i++)c[i]=p.def+(p.max-p.def)*Math.sin(i/c.length*Math.PI*4);drawCurve();applyNow()});
  const randBtn=mkSh('‚öÑ','Random',()=>{const p=PARAMS.find(x=>x.key===m.activeParam);const c=m.curves[m.activeParam];for(let i=0;i<c.length;i++)c[i]=p.min+Math.random()*(p.max-p.min);drawCurve();applyNow()});
  cfg.append(pSel,stSel,flatBtn,rampUp,rampDn,sineBtn,randBtn);
  bd.appendChild(cfg);
  // canvas
  const cvs=document.createElement('canvas');cvs.style.cssText='width:100%;flex:1;background:var(--s2);border:1px solid var(--border);border-radius:4px;cursor:crosshair;min-height:80px;touch-action:none;-webkit-touch-callout:none';
  bd.appendChild(cvs);bd.style.display='flex';bd.style.flexDirection='column';
  // value readout
  const readout=document.createElement('div');readout.style.cssText='font-size:6px;color:var(--dim);font-weight:700;padding:2px 0 0;min-height:10px';
  bd.appendChild(readout);
  // draw
  function drawCurve(){
    const c=cvs.getContext('2d');const W=cvs.width=cvs.clientWidth*2;const H=cvs.height=cvs.clientHeight*2;
    c.clearRect(0,0,W,H);
    const p=PARAMS.find(x=>x.key===m.activeParam);const curve=m.curves[m.activeParam];const steps=curve.length;
    const sw=W/steps;
    // grid lines
    c.strokeStyle='rgba(245,158,11,.06)';c.lineWidth=1;
    for(let i=0;i<=steps;i+=4){c.beginPath();c.moveTo(i*sw,0);c.lineTo(i*sw,H);c.stroke()}
    for(let i=0;i<=4;i++){c.beginPath();c.moveTo(0,i*H/4);c.lineTo(W,i*H/4);c.stroke()}
    // fill
    c.beginPath();c.moveTo(0,H);
    for(let i=0;i<steps;i++){const v=(curve[i]-p.min)/(p.max-p.min);const y=H-(v*H);const x=steps>1?i/(steps-1)*W:W/2;c.lineTo(x,y)}
    c.lineTo(W,H);c.closePath();c.fillStyle='rgba(245,158,11,.12)';c.fill();
    // line
    c.beginPath();c.strokeStyle='#f59e0b';c.lineWidth=2;
    for(let i=0;i<steps;i++){const v=(curve[i]-p.min)/(p.max-p.min);const y=H-(v*H);const x=steps>1?i/(steps-1)*W:W/2;
      if(i===0)c.moveTo(x,y);else c.lineTo(x,y)}
    c.stroke();
    // dots
    for(let i=0;i<steps;i++){const v=(curve[i]-p.min)/(p.max-p.min);const y=H-(v*H);const x=steps>1?i/(steps-1)*W:W/2;
      c.beginPath();c.arc(x,y,3,0,Math.PI*2);c.fillStyle='#f59e0b';c.fill()}
    // current step
    const ch=chs[m.ci];if(ch&&ch.on&&ch.step>=0){const ms=chMax(m.ci)||16;
      const pct=ch.step/(ms-1);const px=pct*W;const bw=W/steps;
      c.fillStyle='rgba(245,158,11,.15)';c.fillRect(px-bw/2,0,bw,H);
      c.fillStyle='#f59e0b';c.fillRect(px,0,2,H)}
  }
  // mouse draw
  let drawing=false;
  function getStepVal(e){
    const rect=cvs.getBoundingClientRect();const x=(e.clientX-rect.left)/rect.width;const y=1-(e.clientY-rect.top)/rect.height;
    const p=PARAMS.find(x=>x.key===m.activeParam);const step=Math.floor(x*m.curves[m.activeParam].length);
    const val=Math.max(p.min,Math.min(p.max,p.min+y*(p.max-p.min)));
    return{step:Math.max(0,Math.min(step,m.curves[m.activeParam].length-1)),val}
  }
  function setPoint(e){const{step,val}=getStepVal(e);const p=PARAMS.find(x=>x.key===m.activeParam);
    m.curves[m.activeParam][step]=Math.round(val*100)/100;drawCurve();
    readout.textContent='Step '+(step+1)+': '+Math.round(val)+' '+p.unit;
    applyNow()}
  cvs.addEventListener('mousedown',e=>{drawing=true;setPoint(e)});
  cvs.addEventListener('mousemove',e=>{if(drawing)setPoint(e);else{const{step,val}=getStepVal(e);const p=PARAMS.find(x=>x.key===m.activeParam);readout.textContent='Step '+(step+1)+': '+Math.round(m.curves[m.activeParam][step])+' '+p.unit}});
  window.addEventListener('mouseup',()=>{drawing=false});
  // Touch draw ‚Äî same as OSC: direct draw, lock scroll
  cvs.addEventListener('touchstart',e=>{e.preventDefault();e.stopPropagation();drawing=true;lockWsScroll();
    const wb=cvs.closest('.wbody');if(wb){wb.style.overflow='hidden';wb.style.touchAction='none'}
    setPoint(e.touches[0]);},{passive:false});
  cvs.addEventListener('touchmove',e=>{e.preventDefault();e.stopPropagation();if(drawing)setPoint(e.touches[0]);},{passive:false});
  cvs.addEventListener('touchend',e=>{e.preventDefault();e.stopPropagation();
    const wb=cvs.closest('.wbody');if(wb){wb.style.overflow='auto';wb.style.touchAction=''}
    unlockWsScroll();drawing=false;},{passive:false});
  // apply curves to channel in real-time
  function ensureChain(){
    if(!ctx)return false;const ch=chs[m.ci];if(!ch||!ch.g)return false;
    if(!m._autoNodes){
      m._autoNodes={};
      m._autoNodes.lpf=ctx.createBiquadFilter();m._autoNodes.lpf.type='lowpass';m._autoNodes.lpf.frequency.value=20000;m._autoNodes.lpf.Q.value=3;
      m._autoNodes.hpf=ctx.createBiquadFilter();m._autoNodes.hpf.type='highpass';m._autoNodes.hpf.frequency.value=20;m._autoNodes.hpf.Q.value=1;
      m._autoNodes.pan=ctx.createStereoPanner();
      m._autoNodes.gain=ctx.createGain();
      // chain: lpf ‚Üí hpf ‚Üí pan ‚Üí gain ‚Üí mGain
      m._autoNodes.lpf.connect(m._autoNodes.hpf);
      m._autoNodes.hpf.connect(m._autoNodes.pan);
      m._autoNodes.pan.connect(m._autoNodes.gain);
      m._autoNodes.gain.connect(mGain);
      // Insert between scDuck and mGain (actual routing: ch.g ‚Üí ch.scDuck ‚Üí mGain)
      // Check for FX limiter first
      const fx=mods.find(x=>x.type==='fx'&&x.ci===m.ci&&x._nd&&x._nd.ok);
      if(fx&&fx._nd.limiter){
        // FX routing: ch.scDuck ‚Üí fx chain ‚Üí limiter ‚Üí mGain
        try{fx._nd.limiter.disconnect(mGain)}catch(e){}
        fx._nd.limiter.connect(m._autoNodes.lpf);
        m._autoNodes._src=fx._nd.limiter;
      }else{
        // Normal routing: ch.scDuck ‚Üí mGain
        try{ch.scDuck.disconnect(mGain)}catch(e){}
        ch.scDuck.connect(m._autoNodes.lpf);
        m._autoNodes._src=ch.scDuck;
      }
    }
    return true;
  }
  function applyCurves(step){
    if(!ensureChain())return;
    const now=ctx.currentTime;
    const len=m.curves.vol?m.curves.vol.length:32;const s=((step%len)+len)%len;
    // Volume
    const vc=m.curves.vol;if(vc)m._autoNodes.gain.gain.setTargetAtTime(vc[s]/100,now,.02);
    // LP Filter
    const fc=m.curves.flt;if(fc)m._autoNodes.lpf.frequency.setTargetAtTime(Math.max(20,Math.min(20000,fc[s])),now,.02);
    // HP Filter
    const hc=m.curves.hpf;if(hc)m._autoNodes.hpf.frequency.setTargetAtTime(Math.max(20,Math.min(20000,hc[s])),now,.02);
    // Pan
    const pc=m.curves.pan;if(pc)m._autoNodes.pan.pan.setTargetAtTime(pc[s]/100,now,.02);
    // Swing
    const swc=m.curves.sw;if(swc)chs[m.ci].sw=swc[s];
    // Send FX ‚Äî control reverb/delay wet
    const snc=m.curves.send;if(snc){
      mods.forEach(x=>{if(x.type==='fx'&&x.ci===m.ci&&x._nd){
        if(x._nd.rvG)x._nd.rvG.gain.setTargetAtTime(snc[s]/100,now,.02);
        if(x._nd.dlG)x._nd.dlG.gain.setTargetAtTime(snc[s]/100,now,.02)}})}
  }
  // Apply current param at step 0 immediately when user draws
  function applyNow(){
    if(!ensureChain())return;
    const now=ctx.currentTime;const p=m.activeParam;const curve=m.curves[p];if(!curve||!curve.length)return;
    // Apply all steps' average or first step ‚Äî just use step 0 for immediate feedback
    const v=curve[0];
    if(p==='vol')m._autoNodes.gain.gain.setTargetAtTime(v/100,now,.02);
    if(p==='flt')m._autoNodes.lpf.frequency.setTargetAtTime(Math.max(20,Math.min(20000,v)),now,.02);
    if(p==='hpf')m._autoNodes.hpf.frequency.setTargetAtTime(Math.max(20,Math.min(20000,v)),now,.02);
    if(p==='pan')m._autoNodes.pan.pan.setTargetAtTime(v/100,now,.02);
  }
  // cleanup
  m.destroy=()=>{
    if(m._autoNodes){
      // Restore original routing
      if(m._autoNodes._src){
        try{m._autoNodes._src.disconnect(m._autoNodes.lpf)}catch(e){}
        m._autoNodes._src.connect(mGain);
      }
      [m._autoNodes.lpf,m._autoNodes.hpf,m._autoNodes.pan,m._autoNodes.gain].forEach(n=>{try{if(n)n.disconnect()}catch(e){}});
      m._autoNodes=null;
    }
  };
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  // lightweight rAF for visual only ‚Äî throttled
  let lastDraw=0;
  requestAnimationFrame(function loop(){if(!document.getElementById('m'+id))return;
    const now=performance.now();if(now-lastDraw>100){lastDraw=now;drawCurve()}
    requestAnimationFrame(loop)});
  wsI.appendChild(el);mods.push(m);filt();
}

// === SIDECHAIN.EXE ‚Äî rhythmic ducking ===
function addSidechain(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('SIDE<span>.EXE</span>','Sidechain','#f43f5e',300+(mods.length%4)*30,200+(mods.length%4)*20,460,260,ci);
  el.id='m'+id;
  const SC='#f43f5e';
  const m={id,type:'sidechain',el,ci,ts:16,depth:.8,attack:5,release:120,pattern:new Array(16).fill(0),
    onStep:()=>{},clr:()=>{}};
  m.dst=()=>chs[m.ci].g||mGain;
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});
  for(let i=0;i<16;i+=4)m.pattern[i]=1;

  // Info
  const info=document.createElement('div');info.style.cssText='font-size:6px;color:var(--dim);line-height:1.5;padding:3px 6px;background:var(--s2);border:1px solid var(--border);border-radius:3px;margin-bottom:3px';
  info.innerHTML='<b style="color:'+SC+'">SIDECHAIN</b> ducks this channel\'s volume on each red step. <b style="color:var(--text)">Setup:</b> Synth/pad on this channel, beat on a different channel. Pattern should match your kick hits.';
  bd.appendChild(info);

  // Controls
  const cRow=document.createElement('div');cRow.style.cssText='display:flex;gap:6px;align-items:center;padding:0 0 3px;flex-wrap:wrap';
  function mkK(label,min,max,val,unit,fn){
    const w=document.createElement('div');w.style.cssText='display:flex;flex-direction:column;align-items:center;gap:1px';
    const lb=document.createElement('label');lb.style.cssText='font-size:5px;color:var(--dim);font-weight:700';lb.textContent=label;
    const inp=document.createElement('input');inp.type='range';inp.min=min;inp.max=max;inp.value=val;
    inp.style.cssText='width:50px;height:4px;-webkit-appearance:none;appearance:none;background:var(--s3);border-radius:2px;outline:none;cursor:pointer';
    const vd=document.createElement('div');vd.style.cssText='font-size:6px;color:var(--text);font-weight:700';vd.textContent=val+unit;
    inp.addEventListener('input',()=>{vd.textContent=inp.value+unit;fn(+inp.value)});
    w.append(lb,inp,vd);return w;
  }
  cRow.append(mkK('DEPTH',0,100,80,'%',v=>{m.depth=v/100}),mkK('ATK',1,50,5,'ms',v=>{m.attack=v}),mkK('REL',10,500,120,'ms',v=>{m.release=v}));
  // Step count
  const stW=document.createElement('div');stW.style.cssText='display:flex;flex-direction:column;align-items:center;gap:1px';
  const stLb=document.createElement('label');stLb.style.cssText='font-size:5px;color:var(--dim);font-weight:700';stLb.textContent='STEPS';
  const stBtns=document.createElement('div');stBtns.style.cssText='display:flex;gap:1px';
  [8,16,32,64].forEach(n=>{
    const b=document.createElement('button');b.className='pbtn';b.style.cssText='font-size:5px;padding:1px 4px';b.textContent=n;
    if(n===16)b.classList.add('active');
    b.addEventListener('click',()=>{
      const old=m.pattern;const np=new Array(n).fill(0);
      for(let i=0;i<Math.min(old.length,n);i++)np[i]=old[i];
      m.pattern=np;m.ts=n;
      stBtns.querySelectorAll('.pbtn').forEach(x=>x.classList.remove('active'));b.classList.add('active');
      buildGrid();
    });stBtns.appendChild(b)});
  stW.append(stLb,stBtns);cRow.append(stW);
  // Presets (adapt to current step count)
  const preW=document.createElement('div');preW.style.cssText='display:flex;gap:2px;flex-wrap:wrap';
  [{n:'4/4',fn:()=>{const p=new Array(m.ts).fill(0);for(let i=0;i<m.ts;i+=m.ts/4)p[Math.floor(i)]=1;return p}},
   {n:'Pump',fn:()=>{const p=new Array(m.ts).fill(0);for(let i=0;i<m.ts;i+=m.ts/2)p[Math.floor(i)]=1;return p}},
   {n:'Fast',fn:()=>{const p=new Array(m.ts).fill(0);for(let i=0;i<m.ts;i+=2)p[i]=1;return p}},
   {n:'Half',fn:()=>{const p=new Array(m.ts).fill(0);p[0]=1;return p}},
   {n:'All',fn:()=>new Array(m.ts).fill(1)},
   {n:'Clear',fn:()=>new Array(m.ts).fill(0)}].forEach(pr=>{
    const b=document.createElement('button');b.className='pbtn';b.style.fontSize='5px';b.textContent=pr.n;
    b.addEventListener('click',()=>{m.pattern=pr.fn();buildGrid()});preW.appendChild(b)});
  cRow.append(preW);bd.appendChild(cRow);

  // Step grid
  const gridWrap=document.createElement('div');gridWrap.style.cssText='display:flex;gap:1px;padding:3px 0';
  function buildGrid(){
    gridWrap.innerHTML='';
    const beatEvery=Math.max(1,Math.floor(m.pattern.length/4));
    m.pattern.forEach((v,i)=>{
      const s=document.createElement('div');
      s.style.cssText='flex:1;height:26px;min-width:3px;background:'+(v?SC:'var(--s2)')+';border:1px solid '+(v?SC:'var(--border)')+';border-radius:2px;cursor:pointer;transition:background .08s;display:flex;align-items:flex-end;justify-content:center';
      if(i%beatEvery===0){const mk=document.createElement('span');mk.style.cssText='font-size:4px;color:'+(v?'rgba(255,255,255,.6)':'var(--dim)');mk.textContent=(i/beatEvery+1);s.appendChild(mk)}
      s.addEventListener('click',()=>{m.pattern[i]=m.pattern[i]?0:1;buildGrid()});
      gridWrap.appendChild(s)});
  }
  buildGrid();bd.appendChild(gridWrap);

  // VU canvas ‚Äî smooth, no jitter
  const vuC=document.createElement('canvas');vuC.width=400;vuC.height=10;
  vuC.style.cssText='width:100%;height:8px;border-radius:3px;margin-top:2px';
  bd.appendChild(vuC);
  const vuCtx=vuC.getContext('2d');
  let vuVal=0;
  function drawVU(){
    vuCtx.clearRect(0,0,400,10);
    vuCtx.fillStyle='var(--s2)';vuCtx.fillRect(0,0,400,10);
    if(vuVal>0.01){
      vuCtx.fillStyle=SC;vuCtx.fillRect(0,0,400*vuVal,10);
    }
    vuVal*=0.9; // smooth decay
    _vuRaf=requestAnimationFrame(drawVU);
  }
  let _vuRaf=requestAnimationFrame(drawVU);

  // === DUCKING ‚Äî uses ch.scDuck.gain ===
  // ch.g -> ch.scDuck -> mGain (set up in initA)
  // FX chain also routes through ch.scDuck via _out
  // Nobody else touches ch.scDuck.gain, so no conflicts
  function duck(){
    initA();if(!ctx)return;
    const sd=chs[m.ci].scDuck;if(!sd)return;
    const now=ctx.currentTime;
    const atk=Math.max(m.attack/1000,0.003);
    const rel=m.release/1000;
    sd.gain.cancelScheduledValues(now);
    // Use exponential approach for smooth click-free ducking
    sd.gain.setTargetAtTime(1-m.depth,now,atk/3);
    // Schedule return to 1 after attack period
    sd.gain.setTargetAtTime(1,now+atk,rel/3);
    vuVal=m.depth;
  }
  function releaseDuck(){
    if(!ctx)return;
    const sd=chs[m.ci].scDuck;if(!sd)return;
    sd.gain.cancelScheduledValues(ctx.currentTime);
    sd.gain.setValueAtTime(1,ctx.currentTime);
    vuVal=0;
  }

  m.onStep=(s,t)=>{
    if(s<m.pattern.length&&m.pattern[s])duck();
    const cells=gridWrap.children;
    for(let i=0;i<cells.length;i++){
      cells[i].style.boxShadow=i===s?'inset 0 0 0 2px rgba(255,255,255,.5)':'none';
    }
  };
  m.clr=()=>{releaseDuck()};
  m.destroy=()=>{
    cancelAnimationFrame(_vuRaf);
    releaseDuck();
  };
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}


// === COLLAB.EXE ‚Äî export/import module configs ===
function addCollab(){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('COLLAB<span>.EXE</span>','Share','#8b5cf6',200+(mods.length%4)*30,80+(mods.length%4)*20,440,320,-1);
  el.id='m'+id;el.style.zIndex=200;
  const m={id,type:'collab',el,ci:-1,ts:0,onStep:()=>{},clr:()=>{}};
  // header
  const info=document.createElement('div');info.style.cssText='font-size:6px;color:var(--dim);line-height:1.5;margin-bottom:6px';
  info.textContent='Export individual modules as shareable snippets. Import snippets from collaborators.';
  bd.appendChild(info);
  // export section
  const expLbl=document.createElement('div');expLbl.style.cssText='font-size:6px;font-weight:800;color:#8b5cf6;letter-spacing:.5px;margin-bottom:4px';expLbl.textContent='EXPORT';
  bd.appendChild(expLbl);
  const modList=document.createElement('div');modList.style.cssText='display:flex;flex-wrap:wrap;gap:3px;margin-bottom:6px;max-height:90px;overflow-y:auto';
  function refreshList(){
    modList.innerHTML='';
    mods.forEach(mod=>{
      if(mod.type==='collab'||mod.type==='mixer'||mod.type==='bank')return;
      const b=document.createElement('button');b.className='pbtn';
      b.style.cssText='font-size:6px;padding:3px 6px;display:flex;align-items:center;gap:3px';
      const dot=document.createElement('span');dot.style.cssText='width:5px;height:5px;border-radius:50%;background:'+CHR[mod.ci];
      const nm=document.createElement('span');nm.textContent=mod.type.toUpperCase()+(mod.ci>=0?' CH'+(mod.ci+1):'');
      b.append(dot,nm);
      b.addEventListener('click',()=>exportMod(mod));
      modList.appendChild(b)});
  }
  refreshList();
  bd.appendChild(modList);
  const refreshBtn=document.createElement('button');refreshBtn.className='pbtn';refreshBtn.style.cssText='font-size:5px;margin-bottom:8px';
  refreshBtn.textContent='‚Üª Refresh list';refreshBtn.addEventListener('click',refreshList);
  bd.appendChild(refreshBtn);
  // export area
  const expArea=document.createElement('textarea');expArea.style.cssText='width:100%;height:50px;background:var(--s2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:monospace;font-size:5px;padding:4px;resize:none;outline:none;margin-bottom:6px';
  expArea.placeholder='Click a module above to export its config...';expArea.readOnly=true;
  bd.appendChild(expArea);
  const copyBtn=document.createElement('button');copyBtn.className='pbtn';copyBtn.style.cssText='font-size:6px;margin-bottom:8px;border-color:#8b5cf660;color:#8b5cf6';
  copyBtn.textContent='üìã Copy to clipboard';
  copyBtn.addEventListener('click',()=>{if(!expArea.value)return;navigator.clipboard.writeText(expArea.value).then(()=>{copyBtn.textContent='‚úì Copied!';setTimeout(()=>{copyBtn.textContent='üìã Copy to clipboard'},1500)})});
  bd.appendChild(copyBtn);
  // import section
  const impLbl=document.createElement('div');impLbl.style.cssText='font-size:6px;font-weight:800;color:#8b5cf6;letter-spacing:.5px;margin-bottom:4px;border-top:1px solid var(--border);padding-top:6px';impLbl.textContent='IMPORT';
  bd.appendChild(impLbl);
  const impArea=document.createElement('textarea');impArea.style.cssText='width:100%;height:50px;background:var(--s2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:monospace;font-size:5px;padding:4px;resize:none;outline:none;margin-bottom:4px';
  impArea.placeholder='Paste a module snippet here...';
  bd.appendChild(impArea);
  const impBtn=document.createElement('button');impBtn.className='pbtn';impBtn.style.cssText='font-size:6px;border-color:#8b5cf660;color:#8b5cf6;font-weight:800';
  impBtn.textContent='‚¨á Import module';
  impBtn.addEventListener('click',()=>{importMod(impArea.value)});
  bd.appendChild(impBtn);
  const statusEl=document.createElement('div');statusEl.style.cssText='font-size:6px;color:var(--dim);padding-top:2px;min-height:12px';
  bd.appendChild(statusEl);
  // export function ‚Äî reuses save serialization
  function exportMod(mod){
    const d={type:mod.type,ci:mod.ci,_collab:1,_v:1};
    switch(mod.type){
      case 'beat':d.ts=mod.ts;d.cm=mod.cm;d.ch=mod.ch.map(c=>({n:c.n,name:c.name,t:c.t,s:c.s,c:c.c,v:c.v,mut:c.mut,solo:c.solo,steps:[...c.steps]}));break;
      case 'synth':case 'piano':['wv','det','a','d','s','r','ff','fr','vol','oct'].forEach(k=>{if(mod[k]!==undefined)d[k]=mod[k]});if(mod.sus!==undefined)d.sus=mod.sus;break;
      case 'bass':d.vol=mod.vol;d.oct=mod.oct;d.mode=mod.mode;break;
      case 'note':d.ts=mod.ts;d.oct=mod.oct;d.wv=mod.wv;d.vol=mod.vol;d.inst=mod.inst;
        ['a','d','s','r','ff','fr','det'].forEach(k=>{if(mod[k]!==undefined)d[k]=mod[k]});
        d.cells=[];if(mod.grid)mod.grid.forEach((row,ri)=>row.forEach((v,ci)=>{if(v)d.cells.push([ri,ci])}));break;
      case 'drum':d.ts=mod.ts;
        d.parts=mod.parts.map(p=>({name:p.name,cat:p.cat,col:p.col,v:p.v,pitch:p.pitch,decay:p.decay,
          tone:p.tone,drive:p.drive,body:p.body,pan:p.pan,prob:p.prob,hum:p.hum,swing:p.swing,
          mut:p.mut,solo:p.solo,snd:p.snd}));
        if(mod.getPats){d.pats=mod.getPats().map(p=>({steps:p.steps,grid:p.grid.map(r=>[...r])}))}break;
      case 'chord':d.ts=mod.ts;d.oct=mod.oct;d.vol=mod.vol;d.wv=mod.wv;d.det=mod.det;
        ['a','d','s','r'].forEach(k=>{if(mod[k]!==undefined)d[k]=mod[k]});
        d.slots=mod.slots.map(s=>({root:s.root,type:s.type}));if(mod.stepsPerChord)d.stepsPerChord=mod.stepsPerChord;break;
      case 'fx':d.sliders=[];mod.el.querySelectorAll('input[type=range]').forEach(s=>{d.sliders.push(+s.value)});
        d.toggles=[];mod.el.querySelectorAll('.fxsw').forEach(s=>{d.toggles.push(s.classList.contains('on'))});break;
      case 'inst':['iIdx','i2Idx','oct','vol','detune','chord','bend','rvbMix','dlMix','dlTime'].forEach(k=>{if(mod[k]!==undefined)d[k]=mod[k]});break;
      case 'osc':['wv','oct','vol','det','a','d','s','r','ff','fr','useCustom'].forEach(k=>{if(mod[k]!==undefined)d[k]=mod[k]});
        d.custom=[...mod.custom];d.harmonics=[...mod.harmonics];break;
      case 'auto':d.ts=mod.ts;d.activeParam=mod.activeParam;d.curves={};Object.keys(mod.curves).forEach(k=>d.curves[k]=[...mod.curves[k]]);break;
      case 'sidechain':d.depth=mod.depth;d.attack=mod.attack;d.release=mod.release;d.pattern=[...mod.pattern];break;
    }
    const mt=mod.el.getAttribute('data-mod-theme');if(mt)d.modTheme=mt;
    const json=JSON.stringify(d);
    expArea.value=json;statusEl.textContent='‚úì Exported '+mod.type.toUpperCase()+' ('+json.length+' bytes)';statusEl.style.color='#10b981';
    setTimeout(()=>{statusEl.style.color='var(--dim)'},2000);
  }
  // import function
  function importMod(str){
    try{
      const d=JSON.parse(str.trim());
      if(!d.type||!d._collab){statusEl.textContent='‚úó Invalid snippet ‚Äî not a Collab export';statusEl.style.color='#ef4444';return}
      const adders={beat:addBeat,synth:addSynth,fx:addFx,piano:addPiano,bass:addBass,
        note:addNote,drum:addDrum,chord:addChord,inst:addInst,osc:addOsc,auto:addAuto,sidechain:addSidechain};
      const fn=adders[d.type];if(!fn){statusEl.textContent='‚úó Unknown module type: '+d.type;statusEl.style.color='#ef4444';return}
      fn(d.ci||0);
      const mod=mods[mods.length-1];if(!mod){statusEl.textContent='‚úó Failed to create module';statusEl.style.color='#ef4444';return}
      // restore state ‚Äî reuse loadState logic
      switch(d.type){
        case 'beat':if(d.ch&&mod.ch){d.ch.forEach((c,i)=>{if(mod.ch[i]){
            ['n','name','t','s','c','v','mut','solo'].forEach(k=>{if(c[k]!==undefined)mod.ch[i][k]=c[k]});
            if(c.steps)c.steps.forEach((s,si)=>{mod.ch[i].steps[si]=s})}});
          if(d.ts)mod.ts=d.ts;if(d.cm)mod.cm=d.cm;
          const gEl=mod.el.querySelector('.wbody');if(gEl&&typeof buildBG==='function')buildBG(mod,gEl)}break;
        case 'synth':case 'piano':['wv','det','a','d','s','r','ff','fr','vol','oct','sus'].forEach(k=>{if(d[k]!==undefined)mod[k]=d[k]});
          {const sls=mod.el.querySelectorAll('.sk');
           sls.forEach(sl=>{const lb=sl.querySelector('label');const inp=sl.querySelector('input');const vd=sl.querySelector('.kv');
             if(!lb||!inp)return;const n=lb.textContent.toLowerCase();
             const map={det:mod.det,oct:mod.oct,a:mod.a*100,d:mod.d*100,s:mod.s*100,r:mod.r*100,
               freq:mod.ff,res:mod.fr,vol:mod.vol*100,atk:(mod.a||.01)*1000,rel:(mod.r||.3)*100};
             for(const[k,v]of Object.entries(map)){if(n.startsWith(k)){inp.value=v;if(vd)vd.textContent=Math.round(v);break}}});
           const wsel=mod.el.querySelector('.wsel');if(wsel&&d.wv)wsel.value=d.wv}
          break;
        case 'bass':if(d.vol!==undefined)mod.vol=d.vol;if(d.oct!==undefined)mod.oct=d.oct;if(d.mode!==undefined)mod.mode=d.mode;
          {const sls=mod.el.querySelectorAll('.sk');
           sls.forEach(sl=>{const lb=sl.querySelector('label');const inp=sl.querySelector('input');const vd=sl.querySelector('.kv');
             if(!lb||!inp)return;const n=lb.textContent.toLowerCase();
             const map={oct:mod.oct,vol:mod.vol*100};
             for(const[k,v]of Object.entries(map)){if(n.startsWith(k)){inp.value=v;if(vd)vd.textContent=Math.round(v);break}}});
           // sync mode buttons
           mod.el.querySelectorAll('.pbtn,.stog button').forEach(b=>{
             if(b.textContent.toLowerCase()===mod.mode)b.click&&b.click()})}
          break;
        case 'note':['ts','oct','wv','vol','a','d','s','r','ff','fr','det','inst'].forEach(k=>{if(d[k]!==undefined)mod[k]=d[k]});
          // clear grid first, then set imported cells
          if(mod.grid)mod.grid.forEach(r=>r.fill(false));
          if(d.cells&&mod.grid){
            // expand grid if needed
            if(d.ts&&d.ts>mod.grid[0].length)mod.grid.forEach(r=>{while(r.length<d.ts)r.push(false)});
            d.cells.forEach(([r,c])=>{if(mod.grid[r])mod.grid[r][c]=true})}
          if(mod.buildNR)mod.buildNR();
          {const sls=mod.el.querySelectorAll('.sk');
           sls.forEach(sl=>{const lb=sl.querySelector('label');const inp=sl.querySelector('input');const vd=sl.querySelector('.kv');
             if(!lb||!inp)return;const n=lb.textContent.toLowerCase();
             const map={oct:mod.oct,vol:mod.vol*100,det:mod.det,a:mod.a*100,d:mod.d*100,s:mod.s*100,r:mod.r*100,freq:mod.ff,res:mod.fr};
             for(const[k,v]of Object.entries(map)){if(n.startsWith(k)){inp.value=v;if(vd)vd.textContent=Math.round(v);break}}});
           const wbtns=mod.el.querySelectorAll('.swb');wbtns.forEach(b=>{b.classList.toggle('active',
             (mod.wv==='sawtooth'&&b.textContent==='SAW')||(mod.wv==='square'&&b.textContent==='SQU')||
             (mod.wv==='triangle'&&b.textContent==='TRI')||(mod.wv==='sine'&&b.textContent==='SIN'))});
           const isel=mod.el.querySelector('select');if(isel&&d.inst)isel.value=d.inst}
          break;
        case 'drum':if(d.parts&&mod.parts){d.parts.forEach((p,i)=>{if(mod.parts[i]){
            ['name','cat','col','v','pitch','decay','tone','drive','body','pan','prob','hum','swing','mut','solo','snd'].forEach(k=>{
              if(p[k]!==undefined)mod.parts[i][k]=p[k]})}})}
          if(d.pats&&mod.setPats)mod.setPats(d.pats);
          if(mod.buildGrid)mod.buildGrid();break;
        case 'chord':['ts','oct','vol','wv','det','a','d','s','r'].forEach(k=>{if(d[k]!==undefined)mod[k]=d[k]});
          if(d.stepsPerChord)mod.stepsPerChord=d.stepsPerChord;
          if(d.slots){mod.slots=d.slots.map(s=>({root:s.root,type:s.type}));
            mod.ts=mod.slots.length*mod.stepsPerChord;
            if(mod.renSlots)mod.renSlots()}
          {const sls=mod.el.querySelectorAll('.sk');
           sls.forEach(sl=>{const lb=sl.querySelector('label');const inp=sl.querySelector('input');const vd=sl.querySelector('.kv');
             if(!lb||!inp)return;const n=lb.textContent.toLowerCase();
             const map={oct:mod.oct,vol:mod.vol*100,det:mod.det,a:mod.a*100,d:mod.d*100,s:mod.s*100,r:mod.r*100};
             for(const[k,v]of Object.entries(map)){if(n.startsWith(k)){inp.value=v;if(vd)vd.textContent=Math.round(v);break}}});
           const wbtns=mod.el.querySelectorAll('.swb');wbtns.forEach(b=>{b.classList.toggle('active',
             (d.wv==='sawtooth'&&b.textContent==='SAW')||(d.wv==='square'&&b.textContent==='SQU')||
             (d.wv==='triangle'&&b.textContent==='TRI')||(d.wv==='sine'&&b.textContent==='SIN'))});
           // sync steps per chord buttons
           mod.el.querySelectorAll('.stog button, .pbtn').forEach(b=>{
             if(['2','4','8','16'].includes(b.textContent)&&mod.stepsPerChord==+b.textContent)b.classList.add('active')})}
          break;
        case 'fx':
          if(d.sliders){const sls=mod.el.querySelectorAll('input[type=range]');
            d.sliders.forEach((v,i)=>{if(sls[i]){sls[i].value=v;sls[i].dispatchEvent(new Event('input',{bubbles:true}))}})}
          if(d.toggles){const ts=mod.el.querySelectorAll('.fxsw');
            d.toggles.forEach((on,i)=>{if(ts[i]){
              const isOn=ts[i].classList.contains('on');
              if(on&&!isOn)ts[i].click();
              else if(!on&&isOn)ts[i].click()}})}
          // re-dispatch slider values after toggles to ensure updFx picks them up
          if(d.sliders){const sls=mod.el.querySelectorAll('input[type=range]');
            d.sliders.forEach((v,i)=>{if(sls[i]){sls[i].value=v;sls[i].dispatchEvent(new Event('input',{bubbles:true}))}})}
          break;
        case 'inst':['iIdx','i2Idx','oct','vol','detune','chord','bend','rvbMix','dlMix','dlTime'].forEach(k=>{if(d[k]!==undefined)mod[k]=d[k]});
          {const sls=mod.el.querySelectorAll('.sk');
           sls.forEach(sl=>{const lb=sl.querySelector('label');const inp=sl.querySelector('input');const vd=sl.querySelector('.kv');
             if(!lb||!inp)return;const n=lb.textContent.toLowerCase();
             const map={oct:mod.oct,vol:mod.vol*100,det:mod.detune||0};
             for(const[k,v]of Object.entries(map)){if(n.startsWith(k)){inp.value=v;if(vd)vd.textContent=Math.round(v);break}}});
           // sync instrument selectors
           const sels=mod.el.querySelectorAll('select');
           if(sels[0]&&mod.iIdx!==undefined)sels[0].selectedIndex=mod.iIdx;
           if(sels[1]&&mod.i2Idx!==undefined)sels[1].selectedIndex=mod.i2Idx}
          break;
        case 'osc':['wv','oct','vol','det','a','d','s','r','ff','fr','useCustom'].forEach(k=>{if(d[k]!==undefined)mod[k]=d[k]});
          if(d.custom)for(let i=0;i<d.custom.length&&i<mod.custom.length;i++)mod.custom[i]=d.custom[i];
          if(d.harmonics)d.harmonics.forEach((v,i)=>{if(i<mod.harmonics.length)mod.harmonics[i]=v});
          {const sls=mod.el.querySelectorAll('.sk');
           sls.forEach(sl=>{const lb=sl.querySelector('label');const inp=sl.querySelector('input');const vd=sl.querySelector('.kv');
             if(!lb||!inp)return;const n=lb.textContent.toLowerCase();
             const map={oct:mod.oct,vol:mod.vol*100,det:mod.det,a:mod.a*100,d:mod.d*100,s:mod.s*100,r:mod.r*100,freq:mod.ff,res:mod.fr};
             for(const[k,v]of Object.entries(map)){if(n.startsWith(k)){inp.value=v;if(vd)vd.textContent=Math.round(v);break}}});
           const wsel=mod.el.querySelector('.wsel');if(wsel&&d.wv)wsel.value=d.wv}
          break;
        case 'auto':if(d.activeParam)mod.activeParam=d.activeParam;
          if(d.curves)Object.keys(d.curves).forEach(k=>{mod.curves[k]=d.curves[k]});
          {const pSel=mod.el.querySelector('select');if(pSel&&d.activeParam)pSel.value=d.activeParam}
          break;
        case 'sidechain':if(d.depth!==undefined)mod.depth=d.depth;if(d.attack)mod.attack=d.attack;
          if(d.release)mod.release=d.release;if(d.pattern){mod.pattern=d.pattern;
            // rebuild sidechain grid
            const gridW=mod.el.querySelector('div[style*="gap:1px"]');
            if(gridW){gridW.innerHTML='';mod.pattern.forEach((v,i)=>{
              const s=document.createElement('div');
              s.style.cssText='flex:1;height:28px;background:'+(v?'#f43f5e':'var(--s2)')+';border:1px solid '+(v?'#f43f5e':'var(--border)')+';border-radius:3px;cursor:pointer;transition:all .08s';
              s.addEventListener('click',()=>{mod.pattern[i]=mod.pattern[i]?0:1;s.style.background=mod.pattern[i]?'#f43f5e':'var(--s2)';s.style.borderColor=mod.pattern[i]?'#f43f5e':'var(--border)'});
              gridW.appendChild(s)})}}
          break;
      }
      if(d.modTheme){const t=typeof THEMES!=='undefined'&&THEMES.find(th=>th.name===d.modTheme);if(t){
        mod.el.style.setProperty('--bg',t.bg);mod.el.style.setProperty('--surface',t.surface);mod.el.style.setProperty('--s2',t.s2);mod.el.style.setProperty('--s3',t.s3);
        mod.el.style.setProperty('--border',t.border);mod.el.style.setProperty('--text',t.text);mod.el.style.setProperty('--dim',t.dim);mod.el.setAttribute('data-mod-theme',d.modTheme)}}
      statusEl.textContent='‚úì Imported '+d.type.toUpperCase()+' to CH'+(d.ci+1);statusEl.style.color='#10b981';
      refreshList();
    }catch(e){statusEl.textContent='‚úó Parse error: '+e.message;statusEl.style.color='#ef4444'}
    setTimeout(()=>{statusEl.style.color='var(--dim)'},3000);
  }
  m.destroy=()=>{};
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}

// === LEARN MODULE ‚Äî interactive music production lessons ===
function addLearn(){
  const id=mid++;
  // Start large ‚Äî near full viewport
  const ws=document.getElementById('workspace');
  const vw=Math.min(ws.clientWidth-40,900),vh=Math.min(ws.clientHeight-20,700);
  const{el,bd,sel,bdg,ct}=mkW('LEARN<span>.EXE</span>','Lessons','#14b8a6',60+(mods.length%4)*30,40+(mods.length%4)*20,vw,vh,-1);
  el.id='m'+id;el.style.minWidth='340px';
  // Maximize button
  let _maximized=false,_prevRect=null;
  const maxBtn=document.createElement('button');maxBtn.className='wb';maxBtn.title='Maximize';maxBtn.textContent='\u25a1';maxBtn.style.cssText+='font-size:10px;line-height:1';
  ct.insertBefore(maxBtn,ct.querySelector('.min'));
  function toggleMax(){
    const ws=document.getElementById('workspace');
    if(_maximized){
      el.style.left=_prevRect.l+'px';el.style.top=_prevRect.t+'px';el.style.width=_prevRect.w+'px';el.style.height=_prevRect.h+'px';
      maxBtn.textContent='\u25a1';_maximized=false;
    }else{
      _prevRect={l:el.offsetLeft,t:el.offsetTop,w:el.offsetWidth,h:el.offsetHeight};
      el.style.left=ws.scrollLeft+'px';el.style.top=ws.scrollTop+'px';
      el.style.width=ws.clientWidth+'px';el.style.height=ws.clientHeight+'px';
      maxBtn.textContent='\u25a3';_maximized=true;
    }
  }
  maxBtn.addEventListener('click',e=>{e.stopPropagation();toggleMax()});
  // Double-click titlebar to maximize
  el.querySelector('.wh').addEventListener('dblclick',e=>{if(!e.target.closest('.wb')&&!e.target.closest('.wsel'))toggleMax()});
  const m={id,type:'learn',el,ci:-1,ts:0,onStep:()=>{},clr:()=>{}};
  const LC='#14b8a6';
  bd.style.overflow='hidden';bd.style.display='flex';bd.style.flexDirection='column';
  let _demoIntervals=[];

  // Dynamic scale ‚Äî content zooms proportionally with window size
  function updScale(){
    const w=el.offsetWidth;
    const z=Math.max(1,Math.min(2.8,w/380));
    nav.style.zoom=z;content.style.zoom=z;
  }
  const _resObs=new ResizeObserver(updScale);_resObs.observe(el);

  function aud(){if(!ctx)initA();return ctx}
  function mf(n){return 440*Math.pow(2,(n-69)/12)}
  function playTone(freq,dur,wv,vol,dest){const c=aud();if(!c)return;const d=dest||mGain;const o=c.createOscillator(),g=c.createGain();o.type=wv||'sawtooth';o.frequency.value=freq;g.gain.setValueAtTime(vol||.15,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+dur);o.connect(g);g.connect(d);o.start(c.currentTime);o.stop(c.currentTime+dur+.05)}
  function playKick(t,vol){const c=aud();const o=c.createOscillator(),g=c.createGain();o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(30,t+.15);g.gain.setValueAtTime(vol||.4,t);g.gain.exponentialRampToValueAtTime(.001,t+.3);o.connect(g);g.connect(mGain);o.start(t);o.stop(t+.35)}
  function playSnare(t,vol){const c=aud();const len=.15;const buf=c.createBuffer(1,c.sampleRate*len,c.sampleRate);const d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,2);const s=c.createBufferSource(),g=c.createGain();s.buffer=buf;g.gain.setValueAtTime(vol||.25,t);g.gain.exponentialRampToValueAtTime(.001,t+len);s.connect(g);g.connect(mGain);s.start(t)}
  function playHH(t,vol){const c=aud();const len=.06;const buf=c.createBuffer(1,c.sampleRate*len,c.sampleRate);const d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,3);const s=c.createBufferSource(),g=c.createGain(),f=c.createBiquadFilter();f.type='highpass';f.frequency.value=7000;s.buffer=buf;g.gain.setValueAtTime(vol||.12,t);g.gain.exponentialRampToValueAtTime(.001,t+len);s.connect(f);f.connect(g);g.connect(mGain);s.start(t)}

  // DEMO: Step grid
  function mkBeatDemo(kickPat,snarePat,hhPat,bpm){
    const wrap=document.createElement('div');wrap.style.cssText='background:var(--s3);border:1px solid var(--border);border-radius:4px;padding:6px;margin:6px 0';
    const steps=16,spd=60/bpm/4;let playing=false,timer=null,step=0;
    const grid={kick:kickPat.slice(),snare:snarePat.slice(),hh:hhPat.slice()};
    const rows=[{name:'KICK',color:'#e8364f',key:'kick'},{name:'SNARE',color:'#22d3ee',key:'snare'},{name:'HH',color:'#a855f7',key:'hh'}];
    const cellEls={};
    const hdr=document.createElement('div');hdr.style.cssText='display:flex;align-items:center;gap:6px;margin-bottom:4px';
    const playBtn=document.createElement('button');playBtn.style.cssText='background:'+LC+';border:none;color:#fff;font-family:inherit;font-size:7px;font-weight:800;padding:4px 12px;border-radius:3px;cursor:pointer';playBtn.textContent='\u25b6 PLAY';
    const bpmLbl=document.createElement('span');bpmLbl.style.cssText='font-size:6px;color:var(--dim);font-weight:700';bpmLbl.textContent=bpm+' BPM';
    hdr.append(playBtn,bpmLbl);wrap.appendChild(hdr);
    rows.forEach(r=>{
      const row=document.createElement('div');row.style.cssText='display:flex;align-items:center;gap:1px;margin-bottom:1px';
      const lbl=document.createElement('div');lbl.style.cssText='font-size:5px;font-weight:800;color:'+r.color+';width:30px';lbl.textContent=r.name;
      row.appendChild(lbl);cellEls[r.key]=[];
      for(let i=0;i<steps;i++){const cell=document.createElement('div');cell.style.cssText='flex:1;height:16px;border:1px solid var(--border);border-radius:1px;cursor:pointer;transition:background .06s;'+(i%4===0?'border-left-color:var(--dim);':'');
        if(grid[r.key][i])cell.style.background=r.color;
        cell.addEventListener('click',()=>{grid[r.key][i]=grid[r.key][i]?0:1;cell.style.background=grid[r.key][i]?r.color:''});
        cell.addEventListener('touchstart',e=>{e.preventDefault();grid[r.key][i]=grid[r.key][i]?0:1;cell.style.background=grid[r.key][i]?r.color:''},{passive:false});
        row.appendChild(cell);cellEls[r.key].push(cell)}
      wrap.appendChild(row)});
    function tick(){const c=aud(),t=c.currentTime;if(grid.kick[step])playKick(t);if(grid.snare[step])playSnare(t);if(grid.hh[step])playHH(t);
      rows.forEach(r=>{cellEls[r.key].forEach((c,i)=>{c.style.boxShadow=i===step?'inset 0 0 0 1px #fff':'none'})});step=(step+1)%steps}
    playBtn.addEventListener('click',()=>{if(playing){playing=false;clearInterval(timer);playBtn.textContent='\u25b6 PLAY';step=0;rows.forEach(r=>{cellEls[r.key].forEach(c=>{c.style.boxShadow='none'})});return}
      playing=true;playBtn.textContent='\u25a0 STOP';step=0;initA();timer=setInterval(tick,spd*1000);_demoIntervals.push(timer)});
    return wrap}

  // DEMO: Waveforms
  function mkWaveDemo(){
    const wrap=document.createElement('div');wrap.style.cssText='background:var(--s3);border:1px solid var(--border);border-radius:4px;padding:6px;margin:6px 0';
    const row=document.createElement('div');row.style.cssText='display:flex;gap:4px;flex-wrap:wrap';
    const waves=[{n:'SINE',w:'sine',c:'#22d3ee'},{n:'TRIANGLE',w:'triangle',c:'#10b981'},{n:'SAW',w:'sawtooth',c:'#f59e0b'},{n:'SQUARE',w:'square',c:'#e8364f'}];
    let aO=null,aG=null;
    waves.forEach(wv=>{const btn=document.createElement('button');btn.style.cssText='background:var(--s2);border:2px solid '+wv.c+'40;color:'+wv.c+';font-family:inherit;font-size:7px;font-weight:800;padding:8px 14px;border-radius:4px;cursor:pointer;transition:all .1s;flex:1;min-width:55px';btn.textContent=wv.n;
      const go=()=>{const c=aud();aO=c.createOscillator();aG=c.createGain();aO.type=wv.w;aO.frequency.value=220;aG.gain.value=.18;aO.connect(aG);aG.connect(mGain);aO.start();btn.style.background=wv.c;btn.style.color='#fff'};
      const stop=()=>{if(aO){try{aG.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.05);aO.stop(ctx.currentTime+.1)}catch(e){}aO=null}btn.style.background='var(--s2)';btn.style.color=wv.c};
      btn.addEventListener('mousedown',go);btn.addEventListener('mouseup',stop);btn.addEventListener('mouseleave',stop);
      btn.addEventListener('touchstart',e=>{e.preventDefault();go()},{passive:false});btn.addEventListener('touchend',e=>{e.preventDefault();stop()},{passive:false});
      row.appendChild(btn)});
    const note=document.createElement('div');note.style.cssText='font-size:5px;color:var(--dim);margin-top:4px;text-align:center';note.textContent='Hold each button to hear the waveform at A3 (220Hz)';
    wrap.append(row,note);return wrap}

  // DEMO: Filter sweep
  function mkFilterDemo(){
    const wrap=document.createElement('div');wrap.style.cssText='background:var(--s3);border:1px solid var(--border);border-radius:4px;padding:6px;margin:6px 0';
    const row=document.createElement('div');row.style.cssText='display:flex;align-items:center;gap:6px';
    const lbl=document.createElement('div');lbl.style.cssText='font-size:5px;color:var(--dim);font-weight:700;white-space:nowrap';lbl.textContent='CUTOFF';
    const slider=document.createElement('input');slider.type='range';slider.min=50;slider.max=18000;slider.value=4000;slider.style.cssText='flex:1;height:16px;cursor:pointer';
    const val=document.createElement('span');val.style.cssText='font-size:7px;color:'+LC+';font-weight:800;min-width:44px;text-align:right';val.textContent='4000Hz';
    const playBtn=document.createElement('button');playBtn.style.cssText='background:'+LC+';border:none;color:#fff;font-family:inherit;font-size:6px;font-weight:800;padding:5px 10px;border-radius:3px;cursor:pointer';playBtn.textContent='HOLD';
    let osc=null,gain=null,flt=null;
    slider.addEventListener('input',()=>{val.textContent=slider.value+'Hz';if(flt)flt.frequency.value=+slider.value});
    const go=()=>{const c=aud();osc=c.createOscillator();gain=c.createGain();flt=c.createBiquadFilter();osc.type='sawtooth';osc.frequency.value=110;gain.gain.value=.18;flt.type='lowpass';flt.frequency.value=+slider.value;flt.Q.value=5;osc.connect(flt);flt.connect(gain);gain.connect(mGain);osc.start();playBtn.style.background='#fff';playBtn.style.color=LC};
    const stop=()=>{if(osc){try{gain.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.05);osc.stop(ctx.currentTime+.1)}catch(e){}osc=null;flt=null}playBtn.style.background=LC;playBtn.style.color='#fff'};
    playBtn.addEventListener('mousedown',go);playBtn.addEventListener('mouseup',stop);playBtn.addEventListener('mouseleave',stop);
    playBtn.addEventListener('touchstart',e=>{e.preventDefault();go()},{passive:false});playBtn.addEventListener('touchend',e=>{e.preventDefault();stop()},{passive:false});
    row.append(lbl,slider,val,playBtn);
    const note=document.createElement('div');note.style.cssText='font-size:5px;color:var(--dim);margin-top:3px;text-align:center';note.textContent='Hold PLAY and sweep the slider to hear the filter open and close';
    wrap.append(row,note);return wrap}

  // DEMO: ADSR
  function mkADSRDemo(){
    const wrap=document.createElement('div');wrap.style.cssText='background:var(--s3);border:1px solid var(--border);border-radius:4px;padding:6px;margin:6px 0';
    const env={a:.01,d:.2,s:.5,r:.3};
    const sliders=document.createElement('div');sliders.style.cssText='display:flex;gap:6px;margin-bottom:4px';
    const canvas=document.createElement('canvas');canvas.width=300;canvas.height=50;canvas.style.cssText='width:100%;height:50px;border-radius:3px;background:var(--s2)';
    function drawEnv(){const c2=canvas.getContext('2d');c2.clearRect(0,0,300,50);const w=300,h=50,pad=4;c2.strokeStyle=LC;c2.lineWidth=2;c2.beginPath();
      const aw=env.a*80,dw=env.d*80,sw=60,rw=env.r*80,total=aw+dw+sw+rw,scale=Math.min(1,(w-pad*2)/total);
      let x=pad;c2.moveTo(x,h-pad);x+=aw*scale;c2.lineTo(x,pad);x+=dw*scale;c2.lineTo(x,pad+(1-env.s)*(h-pad*2));x+=sw*scale;c2.lineTo(x,pad+(1-env.s)*(h-pad*2));x+=rw*scale;c2.lineTo(x,h-pad);c2.stroke();
      c2.font='bold 8px monospace';c2.fillStyle='#888';c2.fillText('A',pad+aw*scale/2-3,h-2);c2.fillText('D',pad+aw*scale+dw*scale/2-3,h-2);c2.fillText('S',pad+aw*scale+dw*scale+sw*scale/2-3,h-2);c2.fillText('R',pad+aw*scale+dw*scale+sw*scale+rw*scale/2-3,h-2)}
    ['A','D','S','R'].forEach((n,i)=>{const k=['a','d','s','r'][i];const sw=document.createElement('div');sw.style.cssText='flex:1;display:flex;flex-direction:column;align-items:center;gap:1px';
      const lb=document.createElement('div');lb.style.cssText='font-size:6px;font-weight:800;color:'+LC;lb.textContent=n;
      const vl=document.createElement('div');vl.style.cssText='font-size:5px;color:var(--dim);font-weight:700';vl.textContent=env[k].toFixed(2);
      const sl=document.createElement('input');sl.type='range';sl.min=0;sl.max=100;sl.value=env[k]*100;sl.style.cssText='width:100%;height:14px';
      sl.addEventListener('input',()=>{env[k]=sl.value/100;vl.textContent=env[k].toFixed(2);drawEnv()});
      sw.append(lb,sl,vl);sliders.appendChild(sw)});
    const playBtn=document.createElement('button');playBtn.style.cssText='background:'+LC+';border:none;color:#fff;font-family:inherit;font-size:7px;font-weight:800;padding:5px 14px;border-radius:3px;cursor:pointer;margin-top:4px';
    playBtn.textContent='\u25b6 PLAY NOTE';
    playBtn.addEventListener('click',()=>{const c=aud(),t=c.currentTime;const o=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();o.type='sawtooth';o.frequency.value=220;f.type='lowpass';f.frequency.value=3000;f.Q.value=1;
      g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(.2,t+Math.max(env.a,.005));g.gain.linearRampToValueAtTime(.2*Math.max(env.s,.01),t+env.a+Math.max(env.d,.005));
      g.gain.setValueAtTime(.2*Math.max(env.s,.01),t+env.a+env.d+.4);g.gain.linearRampToValueAtTime(.001,t+env.a+env.d+.4+Math.max(env.r,.005));
      o.connect(f);f.connect(g);g.connect(mGain);o.start(t);o.stop(t+env.a+env.d+.5+env.r)});
    wrap.append(sliders,canvas,playBtn);drawEnv();return wrap}

  // DEMO: Chords
  function mkChordDemo(){
    const wrap=document.createElement('div');wrap.style.cssText='background:var(--s3);border:1px solid var(--border);border-radius:4px;padding:6px;margin:6px 0';
    const row=document.createElement('div');row.style.cssText='display:flex;gap:4px;flex-wrap:wrap';
    const chords=[{n:'C Maj',notes:[60,64,67],c:'#22d3ee'},{n:'G Maj',notes:[55,59,62],c:'#f59e0b'},{n:'A min',notes:[57,60,64],c:'#a855f7'},{n:'F Maj',notes:[53,57,60],c:'#10b981'},{n:'D min',notes:[50,53,57],c:'#ec4899'},{n:'E min',notes:[52,55,59],c:'#f97316'}];
    chords.forEach(ch=>{const btn=document.createElement('button');btn.style.cssText='background:var(--s2);border:2px solid '+ch.c+'40;color:'+ch.c+';font-family:inherit;font-size:6px;font-weight:800;padding:7px 10px;border-radius:4px;cursor:pointer;transition:all .1s;flex:1;min-width:50px';btn.textContent=ch.n;
      btn.addEventListener('click',()=>{const c=aud(),t=c.currentTime;ch.notes.forEach(n=>{const o=c.createOscillator(),g=c.createGain();o.type='triangle';o.frequency.value=mf(n);g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.001,t+1.2);o.connect(g);g.connect(mGain);o.start(t);o.stop(t+1.3)});
        btn.style.background=ch.c;btn.style.color='#fff';setTimeout(()=>{btn.style.background='var(--s2)';btn.style.color=ch.c},300)});
      row.appendChild(btn)});
    const note=document.createElement('div');note.style.cssText='font-size:5px;color:var(--dim);margin-top:4px;text-align:center';note.textContent='Try C \u2192 G \u2192 Am \u2192 F (the most popular pop progression)';
    wrap.append(row,note);return wrap}

  // DEMO: Mini piano
  function mkPianoDemo(){
    const wrap=document.createElement('div');wrap.style.cssText='background:var(--s3);border:1px solid var(--border);border-radius:4px;padding:6px;margin:6px 0';
    const kb=document.createElement('div');kb.style.cssText='display:flex;position:relative;height:55px;user-select:none';
    const whites=[60,62,64,65,67,69,71,72];const nn=['C','D','E','F','G','A','B','C'];
    const blackPos=[[0,61],[1,63],[3,66],[4,68],[5,70]];
    whites.forEach((n,i)=>{const k=document.createElement('div');k.style.cssText='flex:1;background:#e8e8e8;border:1px solid #aaa;border-radius:0 0 3px 3px;display:flex;align-items:flex-end;justify-content:center;padding-bottom:3px;font-size:6px;color:#888;font-weight:700;cursor:pointer;transition:background .05s;user-select:none';
      k.textContent=nn[i];
      const go=()=>{initA();playTone(mf(n),.6,'sawtooth',.12);k.style.background='#b0e8e0'};const up=()=>{k.style.background='#e8e8e8'};
      k.addEventListener('mousedown',go);k.addEventListener('mouseup',up);k.addEventListener('mouseleave',up);
      k.addEventListener('touchstart',e=>{e.preventDefault();go()},{passive:false});k.addEventListener('touchend',e=>{e.preventDefault();up()},{passive:false});
      kb.appendChild(k)});
    blackPos.forEach(([pos,n])=>{const k=document.createElement('div');k.style.cssText='position:absolute;top:0;width:'+(100/whites.length*.6)+'%;height:58%;background:#222;border:1px solid #111;border-radius:0 0 2px 2px;cursor:pointer;z-index:2;left:'+(pos/whites.length*100+100/whites.length*.65)+'%';
      const go=()=>{initA();playTone(mf(n),.6,'sawtooth',.12);k.style.background='#1a8a7a'};const up=()=>{k.style.background='#222'};
      k.addEventListener('mousedown',e=>{e.stopPropagation();go()});k.addEventListener('mouseup',up);k.addEventListener('mouseleave',up);
      k.addEventListener('touchstart',e=>{e.preventDefault();e.stopPropagation();go()},{passive:false});k.addEventListener('touchend',e=>{e.preventDefault();up()},{passive:false});
      kb.appendChild(k)});
    const note=document.createElement('div');note.style.cssText='font-size:5px;color:var(--dim);margin-top:3px;text-align:center';note.textContent='White keys C\u2192C = C major scale. Start from A = A natural minor.';
    wrap.append(kb,note);return wrap}

  // DEMO: Reverb - dry vs wet comparison
  function mkReverbDemo(){
    const wrap=document.createElement('div');wrap.style.cssText='background:var(--s3);border:1px solid var(--border);border-radius:4px;padding:6px;margin:6px 0';
    const row=document.createElement('div');row.style.cssText='display:flex;gap:4px;align-items:center';
    const mixLbl=document.createElement('div');mixLbl.style.cssText='font-size:5px;color:var(--dim);font-weight:700;white-space:nowrap';mixLbl.textContent='REVERB MIX';
    const slider=document.createElement('input');slider.type='range';slider.min=0;slider.max=100;slider.value=50;slider.style.cssText='flex:1;height:16px';
    const val=document.createElement('span');val.style.cssText='font-size:7px;color:'+LC+';font-weight:800;min-width:30px;text-align:right';val.textContent='50%';
    slider.addEventListener('input',()=>{val.textContent=slider.value+'%'});
    const playBtn=document.createElement('button');playBtn.style.cssText='background:'+LC+';border:none;color:#fff;font-family:inherit;font-size:6px;font-weight:800;padding:5px 10px;border-radius:3px;cursor:pointer';playBtn.textContent='\u25b6 CHORD';
    playBtn.addEventListener('click',()=>{
      const c=aud(),t=c.currentTime,mix=slider.value/100;
      const dry=c.createGain(),wet=c.createGain();dry.gain.value=1-mix;wet.gain.value=mix;
      const conv=c.createConvolver(),len=c.sampleRate*2,buf=c.createBuffer(2,len,c.sampleRate);
      for(let ch=0;ch<2;ch++){const d=buf.getChannelData(ch);for(let i=0;i<len;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/len,2.5)}
      conv.buffer=buf;
      [60,64,67].forEach(n=>{const o=c.createOscillator(),g=c.createGain();o.type='triangle';o.frequency.value=mf(n);g.gain.setValueAtTime(.08,t);g.gain.exponentialRampToValueAtTime(.001,t+.8);
        o.connect(g);g.connect(dry);g.connect(conv);o.start(t);o.stop(t+.9)});
      conv.connect(wet);dry.connect(mGain);wet.connect(mGain);
      playBtn.style.background='#fff';playBtn.style.color=LC;setTimeout(()=>{playBtn.style.background=LC;playBtn.style.color='#fff'},400)});
    row.append(mixLbl,slider,val,playBtn);
    const note=document.createElement('div');note.style.cssText='font-size:5px;color:var(--dim);margin-top:3px;text-align:center';note.textContent='Set mix to 0% (dry) vs 100% (drenched). Click chord to hear the difference.';
    wrap.append(row,note);return wrap}

  // DEMO: Delay with tap rhythm
  function mkDelayDemo(){
    const wrap=document.createElement('div');wrap.style.cssText='background:var(--s3);border:1px solid var(--border);border-radius:4px;padding:6px;margin:6px 0';
    const r1=document.createElement('div');r1.style.cssText='display:flex;gap:6px;align-items:center;margin-bottom:4px';
    const timeLbl=document.createElement('div');timeLbl.style.cssText='font-size:5px;color:var(--dim);font-weight:700';timeLbl.textContent='DELAY TIME';
    const timeSl=document.createElement('input');timeSl.type='range';timeSl.min=50;timeSl.max=500;timeSl.value=200;timeSl.style.cssText='flex:1;height:14px';
    const timeVal=document.createElement('span');timeVal.style.cssText='font-size:6px;color:'+LC+';font-weight:800;min-width:36px';timeVal.textContent='200ms';
    timeSl.addEventListener('input',()=>{timeVal.textContent=timeSl.value+'ms'});
    const fbLbl=document.createElement('div');fbLbl.style.cssText='font-size:5px;color:var(--dim);font-weight:700';fbLbl.textContent='FEEDBACK';
    const fbSl=document.createElement('input');fbSl.type='range';fbSl.min=0;fbSl.max=85;fbSl.value=40;fbSl.style.cssText='width:60px;height:14px';
    const fbVal=document.createElement('span');fbVal.style.cssText='font-size:6px;color:'+LC+';font-weight:800;min-width:28px';fbVal.textContent='40%';
    fbSl.addEventListener('input',()=>{fbVal.textContent=fbSl.value+'%'});
    r1.append(timeLbl,timeSl,timeVal,fbLbl,fbSl,fbVal);
    const tapBtn=document.createElement('button');tapBtn.style.cssText='background:'+LC+';border:none;color:#fff;font-family:inherit;font-size:7px;font-weight:800;padding:6px 16px;border-radius:3px;cursor:pointer;width:100%';
    tapBtn.textContent='\u25b6 TAP TO HEAR DELAY';
    tapBtn.addEventListener('click',()=>{
      const c=aud(),t=c.currentTime,dTime=timeSl.value/1000,fb=fbSl.value/100;
      const src=c.createOscillator(),srcG=c.createGain(),delay=c.createDelay(1),fbG=c.createGain(),outG=c.createGain();
      src.type='sawtooth';src.frequency.value=440;srcG.gain.setValueAtTime(.15,t);srcG.gain.exponentialRampToValueAtTime(.001,t+.15);
      delay.delayTime.value=dTime;fbG.gain.value=fb;outG.gain.value=.8;
      src.connect(srcG);srcG.connect(mGain);srcG.connect(delay);delay.connect(fbG);fbG.connect(delay);delay.connect(outG);outG.connect(mGain);
      src.start(t);src.stop(t+.2);setTimeout(()=>{try{outG.disconnect()}catch(e){}},dTime*8*1000);
      tapBtn.style.background='#fff';tapBtn.style.color=LC;setTimeout(()=>{tapBtn.style.background=LC;tapBtn.style.color='#fff'},200)});
    const note=document.createElement('div');note.style.cssText='font-size:5px;color:var(--dim);margin-top:3px;text-align:center';note.textContent='Adjust time and feedback, then tap. Short time = slapback. Long + high feedback = ambient wash.';
    wrap.append(r1,tapBtn,note);return wrap}

  // DEMO: Sidechain pump visualization + audio
  function mkSidechainDemo(){
    const wrap=document.createElement('div');wrap.style.cssText='background:var(--s3);border:1px solid var(--border);border-radius:4px;padding:6px;margin:6px 0';
    const canvas=document.createElement('canvas');canvas.width=300;canvas.height=40;canvas.style.cssText='width:100%;height:40px;background:var(--s2);border-radius:3px;margin-bottom:4px';
    const r1=document.createElement('div');r1.style.cssText='display:flex;gap:6px;align-items:center';
    const depLbl=document.createElement('div');depLbl.style.cssText='font-size:5px;color:var(--dim);font-weight:700';depLbl.textContent='DEPTH';
    const depSl=document.createElement('input');depSl.type='range';depSl.min=0;depSl.max=100;depSl.value=80;depSl.style.cssText='flex:1;height:14px';
    const playBtn=document.createElement('button');playBtn.style.cssText='background:'+LC+';border:none;color:#fff;font-family:inherit;font-size:7px;font-weight:800;padding:5px 12px;border-radius:3px;cursor:pointer';
    playBtn.textContent='\u25b6 PLAY';
    let scPlaying=false,scTimer=null,scStep=0;
    const bpm=128,spd=60/bpm/4;
    playBtn.addEventListener('click',()=>{
      if(scPlaying){scPlaying=false;clearInterval(scTimer);playBtn.textContent='\u25b6 PLAY';return}
      scPlaying=true;playBtn.textContent='\u25a0 STOP';scStep=0;initA();
      // Pad drone
      const c=aud();
      const padO1=c.createOscillator(),padO2=c.createOscillator(),padG=c.createGain();
      padO1.type='sawtooth';padO1.frequency.value=mf(60);padO2.type='sawtooth';padO2.frequency.value=mf(60)*1.005;
      padG.gain.value=.12;padO1.connect(padG);padO2.connect(padG);
      const padF=c.createBiquadFilter();padF.type='lowpass';padF.frequency.value=800;padG.connect(padF);padF.connect(mGain);
      padO1.start();padO2.start();
      scTimer=setInterval(()=>{
        const t=c.currentTime,depth=depSl.value/100;
        if(scStep%4===0)playKick(t,.3);
        // Sidechain pump on pad
        if(scStep%4===0){padG.gain.cancelScheduledValues(t);padG.gain.setValueAtTime(.12*(1-depth),t);padG.gain.linearRampToValueAtTime(.12,t+spd*3)}
        // Draw envelope
        const c2=canvas.getContext('2d');c2.clearRect(0,0,300,40);c2.fillStyle=LC+'30';
        for(let i=0;i<16;i++){const x=i/16*300,w=300/16;const isKick=i%4===0;
          const h=isKick?40*(1-depth):40;c2.fillRect(x,40-h,w-1,h)}
        c2.fillStyle=LC;c2.fillRect((scStep%16)/16*300,0,300/16-1,40);
        scStep++;
      },spd*1000);_demoIntervals.push(scTimer);
      // Cleanup
      const origStop=playBtn.onclick;
      const stopAll=()=>{try{padO1.stop();padO2.stop()}catch(e){}};
      playBtn.addEventListener('click',stopAll,{once:true})});
    r1.append(depLbl,depSl,playBtn);
    const note=document.createElement('div');note.style.cssText='font-size:5px;color:var(--dim);margin-top:3px;text-align:center';note.textContent='Kick plays every beat. Pad volume ducks (pumps) by the depth amount. Adjust depth to hear the effect.';
    wrap.append(canvas,r1,note);return wrap}

  // DEMO: Distortion A/B
  function mkDistortDemo(){
    const wrap=document.createElement('div');wrap.style.cssText='background:var(--s3);border:1px solid var(--border);border-radius:4px;padding:6px;margin:6px 0';
    const r1=document.createElement('div');r1.style.cssText='display:flex;gap:6px;align-items:center;margin-bottom:4px';
    const drvLbl=document.createElement('div');drvLbl.style.cssText='font-size:5px;color:var(--dim);font-weight:700';drvLbl.textContent='DRIVE';
    const drvSl=document.createElement('input');drvSl.type='range';drvSl.min=0;drvSl.max=100;drvSl.value=0;drvSl.style.cssText='flex:1;height:14px';
    const drvVal=document.createElement('span');drvVal.style.cssText='font-size:7px;color:#e8364f;font-weight:800;min-width:36px;text-align:right';drvVal.textContent='CLEAN';
    drvSl.addEventListener('input',()=>{drvVal.textContent=drvSl.value>0?drvSl.value+'%':'CLEAN';drvVal.style.color=drvSl.value>50?'#e8364f':drvSl.value>0?'#f59e0b':LC});
    r1.append(drvLbl,drvSl,drvVal);
    const playBtn=document.createElement('button');playBtn.style.cssText='background:'+LC+';border:none;color:#fff;font-family:inherit;font-size:6px;font-weight:800;padding:5px 10px;border-radius:3px;cursor:pointer';
    playBtn.textContent='HOLD TO HEAR';
    let osc=null,gain=null,dist=null;
    const go=()=>{const c=aud();osc=c.createOscillator();gain=c.createGain();dist=c.createWaveShaper();
      osc.type='sawtooth';osc.frequency.value=110;gain.gain.value=.15;
      const amt=drvSl.value/100*50;const len=44100;const curve=new Float32Array(len);
      for(let i=0;i<len;i++){const x=i*2/len-1;curve[i]=amt>0?(Math.PI+amt)*x/(Math.PI+amt*Math.abs(x)):x}
      dist.curve=curve;dist.oversample='4x';
      osc.connect(dist);dist.connect(gain);gain.connect(mGain);osc.start();
      playBtn.style.background='#e8364f';playBtn.style.color='#fff'};
    const stop=()=>{if(osc){try{gain.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.05);osc.stop(ctx.currentTime+.1)}catch(e){}osc=null}playBtn.style.background=LC;playBtn.style.color='#fff'};
    playBtn.addEventListener('mousedown',go);playBtn.addEventListener('mouseup',stop);playBtn.addEventListener('mouseleave',stop);
    playBtn.addEventListener('touchstart',e=>{e.preventDefault();go()},{passive:false});playBtn.addEventListener('touchend',e=>{e.preventDefault();stop()},{passive:false});
    const note=document.createElement('div');note.style.cssText='font-size:5px;color:var(--dim);margin-top:3px;text-align:center';note.textContent='Set drive to 0 (clean), hold to play, then increase drive while holding. Hear warmth turn to aggression.';
    wrap.append(r1,playBtn,note);return wrap}

  // DEMO: Mixer balance ‚Äî 3 layers with independent volume
  function mkMixDemo(){
    const wrap=document.createElement('div');wrap.style.cssText='background:var(--s3);border:1px solid var(--border);border-radius:4px;padding:6px;margin:6px 0';
    const layers=[{name:'KICK',color:'#e8364f',vol:.7},{name:'BASS',color:'#818cf8',vol:.4},{name:'LEAD',color:'#22d3ee',vol:.3}];
    const sliders=document.createElement('div');sliders.style.cssText='display:flex;flex-direction:column;gap:3px;margin-bottom:4px';
    layers.forEach(l=>{
      const row=document.createElement('div');row.style.cssText='display:flex;align-items:center;gap:4px';
      const nm=document.createElement('div');nm.style.cssText='font-size:5px;font-weight:800;color:'+l.color+';width:28px';nm.textContent=l.name;
      const sl=document.createElement('input');sl.type='range';sl.min=0;sl.max=100;sl.value=l.vol*100;sl.style.cssText='flex:1;height:14px';
      const vl=document.createElement('span');vl.style.cssText='font-size:6px;color:var(--dim);font-weight:700;min-width:24px;text-align:right';vl.textContent=Math.round(l.vol*100);
      sl.addEventListener('input',()=>{l.vol=sl.value/100;vl.textContent=sl.value});
      row.append(nm,sl,vl);sliders.appendChild(row)});
    let playing=false,timer=null,step=0;const bpm=120,spd=60/bpm/4;
    const playBtn=document.createElement('button');playBtn.style.cssText='background:'+LC+';border:none;color:#fff;font-family:inherit;font-size:7px;font-weight:800;padding:5px 14px;border-radius:3px;cursor:pointer;width:100%';
    playBtn.textContent='\u25b6 PLAY MIX';
    let bassO=null,bassG=null,leadO=null,leadG=null;
    playBtn.addEventListener('click',()=>{
      if(playing){playing=false;clearInterval(timer);playBtn.textContent='\u25b6 PLAY MIX';
        try{if(bassO)bassO.stop();if(leadO)leadO.stop()}catch(e){}bassO=null;leadO=null;return}
      playing=true;playBtn.textContent='\u25a0 STOP';step=0;const c=aud();
      // Bass drone
      bassO=c.createOscillator();bassG=c.createGain();bassO.type='sawtooth';bassO.frequency.value=mf(36);
      const bassF=c.createBiquadFilter();bassF.type='lowpass';bassF.frequency.value=400;
      bassG.gain.value=layers[1].vol*.2;bassO.connect(bassF);bassF.connect(bassG);bassG.connect(mGain);bassO.start();
      // Lead
      leadO=c.createOscillator();leadG=c.createGain();leadO.type='triangle';leadO.frequency.value=mf(72);
      leadG.gain.value=layers[2].vol*.12;leadO.connect(leadG);leadG.connect(mGain);leadO.start();
      const melody=[72,71,67,69,72,74,71,67];
      timer=setInterval(()=>{const t=c.currentTime;
        if(step%4===0)playKick(t,layers[0].vol*.5);
        if(step%2===0)playHH(t,layers[0].vol*.15);
        bassG.gain.setTargetAtTime(layers[1].vol*.2,t,.02);
        leadG.gain.setTargetAtTime(layers[2].vol*.12,t,.02);
        if(step%2===0)leadO.frequency.setTargetAtTime(mf(melody[(step/2)%melody.length]),t,.02);
        step++},spd*1000);_demoIntervals.push(timer)});
    const note=document.createElement('div');note.style.cssText='font-size:5px;color:var(--dim);margin-top:3px;text-align:center';note.textContent='Press play, then adjust the 3 sliders in real-time. Hear how balance changes the mix.';
    wrap.append(sliders,playBtn,note);return wrap}

  // DEMO: EQ frequency bands
  function mkEQDemo(){
    const wrap=document.createElement('div');wrap.style.cssText='background:var(--s3);border:1px solid var(--border);border-radius:4px;padding:6px;margin:6px 0';
    const bands=[{name:'LOW',freq:200,color:'#e8364f'},{name:'MID',freq:1000,color:'#f59e0b'},{name:'HIGH',freq:5000,color:'#22d3ee'}];
    const gains={LOW:0,MID:0,HIGH:0};
    const sliders=document.createElement('div');sliders.style.cssText='display:flex;gap:8px;margin-bottom:4px';
    bands.forEach(b=>{
      const col=document.createElement('div');col.style.cssText='flex:1;display:flex;flex-direction:column;align-items:center;gap:2px';
      const lb=document.createElement('div');lb.style.cssText='font-size:6px;font-weight:800;color:'+b.color;lb.textContent=b.name;
      const vl=document.createElement('div');vl.style.cssText='font-size:5px;color:var(--dim);font-weight:700';vl.textContent='0 dB';
      const sl=document.createElement('input');sl.type='range';sl.min=-12;sl.max=12;sl.value=0;sl.style.cssText='width:100%;height:14px';
      sl.addEventListener('input',()=>{gains[b.name]=+sl.value;vl.textContent=sl.value+' dB'});
      col.append(lb,sl,vl);sliders.appendChild(col)});
    const playBtn=document.createElement('button');playBtn.style.cssText='background:'+LC+';border:none;color:#fff;font-family:inherit;font-size:6px;font-weight:800;padding:5px 10px;border-radius:3px;cursor:pointer';
    playBtn.textContent='HOLD TO HEAR';
    let oscs=[],gn=null,eqs=[];
    const go=()=>{const c=aud();gn=c.createGain();gn.gain.value=.12;
      // Noise + tone for all bands
      const len=c.sampleRate*2,buf=c.createBuffer(1,len,c.sampleRate);const d=buf.getChannelData(0);
      for(let i=0;i<len;i++)d[i]=(Math.random()*2-1);
      const noise=c.createBufferSource();noise.buffer=buf;noise.loop=true;
      const tone=c.createOscillator();tone.type='sawtooth';tone.frequency.value=110;
      const mix=c.createGain();mix.gain.value=1;
      const noiseG=c.createGain();noiseG.gain.value=.3;noise.connect(noiseG);noiseG.connect(mix);
      const toneG=c.createGain();toneG.gain.value=.7;tone.connect(toneG);toneG.connect(mix);
      // 3-band EQ
      const lo=c.createBiquadFilter();lo.type='lowshelf';lo.frequency.value=200;lo.gain.value=gains.LOW;
      const mid=c.createBiquadFilter();mid.type='peaking';mid.frequency.value=1000;mid.Q.value=1;mid.gain.value=gains.MID;
      const hi=c.createBiquadFilter();hi.type='highshelf';hi.frequency.value=5000;hi.gain.value=gains.HIGH;
      eqs=[lo,mid,hi];mix.connect(lo);lo.connect(mid);mid.connect(hi);hi.connect(gn);gn.connect(mGain);
      noise.start();tone.start();oscs=[noise,tone];
      playBtn.style.background='#fff';playBtn.style.color=LC;
      // Live update EQ
      const eqUp=setInterval(()=>{if(!oscs.length){clearInterval(eqUp);return}lo.gain.value=gains.LOW;mid.gain.value=gains.MID;hi.gain.value=gains.HIGH},50);
      _demoIntervals.push(eqUp)};
    const stop=()=>{oscs.forEach(o=>{try{o.stop()}catch(e){}});oscs=[];eqs=[];
      playBtn.style.background=LC;playBtn.style.color='#fff'};
    playBtn.addEventListener('mousedown',go);playBtn.addEventListener('mouseup',stop);playBtn.addEventListener('mouseleave',stop);
    playBtn.addEventListener('touchstart',e=>{e.preventDefault();go()},{passive:false});playBtn.addEventListener('touchend',e=>{e.preventDefault();stop()},{passive:false});
    const note=document.createElement('div');note.style.cssText='font-size:5px;color:var(--dim);margin-top:3px;text-align:center';note.textContent='Hold PLAY and sweep the EQ bands. Boost LOW for bass, cut MID for space, boost HIGH for brightness.';
    wrap.append(sliders,playBtn,note);return wrap}

  // --- NAV + CONTENT ---
  const nav=document.createElement('div');nav.style.cssText='display:flex;gap:0;border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto;scrollbar-width:none';
  const content=document.createElement('div');content.style.cssText='flex:1;overflow-y:auto;padding:8px 10px;min-height:0';

  const lessons=[
    {tab:'BASICS',title:'Music Production Basics',sections:[
      {h:'What is a DAW?',body:'A DAW (Digital Audio Workstation) is software for making music. This studio is a browser-based DAW with the same core tools found in Ableton, FL Studio, and Logic Pro ‚Äî step sequencers, synthesizers, effects, mixing, and arrangement.\n\n<b style="color:'+LC+'">Try it:</b> Click <b>+BEAT</b> to open a step sequencer. Click cells to place hits. Press PLAY.'},
      {h:'Tempo & BPM',body:'BPM (Beats Per Minute) controls speed. Common tempos:\n\n\u2022 <b>70-90</b> \u2014 Hip-hop, Lo-fi, R&B\n\u2022 <b>100-115</b> \u2014 Pop, Reggaeton\n\u2022 <b>120-130</b> \u2014 House, Techno\n\u2022 <b>140-170</b> \u2014 DnB, Dubstep\n\n<b style="color:'+LC+'">Interactive:</b> Same pattern at different speeds \u2014 hear how BPM transforms the vibe.',demo:'beat_tempo'},
      {h:'Bars, Beats & Steps',body:'Music divides into <b>bars</b> (measures). In 4/4 time each bar has 4 beats. The 16-step grid = 1 bar with 16th note resolution. Steps 1, 5, 9, 13 are the downbeats.\n\n<b style="color:'+LC+'">Interactive:</b> Click cells to toggle hits. Press PLAY to hear your pattern.',demo:'beat_basic'}
    ]},
    {tab:'RHYTHM',title:'Building Rhythms',sections:[
      {h:'Kick & Snare',body:'The <b>kick</b> is the heartbeat (low thump). The <b>snare</b> is the crack (sharp hit). Together they form the backbone of nearly all music.\n\nBasic rock beat: Kick on 1 & 3, Snare on 2 & 4.\n\n<b style="color:'+LC+'">Interactive:</b> Pre-loaded kick/snare pattern. Add or remove hits to feel the difference.',demo:'beat_kicksnare'},
      {h:'Hi-Hats & Groove',body:'Hi-hats fill the space between kick and snare, creating movement and energy.\n\n\u2022 Every step = 16th notes (driving)\n\u2022 Every 2 steps = 8th notes (standard)\n\u2022 Every 4 steps = quarter notes (minimal)\n\n<b style="color:'+LC+'">Interactive:</b> Full beat with hi-hats. Try removing some to hear how spacing changes the feel.',demo:'beat_hihats'},
      {h:'Swing',body:'<b>Swing</b> pushes every other hi-hat slightly late, creating a human bounce.\n\n\u2022 0% = Straight, mechanical (EDM, Techno)\n\u2022 15-25% = Subtle bounce (Pop, R&B)\n\u2022 50%+ = Triplet feel (Hip-hop, Jazz)\n\n<b style="color:'+LC+'">Try it:</b> Open a BEAT module and adjust the channel swing in the mixer.'}
    ]},
    {tab:'MELODY',title:'Melody & Harmony',sections:[
      {h:'Notes & Scales',body:'A <b>scale</b> is a set of notes that sound good together. White keys from C\u2192C = <b>C major</b> (happy). White keys from A\u2192A = <b>A minor</b> (sad).\n\n<b style="color:'+LC+'">Interactive:</b> Play the keyboard below. Try both scales and hear the mood change.',demo:'piano'},
      {h:'Chords',body:'A <b>chord</b> is 3+ notes played at once. The most famous progression is <b>I-V-vi-IV</b> (C \u2192 G \u2192 Am \u2192 F) \u2014 used in hundreds of pop songs.\n\n<b style="color:'+LC+'">Interactive:</b> Click chords to hear them. Play C \u2192 G \u2192 Am \u2192 F in order.',demo:'chords'},
      {h:'Bass Lines',body:'Bass bridges rhythm and melody. It follows the root note of each chord in lower octaves (Oct 2-3). When bass and kick hit together, it creates a powerful low-end.\n\n<b style="color:'+LC+'">Try it:</b> Open a BASS module at octave 2-3 and play root notes matching your chords.'},
      {h:'Melody Writing',body:'Tips:\n\u2022 <b>Start simple</b> \u2014 3-5 notes from your scale\n\u2022 <b>Repetition</b> \u2014 Repeat a phrase, vary slightly\n\u2022 <b>Step motion</b> \u2014 Adjacent notes (smooth)\n\u2022 <b>Leaps</b> \u2014 Skip notes (dramatic, use sparingly)\n\n<b style="color:'+LC+'">Try it:</b> Open NOTE module. Draw a 4-note phrase. Copy it, change the last note.'}
    ]},
    {tab:'SOUND',title:'Sound Design',sections:[
      {h:'Waveforms',body:'All synth sound starts with an <b>oscillator</b>. Each waveform has a unique character:\n\n\u2022 <b>Sine</b> \u2014 Pure, smooth (sub-bass)\n\u2022 <b>Triangle</b> \u2014 Mellow, flute-like\n\u2022 <b>Sawtooth</b> \u2014 Rich, bright (leads, pads, bass)\n\u2022 <b>Square</b> \u2014 Hollow, retro/8-bit\n\n<b style="color:'+LC+'">Interactive:</b> Hold each button to hear the raw waveform.',demo:'waveforms'},
      {h:'Filters',body:'A <b>low-pass filter</b> removes high frequencies. Low cutoff = dark/muffled. High = bright/open. <b>Resonance</b> boosts at the cutoff for a "wah" character.\n\nFilter sweeps are the basis of every EDM build-up.\n\n<b style="color:'+LC+'">Interactive:</b> Hold PLAY and drag the slider to sweep the filter.',demo:'filter'},
      {h:'ADSR Envelope',body:'<b>ADSR</b> shapes how sound evolves over time:\n\n\u2022 <b>Attack</b> \u2014 Time to peak (0=instant, high=slow swell)\n\u2022 <b>Decay</b> \u2014 Drop to sustain level\n\u2022 <b>Sustain</b> \u2014 Level while held\n\u2022 <b>Release</b> \u2014 Fade after release\n\nPresets: Pad (slow A, high S), Pluck (zero A, low S), Bass (zero A, mid S).\n\n<b style="color:'+LC+'">Interactive:</b> Adjust sliders, click PLAY NOTE, see the curve change.',demo:'adsr'},
      {h:'Detune',body:'<b>Detune</b> shifts pitch between oscillators creating a rich, wide sound. 0=thin. 5-15=warm. 30+=massive supersaw.\n\n<b style="color:'+LC+'">Try it:</b> Open SYNTH with sawtooth, play a note, increase Detune.'}
    ]},
    {tab:'FX',title:'Effects',sections:[
      {h:'Reverb',body:'Simulates space \u2014 room reflections. Adds depth and dimension. Use more on melodies, less on kick/bass to keep the low end tight.\n\n<b style="color:'+LC+'">Interactive:</b> Adjust the mix slider and click the chord. 0% = bone dry. 100% = drenched in space.',demo:'reverb'},
      {h:'Delay',body:'Creates echoes at a set time interval. <b>Time</b> controls the gap between echoes. <b>Feedback</b> controls how many repeats.\n\n<b style="color:'+LC+'">Interactive:</b> Adjust time and feedback, then tap. Short time = slapback. Long + high feedback = ambient wash.',demo:'delay'},
      {h:'Sidechain',body:'Makes one sound duck when another plays \u2014 the pumping effect in dance music. The kick triggers a volume dip in the pad/bass.\n\n<b style="color:'+LC+'">Interactive:</b> Play and adjust the depth slider. Watch the volume curve duck on every kick hit.',demo:'sidechain'},
      {h:'Distortion',body:'Adds harmonics by clipping the signal. Low drive = subtle warmth. High drive = aggressive grit. Bitcrush = lo-fi/retro.\n\n<b style="color:'+LC+'">Interactive:</b> Hold to play a bass note. Sweep drive from clean to destroyed in real-time.',demo:'distortion'}
    ]},
    {tab:'MIX',title:'Mixing',sections:[
      {h:'Level Balance',body:'Start with everything down. Build: kick first (reference) \u2192 bass (under kick) \u2192 snare/hats \u2192 melodies on top.\n\nKey: <b>if everything is loud, nothing is loud.</b>\n\n<b style="color:'+LC+'">Interactive:</b> Three layers playing live. Adjust each slider and hear how balance changes the mix.',demo:'mixer'},
      {h:'Arrangement',body:'Song structure:\n\u2022 <b>Intro</b> (4-8 bars) \u2192 <b>Verse</b> (8-16) \u2192 <b>Drop</b> (8-16) \u2192 <b>Breakdown</b> (4-8) \u2192 <b>Outro</b>\n\nSimplest: drums \u2192 +bass (4 bars) \u2192 +melody (8 bars) \u2192 strip back \u2192 rebuild.\n\n<b style="color:'+LC+'">Try it:</b> Use channel muting in the mixer to arrange live.'},
      {h:'EQ',body:'Every sound lives in a frequency range. <b>Cut rather than boost</b> \u2014 it is cleaner.\n\n\u2022 Sub 20-60Hz \u2014 Kick/bass\n\u2022 Bass 60-250Hz \u2014 Warmth\n\u2022 Mids 250Hz-4kHz \u2014 Instruments\n\u2022 Highs 4-20kHz \u2014 Sparkle, hats\n\n<b style="color:'+LC+'">Interactive:</b> Hold PLAY and sweep the 3-band EQ. Hear how each band changes the sound.',demo:'eq'},
      {h:'Export',body:'Click <b>REC</b> in toolbar, play your arrangement, stop and download WAV. Use <b>SAVE</b> to store your session as JSON. Use <b>COLLAB</b> to share modules.'}
    ]}
  ];

  let activeTab=0;
  lessons.forEach((les,i)=>{const tab=document.createElement('button');tab.style.cssText='background:none;border:none;border-bottom:2px solid transparent;color:var(--dim);font-family:inherit;font-size:6px;font-weight:800;padding:5px 8px;cursor:pointer;letter-spacing:.5px;transition:all .12s;white-space:nowrap';tab.textContent=les.tab;
    tab.addEventListener('click',()=>{activeTab=i;renderContent();updateTabs()});nav.appendChild(tab)});
  function updateTabs(){nav.querySelectorAll('button').forEach((t,i)=>{t.style.borderBottomColor=i===activeTab?LC:'transparent';t.style.color=i===activeTab?LC:'var(--dim)'})}

  function renderContent(){
    _demoIntervals.forEach(t=>clearInterval(t));_demoIntervals=[];
    const les=lessons[activeTab];content.innerHTML='';
    const title=document.createElement('div');title.style.cssText='font-size:10px;font-weight:800;color:'+LC+';letter-spacing:.5px;margin-bottom:8px';title.textContent=les.title;content.appendChild(title);
    les.sections.forEach((sec,si)=>{
      const wrap=document.createElement('div');wrap.style.cssText='margin-bottom:10px';
      const hdr=document.createElement('div');hdr.style.cssText='font-size:7px;font-weight:800;color:var(--text);margin-bottom:0;padding:4px 6px;background:var(--s2);border:1px solid var(--border);border-radius:3px;cursor:pointer;display:flex;align-items:center;gap:4px;transition:all .12s';
      const arrow=document.createElement('span');arrow.style.cssText='color:'+LC+';font-size:8px;transition:transform .15s';arrow.textContent='\u25b6';
      const txt=document.createElement('span');txt.textContent=sec.h;
      hdr.append(arrow,txt);
      if(sec.demo){const badge=document.createElement('span');badge.style.cssText='font-size:4.5px;background:'+LC+'20;color:'+LC+';padding:1px 4px;border-radius:2px;font-weight:800;margin-left:auto';badge.textContent='\u266b INTERACTIVE';hdr.appendChild(badge)}
      const body=document.createElement('div');body.style.cssText='font-size:6.5px;color:var(--dim);line-height:1.7;padding:6px 8px;display:none;border-left:2px solid '+LC+'30';
      body.innerHTML=sec.body.replace(/\n/g,'<br>');
      let demoBuilt=false;
      const buildDemo=()=>{if(demoBuilt||!sec.demo)return;demoBuilt=true;
        if(sec.demo==='beat_basic')body.appendChild(mkBeatDemo([1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],120));
        else if(sec.demo==='beat_kicksnare')body.appendChild(mkBeatDemo([1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],120));
        else if(sec.demo==='beat_hihats')body.appendChild(mkBeatDemo([1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],120));
        else if(sec.demo==='beat_tempo'){
          [80,120,160].forEach(bpm=>{body.appendChild(mkBeatDemo([1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],bpm))})}
        else if(sec.demo==='waveforms')body.appendChild(mkWaveDemo());
        else if(sec.demo==='filter')body.appendChild(mkFilterDemo());
        else if(sec.demo==='adsr')body.appendChild(mkADSRDemo());
        else if(sec.demo==='chords')body.appendChild(mkChordDemo());
        else if(sec.demo==='piano')body.appendChild(mkPianoDemo());
        else if(sec.demo==='reverb')body.appendChild(mkReverbDemo());
        else if(sec.demo==='delay')body.appendChild(mkDelayDemo());
        else if(sec.demo==='sidechain')body.appendChild(mkSidechainDemo());
        else if(sec.demo==='distortion')body.appendChild(mkDistortDemo());
        else if(sec.demo==='mixer')body.appendChild(mkMixDemo());
        else if(sec.demo==='eq')body.appendChild(mkEQDemo())};
      hdr.addEventListener('click',()=>{const open=body.style.display!=='none';body.style.display=open?'none':'block';arrow.style.transform=open?'':'rotate(90deg)';hdr.style.borderColor=open?'var(--border)':LC+'40';if(!open)buildDemo()});
      if(si===0){body.style.display='block';arrow.style.transform='rotate(90deg)';hdr.style.borderColor=LC+'40';setTimeout(buildDemo,50)}
      wrap.append(hdr,body);content.appendChild(wrap)})
  }

  bd.append(nav,content);updateTabs();renderContent();
  m.destroy=()=>{_demoIntervals.forEach(t=>clearInterval(t));_resObs.disconnect()};
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}




// === MIDI MODULE ===
function addMidi(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('MIDI<span>.IN</span>','Controller','#10b981',200+(mods.length%4)*30,100+(mods.length%4)*20,520,480,ci);
  el.id='m'+id;el.style.minWidth='360px';
  const NN=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const MC='#10b981';
  const m={id,type:'midi',el,ci,ts:0,input:null,mappings:[],onStep:()=>{},clr:()=>{}};
  m.dst=()=>chs[m.ci].g||mGain;
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt();buildCards()});

  // --- TOP BAR: Status + Note + Transpose ---
  const topBar=document.createElement('div');topBar.style.cssText='display:flex;gap:4px;align-items:center;margin-bottom:4px;flex-wrap:wrap';
  const status=document.createElement('div');
  status.style.cssText='font-size:6px;color:var(--dim);padding:2px 6px;background:var(--s2);border:1px solid var(--border);border-radius:3px;flex:1;min-width:100px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis';
  status.textContent='\u23fb Waiting for MIDI...';
  const noteDisp=document.createElement('div');
  noteDisp.style.cssText='font-size:12px;font-weight:800;color:var(--dim);min-width:36px;text-align:center;padding:2px 4px;background:var(--s2);border:1px solid var(--border);border-radius:3px;transition:all .1s';
  noteDisp.textContent='--';
  const trLbl=document.createElement('span');trLbl.style.cssText='font-size:5px;color:var(--dim);font-weight:700';trLbl.textContent='TR';
  const trM=document.createElement('button');trM.className='pbtn';trM.textContent='-';
  const trV=document.createElement('span');trV.style.cssText='font-size:8px;color:'+MC+';font-weight:800;min-width:14px;text-align:center';trV.textContent='0';
  const trP=document.createElement('button');trP.className='pbtn';trP.textContent='+';
  let transpose=0;
  trM.addEventListener('click',()=>{transpose--;trV.textContent=transpose});
  trP.addEventListener('click',()=>{transpose++;trV.textContent=transpose});
  topBar.append(status,noteDisp,trLbl,trM,trV,trP);bd.appendChild(topBar);

  // Beta notice
  const betaNotice=document.createElement('div');
  betaNotice.style.cssText='font-size:5px;color:#f59e0b;background:#f59e0b10;border:1px solid #f59e0b30;border-radius:2px;padding:2px 5px;margin-bottom:4px;font-weight:700;letter-spacing:.3px';
  betaNotice.textContent='\u26a0 BETA ‚Äî CC mapping is experimental. Some controls may not respond as expected.';
  bd.appendChild(betaNotice);

  // --- PORTS ---
  const portWrap=document.createElement('div');portWrap.className='midi-ports';portWrap.style.marginBottom='4px';bd.appendChild(portWrap);

  // --- NOTE ROUTE ---
  const routeRow=document.createElement('div');routeRow.style.cssText='display:flex;gap:4px;align-items:center;margin-bottom:6px';
  const routeLbl=document.createElement('span');routeLbl.style.cssText='font-size:6px;color:var(--dim);font-weight:700';routeLbl.textContent='NOTE ROUTE:';
  const routeSel=document.createElement('select');
  routeSel.style.cssText='background:var(--s3);border:1px solid '+MC+'40;color:'+MC+';font-family:inherit;font-size:6px;font-weight:700;padding:2px 4px;border-radius:3px;cursor:pointer;outline:none;flex:1';
  routeSel.innerHTML='<option value="all">ALL (same ch)</option>';
  routeRow.append(routeLbl,routeSel);bd.appendChild(routeRow);

  // ============================================
  // CARD-BASED MAPPING
  // ============================================
  let activeLearn=null;

  const mapHdr=document.createElement('div');mapHdr.style.cssText='display:flex;align-items:center;gap:4px;margin-bottom:4px;border-top:1px solid var(--border);padding-top:6px;flex-wrap:wrap';
  const mapTitle=document.createElement('span');mapTitle.style.cssText='font-size:7px;font-weight:800;color:'+MC+';letter-spacing:1px';mapTitle.textContent='CC MAPPING';
  const mapSpacer=document.createElement('div');mapSpacer.style.flex='1';
  const mkPB=(txt,fn)=>{const b=document.createElement('button');b.className='pbtn';b.style.cssText+='font-size:5px;padding:2px 5px;border-color:'+MC+'50;color:'+MC;b.textContent=txt;b.addEventListener('click',fn);return b};
  const saveBtn=mkPB('\u2193 SAVE',()=>{
    if(!m.mappings.length)return;
    const p={_midiPreset:1,mappings:m.mappings.map(mp=>({cc:mp.cc,modType:mods.find(x=>x.id===mp.modId)?.type||'?',paramKey:mp.paramKey,paramName:mp.paramName,min:mp.min,max:mp.max})),transpose};
    const b=new Blob([JSON.stringify(p)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='midi-preset.json';a.click();URL.revokeObjectURL(a.href)});
  const loadInp=document.createElement('input');loadInp.type='file';loadInp.accept='.json';loadInp.style.cssText='position:absolute;left:-9999px;opacity:0;width:1px;height:1px';
  const loadBtn=mkPB('\u2191 LOAD',()=>loadInp.click());
  loadInp.addEventListener('change',()=>{if(!loadInp.files[0])return;const r=new FileReader();r.onload=e=>{try{
    const p=JSON.parse(e.target.result);if(!p._midiPreset)return;m.mappings=[];
    p.mappings.forEach(mp=>{const c=mods.filter(x=>x.type===mp.modType&&x.id!==id);if(c.length)m.mappings.push({cc:mp.cc,modId:c[0].id,paramKey:mp.paramKey,paramName:mp.paramName,min:mp.min,max:mp.max,lastVal:0})});
    if(p.transpose!==undefined){transpose=p.transpose;trV.textContent=transpose}buildCards()}catch(err){}};r.readAsText(loadInp.files[0]);loadInp.value=''});
  const copyBtn=mkPB('\u2398 COPY',()=>{if(!m.mappings.length)return;
    const p={_midiPreset:1,mappings:m.mappings.map(mp=>({cc:mp.cc,modType:mods.find(x=>x.id===mp.modId)?.type||'?',paramKey:mp.paramKey,paramName:mp.paramName,min:mp.min,max:mp.max})),transpose};
    navigator.clipboard.writeText(JSON.stringify(p)).then(()=>{copyBtn.textContent='\u2713';setTimeout(()=>{copyBtn.textContent='\u2398 COPY'},1200)})});
  const pasteBtn=mkPB('\u2399 PASTE',()=>{navigator.clipboard.readText().then(t=>{try{
    const p=JSON.parse(t);if(!p._midiPreset)return;m.mappings=[];
    p.mappings.forEach(mp=>{const c=mods.filter(x=>x.type===mp.modType&&x.id!==id);if(c.length)m.mappings.push({cc:mp.cc,modId:c[0].id,paramKey:mp.paramKey,paramName:mp.paramName,min:mp.min,max:mp.max,lastVal:0})});
    if(p.transpose!==undefined){transpose=p.transpose;trV.textContent=transpose}buildCards()}catch(err){}}).catch(()=>{})});
  const clearBtn=mkPB('\u2715 CLEAR',()=>{m.mappings=[];activeLearn=null;buildCards()});
  clearBtn.style.borderColor='#ef444450';clearBtn.style.color='#ef4444';
  mapHdr.append(mapTitle,mapSpacer,saveBtn,loadBtn,copyBtn,pasteBtn,clearBtn,loadInp);bd.appendChild(mapHdr);

  // Card container
  const cardWrap=document.createElement('div');cardWrap.style.cssText='display:flex;flex-direction:column;gap:4px;overflow-y:auto;flex:1;min-height:0;padding-bottom:4px';
  bd.appendChild(cardWrap);

  // Module params
  function getParams(mod){
    const p=[];
    // === CONTINUOUS (CC 0-127 maps to range) ===
    if(mod.vol!==undefined)p.push({key:'vol',name:'VOLUME',min:0,max:1,mode:'cc'});
    if(mod.ff!==undefined)p.push({key:'ff',name:'FILTER FREQ',min:20,max:18000,mode:'cc'});
    if(mod.fr!==undefined)p.push({key:'fr',name:'FILTER RES',min:0,max:10,mode:'cc'});
    if(mod.oct!==undefined)p.push({key:'oct',name:'OCTAVE',min:2,max:6,mode:'cc'});
    if(mod.det!==undefined)p.push({key:'det',name:'DETUNE',min:0,max:50,mode:'cc'});
    if(mod.a!==undefined)p.push({key:'a',name:'ATTACK',min:0,max:1,mode:'cc'});
    if(mod.d!==undefined)p.push({key:'d',name:'DECAY',min:0,max:1,mode:'cc'});
    if(mod.s!==undefined&&mod.type!=='beat')p.push({key:'s',name:'SUSTAIN',min:0,max:1,mode:'cc'});
    if(mod.r!==undefined)p.push({key:'r',name:'RELEASE',min:0,max:1,mode:'cc'});
    // Beat ‚Äî mute/solo toggles + volume per track
    if(mod.type==='beat'&&mod.ch){
      mod.ch.forEach((ch,i)=>{
        const nm=ch.n||'TR'+(i+1);
        p.push({key:'beat_m_'+i,name:nm+' MUTE',min:0,max:1,mode:'toggle'});
        p.push({key:'beat_s_'+i,name:nm+' SOLO',min:0,max:1,mode:'toggle'});
        p.push({key:'beat_v_'+i,name:nm+' VOL',min:0,max:1,mode:'cc'});
      });
    }
    // Drum ‚Äî mute/solo + synth + pattern switching
    if(mod.type==='drum'&&mod.parts){
      mod.parts.forEach((pt,i)=>{
        const nm=pt.name||'P'+(i+1);
        p.push({key:'drum_m_'+i,name:nm+' MUTE',min:0,max:1,mode:'toggle'});
        p.push({key:'drum_s_'+i,name:nm+' SOLO',min:0,max:1,mode:'toggle'});
        p.push({key:'drum_v_'+i,name:nm+' VOL',min:0,max:1,mode:'cc'});
        p.push({key:'drum_p_'+i,name:nm+' PITCH',min:-12,max:12,mode:'cc'});
        p.push({key:'drum_d_'+i,name:nm+' DECAY',min:.01,max:2,mode:'cc'});
      });
      p.push({key:'drum_pat_0',name:'PATTERN A',min:0,max:1,mode:'trigger'});
      p.push({key:'drum_pat_1',name:'PATTERN B',min:0,max:1,mode:'trigger'});
      p.push({key:'drum_pat_2',name:'PATTERN C',min:0,max:1,mode:'trigger'});
      p.push({key:'drum_pat_3',name:'PATTERN D',min:0,max:1,mode:'trigger'});
    }
    // FX ‚Äî toggle each effect on/off
    if(mod.type==='fx'){
      const FX_NAMES=['REVERB','DELAY','DISTORT','FILTER','CHORUS','PHASER','COMPRESS','BITCRUSH','VINYL','WOW/FLUT','LO-FI','SATURATE','TREMOLO','RING MOD','FLANGER','LIMITER','GATE','EQ','PITCH'];
      FX_NAMES.forEach((nm,i)=>{p.push({key:'fx_tog_'+i,name:nm,min:0,max:1,mode:'toggle'})});
    }
    // Sidechain
    if(mod.type==='sidechain'){
      p.push({key:'depth',name:'SC DEPTH',min:0,max:1,mode:'cc'});
      p.push({key:'attack',name:'SC ATTACK',min:1,max:50,mode:'cc'});
      p.push({key:'release',name:'SC RELEASE',min:10,max:500,mode:'cc'});
    }
    return p;
  }
  const TCOL={beat:'#e8364f',synth:'#22d3ee',piano:'#f472b6',bass:'#818cf8',note:'#10b981',drum:'#f97316',chord:'#d946ef',inst:'#d946ef',osc:'#60a5fa',sample:'#818cf8',auto:'#f59e0b',sidechain:'#f43f5e',fx:'#f59e0b'};

  function buildCards(){
    cardWrap.innerHTML='';
    // Channel card
    const chCard=mkCard('CHANNEL',MC);
    const chRow=document.createElement('div');chRow.style.cssText='display:flex;gap:4px';
    [{key:'ch_vol',name:'VOL',min:0,max:1,mode:'cc'},{key:'ch_bpm',name:'BPM',min:40,max:300,mode:'cc'},{key:'ch_swing',name:'SWING',min:0,max:100,mode:'cc'}].forEach(p=>{
      chRow.appendChild(mkKnob(id,p,MC))});
    chCard.appendChild(chRow);cardWrap.appendChild(chCard);

    // Module cards
    mods.filter(x=>x.id!==id).forEach(mod=>{
      const params=getParams(mod);if(!params.length)return;
      const col=TCOL[mod.type]||'var(--dim)';
      const card=mkCard(mod.type.toUpperCase()+' #'+mod.id+' CH'+(mod.ci+1),col);

      if(mod.type==='beat')buildBeatLayout(card,mod,params,col);
      else if(mod.type==='drum')buildDrumLayout(card,mod,params,col);
      else if(mod.type==='synth'||mod.type==='piano'||mod.type==='bass'||mod.type==='inst'||mod.type==='chord'||mod.type==='osc')buildSynthLayout(card,mod,params,col);
      else if(mod.type==='fx')buildFxLayout(card,mod,params,col);
      else if(mod.type==='sidechain')buildSidechainLayout(card,mod,params,col);
      else{const w=document.createElement('div');w.style.cssText='display:flex;gap:3px;flex-wrap:wrap';
        params.forEach(p=>w.appendChild(mkParamBtn(mod.id,p.key,p.name,p.min,p.max,col,p.mode)));card.appendChild(w)}
      cardWrap.appendChild(card);
    });
  }

  function mkCard(title,col){
    const c=document.createElement('div');c.style.cssText='background:var(--s2);border:1px solid var(--border);border-radius:4px;padding:6px 7px';
    const h=document.createElement('div');h.style.cssText='font-size:6px;font-weight:800;letter-spacing:.5px;margin-bottom:5px;display:flex;align-items:center;gap:4px;color:'+col;
    h.innerHTML='<span style="width:5px;height:5px;border-radius:50%;background:'+col+';display:inline-block"></span>'+title;
    c.appendChild(h);return c}
  function mkSec(label){
    const s=document.createElement('div');s.style.cssText='margin-top:5px';
    const l=document.createElement('div');l.style.cssText='font-size:4.5px;color:var(--dim);font-weight:800;letter-spacing:.8px;margin-bottom:3px;border-bottom:1px solid var(--border);padding-bottom:2px';
    l.textContent=label;s.appendChild(l);return s}

  // ========= BEAT ‚Äî mirror: [NAME][M][S][slider] per row =========
  function buildBeatLayout(card,mod,params,col){
    const BC_COL=['#e8364f','#22d3ee','#a855f7','#10b981','#f59e0b','#f97316','#818cf8','#ec4899'];
    if(!mod.ch)return;
    const grid=document.createElement('div');grid.style.cssText='display:grid;grid-template-columns:30px auto;gap:0;border:1px solid var(--border);border-radius:3px;overflow:hidden';
    mod.ch.forEach((ch,i)=>{
      const c=BC_COL[i%8]||col;
      // Left: name + controls
      const left=document.createElement('div');left.style.cssText='display:flex;align-items:center;gap:0;background:var(--s3);padding:1px 3px;border-bottom:1px solid var(--border)';
      const nm=document.createElement('div');nm.style.cssText='font-size:5px;font-weight:800;color:'+c+';width:30px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis';
      nm.textContent=ch.n||'TR'+(i+1);left.appendChild(nm);
      // Right: controls row
      const right=document.createElement('div');right.style.cssText='display:flex;align-items:center;gap:2px;padding:2px 3px;border-bottom:1px solid var(--border)';
      const mb=mkMiniBtn(mod.id,'beat_m_'+i,'M','toggle',c);
      const sb=mkMiniBtn(mod.id,'beat_s_'+i,'S','toggle',c);
      // Volume as a mini slider representation
      const vb=mkSliderBtn(mod.id,'beat_v_'+i,'cc',c);
      right.append(mb,sb,vb);
      grid.append(left,right);
    });
    card.appendChild(grid);
  }

  // ========= SYNTH/PIANO/BASS ‚Äî mirror: OSC | ENV | FLT sections =========
  function buildSynthLayout(card,mod,params,col){
    const find=k=>params.find(x=>x.key===k);
    // OSC section
    const hasOsc=find('det')||find('oct')||find('vol');
    if(hasOsc){
      const sec=mkSec('OSC');const row=document.createElement('div');row.style.cssText='display:flex;gap:4px;flex-wrap:wrap';
      if(find('det'))row.appendChild(mkKnob(mod.id,find('det'),col));
      if(find('oct'))row.appendChild(mkKnob(mod.id,find('oct'),col));
      sec.appendChild(row);card.appendChild(sec);
    }
    // ENV section
    const envKeys=['a','d','s','r'];
    if(envKeys.some(k=>find(k))){
      const sec=mkSec('ENVELOPE');const row=document.createElement('div');row.style.cssText='display:flex;gap:4px';
      envKeys.forEach(k=>{const p=find(k);if(p)row.appendChild(mkKnob(mod.id,p,col))});
      sec.appendChild(row);card.appendChild(sec);
    }
    // FLT section
    const fltKeys=['ff','fr','vol'];
    if(fltKeys.some(k=>find(k))){
      const sec=mkSec('FILTER / OUTPUT');const row=document.createElement('div');row.style.cssText='display:flex;gap:4px';
      fltKeys.forEach(k=>{const p=find(k);if(p)row.appendChild(mkKnob(mod.id,p,col))});
      sec.appendChild(row);card.appendChild(sec);
    }
  }

  // ========= DRUM ‚Äî part rows + pattern bank =========
  function buildDrumLayout(card,mod,params,col){
    if(!mod.parts)return;
    const grid=document.createElement('div');grid.style.cssText='display:grid;grid-template-columns:36px auto;gap:0;border:1px solid var(--border);border-radius:3px;overflow:hidden';
    mod.parts.forEach((pt,i)=>{
      const nm=pt.name||'P'+(i+1);
      const left=document.createElement('div');left.style.cssText='display:flex;align-items:center;padding:1px 3px;background:var(--s3);border-bottom:1px solid var(--border)';
      const nl=document.createElement('div');nl.style.cssText='font-size:4.5px;font-weight:800;color:'+col+';white-space:nowrap;overflow:hidden;text-overflow:ellipsis';
      nl.textContent=nm;left.appendChild(nl);
      const right=document.createElement('div');right.style.cssText='display:flex;align-items:center;gap:2px;padding:2px 3px;border-bottom:1px solid var(--border)';
      right.append(
        mkMiniBtn(mod.id,'drum_m_'+i,'M','toggle',col),
        mkMiniBtn(mod.id,'drum_s_'+i,'S','toggle',col),
        mkMiniBtn(mod.id,'drum_v_'+i,'VOL','cc',col),
        mkMiniBtn(mod.id,'drum_p_'+i,'PIT','cc',col),
        mkMiniBtn(mod.id,'drum_d_'+i,'DEC','cc',col));
      grid.append(left,right);
    });
    card.appendChild(grid);
    // Pattern bank
    const sec=mkSec('PATTERNS');const row=document.createElement('div');row.style.cssText='display:flex;gap:3px';
    ['A','B','C','D'].forEach((l,i)=>{row.appendChild(mkMiniBtn(mod.id,'drum_pat_'+i,l,'trigger',col))});
    sec.appendChild(row);card.appendChild(sec);
  }

  // ========= FX ‚Äî 3-col grid mirroring the actual FX unit layout =========
  function buildFxLayout(card,mod,params,col){
    const grid=document.createElement('div');grid.style.cssText='display:grid;grid-template-columns:repeat(3,1fr);gap:2px';
    params.forEach(p=>{
      const btn=mkMiniBtn(mod.id,p.key,p.name,p.mode,col);
      btn.style.height='22px';btn.style.fontSize='5px';
      grid.appendChild(btn);
    });
    card.appendChild(grid);
  }

  // ========= SIDECHAIN ‚Äî knobs =========
  function buildSidechainLayout(card,mod,params,col){
    const row=document.createElement('div');row.style.cssText='display:flex;gap:4px';
    params.forEach(p=>row.appendChild(mkKnob(mod.id,p,col)));
    card.appendChild(row);
  }

  // --- Mini button (for grids/rows) ---
  function mkMiniBtn(modId,paramKey,label,mode,col){
    const btn=document.createElement('button');
    const mapping=m.mappings.find(mp=>mp.modId===modId&&mp.paramKey===paramKey);
    const isActive=activeLearn&&activeLearn.modId===modId&&activeLearn.paramKey===paramKey;
    const params=getParams(mods.find(x=>x.id===modId)||{type:''});
    const p=params.find(x=>x.key===paramKey)||{min:0,max:1,mode:mode};
    if(mapping){
      btn.style.cssText='position:relative;overflow:hidden;background:'+MC+'20;border:1px solid '+MC+';color:'+MC+';font-family:inherit;font-size:5px;font-weight:800;padding:2px 4px;border-radius:2px;cursor:pointer;min-width:22px;text-align:center;line-height:1.2';
      btn.textContent='CC'+mapping.cc;
      const fill=document.createElement('div');fill.style.cssText='position:absolute;left:0;bottom:0;height:2px;background:'+MC+';width:'+(mapping.lastVal||0)+'%;transition:width .08s';
      btn.appendChild(fill);mapping._fill=fill;
      btn.addEventListener('click',()=>{const i=m.mappings.findIndex(mp=>mp.modId===modId&&mp.paramKey===paramKey);if(i>=0)m.mappings.splice(i,1);buildCards()});
    }else if(isActive){
      btn.style.cssText='background:'+MC+';border:1px solid '+MC+';color:#fff;font-family:inherit;font-size:5px;font-weight:800;padding:2px 4px;border-radius:2px;cursor:pointer;min-width:22px;text-align:center;animation:midiPulse .8s infinite;line-height:1.2';
      btn.textContent='\u25cf';
      btn.addEventListener('click',()=>{activeLearn=null;buildCards()});
    }else{
      const bdr=mode==='toggle'?'#f59e0b30':mode==='trigger'?'#a855f730':'var(--border)';
      const tc=mode==='toggle'?'#f59e0b':mode==='trigger'?'#a855f7':'var(--dim)';
      btn.style.cssText='background:var(--s3);border:1px solid '+bdr+';color:'+tc+';font-family:inherit;font-size:5px;font-weight:700;padding:2px 4px;border-radius:2px;cursor:pointer;transition:all .1s;min-width:22px;text-align:center;line-height:1.2';
      btn.textContent=label;
      btn.addEventListener('mouseenter',()=>{btn.style.borderColor=MC;btn.style.color='var(--text)'});
      btn.addEventListener('mouseleave',()=>{btn.style.borderColor=bdr;btn.style.color=tc});
      btn.addEventListener('click',()=>{activeLearn={modId,paramKey,paramName:label,min:p.min,max:p.max,mode:p.mode};buildCards()});
    }
    return btn;
  }

  // --- Volume slider representation ---
  function mkSliderBtn(modId,paramKey,mode,col){
    const wrap=document.createElement('div');wrap.style.cssText='flex:1;height:12px;position:relative;cursor:pointer;min-width:40px';
    const mapping=m.mappings.find(mp=>mp.modId===modId&&mp.paramKey===paramKey);
    const isActive=activeLearn&&activeLearn.modId===modId&&activeLearn.paramKey===paramKey;
    const params=getParams(mods.find(x=>x.id===modId)||{type:''});
    const p=params.find(x=>x.key===paramKey)||{min:0,max:1,mode:'cc'};
    const track=document.createElement('div');track.style.cssText='position:absolute;top:4px;left:0;right:0;height:4px;background:var(--s3);border-radius:2px;border:1px solid var(--border)';
    if(mapping){
      track.style.borderColor=MC;
      const fill=document.createElement('div');fill.style.cssText='position:absolute;left:0;top:0;height:100%;background:'+MC+';width:'+(mapping.lastVal||0)+'%;border-radius:2px;transition:width .08s';
      track.appendChild(fill);mapping._fill=fill;
      const lbl=document.createElement('div');lbl.style.cssText='position:absolute;right:0;top:-1px;font-size:4.5px;color:'+MC+';font-weight:800';lbl.textContent='CC'+mapping.cc;
      wrap.appendChild(lbl);
      wrap.addEventListener('click',()=>{const i=m.mappings.findIndex(mp=>mp.modId===modId&&mp.paramKey===paramKey);if(i>=0)m.mappings.splice(i,1);buildCards()});
    }else if(isActive){
      track.style.borderColor=MC;track.style.background=MC+'40';
      const lbl=document.createElement('div');lbl.style.cssText='position:absolute;left:50%;top:0;transform:translateX(-50%);font-size:5px;color:#fff;font-weight:800;animation:midiPulse .8s infinite';lbl.textContent='\u25cf';
      wrap.appendChild(lbl);
      wrap.addEventListener('click',()=>{activeLearn=null;buildCards()});
    }else{
      wrap.addEventListener('mouseenter',()=>{track.style.borderColor=MC+'80'});
      wrap.addEventListener('mouseleave',()=>{track.style.borderColor='var(--border)'});
      wrap.addEventListener('click',()=>{activeLearn={modId,paramKey,paramName:'VOL',min:p.min,max:p.max,mode:'cc'};buildCards()});
    }
    wrap.appendChild(track);return wrap;
  }

  // --- Knob representation ---
  function mkKnob(modId,p,col){
    const wrap=document.createElement('div');wrap.style.cssText='display:flex;flex-direction:column;align-items:center;gap:1px';
    const lbl=document.createElement('div');lbl.style.cssText='font-size:4.5px;color:var(--dim);font-weight:700;letter-spacing:.3px;text-align:center;white-space:nowrap';
    lbl.textContent=p.name;
    const mapping=m.mappings.find(mp=>mp.modId===modId&&mp.paramKey===p.key);
    const isActive=activeLearn&&activeLearn.modId===modId&&activeLearn.paramKey===p.key;
    const knob=document.createElement('div');
    if(mapping){
      knob.style.cssText='width:26px;height:26px;border-radius:50%;border:2px solid '+MC+';background:'+MC+'15;display:flex;align-items:center;justify-content:center;font-size:5px;font-weight:800;color:'+MC+';cursor:pointer;position:relative;overflow:hidden';
      knob.textContent='CC'+mapping.cc;
      const fill=document.createElement('div');fill.style.cssText='position:absolute;bottom:0;left:0;right:0;height:'+(mapping.lastVal||0)+'%;background:'+MC+'30;transition:height .08s;border-radius:0 0 50% 50%';
      knob.appendChild(fill);mapping._fill={style:{set width(v){fill.style.height=v}}};
      // Override fill update to use height
      Object.defineProperty(mapping,'_fill',{value:{style:fill.style},writable:true});
      knob.addEventListener('click',()=>{const i=m.mappings.findIndex(mp=>mp.modId===modId&&mp.paramKey===p.key);if(i>=0)m.mappings.splice(i,1);buildCards()});
    }else if(isActive){
      knob.style.cssText='width:26px;height:26px;border-radius:50%;border:2px solid '+MC+';background:'+MC+';display:flex;align-items:center;justify-content:center;font-size:8px;color:#fff;cursor:pointer;animation:midiPulse .8s infinite';
      knob.textContent='\u25cf';
      knob.addEventListener('click',()=>{activeLearn=null;buildCards()});
    }else{
      knob.style.cssText='width:26px;height:26px;border-radius:50%;border:2px solid var(--border);background:var(--s3);display:flex;align-items:center;justify-content:center;font-size:8px;color:var(--dim);cursor:pointer;transition:all .12s';
      knob.textContent='\u25cb';
      knob.addEventListener('mouseenter',()=>{knob.style.borderColor=MC+'80';knob.style.color='var(--text)'});
      knob.addEventListener('mouseleave',()=>{knob.style.borderColor='var(--border)';knob.style.color='var(--dim)'});
      knob.addEventListener('click',()=>{activeLearn={modId,paramKey:p.key,paramName:p.name,min:p.min,max:p.max,mode:p.mode};buildCards()});
    }
    wrap.append(lbl,knob);return wrap;
  }

  function mkParamBtn(modId,paramKey,paramName,min,max,col,mode){
    const btn=document.createElement('button');
    const mapping=m.mappings.find(mp=>mp.modId===modId&&mp.paramKey===paramKey);
    const isActive=activeLearn&&activeLearn.modId===modId&&activeLearn.paramKey===paramKey;
    const icon=mode==='toggle'?'\u25c6 ':mode==='trigger'?'\u25b6 ':'\u25cf ';
    const modeTag=mode==='toggle'?' [TOG]':mode==='trigger'?' [BTN]':'';
    if(mapping){
      btn.style.cssText='position:relative;overflow:hidden;background:var(--s3);border:1px solid '+MC+';color:#fff;font-family:inherit;font-size:5.5px;font-weight:800;padding:3px 6px;border-radius:3px;cursor:pointer;transition:all .12s;letter-spacing:.3px;min-width:50px;text-align:center';
      btn.textContent=paramName+' [CC'+mapping.cc+']';
      const fill=document.createElement('div');fill.style.cssText='position:absolute;left:0;bottom:0;height:2px;background:'+MC+';width:'+(mapping.lastVal||0)+'%;transition:width .1s;border-radius:0 0 3px 3px';
      btn.appendChild(fill);mapping._fill=fill;
      btn.addEventListener('click',()=>{const i=m.mappings.findIndex(mp=>mp.modId===modId&&mp.paramKey===paramKey);if(i>=0)m.mappings.splice(i,1);buildCards()});
    }else if(isActive){
      btn.style.cssText='background:'+MC+';border:1px solid '+MC+';color:#fff;font-family:inherit;font-size:5.5px;font-weight:800;padding:3px 6px;border-radius:3px;cursor:pointer;letter-spacing:.3px;min-width:44px;text-align:center;animation:midiPulse .8s infinite';
      btn.textContent='\u25cf '+paramName+'...';
      btn.addEventListener('click',()=>{activeLearn=null;buildCards()});
    }else{
      const borderCol=mode==='toggle'?'#f59e0b40':mode==='trigger'?'#a855f740':'var(--border)';
      const textCol=mode==='toggle'?'#f59e0b':mode==='trigger'?'#a855f7':'var(--dim)';
      btn.style.cssText='background:var(--s3);border:1px solid '+borderCol+';color:'+textCol+';font-family:inherit;font-size:5.5px;font-weight:700;padding:3px 6px;border-radius:3px;cursor:pointer;transition:all .12s;letter-spacing:.3px;min-width:44px;text-align:center';
      btn.textContent=paramName+modeTag;
      btn.addEventListener('mouseenter',()=>{btn.style.borderColor=MC+'80';btn.style.color='var(--text)'});
      btn.addEventListener('mouseleave',()=>{btn.style.borderColor=borderCol;btn.style.color=textCol});
      btn.addEventListener('click',()=>{activeLearn={modId,paramKey,paramName,min,max,mode};buildCards()});
    }
    return btn;
  }

  if(!document.getElementById('midiPulseCSS')){const s=document.createElement('style');s.id='midiPulseCSS';s.textContent='@keyframes midiPulse{0%,100%{opacity:1}50%{opacity:.6}}';document.head.appendChild(s)}

  // --- LOG ---
  const log=document.createElement('div');log.className='midi-log';log.style.cssText+='margin-top:4px;max-height:36px';
  log.textContent='Tap a param, then move a CC on your controller.';
  bd.appendChild(log);
  function addLog(msg){const t=document.createElement('div');t.textContent=new Date().toLocaleTimeString().slice(0,-3)+' '+msg;log.prepend(t);if(log.children.length>20)log.removeChild(log.lastChild)}

  // --- NOTE ROUTING ---
  function routeNote(note,vel,on){
    const adj=note+transpose;const tgt=routeSel.value;
    const ts=tgt==='all'?mods.filter(x=>x.ci===m.ci&&x.id!==id):mods.filter(x=>x.id===+tgt);
    ts.forEach(mod=>{if(on){if(mod.play)mod.play(adj%128,vel/127);else if(mod.playFreq)mod.playFreq(440*Math.pow(2,(adj-69)/12),vel/127)}
      else{if(mod.stop)mod.stop(adj%128);else if(mod.stopN)mod.stopN(adj%128)}});
    if(on){noteDisp.textContent=NN[adj%12]+(Math.floor(adj/12)-1);noteDisp.style.color=MC;noteDisp.style.borderColor=MC;noteDisp.style.background='rgba(16,185,129,.08)'}
    else{noteDisp.style.color='var(--dim)';noteDisp.style.borderColor='var(--border)';noteDisp.style.background='var(--s2)'}
  }

  // --- CC ROUTING ---
  function routeCC(cc,val){
    addLog('CC'+cc+' = '+val);const norm=val/127;
    if(activeLearn){const al=activeLearn;activeLearn=null;
      let i=m.mappings.findIndex(x=>x.cc===cc);if(i>=0)m.mappings.splice(i,1);
      i=m.mappings.findIndex(x=>x.modId===al.modId&&x.paramKey===al.paramKey);if(i>=0)m.mappings.splice(i,1);
      m.mappings.push({cc,modId:al.modId,paramKey:al.paramKey,paramName:al.paramName,min:al.min,max:al.max,lastVal:norm*100});
      addLog('\u2713 CC'+cc+' \u2192 '+al.paramName);buildCards();return}
    let handled=false;
    m.mappings.forEach(mp=>{if(mp.cc!==cc)return;handled=true;
      const mod=mods.find(x=>x.id===mp.modId);const v=mp.min+(mp.max-mp.min)*norm;mp.lastVal=norm*100;if(mp._fill)mp._fill.style.width=mp.lastVal+'%';
      const pk=mp.paramKey;const isOn=val>63;
      // Channel-level
      if(pk==='ch_vol'){const chi=mod?mod.ci:m.ci;if(chs[chi]&&chs[chi].g)chs[chi].g.gain.setTargetAtTime(norm,ctx.currentTime,.02)}
      else if(pk==='ch_swing'){const chi=mod?mod.ci:m.ci;if(chs[chi])chs[chi].sw=Math.round(norm*100)}
      else if(pk==='ch_bpm'){}
      // Beat mute/solo/volume
      else if(pk.startsWith('beat_')&&mod&&mod.ch){
        const parts=pk.split('_');const what=parts[1];const ti=+parts[2];
        if(mod.ch[ti]){
          if(what==='m'&&isOn&&!mp._lastOn){mod.ch[ti].mut=!mod.ch[ti].mut;
            const btn=mod.el.querySelectorAll('.bm')[ti];if(btn)btn.classList.toggle('muted',mod.ch[ti].mut)}
          else if(what==='s'&&isOn&&!mp._lastOn){mod.ch[ti].solo=!mod.ch[ti].solo;
            const btn=mod.el.querySelectorAll('.bs_btn')[ti];if(btn)btn.classList.toggle('soloed',mod.ch[ti].solo)}
          else if(what==='v'){mod.ch[ti].v=v;const sl=mod.el.querySelectorAll('.bv')[ti];if(sl)sl.value=v*100}
        }mp._lastOn=isOn;
      }
      // Drum mute/solo/vol/pitch/decay + pattern
      else if(pk.startsWith('drum_')&&mod){
        const parts=pk.split('_');const what=parts[1];const ti=+parts[2];
        if(what==='pat'&&isOn&&!mp._lastOn){
          // Switch drum pattern
          const patBtns=mod.el.querySelectorAll('.stog button');
          if(patBtns[ti])patBtns[ti].click();
        }else if(mod.parts&&mod.parts[ti]){
          if(what==='m'&&isOn&&!mp._lastOn){mod.parts[ti].mut=!mod.parts[ti].mut;if(mod.buildGrid)mod.buildGrid()}
          else if(what==='s'&&isOn&&!mp._lastOn){mod.parts[ti].solo=!mod.parts[ti].solo;if(mod.buildGrid)mod.buildGrid()}
          else if(what==='v')mod.parts[ti].v=v;
          else if(what==='p')mod.parts[ti].pitch=v;
          else if(what==='d')mod.parts[ti].decay=v;
        }mp._lastOn=isOn;
      }
      // FX toggle
      else if(pk.startsWith('fx_tog_')&&mod&&isOn&&!mp._lastOn){
        const ti=+pk.split('_')[2];
        const toggles=mod.el.querySelectorAll('.fxsw');
        if(toggles[ti])toggles[ti].click();
        mp._lastOn=isOn;
      }
      // Direct module property (synth params, sidechain, etc)
      else{if(mod&&mod[pk]!==undefined)mod[pk]=v;mp._lastOn=isOn}
    });
    if(!handled){if(cc===7){chs[m.ci].vol=val/127*100;if(chs[m.ci].g)chs[m.ci].g.gain.value=val/127;updMx()}
      if(cc===1){mods.filter(x=>x.ci===m.ci&&x.ff!==undefined).forEach(mod=>{mod.ff=50+val/127*18000})}}
  }

  function onMsg(e){const[st,d1,d2]=e.data;const cmd=st>>4;
    if(cmd===9&&d2>0){routeNote(d1,d2,true);addLog('ON '+NN[d1%12]+(Math.floor(d1/12)-1)+' v'+d2)}
    else if(cmd===8||(cmd===9&&d2===0)){routeNote(d1,0,false);addLog('OFF '+NN[d1%12]+(Math.floor(d1/12)-1))}
    else if(cmd===11){routeCC(d1,d2)}
    else if(cmd===14){addLog('BEND '+(((d2<<7)|d1)-8192))}}

  function refreshTargets(){while(routeSel.options.length>1)routeSel.remove(1);
    mods.filter(x=>x.ci===m.ci&&x.id!==id&&(x.play||x.playFreq)).forEach(mod=>{
      const o=document.createElement('option');o.value=mod.id;o.textContent=mod.type.toUpperCase()+' #'+mod.id;routeSel.appendChild(o)})}
  const intv=setInterval(()=>{refreshTargets();buildCards()},4000);
  setTimeout(()=>{refreshTargets();buildCards()},100);

  if(navigator.requestMIDIAccess){
    navigator.requestMIDIAccess({sysex:false}).then(access=>{
      status.textContent='\u2713 MIDI ready';status.style.color=MC;
      function refreshPorts(){portWrap.innerHTML='';
        access.inputs.forEach(inp=>{const p=document.createElement('div');p.className='midi-port'+(m.input===inp?' connected':'');
          p.innerHTML='<span class="mp-dot"></span>'+inp.name;
          p.addEventListener('click',()=>{if(m.input)m.input.onmidimessage=null;m.input=inp;inp.onmidimessage=onMsg;initA();
            portWrap.querySelectorAll('.midi-port').forEach(x=>x.classList.remove('connected'));p.classList.add('connected');
            status.textContent='\u25cf '+inp.name;addLog('Connected: '+inp.name)});portWrap.appendChild(p)});
        if(!access.inputs.size){const np=document.createElement('div');np.style.cssText='font-size:6px;color:var(--dim);padding:3px';np.textContent='No MIDI devices. Plug in a controller.';portWrap.appendChild(np)}}
      refreshPorts();access.onstatechange=()=>refreshPorts();
      if(access.inputs.size>0){const first=access.inputs.values().next().value;
        if(first){m.input=first;first.onmidimessage=onMsg;status.textContent='\u25cf '+first.name;status.style.color=MC;setTimeout(refreshPorts,100)}}
    }).catch(e=>{status.textContent='\u26a0 '+e.message;status.style.color='#ef4444'});
  }else{status.textContent='\u26a0 Web MIDI not supported';status.style.color='#ef4444'}

  m.destroy=()=>{if(m.input)m.input.onmidimessage=null;clearInterval(intv)};
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}


// === TRACKS MODULE ‚Äî freeform DAW-style track arranger ===
function addTracks(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('TRACKS<span>.EXE</span>','Tracks',CHR[ci],30,30,1100,600,ci);
  el.id='m'+id;el.style.minWidth='750px';el.style.minHeight='400px';
  el.style.setProperty('--ac',CHR[ci]);el.style.setProperty('--ac-bright',CHR[ci]);
  bd.style.display='flex';bd.style.flexDirection='column';bd.style.overflow='hidden';
  const COLORS=['#e8364f','#22d3ee','#a855f7','#10b981','#f59e0b','#f97316','#ec4899','#818cf8','#34d399','#fbbf24','#fb923c','#06b6d4'];
  let ppb=60;
  const TRACK_H=56;
  const m={id,type:'arrange',el,ci,ts:0,tracks:[],playing:false,playStart:0,bpm:120,
    onStep:(s,t)=>{if(!m.playing&&m.tracks.length){initA();routeBusesToChannel();playAll_arr(0)}},
    clr:()=>{if(m.playing)stopAll_arr(false)}};
  m.dst=()=>chs[m.ci].g||mGain;
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);el.style.setProperty('--ac',CHR[m.ci]);el.style.setProperty('--ac-bright',CHR[m.ci]);filt()});

  // === CONTROLS BAR ===
  const ctrl=document.createElement('div');ctrl.className='arr-ctrl';
  // Transport group
  const transport=document.createElement('div');transport.className='arr-transport';
  const playBtn=document.createElement('button');playBtn.className='arr-tbtn play';playBtn.title='Play';playBtn.innerHTML='&#9654;';
  const pauseBtn=document.createElement('button');pauseBtn.className='arr-tbtn pause';pauseBtn.title='Pause';pauseBtn.innerHTML='&#10074;&#10074;';pauseBtn.style.display='none';
  const stopBtn=document.createElement('button');stopBtn.className='arr-tbtn stop';stopBtn.title='Stop';stopBtn.innerHTML='&#9632;';
  transport.append(playBtn,pauseBtn,stopBtn);
  // Time display
  const timeDisp=document.createElement('div');timeDisp.className='arr-time';timeDisp.textContent='0:00.0';
  // BPM param
  const bpmParam=document.createElement('div');bpmParam.className='arr-param';
  const bpmLbl=document.createElement('label');bpmLbl.textContent='BPM';
  const bpmInp=document.createElement('input');bpmInp.type='number';bpmInp.value=120;bpmInp.min=30;bpmInp.max=300;bpmInp.style.width='44px';bpmInp.style.textAlign='center';
  bpmInp.addEventListener('change',()=>{
    const newBpm=Math.max(30,Math.min(300,+bpmInp.value));bpmInp.value=newBpm;
    if(newBpm===m.bpm)return;
    const ratio=newBpm/m.bpm;
    // Rescale all beat positions so real-time stays the same
    // (clip at 2.0s stays at 2.0s, but its beat number changes)
    m.tracks.forEach(t=>t.clips.forEach(c=>{c.startBeat*=ratio;c.durBeats*=ratio}));
    needleBeat*=ratio;
    m.bpm=newBpm;
    render();setNeedle(needleBeat);
  });
  bpmParam.append(bpmLbl,bpmInp);
  // Snap param
  const snapParam=document.createElement('div');snapParam.className='arr-param';
  const snapLb=document.createElement('label');snapLb.textContent='SNAP';
  const snapSel=document.createElement('select');snapSel.style.width='48px';
  [{v:0,t:'OFF'},{v:.25,t:'1/4'},{v:.5,t:'1/2'},{v:1,t:'BAR'},{v:2,t:'2B'},{v:4,t:'4B'}].forEach(s=>{
    const o=document.createElement('option');o.value=s.v;o.textContent=s.t;snapSel.appendChild(o)});
  snapSel.value='0.25';snapParam.append(snapLb,snapSel);
  // Zoom
  const zoomWrap=document.createElement('div');zoomWrap.className='arr-zoom';
  const zoomLbl=document.createElement('span');zoomLbl.textContent='ZOOM';
  const zoomOut=document.createElement('button');zoomOut.className='arr-fxbtn';zoomOut.textContent='\u2013';zoomOut.style.cssText+='width:22px;padding:3px 0;text-align:center;font-size:12px';
  const zoomIn=document.createElement('button');zoomIn.className='arr-fxbtn';zoomIn.textContent='+';zoomIn.style.cssText+='width:22px;padding:3px 0;text-align:center;font-size:12px';
  zoomOut.addEventListener('click',()=>{ppb=Math.max(15,ppb-15);render()});
  zoomIn.addEventListener('click',()=>{ppb=Math.min(200,ppb+15);render()});
  zoomWrap.append(zoomLbl,zoomOut,zoomIn);
  const sep1=document.createElement('div');sep1.className='arr-sep';
  const sep2=document.createElement('div');sep2.className='arr-sep';
  // Track + Import
  const addTrackBtn=document.createElement('button');addTrackBtn.className='arr-fxbtn';addTrackBtn.textContent='+ TRACK';
  addTrackBtn.addEventListener('click',()=>{addTrack('Track '+(m.tracks.length+1));render()});
  const impBtn=document.createElement('button');impBtn.className='arr-fxbtn';impBtn.style.cssText+='border-color:rgba(20,184,166,.2);color:rgba(20,184,166,.6)';
  impBtn.textContent='\u2b06 IMPORT';
  const fin=document.createElement('input');fin.type='file';fin.accept='audio/*,.wav,.mp3,.m4a,.aac,.ogg,.flac,.aiff,.caf';fin.multiple=true;fin.style.cssText='position:absolute;left:-9999px;opacity:0;width:1px;height:1px';
  impBtn.addEventListener('click',()=>fin.click());
  fin.addEventListener('change',()=>{if(fin.files.length)loadFiles(fin.files);fin.value=''});
  ctrl.append(transport,timeDisp,sep1,bpmParam,snapParam,sep2,zoomWrap,addTrackBtn,impBtn);
  bd.appendChild(ctrl);bd.appendChild(fin);

  // === TIMELINE ===
  const timeline=document.createElement('div');timeline.className='arr-timeline';
  const tlInner=document.createElement('div');tlInner.className='arr-inner';
  const playhead=document.createElement('div');playhead.className='arr-playhead';
  playhead.innerHTML='<div class="arr-ph-head"></div><div class="arr-ph-line"></div><div class="arr-ph-glow"></div>';
  tlInner.appendChild(playhead);
  timeline.appendChild(tlInner);
  let needleBeat=0;
  const HDW=140; // track header width
  function setNeedle(beat){needleBeat=Math.max(0,beat);playhead.style.left=(HDW+beatsToPx(needleBeat))+'px';updTimeDisp()}
  function mouseEvToBeat(ev){const rect=tlInner.getBoundingClientRect();return Math.max(0,(ev.clientX-rect.left-HDW)/ppb)}
  // Needle dragging
  let _ndDrag=false;
  playhead.addEventListener('mousedown',e=>{
    e.stopPropagation();e.preventDefault();_ndDrag=true;playhead.classList.add('dragging');
    const wasPl=m.playing;if(wasPl){m.playing=false;playSrcs.forEach(s=>{try{s.stop()}catch(e){}});playSrcs=[];playBtn.style.display='';pauseBtn.style.display='none'}
    const onM=ev=>{setNeedle(mouseEvToBeat(ev))};
    const onU=()=>{window.removeEventListener('mousemove',onM);window.removeEventListener('mouseup',onU);
      _ndDrag=false;playhead.classList.remove('dragging');
      if(wasPl){playAll_arr(needleBeat*(60/m.bpm))}
    };
    window.addEventListener('mousemove',onM);window.addEventListener('mouseup',onU);
  });
  timeline.addEventListener('dragover',e=>{e.preventDefault();timeline.style.borderColor=CHR[m.ci]||'#14b8a6'});
  timeline.addEventListener('dragleave',()=>{timeline.style.borderColor=''});
  timeline.addEventListener('drop',e=>{e.preventDefault();timeline.style.borderColor='';if(e.dataTransfer.files.length)loadFiles(e.dataTransfer.files)});
  timeline.addEventListener('wheel',e=>{if(e.ctrlKey||e.metaKey){e.preventDefault();const op=ppb;ppb=Math.max(15,Math.min(200,ppb+(e.deltaY<0?8:-8)));if(ppb!==op){setNeedle(needleBeat);render()}}},{passive:false});
  // Click to place needle / seek
  timeline.addEventListener('mousedown',e=>{
    if(_ndDrag||e.target.closest('.arr-clip')||e.target.closest('.arr-track-hd')||e.target.closest('.arr-playhead'))return;
    // Ignore clicks on scrollbar area or interactive elements
    if(e.target===timeline){const rect=timeline.getBoundingClientRect();if(e.clientY>rect.bottom-16)return;if(e.clientX>rect.right-16)return}
    if(e.target.closest('input,button,select'))return;
    const beat=mouseEvToBeat(e);
    if(beat<0)return;
    setNeedle(beat);
    if(m.playing){playSrcs.forEach(s=>{try{s.stop()}catch(e){}});playSrcs=[];m.playing=false;playAll_arr(needleBeat*(60/m.bpm))}
  });
  bd.appendChild(timeline);

  // === TOOLSTRIP ===
  const tools=document.createElement('div');tools.className='arr-tools';
  // --- Clip Actions group ---
  const actGrp=document.createElement('div');actGrp.className='arr-tool-grp';
  const actLbl=document.createElement('div');actLbl.className='arr-tool-grp-label';actLbl.textContent='CLIP';actGrp.appendChild(actLbl);
  const actRow=document.createElement('div');actRow.className='arr-tool-row';
  ['Reverse','Normalize','Silence'].forEach(name=>{
    const b=document.createElement('button');b.className='arr-tool-btn';b.textContent=name;
    b.addEventListener('click',()=>applyClipFx(name));actRow.appendChild(b)});
  const dupBtn=document.createElement('button');dupBtn.className='arr-tool-btn';dupBtn.textContent='\u2750 Dup';
  dupBtn.addEventListener('click',()=>{if(!selectedClip)return;
    const c=selectedClip;const t=m.tracks.find(t=>t.clips.includes(c));if(!t)return;
    const nc={buf:c.buf,name:c.name+' copy',startBeat:c.startBeat+c.durBeats,durBeats:c.durBeats,offset:c.offset||0,vol:c.vol,color:c.color};
    t.clips.push(nc);selectedClip=nc;render()});
  actRow.appendChild(dupBtn);
  const delClipBtn=document.createElement('button');delClipBtn.className='arr-tool-btn';delClipBtn.textContent='\u2717 Del';delClipBtn.style.cssText='border-color:rgba(239,68,68,.2);color:rgba(239,68,68,.5)';
  delClipBtn.addEventListener('click',()=>{if(!selectedClip)return;m.tracks.forEach(t=>{const i=t.clips.indexOf(selectedClip);if(i>=0)t.clips.splice(i,1)});selectedClip=null;render()});
  actRow.appendChild(delClipBtn);actGrp.appendChild(actRow);tools.appendChild(actGrp);
  // --- Fade group ---
  const fadeGrp=document.createElement('div');fadeGrp.className='arr-tool-grp';
  const fadeLbl=document.createElement('div');fadeLbl.className='arr-tool-grp-label';fadeLbl.textContent='FADE';fadeGrp.appendChild(fadeLbl);
  let fadeDur=0.5;
  const fadeRow=document.createElement('div');fadeRow.className='arr-tool-row';
  const fadeDurLbl=document.createElement('label');fadeDurLbl.textContent='Dur';
  const fadeDurSlider=document.createElement('input');fadeDurSlider.type='range';fadeDurSlider.min='0.05';fadeDurSlider.max='5';fadeDurSlider.step='0.05';fadeDurSlider.value='0.5';
  const fadeDurVal=document.createElement('span');fadeDurVal.className='arr-tool-val';fadeDurVal.textContent='0.5s';
  fadeDurSlider.addEventListener('input',()=>{fadeDur=+fadeDurSlider.value;fadeDurVal.textContent=fadeDur.toFixed(2)+'s'});
  fadeRow.append(fadeDurLbl,fadeDurSlider,fadeDurVal);
  const fadeRow2=document.createElement('div');fadeRow2.className='arr-tool-row';
  const fiBtn=document.createElement('button');fiBtn.className='arr-tool-btn';fiBtn.textContent='Fade In';
  fiBtn.addEventListener('click',()=>applyClipFx('Fade In'));
  const foBtn=document.createElement('button');foBtn.className='arr-tool-btn';foBtn.textContent='Fade Out';
  foBtn.addEventListener('click',()=>applyClipFx('Fade Out'));
  fadeRow2.append(fiBtn,foBtn);fadeGrp.append(fadeRow,fadeRow2);tools.appendChild(fadeGrp);
  // --- Speed/Pitch group ---
  const spGrp=document.createElement('div');spGrp.className='arr-tool-grp';
  const spLbl=document.createElement('div');spLbl.className='arr-tool-grp-label';spLbl.textContent='SPEED / PITCH';spGrp.appendChild(spLbl);
  let pitchAmt=1;let speedRatio=1;
  const ptRow=document.createElement('div');ptRow.className='arr-tool-row';
  const ptLbl=document.createElement('label');ptLbl.textContent='Pitch';
  const ptSlider=document.createElement('input');ptSlider.type='range';ptSlider.min='0.5';ptSlider.max='2';ptSlider.step='0.01';ptSlider.value='1';
  const ptVal=document.createElement('span');ptVal.className='arr-tool-val';ptVal.textContent='1.00\u00d7';
  ptSlider.addEventListener('input',()=>{pitchAmt=+ptSlider.value;ptVal.textContent=pitchAmt.toFixed(2)+'\u00d7'});
  ptSlider.addEventListener('change',()=>{if(pitchAmt!==1)applyClipFx('PitchSlider')});
  ptRow.append(ptLbl,ptSlider,ptVal);
  const spRow=document.createElement('div');spRow.className='arr-tool-row';
  const spRLbl=document.createElement('label');spRLbl.textContent='Speed';
  const spSlider=document.createElement('input');spSlider.type='range';spSlider.min='0.25';spSlider.max='4';spSlider.step='0.05';spSlider.value='1';
  const spVal=document.createElement('span');spVal.className='arr-tool-val';spVal.textContent='1.00\u00d7';
  spSlider.addEventListener('input',()=>{speedRatio=+spSlider.value;spVal.textContent=speedRatio.toFixed(2)+'\u00d7'});
  spSlider.addEventListener('change',()=>{if(speedRatio!==1)applyClipFx('SpeedSlider')});
  spRow.append(spRLbl,spSlider,spVal);
  spGrp.append(ptRow,spRow);tools.appendChild(spGrp);
  // --- Lo-Fi / Crush group ---
  const loGrp=document.createElement('div');loGrp.className='arr-tool-grp';
  const loLbl=document.createElement('div');loLbl.className='arr-tool-grp-label';loLbl.textContent='DEGRADE';loGrp.appendChild(loLbl);
  let crushBits=8;
  const crRow=document.createElement('div');crRow.className='arr-tool-row';
  const crLbl=document.createElement('label');crLbl.textContent='Bits';
  const crSlider=document.createElement('input');crSlider.type='range';crSlider.min='2';crSlider.max='16';crSlider.step='1';crSlider.value='8';
  const crVal=document.createElement('span');crVal.className='arr-tool-val';crVal.textContent='8';
  crSlider.addEventListener('input',()=>{crushBits=+crSlider.value;crVal.textContent=crushBits});
  crSlider.addEventListener('change',()=>applyClipFx('CrushSlider'));
  crRow.append(crLbl,crSlider,crVal);
  const crRow2=document.createElement('div');crRow2.className='arr-tool-row';
  const loBtn=document.createElement('button');loBtn.className='arr-tool-btn';loBtn.textContent='Lo-Fi';
  loBtn.addEventListener('click',()=>applyClipFx('Lo-Fi'));
  crRow2.append(loBtn);loGrp.append(crRow,crRow2);tools.appendChild(loGrp);
  // --- Gain group ---
  const gGrp=document.createElement('div');gGrp.className='arr-tool-grp';
  const gLbl=document.createElement('div');gLbl.className='arr-tool-grp-label';gLbl.textContent='GAIN';gGrp.appendChild(gLbl);
  let clipGain=1;
  const gRow=document.createElement('div');gRow.className='arr-tool-row';
  const gRLbl=document.createElement('label');gRLbl.textContent='Vol';
  const gSlider=document.createElement('input');gSlider.type='range';gSlider.min='0';gSlider.max='3';gSlider.step='0.01';gSlider.value='1';
  const gVal=document.createElement('span');gVal.className='arr-tool-val';gVal.textContent='0 dB';
  gSlider.addEventListener('input',()=>{clipGain=+gSlider.value;gVal.textContent=clipGain===0?'-\u221e dB':(20*Math.log10(clipGain)).toFixed(1)+' dB'});
  gSlider.addEventListener('change',()=>{if(clipGain!==1)applyClipFx('GainSlider')});
  gRow.append(gRLbl,gSlider,gVal);
  gGrp.append(gRow);tools.appendChild(gGrp);
  bd.appendChild(tools);

  // === HELPERS ===
  function snapBeats(beats){const sv=+snapSel.value;if(sv===0)return beats;return Math.round(beats/sv)*sv}
  function pxToBeats(px){return px/ppb}
  function beatsToPx(beats){return beats*ppb}

  function addTrack(name,buf){
    const t={name,clips:[],muted:false,solo:false,vol:1,color:COLORS[m.tracks.length%COLORS.length],bus:m.tracks.length%8};
    m.tracks.push(t);
    if(buf){const durBeats=buf.duration/(60/m.bpm);t.clips.push({buf,name,startBeat:0,durBeats,offset:0,vol:1,color:t.color})}
    return t;
  }
  // Independent bus system ‚Äî uses global ARR_BUSES, routed through module's channel
  function trackDst(t){ensureBuses();return ARR_BUSES[t.bus]||ARR_BUSES[0]}
  function routeBusesToChannel(){
    ensureBuses();
    const chG=chs[m.ci].g||mGain;
    ARR_BUSES.forEach(b=>{try{b.disconnect()}catch(e){};b.connect(chG)});
  }
  // Re-route when channel changes
  const _origChChange=sel.onchange;
  sel.addEventListener('change',()=>routeBusesToChannel());
  // Initial routing once audio is ready
  setTimeout(()=>{if(ctx)routeBusesToChannel()},100);
  async function loadFiles(files){
    initA();
    for(const f of Array.from(files)){try{
      const ab=await f.arrayBuffer();const buf=await ctx.decodeAudioData(ab);
      addTrack(f.name.replace(/\.[^.]+$/,'').slice(0,24),buf);
    }catch(e){console.warn('Load fail',f.name,e)}}
    render();
  }

  // === WAVEFORM DRAWING ===
  function drawClipWave(cvs,clip,color){
    const buf=clip.buf;if(!buf)return;
    const x=cvs.getContext('2d');
    const dpr=window.devicePixelRatio||1;
    const W=cvs.width=Math.max(1,Math.round(cvs.clientWidth*dpr));
    const H=cvs.height=Math.max(1,Math.round(cvs.clientHeight*dpr));
    x.clearRect(0,0,W,H);
    // Background gradient
    const grd=x.createLinearGradient(0,0,0,H);grd.addColorStop(0,color+'18');grd.addColorStop(.5,color+'30');grd.addColorStop(1,color+'18');
    x.fillStyle=grd;x.fillRect(0,0,W,H);
    // Determine sample range - draw at buffer's native scale so trim = crop not compress
    const sr=buf.sampleRate;const nc=buf.numberOfChannels;
    const offsetSamp=Math.floor((clip.offset||0)*sr);
    const bufTotalSamp=buf.length-offsetSamp;
    if(bufTotalSamp<=0)return;
    // The clip's full (untrimmed) width in pixels would show the entire buffer
    // Calculate the native scale: how many samples per pixel at full buffer width
    const fullClipW=Math.max(1,Math.round(cvs.clientWidth*dpr*(buf.duration/(clip.durBeats*(60/m.bpm)))));
    const sampPerPx=bufTotalSamp/fullClipW;
    // We only draw W pixels (the actual canvas), which shows the first portion of the buffer
    const drawPx=Math.min(W,fullClipW);
    // Mix all channels for display
    const mixed=new Float32Array(bufTotalSamp);
    for(let ch=0;ch<nc;ch++){const d=buf.getChannelData(ch);
      for(let i=0;i<bufTotalSamp;i++){const si=offsetSamp+i;if(si<d.length)mixed[i]+=d[si]/nc}}
    // Compute min/max per pixel column for accurate peaks
    const mins=new Float32Array(drawPx);const maxs=new Float32Array(drawPx);
    const rms=new Float32Array(drawPx);
    for(let i=0;i<drawPx;i++){
      const s0=Math.floor(i*sampPerPx);const s1=Math.min(Math.floor((i+1)*sampPerPx),bufTotalSamp);
      let mn=1,mx=-1,sum=0;
      for(let j=s0;j<s1;j++){const v=mixed[j];if(v<mn)mn=v;if(v>mx)mx=v;sum+=v*v}
      mins[i]=mn;maxs[i]=mx;rms[i]=Math.sqrt(sum/Math.max(1,s1-s0));
    }
    // Draw RMS body (filled)
    x.fillStyle=color+'55';
    x.beginPath();
    for(let i=0;i<drawPx;i++){const r=rms[i]*H*.38;x.rect(i,H/2-r,1,r*2)}
    x.fill();
    // Draw peak waveform (outline) 
    x.beginPath();x.strokeStyle=color;x.lineWidth=1;
    for(let i=0;i<drawPx;i++){
      const y1=H*.5+mins[i]*H*.45;const y2=H*.5+maxs[i]*H*.45;
      x.moveTo(i+.5,y1);x.lineTo(i+.5,y2)}
    x.stroke();
    // Center line
    x.strokeStyle=color+'20';x.lineWidth=1;
    x.beginPath();x.moveTo(0,H/2);x.lineTo(W,H/2);x.stroke();
    // Top highlight
    x.fillStyle=color+'06';x.fillRect(0,0,W,H/2);
  }

  // === RENDER ===
  let selectedClip=null;
  function render(){
    playhead.remove();
    tlInner.innerHTML='';
    tlInner.appendChild(playhead);
    setNeedle(needleBeat);
    let maxBeat=32;
    m.tracks.forEach(t=>t.clips.forEach(c=>{const e=c.startBeat+c.durBeats;if(e>maxBeat)maxBeat=e}));
    maxBeat=Math.ceil(maxBeat/4)*4+16;
    const totalW=beatsToPx(maxBeat)+100;
    tlInner.style.width=totalW+'px';
    tlInner.style.height=Math.max(timeline.clientHeight,24+m.tracks.length*TRACK_H+80)+'px';

    // Ruler
    const ruler=document.createElement('div');ruler.className='arr-ruler';ruler.style.width=totalW+'px';ruler.style.marginLeft=HDW+'px';
    for(let b=0;b<=maxBeat;b++){
      const px=beatsToPx(b);
      if(b%4===0){
        const mk=document.createElement('span');mk.className='arr-ruler-mark bar';mk.style.left=px+'px';mk.textContent=(b/4+1);
        ruler.appendChild(mk);
        const line=document.createElement('div');line.className='arr-ruler-line';line.style.left=(px+HDW)+'px';
        line.style.background='color-mix(in srgb, '+(CHR[m.ci]||'#14b8a6')+' 6%, transparent)';line.style.top='24px';line.style.height=(m.tracks.length*TRACK_H+80)+'px';
        tlInner.appendChild(line);
      }else if(ppb>=30){
        const mk=document.createElement('span');mk.className='arr-ruler-mark';mk.style.left=px+'px';mk.textContent='\u00b7';mk.style.opacity='.3';
        ruler.appendChild(mk);
        const line=document.createElement('div');line.className='arr-ruler-line';line.style.left=(px+HDW)+'px';
        line.style.background='var(--border)';line.style.opacity='.3';line.style.top='24px';line.style.height=(m.tracks.length*TRACK_H+80)+'px';
        tlInner.appendChild(line);
      }
    }
    tlInner.appendChild(ruler);

    // Empty state
    if(m.tracks.length===0){
      const empty=document.createElement('div');empty.className='arr-empty';
      empty.innerHTML='<div class="arr-empty-icon">\ud83c\udfa7</div><div class="arr-empty-text">Drop audio files here</div><div class="arr-empty-sub">or click IMPORT / + TRACK to get started</div>';
      tlInner.appendChild(empty);
    }

    // Tracks
    m.tracks.forEach((t,ti)=>{
      const track=document.createElement('div');track.className='arr-track';track.style.height=TRACK_H+'px';
      // Header
      const hd=document.createElement('div');hd.className='arr-track-hd';
      const dot=document.createElement('div');dot.style.cssText='width:8px;height:8px;border-radius:50%;background:'+t.color+';flex-shrink:0';
      const nm=document.createElement('div');nm.className='arr-track-nm';nm.textContent=t.name;
      nm.addEventListener('dblclick',()=>{const n=prompt('Track name:',t.name);if(n){t.name=n;nm.textContent=n}});
      const mBtn=document.createElement('div');mBtn.className='bm'+(t.muted?' muted':'');mBtn.textContent='M';mBtn.style.cssText+='width:14px;height:14px;font-size:6px;border-radius:2px';
      mBtn.addEventListener('click',e=>{e.stopPropagation();t.muted=!t.muted;mBtn.classList.toggle('muted')});
      const sBtn=document.createElement('div');sBtn.className='bs_btn'+(t.solo?' soloed':'');sBtn.textContent='S';sBtn.style.cssText+='width:14px;height:14px;font-size:6px;border-radius:2px';
      sBtn.addEventListener('click',e=>{e.stopPropagation();t.solo=!t.solo;sBtn.classList.toggle('soloed')});
      // Volume slider
      const volS=document.createElement('input');volS.type='range';volS.className='arr-track-vol';volS.min='0';volS.max='2';volS.step='0.01';volS.value=t.vol;
      volS.addEventListener('input',e=>{e.stopPropagation();t.vol=+volS.value});
      // Bus selector (up/down)
      const busWrap=document.createElement('div');busWrap.style.cssText='display:flex;align-items:center;gap:1px';
      const busUp=document.createElement('div');busUp.style.cssText='font-size:7px;cursor:pointer;color:var(--dim);line-height:1;padding:0 1px';busUp.textContent='\u25b2';
      const busDown=document.createElement('div');busDown.style.cssText='font-size:7px;cursor:pointer;color:var(--dim);line-height:1;padding:0 1px';busDown.textContent='\u25bc';
      const busLabel=document.createElement('div');busLabel.className='arr-track-bus';
      busLabel.style.cssText='font-size:6px;font-weight:800;padding:1px 4px;border-radius:2px;color:#fff;min-width:16px;text-align:center;background:'+BUS_COLORS[t.bus];
      busLabel.textContent=t.bus+1;
      busUp.addEventListener('click',e=>{e.stopPropagation();t.bus=(t.bus+1)%ARR_BUS_COUNT;busLabel.textContent=t.bus+1;busLabel.style.background=BUS_COLORS[t.bus]});
      busDown.addEventListener('click',e=>{e.stopPropagation();t.bus=(t.bus-1+ARR_BUS_COUNT)%ARR_BUS_COUNT;busLabel.textContent=t.bus+1;busLabel.style.background=BUS_COLORS[t.bus]});
      busWrap.append(busDown,busLabel,busUp);
      const delBtn=document.createElement('div');delBtn.className='arr-track-del';delBtn.textContent='\u2715';delBtn.title='Delete track';
      delBtn.addEventListener('click',e=>{e.stopPropagation();m.tracks.splice(ti,1);render()});
      hd.append(dot,nm,mBtn,sBtn,volS,busWrap,delBtn);track.appendChild(hd);

      // Track body
      const body=document.createElement('div');body.className='arr-track-body';body.style.width=totalW+'px';

      t.clips.forEach(c=>{
        const clipEl=document.createElement('div');clipEl.className='arr-clip'+(c===selectedClip?' selected':'');
        clipEl.style.left=beatsToPx(c.startBeat)+'px';
        clipEl.style.width=Math.max(16,beatsToPx(c.durBeats))+'px';
        clipEl.style.background=c.color+'40';clipEl.style.borderColor=c.color+'50';
        // Waveform
        const cvs=document.createElement('canvas');cvs.style.cssText='width:100%;height:100%';clipEl.appendChild(cvs);
        requestAnimationFrame(()=>{if(cvs.clientWidth>0)drawClipWave(cvs,c,c.color)});
        // Labels
        const lbl=document.createElement('div');lbl.className='arr-clip-label';lbl.textContent=c.name;clipEl.appendChild(lbl);
        const dur=document.createElement('div');dur.className='arr-clip-dur';dur.textContent=c.buf.duration.toFixed(1)+'s';clipEl.appendChild(dur);
        // Click to select
        clipEl.addEventListener('click',e=>{if(e.altKey){t.clips.push({...c,buf:c.buf,startBeat:c.startBeat+c.durBeats,name:c.name+' copy'});render();return}e.stopPropagation();selectedClip=c;render()});
        // Drag to move (horizontal + vertical cross-track)
        clipEl.addEventListener('mousedown',e=>{
          if(e.target.classList.contains('arr-clip-handle'))return;
          e.stopPropagation();e.preventDefault();selectedClip=c;
          const startX=e.clientX,startY=e.clientY,origBeat=c.startBeat;
          const origTrack=t;let moved=false;let curTrackIdx=ti;
          clipEl.classList.add('dragging');
          const onMove=ev=>{
            moved=true;
            c.startBeat=Math.max(0,snapBeats(origBeat+pxToBeats(ev.clientX-startX)));
            clipEl.style.left=beatsToPx(c.startBeat)+'px';
            // Determine target track from Y
            const tlRect=timeline.getBoundingClientRect();
            const y=ev.clientY-tlRect.top+timeline.scrollTop-24; // 24px ruler
            const newIdx=Math.max(0,Math.min(m.tracks.length-1,Math.floor(y/TRACK_H)));
            if(newIdx!==curTrackIdx){
              const oldT=m.tracks[curTrackIdx];const newT=m.tracks[newIdx];
              const ci=oldT.clips.indexOf(c);
              if(ci>=0){oldT.clips.splice(ci,1);newT.clips.push(c);c.color=newT.color;curTrackIdx=newIdx}
            }
            clipEl.style.top=(3+(curTrackIdx-ti)*TRACK_H)+'px';
          };
          const onUp=()=>{window.removeEventListener('mousemove',onMove);window.removeEventListener('mouseup',onUp);clipEl.classList.remove('dragging');if(moved){render();if(m.playing){const cur=needleBeat*(60/m.bpm);playSrcs.forEach(s=>{try{s.stop()}catch(e){}});playSrcs=[];m.playing=false;playAll_arr(cur)}}};
          window.addEventListener('mousemove',onMove);window.addEventListener('mouseup',onUp);
        });
        // Touch clip drag
        clipEl.addEventListener('touchstart',e=>{
          if(e.target.classList.contains('arr-clip-handle'))return;
          e.stopPropagation();e.preventDefault();selectedClip=c;lockWsScroll();
          const touch=e.touches[0];
          const startX=touch.clientX,startY=touch.clientY,origBeat=c.startBeat;
          let moved=false;let curTrackIdx=ti;
          clipEl.classList.add('dragging');
          const onMove=ev=>{
            ev.preventDefault();const tv=ev.touches[0];moved=true;
            c.startBeat=Math.max(0,snapBeats(origBeat+pxToBeats(tv.clientX-startX)));
            clipEl.style.left=beatsToPx(c.startBeat)+'px';
            const tlRect=timeline.getBoundingClientRect();
            const y=tv.clientY-tlRect.top+timeline.scrollTop-24;
            const newIdx=Math.max(0,Math.min(m.tracks.length-1,Math.floor(y/TRACK_H)));
            if(newIdx!==curTrackIdx){
              const oldT=m.tracks[curTrackIdx];const newT=m.tracks[newIdx];
              const ci2=oldT.clips.indexOf(c);
              if(ci2>=0){oldT.clips.splice(ci2,1);newT.clips.push(c);c.color=newT.color;curTrackIdx=newIdx}
            }
            clipEl.style.top=(3+(curTrackIdx-ti)*TRACK_H)+'px';
          };
          const onUp=()=>{window.removeEventListener('touchmove',onMove);window.removeEventListener('touchend',onUp);unlockWsScroll();clipEl.classList.remove('dragging');if(moved){render();if(m.playing){const cur=needleBeat*(60/m.bpm);playSrcs.forEach(s=>{try{s.stop()}catch(e){}});playSrcs=[];m.playing=false;playAll_arr(cur)}}};
          window.addEventListener('touchmove',onMove,{passive:false});window.addEventListener('touchend',onUp);
        },{passive:false});
        // Right-click delete
        clipEl.addEventListener('contextmenu',e=>{e.preventDefault();const idx=t.clips.indexOf(c);if(idx>=0)t.clips.splice(idx,1);if(selectedClip===c)selectedClip=null;render()});
        // Resize handles
        let _resizeAF=null;
        const _liveWave=()=>{_resizeAF=null;if(cvs.clientWidth>0)drawClipWave(cvs,c,c.color)};
        const hL=document.createElement('div');hL.className='arr-clip-handle left';
        hL.addEventListener('mousedown',e=>{e.stopPropagation();e.preventDefault();const sx=e.clientX,os=c.startBeat,od=c.durBeats,oo=c.offset||0;
          const onM=ev=>{const ns=snapBeats(os+pxToBeats(ev.clientX-sx)),d=ns-os;if(od-d>.25){
            const secPerBeat=60/m.bpm;const offsetDelta=d*secPerBeat;
            c.offset=Math.max(0,oo+offsetDelta);c.startBeat=ns;c.durBeats=od-d;
            clipEl.style.left=beatsToPx(c.startBeat)+'px';clipEl.style.width=Math.max(16,beatsToPx(c.durBeats))+'px';if(!_resizeAF)_resizeAF=requestAnimationFrame(_liveWave)}};
          const onU=()=>{window.removeEventListener('mousemove',onM);window.removeEventListener('mouseup',onU);render()};
          window.addEventListener('mousemove',onM);window.addEventListener('mouseup',onU)});
        hL.addEventListener('touchstart',e=>{e.stopPropagation();e.preventDefault();lockWsScroll();const sx=e.touches[0].clientX,os=c.startBeat,od=c.durBeats,oo=c.offset||0;
          const onM=ev=>{ev.preventDefault();const tx=ev.touches[0].clientX;const ns=snapBeats(os+pxToBeats(tx-sx)),d=ns-os;if(od-d>.25){
            const secPerBeat=60/m.bpm;const offsetDelta=d*secPerBeat;
            c.offset=Math.max(0,oo+offsetDelta);c.startBeat=ns;c.durBeats=od-d;
            clipEl.style.left=beatsToPx(c.startBeat)+'px';clipEl.style.width=Math.max(16,beatsToPx(c.durBeats))+'px';if(!_resizeAF)_resizeAF=requestAnimationFrame(_liveWave)}};
          const onU=()=>{window.removeEventListener('touchmove',onM);window.removeEventListener('touchend',onU);unlockWsScroll();render()};
          window.addEventListener('touchmove',onM,{passive:false});window.addEventListener('touchend',onU)},{passive:false});
        const hR=document.createElement('div');hR.className='arr-clip-handle right';
        hR.addEventListener('mousedown',e=>{e.stopPropagation();e.preventDefault();const sx=e.clientX,od=c.durBeats;
          const onM=ev=>{c.durBeats=Math.max(.25,snapBeats(od+pxToBeats(ev.clientX-sx)));clipEl.style.width=Math.max(16,beatsToPx(c.durBeats))+'px';if(!_resizeAF)_resizeAF=requestAnimationFrame(_liveWave)};
          const onU=()=>{window.removeEventListener('mousemove',onM);window.removeEventListener('mouseup',onU);render()};
          window.addEventListener('mousemove',onM);window.addEventListener('mouseup',onU)});
        hR.addEventListener('touchstart',e=>{e.stopPropagation();e.preventDefault();lockWsScroll();const sx=e.touches[0].clientX,od=c.durBeats;
          const onM=ev=>{ev.preventDefault();const tx=ev.touches[0].clientX;c.durBeats=Math.max(.25,snapBeats(od+pxToBeats(tx-sx)));clipEl.style.width=Math.max(16,beatsToPx(c.durBeats))+'px';if(!_resizeAF)_resizeAF=requestAnimationFrame(_liveWave)};
          const onU=()=>{window.removeEventListener('touchmove',onM);window.removeEventListener('touchend',onU);unlockWsScroll();render()};
          window.addEventListener('touchmove',onM,{passive:false});window.addEventListener('touchend',onU)},{passive:false});
        clipEl.append(hL,hR);body.appendChild(clipEl);
      });

      // Drop onto track
      body.addEventListener('dragover',e=>{e.preventDefault();body.style.background='color-mix(in srgb, var(--ac, #14b8a6) 4%, transparent)'});
      body.addEventListener('dragleave',()=>{body.style.background=''});
      body.addEventListener('drop',async e=>{e.preventDefault();body.style.background='';
        const f=e.dataTransfer.files[0];if(!f||!f.type.startsWith('audio'))return;
        initA();const ab=await f.arrayBuffer();const buf=await ctx.decodeAudioData(ab);
        const rect=body.getBoundingClientRect();const startBeat=snapBeats(pxToBeats(e.clientX-rect.left));
        t.clips.push({buf,name:f.name.replace(/\.[^.]+$/,'').slice(0,24),startBeat,durBeats:buf.duration/(60/m.bpm),offset:0,vol:1,color:t.color});render()});
      track.appendChild(body);tlInner.appendChild(track);
    });
  }

  // === CLIP FX ===
  function applyClipFx(name){
    if(!selectedClip||!selectedClip.buf)return;
    initA();if(!ctx)return;
    const wasPl=m.playing;
    const curSec=wasPl?(ctx.currentTime-m.playStart):needleBeat*(60/m.bpm);
    if(wasPl){m.playing=false;playSrcs.forEach(s=>{try{s.stop()}catch(e){}});playSrcs=[]}
    const c=selectedClip,buf=c.buf,nc=buf.numberOfChannels,sr=buf.sampleRate,len=buf.length;
    const nb=ctx.createBuffer(nc,len,sr);for(let ch=0;ch<nc;ch++)nb.getChannelData(ch).set(buf.getChannelData(ch));
    // Audible region: from offset to offset+clipDuration
    const offSamp=Math.floor((c.offset||0)*sr);
    const clipSec=c.durBeats*(60/m.bpm);
    const endSamp=Math.min(len,offSamp+Math.floor(clipSec*sr));
    const regionLen=endSamp-offSamp;
    if(name==='Reverse'){for(let ch=0;ch<nc;ch++){const d=nb.getChannelData(ch);const sub=d.slice(offSamp,endSamp);sub.reverse();d.set(sub,offSamp)}c.buf=nb}
    else if(name==='Normalize'){let peak=0;for(let ch=0;ch<nc;ch++){const d=nb.getChannelData(ch);for(let i=offSamp;i<endSamp;i++){const a=Math.abs(d[i]);if(a>peak)peak=a}}if(peak>0){const g=1/peak;for(let ch=0;ch<nc;ch++){const d=nb.getChannelData(ch);for(let i=offSamp;i<endSamp;i++)d[i]*=g}}c.buf=nb}
    else if(name==='Silence'){for(let ch=0;ch<nc;ch++){const d=nb.getChannelData(ch);for(let i=offSamp;i<endSamp;i++)d[i]=0}c.buf=nb}
    else if(name==='Fade In'){const fl=Math.min(regionLen,sr*fadeDur);for(let ch=0;ch<nc;ch++){const d=nb.getChannelData(ch);for(let i=0;i<fl;i++)d[offSamp+i]*=i/fl}c.buf=nb}
    else if(name==='Fade Out'){const fl=Math.min(regionLen,sr*fadeDur);for(let ch=0;ch<nc;ch++){const d=nb.getChannelData(ch);for(let i=0;i<fl;i++)d[endSamp-1-i]*=i/fl}c.buf=nb}
    else if(name==='Lo-Fi'){const step=Math.pow(.5,8);for(let ch=0;ch<nc;ch++){const d=nb.getChannelData(ch);for(let i=offSamp;i<endSamp;i++)d[i]=step*Math.floor(d[i]/step+.5)}c.buf=nb}
    else if(name==='CrushSlider'){const step=Math.pow(.5,crushBits);for(let ch=0;ch<nc;ch++){const d=nb.getChannelData(ch);for(let i=offSamp;i<endSamp;i++)d[i]=step*Math.floor(d[i]/step+.5)}c.buf=nb}
    else if(name==='GainSlider'){for(let ch=0;ch<nc;ch++){const d=nb.getChannelData(ch);for(let i=offSamp;i<endSamp;i++)d[i]*=clipGain}c.buf=nb}
    else if(name==='PitchSlider'){const r=pitchAmt,nl=Math.floor(regionLen/r),pb=ctx.createBuffer(nc,offSamp+nl,sr);for(let ch=0;ch<nc;ch++){const s=nb.getChannelData(ch),d=pb.getChannelData(ch);for(let i=0;i<offSamp;i++)d[i]=s[i];for(let i=0;i<nl;i++){const si=i*r,x=Math.floor(si),f=si-x;const si2=offSamp+x;d[offSamp+i]=si2+1<len?s[si2]*(1-f)+s[si2+1]*f:s[Math.min(si2,len-1)]}}c.buf=pb;c.durBeats=nl/sr/(60/m.bpm)}
    else if(name==='SpeedSlider'){const r=speedRatio,nl=Math.floor(regionLen/r),pb=ctx.createBuffer(nc,offSamp+nl,sr);for(let ch=0;ch<nc;ch++){const s=nb.getChannelData(ch),d=pb.getChannelData(ch);for(let i=0;i<offSamp;i++)d[i]=s[i];for(let i=0;i<nl;i++){const si=i*r,x=Math.floor(si),f=si-x;const si2=offSamp+x;d[offSamp+i]=si2+1<len?s[si2]*(1-f)+s[si2+1]*f:s[Math.min(si2,len-1)]}}c.buf=pb;c.durBeats=nl/sr/(60/m.bpm)}
    else{c.buf=nb}
    render();
    if(wasPl)playAll_arr(curSec);
  }

  // === TIME DISPLAY ===
  function fmtBeat(b){const sec=b*(60/m.bpm);const m2=Math.floor(sec/60);const s=sec%60;return m2+':'+('0'+Math.floor(s)).slice(-2)+'.'+Math.floor((s%1)*10)}
  function updTimeDisp(){timeDisp.textContent=fmtBeat(needleBeat)}

  // === PLAYBACK ===
  let playSrcs=[];
  function playAll_arr(seekSec){
    if(!ctx)return;initA();routeBusesToChannel();stopAll_arr(true);
    const sk=seekSec||0;m.playing=true;m.playStart=ctx.currentTime-sk;
    playBtn.style.display='none';pauseBtn.style.display='';
    const anySolo=m.tracks.some(t=>t.solo);
    m.tracks.forEach(t=>{if(t.muted)return;if(anySolo&&!t.solo)return;
      const dst=trackDst(t);
      t.clips.forEach(c=>{const src=ctx.createBufferSource();src.buffer=c.buf;
        const g=ctx.createGain();g.gain.value=c.vol*(t.vol||1);src.connect(g);g.connect(dst);
        const ss=c.startBeat*(60/m.bpm),ds=c.durBeats*(60/m.bpm),cs=ss-sk;
        if(cs>=0)src.start(ctx.currentTime+cs,c.offset||0,Math.min(ds,c.buf.duration));
        else if(cs+ds>0)src.start(ctx.currentTime,Math.min(-cs,c.buf.duration-.01),Math.min(cs+ds,c.buf.duration));
        playSrcs.push(src)})});
    animPH();
  }
  function pauseArr(){
    if(!m.playing)return;
    needleBeat=(ctx.currentTime-m.playStart)/(60/m.bpm);
    m.playing=false;playSrcs.forEach(s=>{try{s.stop()}catch(e){}});playSrcs=[];
    playBtn.style.display='';pauseBtn.style.display='none';
    setNeedle(needleBeat);
  }
  function stopAll_arr(keepNeedle){
    m.playing=false;playSrcs.forEach(s=>{try{s.stop()}catch(e){}});playSrcs=[];
    playBtn.style.display='';pauseBtn.style.display='none';
    if(!keepNeedle)setNeedle(0);
  }
  let phAF=null;let _userScrolling=false;let _scrollTimer=null;
  timeline.addEventListener('scroll',()=>{
    if(m.playing){_userScrolling=true;clearTimeout(_scrollTimer);_scrollTimer=setTimeout(()=>{_userScrolling=false},1500)}
  },{passive:true});
  // Suppress auto-scroll while user is interacting with anything in the timeline
  timeline.addEventListener('mousedown',()=>{_userScrolling=true},{capture:true});
  timeline.addEventListener('mouseup',()=>{clearTimeout(_scrollTimer);_scrollTimer=setTimeout(()=>{_userScrolling=false},1500)},{capture:true});
  function animPH(){if(!m.playing||!document.getElementById('m'+id)){phAF=null;return}
    const beat=(ctx.currentTime-m.playStart)/(60/m.bpm);
    needleBeat=beat;
    playhead.style.left=(HDW+beatsToPx(beat))+'px';
    // Throttle time display to ~15fps
    if(!animPH._lt||beat-animPH._lt>.066){animPH._lt=beat;updTimeDisp()}
    // Auto-scroll only if user isn't manually scrolling
    if(!_userScrolling){
      const tlW=timeline.clientWidth;const absPx=HDW+beatsToPx(beat);
      if(absPx>timeline.scrollLeft+tlW-60)timeline.scrollLeft=absPx-tlW+120;
      if(absPx<timeline.scrollLeft+100)timeline.scrollLeft=Math.max(0,absPx-120);
    }
    let mx=0;m.tracks.forEach(t=>t.clips.forEach(c=>{const e=c.startBeat+c.durBeats;if(e>mx)mx=e}));
    if(beat>mx+2){stopAll_arr();return}phAF=requestAnimationFrame(animPH)}
  playBtn.addEventListener('click',()=>{initA();playAll_arr(needleBeat*(60/m.bpm))});
  pauseBtn.addEventListener('click',pauseArr);
  stopBtn.addEventListener('click',()=>stopAll_arr(false));

  render();
  m.destroy=()=>{stopAll_arr();if(phAF)cancelAnimationFrame(phAF)};
  m.addTrack=addTrack;m.render=render;
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}

// === INIT ===
addBeat(0);addMixer();

// === MOBILE SUPPORT ===
// === WORKSPACE SCROLL LOCK FOR TOUCH ===
const _wsEl=document.querySelector('.workspace');
let _wsLockCount=0;
function lockWsScroll(){
  _wsLockCount++;
  if(_wsEl&&_wsLockCount===1){_wsEl.style.overflow='hidden';_wsEl.style.touchAction='none'}
}
function unlockWsScroll(){
  _wsLockCount=Math.max(0,_wsLockCount-1);
  if(_wsEl&&_wsLockCount===0){_wsEl.style.overflow='';_wsEl.style.touchAction=''}
}

// Global touch polyfill: makes keyboard keys, buttons, and interactive elements work on touch
// Maps touchstart‚Üímousedown, touchend‚Üímouseup on elements with mouse handlers
function addTouchPoly(root){
  // ALL keyboard keys: synth (.swk,.sbk), piano (.pk-w,.pk-b), old (.key,.bkey)
  root.querySelectorAll('.key,.bkey,.swk,.sbk,.pk-w,.pk-b').forEach(k=>{
    k.addEventListener('touchstart',e=>{e.preventDefault();lockWsScroll();
      k.dispatchEvent(new MouseEvent('mousedown',{bubbles:true}));
    },{passive:false});
    k.addEventListener('touchend',e=>{e.preventDefault();unlockWsScroll();
      k.dispatchEvent(new MouseEvent('mouseup',{bubbles:true}));
    },{passive:false});
    k.addEventListener('touchcancel',e=>{unlockWsScroll();
      k.dispatchEvent(new MouseEvent('mouseup',{bubbles:true}));
    });
  });
  // Drum grid cells
  root.querySelectorAll('.drumgrid div[style*="cursor:pointer"]').forEach(c=>{
    c.addEventListener('touchstart',e=>{e.preventDefault();lockWsScroll();
      c.dispatchEvent(new MouseEvent('mousedown',{bubbles:true,button:0}));
    },{passive:false});
    c.addEventListener('touchend',()=>unlockWsScroll());
    c.addEventListener('touchcancel',()=>unlockWsScroll());
  });
  // Note grid cells (.nr-cell)
  root.querySelectorAll('.nr-cell').forEach(c=>{
    c.addEventListener('touchstart',e=>{e.preventDefault();lockWsScroll();
      c.dispatchEvent(new MouseEvent('mousedown',{bubbles:true}));
    },{passive:false});
    c.addEventListener('touchmove',e=>{e.preventDefault();
      const t=e.touches[0];const el=document.elementFromPoint(t.clientX,t.clientY);
      if(el&&el.classList.contains('nr-cell'))el.dispatchEvent(new MouseEvent('mouseenter',{bubbles:true}));
    },{passive:false});
    c.addEventListener('touchend',e=>{unlockWsScroll();
      window.dispatchEvent(new MouseEvent('mouseup',{bubbles:true}));
    });
    c.addEventListener('touchcancel',()=>unlockWsScroll());
  });
  // Range sliders ‚Äî make thumb easier to grab on touch
  root.querySelectorAll('input[type="range"]').forEach(r=>{
    r.style.touchAction='none';
    r.addEventListener('touchstart',()=>lockWsScroll(),{passive:true});
    r.addEventListener('touchend',()=>unlockWsScroll(),{passive:true});
    r.addEventListener('touchcancel',()=>unlockWsScroll());
  });
  // Beat steps (.bstep)
  root.querySelectorAll('.bstep').forEach(s=>{
    s.addEventListener('touchstart',()=>lockWsScroll(),{passive:true});
    s.addEventListener('touchend',()=>unlockWsScroll(),{passive:true});
    s.addEventListener('touchcancel',()=>unlockWsScroll());
  });
}
// Patch existing modules
document.querySelectorAll('.win').forEach(w=>addTouchPoly(w));
// Patch future modules via MutationObserver
const wsObs=new MutationObserver(muts=>{
  muts.forEach(m=>m.addedNodes.forEach(n=>{
    if(n.nodeType===1&&n.classList&&n.classList.contains('win'))addTouchPoly(n);
  }));
});
wsObs.observe(wsI,{childList:true});

// Range slider touch polyfill ‚Äî drag anywhere on the track
function rangeFromTouch(range,touch){
  const rect=range.getBoundingClientRect();
  const x=touch.clientX-rect.left;
  const ratio=Math.max(0,Math.min(1,x/rect.width));
  const min=parseFloat(range.min)||0;
  const max=parseFloat(range.max)||100;
  const step=parseFloat(range.step)||1;
  let v=min+ratio*(max-min);
  v=Math.round(v/step)*step;
  range.value=v;
  range.dispatchEvent(new Event('input',{bubbles:true}));
}
document.addEventListener('touchstart',e=>{
  const range=e.target.closest('input[type="range"]');
  if(!range)return;
  e.preventDefault();
  rangeFromTouch(range,e.touches[0]);
  const onM=ev=>{ev.preventDefault();rangeFromTouch(range,ev.touches[0])};
  const onU=()=>{
    window.removeEventListener('touchmove',onM);
    window.removeEventListener('touchend',onU);
    range.dispatchEvent(new Event('change',{bubbles:true}));
  };
  window.addEventListener('touchmove',onM,{passive:false});
  window.addEventListener('touchend',onU);
},{passive:false});

// Prevent iOS long-press context menu on interactive elements
document.addEventListener('contextmenu',e=>{
  if(e.target.closest('.pk-w,.pk-b,.swk,.sbk,.key,.bkey,.bstep,.wh,.pbtn,.nr-cell,button,.arr-clip,.arr-clip-handle'))e.preventDefault();
});
// Prevent rubber-band scroll on iOS
document.body.addEventListener('touchmove',e=>{
  if(!e.target.closest('.wbody,.workspace,.piano-kb,.skb,.nr-wrap,.arr-timeline,.tb-row1,.tb-row2,#themeGrid,canvas,input[type="range"]'))e.preventDefault();
},{passive:false});

// Touch press feedback on buttons
if('ontouchstart'in window||navigator.maxTouchPoints>0){
  document.addEventListener('touchstart',e=>{
    const btn=e.target.closest('.abtn,.xbtn,.pbtn,.wb,.chtab,.arr-tbtn,button');
    if(btn){btn.style.opacity='.7';btn.style.transform='scale(.95)';btn.style.transition='transform .08s,opacity .08s'}
  },{passive:true});
  document.addEventListener('touchend',e=>{
    const btn=e.target.closest('.abtn,.xbtn,.pbtn,.wb,.chtab,.arr-tbtn,button');
    if(btn){btn.style.opacity='';btn.style.transform='';btn.style.transition=''}
  },{passive:true});
  // Prevent double-tap zoom on buttons
  let _lastTouchEnd=0;
  document.addEventListener('touchend',e=>{
    const now=Date.now();
    if(now-_lastTouchEnd<300&&e.target.closest('button,.abtn,.xbtn,.pbtn,.wb,.chtab,.bstep,.arr-tbtn'))e.preventDefault();
    _lastTouchEnd=now;
  },{passive:false});
}
</script>
</body></html>
